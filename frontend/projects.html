<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) =>
          value === "dark" || value === "light" || value === "system" ? value : null;
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>–ü—Ä–æ–µ–∫—Ç—ã ‚Äî Projects Tracker</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f3f5f9;
        --bg-alt: #eef1f6;
        --surface: #ffffff;
        --surface-muted: #f7f8fc;
        --text: #0f172a;
        --muted: #475569;
        --border: #d9e0ea;
        --divider: rgba(148, 163, 184, 0.35);
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0e1218;
        --bg-alt: #0b1017;
        --surface: #111827;
        --surface-muted: #161f30;
        --text: #e6edf3;
        --muted: #9aa6b6;
        --border: #1f2937;
        --divider: rgba(148, 163, 184, 0.25);
        --shadow: 0 22px 50px rgba(0, 0, 0, 0.5);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        color: var(--text);
      }

      .app-shell {
        max-width: 1280px;
        margin: 0 auto;
        padding: 16px 20px 0;
      }

      .page {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 20px 78px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        position: sticky;
        top: 12px;
        z-index: 900;
      }

      .logo {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: var(--text);
        text-decoration: none;
      }

      .logo img {
        width: 36px;
        height: 36px;
      }

      nav { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

      nav a {
        padding: 8px 12px;
        border-radius: 12px;
        text-decoration: none;
        color: var(--text);
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      nav a:hover { box-shadow: var(--shadow); }

      a {
        color: var(--accent);
      }

      h1 {
        margin: 4px 0 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--surface-muted);
        color: var(--accent);
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid var(--border);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin: 16px 0;
      }

      .filters-card {
        margin: 18px 0;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 14px;
      }

      .filters-grid .form-field input,
      .filters-grid .form-field select,
      .filters-grid .form-field textarea {
        width: auto;
        min-width: 0;
      }

      .form-field.status-field {
        grid-column: 1 / -1;
      }

      .filter-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .filter-actions .filter-trigger {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .badge-dot {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        padding: 2px 6px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--text);
        font-size: 12px;
        border: 1px solid var(--border);
        font-weight: 700;
      }

      .checkbox-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .status-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 14px;
      }

      .status-row label {
        white-space: nowrap;
      }

      .filter-panel {
        position: fixed;
        inset: 0;
        display: grid;
        grid-template-columns: 1fr;
        place-items: stretch;
        z-index: 1100;
      }

      .filter-panel[hidden] {
        display: none;
      }

      .filter-panel .backdrop {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.38);
      }

      .filter-card {
        position: relative;
        margin: auto 0 auto auto;
        width: min(420px, 92vw);
        max-height: 100vh;
        background: var(--surface);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .filter-card header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--divider);
      }

      .filter-card .body {
        padding: 14px 16px 8px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .filter-card .footer {
        padding: 12px 16px;
        border-top: 1px solid var(--divider);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .filter-field label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .filter-field .row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .filter-buttons {
        display: inline-flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .site-footer {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 20px 48px;
        text-align: center;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 9px 14px;
        border-radius: 12px;
        color: var(--text);
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
        border-color: var(--accent);
        color: #fff;
        font-weight: 700;
        box-shadow: 0 12px 30px rgba(16, 163, 127, 0.2);
      }

      button.ghost {
        background: transparent;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 18px 18px 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }

      .projects-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 18px;
      }

      @media (max-width: 960px) {
        .projects-grid {
          grid-template-columns: 1fr;
        }
      }

      .load-more-row {
        display: none;
        justify-content: center;
        margin: 18px 0 0;
      }

      .project-card {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 12px;
        align-items: stretch;
        padding: 12px;
      }

      .overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 32px 18px;
        z-index: 1100;
      }

      .overlay.active {
        display: flex;
      }

      .overlay-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.38);
        backdrop-filter: blur(4px);
      }

      .overlay-card {
        position: relative;
        width: min(960px, 100%);
        max-height: 90vh;
        overflow: auto;
        background: var(--surface);
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: 0 26px 60px rgba(0, 0, 0, 0.3);
        padding: 22px 22px 18px;
        z-index: 1;
      }

      .overlay-card h3 {
        margin-top: 0;
      }

      .overlay-close {
        position: absolute;
        top: 12px;
        right: 12px;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .card-image {
        width: 120px;
        height: 120px;
        border-radius: 12px;
        object-fit: cover;
        background: var(--surface-muted);
        border: 1px solid var(--border);
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: var(--surface-muted);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        background: var(--accent-soft);
        color: var(--text);
      }

      .badge.archived {
        background: rgba(248, 113, 113, 0.15);
        color: #dc2626;
      }

      .badge.closed {
        background: var(--surface-muted);
        color: var(--text);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
      }

      th {
        color: var(--muted);
        letter-spacing: 0.01em;
        font-weight: 600;
      }

      .table-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      tr.archived {
        background: var(--surface-muted);
        color: var(--muted);
      }

      label {
        display: grid;
        gap: 6px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font: inherit;
        background: var(--surface-muted);
        color: var(--text);
      }

      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310a37f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        padding-right: 40px;
      }

      .form-field {
        display: grid;
        gap: 6px;
      }

      .checkbox {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        cursor: pointer;
      }

      .checkbox input {
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 6px;
        border: 2px solid var(--border);
        background: var(--surface);
        transition: border-color 0.2s ease, background-color 0.2s ease;
      }

      .checkbox input:checked {
        border-color: var(--accent);
        background-color: var(--accent-soft);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310a37f' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='5 13 10 17 19 7'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 14px;
      }

      .checkbox input:focus {
        outline: 2px solid var(--accent-soft);
        outline-offset: 2px;
      }

      textarea {
        resize: vertical;
      }

      .flex {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .space-between {
        justify-content: space-between;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--surface-muted);
        border-radius: 999px;
        font-size: 0.9rem;
      }

      .muted {
        color: var(--muted);
      }

      dialog {
        border: none;
        border-radius: 14px;
        padding: 0;
        box-shadow: var(--shadow);
        background: var(--surface);
        color: var(--text);
        width: 100%;
        max-width: min(980px, 95vw);
      }

      dialog.form-dialog {
        width: auto;
      }

      dialog::backdrop {
        background: rgba(15, 23, 42, 0.45);
      }

      .dialog-body {
        padding: 20px;
        min-width: 580px;
        display: grid;
        gap: 16px;
      }

      .dialog-body.large-form {
        min-width: min(820px, 90vw);
      }

      .context-menu {
        position: fixed;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        min-width: 220px;
        z-index: 1000;
        padding: 8px 0;
      }

      .context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu li {
        padding: 8px 14px;
        cursor: pointer;
      }

      .context-menu li:hover {
        background: var(--accent-soft);
      }

      .detail-panel {
        display: grid;
        gap: 8px;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .table-scroll {
        overflow-x: auto;
      }

      .theme-menu {
        position: relative;
      }

      .theme-menu summary {
        list-style: none;
        display: grid;
        place-items: center;
        padding: 6px;
        min-width: 38px;
        min-height: 38px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        cursor: pointer;
        user-select: none;
      }

      .theme-menu summary::-webkit-details-marker {
        display: none;
      }

      .theme-menu[open] summary {
        box-shadow: var(--shadow);
        background: var(--surface);
      }

      .theme-menu-dropdown {
        position: absolute;
        right: 0;
        top: calc(100% + 8px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 6px;
        display: none;
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
        width: max-content;
        z-index: 1200;
      }

      .theme-menu[open] .theme-menu-dropdown {
        display: flex;
      }

      .theme-menu-dropdown button {
        border: none;
        background: transparent;
        color: var(--text);
        text-align: left;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: center;
        min-width: 0;
      }

      .theme-menu-dropdown button:hover,
      .theme-menu-dropdown button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div class="topbar">
        <a class="logo" href="/index.html" aria-label="Projects Tracker">
          <img src="/favicon.svg" alt="Projects Tracker" />
          <div>Projects Tracker</div>
        </a>
        <nav aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <a href="/index.html">–î–∞—à–±–æ—Ä–¥</a>
          <a href="/groups.html">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</a>
          <a href="/projects.html">–ü—Ä–æ–µ–∫—Ç—ã</a>
          <a href="/priority-tasks.html">–í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
          <a href="/templates.html">–®–∞–±–ª–æ–Ω—ã</a>
          <details class="theme-menu">
            <summary aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
              <span aria-hidden="true">üåó</span>
              <span class="theme-menu-label" data-theme-state>–¢–µ–º–∞</span>
            </summary>
            <div class="theme-menu-dropdown" role="menu" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
              <button type="button" role="menuitem" data-theme-select="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="system">üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="dark">üåô –¢—ë–º–Ω–∞—è</button>
            </div>
          </details>
        </nav>
      </div>
    </div>
    <div class="page">
      <div class="flex space-between" style="align-items: baseline">
        <div>
          <p class="pill">–ü—Ä–æ–µ–∫—Ç—ã</p>
          <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</h1>
          <p class="muted" style="margin: 0">–°–æ–∑–¥–∞–Ω–∏–µ, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>
        </div>
      </div>

    <div class="card filters-card">
      <h2 style="margin: 0">–§–∏–ª—å—Ç—Ä—ã</h2>
      <div class="filters-grid">
        <label class="form-field">
          –§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É
          <input id="brandFilter" placeholder="Haier" />
        </label>
        <label class="form-field">
          –§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ
          <select id="groupFilter"></select>
        </label>
        <label class="form-field">
          –¢–µ–∫—É—â–∏–π GTM-—ç—Ç–∞–ø
          <select id="stageFilter"></select>
        </label>
        <label class="form-field">
          –ü–ª–∞–Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫ c
          <input type="date" id="plannedFrom" />
        </label>
        <label class="form-field">
          –ü–ª–∞–Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø–æ
          <input type="date" id="plannedTo" />
        </label>
        <div class="form-field status-field">
          <span>–°—Ç–∞—Ç—É—Å—ã</span>
          <div class="checkbox-list status-row">
            <label class="checkbox"><input type="checkbox" value="active" class="status-filter" /> <span>–ê–∫—Ç–∏–≤–Ω—ã–µ</span></label>
            <label class="checkbox"><input type="checkbox" value="closed" class="status-filter" /> <span>–ó–∞–∫—Ä—ã—Ç—ã–µ</span></label>
            <label class="checkbox"><input type="checkbox" value="archived" class="status-filter" /> <span>–ê—Ä—Ö–∏–≤</span></label>
            <label class="checkbox"><input type="checkbox" id="showArchived" /> <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤</span></label>
          </div>
        </div>
      </div>
    <div class="filter-actions">
      <div class="filter-trigger">
        <button id="openCustomFilters" class="ghost">–§–∏–ª—å—Ç—Ä—ã</button>
        <span id="customFiltersBadge" class="badge-dot" hidden>0</span>
      </div>
      <div class="filter-buttons">
        <button id="applyFilters" class="primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        <button id="resetFilters" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>
    </div>
    </div>
    </div>
    </div>

    <div class="toolbar" style="margin-top: 0">
      <button id="toggleView">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü–µ–π</button>
      <button id="newProject" class="primary">+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
      <button id="exportProjects">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>

    <div id="summary" class="card" style="margin-bottom: 12px"></div>

    <div id="cardView" class="projects-grid"></div>
    <div id="loadMoreRow" class="load-more-row">
      <button id="loadMoreProjects" class="ghost">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
    </div>

    <div id="tableView" class="card table-scroll" style="display: none">
      <table>
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–ì—Ä—É–ø–ø–∞</th>
            <th>–ë—Ä–µ–Ω–¥</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>GTM-—ç—Ç–∞–ø</th>
            <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</th>
            <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="projectRows"></tbody>
      </table>
    </div>

    <div id="detailsOverlay" class="overlay" hidden>
      <div class="overlay-backdrop" aria-hidden="true"></div>
      <div class="overlay-card">
        <button class="ghost overlay-close" id="closeDetails" aria-label="–ó–∞–∫—Ä—ã—Ç—å –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">‚úï</button>
        <h3 style="margin: 0 0 10px">–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–µ–∫—Ç–∞</h3>
        <div class="detail-panel" id="detailContent"></div>
      </div>
    </div>

    <div id="customFilterPanel" class="filter-panel" hidden>
      <div class="backdrop" aria-hidden="true"></div>
      <div class="filter-card">
        <header>
          <div>
            <p class="pill" style="margin: 0 0 4px">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</p>
            <strong>–§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø–æ–ª—è–º</strong>
          </div>
          <button id="closeCustomFilters" class="ghost" aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">‚úï</button>
        </header>
        <div class="body" id="customFilterFields"></div>
        <div class="footer">
          <button id="resetCustomFilters" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button id="applyCustomFilters" class="primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <dialog id="projectDialog" class="form-dialog">
      <div class="dialog-body large-form">
        <div class="flex space-between" style="align-items: start">
          <div>
            <h3 id="dialogTitle" style="margin: 0"></h3>
            <p class="muted" style="margin: 4px 0 0">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –ø—Ä–æ–µ–∫—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∏ –ø–µ—Ä–∏–æ–¥ –∑–∞–ø—É—Å–∫–∞.</p>
          </div>
          <button id="closeDialog" class="ghost">‚úï</button>
        </div>
        <form id="projectForm" class="detail-panel">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ <input name="name" required /></label>
          <label>
            –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
            <select name="group_id" required id="groupSelect"></select>
          </label>
          <div class="row">
            <label>–ë—Ä–µ–Ω–¥ <input name="brand" required placeholder="Haier" /></label>
            <label>–†—ã–Ω–æ–∫/—Ä–µ–≥–∏–æ–Ω <input name="market" placeholder="EU" /></label>
          </div>
          <label>
            –°—Ç–∞—Ç—É—Å
            <select name="status">
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
              <option value="closed">–ó–∞–∫—Ä—ã—Ç</option>
              <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω</option>
            </select>
          </label>
          <div class="row">
            <label>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞ <input type="date" name="planned_launch" /></label>
            <label>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞ <input type="date" name="actual_launch" /></label>
            <label>
              –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
              <select name="priority">
                <option value="">–ù–µ –∑–∞–¥–∞–Ω</option>
                <option value="low">–ù–∏–∑–∫–∏–π</option>
                <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              </select>
            </label>
          </div>
          <div class="row">
            <label>MOQ <input type="number" step="0.01" name="moq" /></label>
            <label>Promo (Price) <input type="number" step="0.01" name="promo_price" /></label>
            <label>RRP (Price) <input type="number" step="0.01" name="rrp_price" /></label>
            <label>FOB —Ü–µ–Ω–∞ <input type="number" step="0.01" name="fob_price" /></label>
          </div>
          <label>
            –¢–µ–∫—É—â–∏–π GTM-—ç—Ç–∞–ø (–ø–æ id —ç—Ç–∞–ø–∞)
            <input name="current_gtm_stage_id" placeholder="–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ç–∞–ø–æ–≤" />
          </label>
          <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ <textarea name="short_description" rows="2"></textarea></label>
          <label>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ <textarea name="full_description" rows="4"></textarea></label>
          <div>
            <div class="flex space-between" style="margin-bottom: 6px">
              <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</span>
              <button id="addCustomField" class="ghost" type="button">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
            </div>
            <div id="customFields"></div>
          </div>
          <div class="flex" style="justify-content: flex-end; margin-top: 8px">
            <button type="button" id="cancelDialog" class="ghost">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </dialog>

    <div id="contextMenu" class="context-menu" hidden>
      <ul id="contextMenuList"></ul>
    </div>

    <script src="/theme.js" defer></script>
    <script>
      const brandFilter = document.getElementById("brandFilter");
      const groupFilter = document.getElementById("groupFilter");
      const stageFilter = document.getElementById("stageFilter");
      const statusCheckboxes = document.querySelectorAll(".status-filter");
      const plannedFrom = document.getElementById("plannedFrom");
      const plannedTo = document.getElementById("plannedTo");
      const showArchived = document.getElementById("showArchived");
      const applyFilters = document.getElementById("applyFilters");
      const resetFilters = document.getElementById("resetFilters");
      const toggleViewBtn = document.getElementById("toggleView");
      const newProjectBtn = document.getElementById("newProject");
      const exportProjectsBtn = document.getElementById("exportProjects");
      const summary = document.getElementById("summary");
      const cardView = document.getElementById("cardView");
      const loadMoreRow = document.getElementById("loadMoreRow");
      const loadMoreBtn = document.getElementById("loadMoreProjects");
      const tableView = document.getElementById("tableView");
      const projectRows = document.getElementById("projectRows");
      const detailOverlay = document.getElementById("detailsOverlay");
      const detailContent = document.getElementById("detailContent");
      const closeDetailsBtn = document.getElementById("closeDetails");
      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");
      const openCustomFiltersBtn = document.getElementById("openCustomFilters");
      const closeCustomFiltersBtn = document.getElementById("closeCustomFilters");
      const applyCustomFiltersBtn = document.getElementById("applyCustomFilters");
      const resetCustomFiltersBtn = document.getElementById("resetCustomFilters");
      const customFilterPanel = document.getElementById("customFilterPanel");
      const customFilterFields = document.getElementById("customFilterFields");
      const customFiltersBadge = document.getElementById("customFiltersBadge");
      const filterStorageKey = "hpt-projects-filters";

      const dialog = document.getElementById("projectDialog");
      const dialogTitle = document.getElementById("dialogTitle");
      const projectForm = document.getElementById("projectForm");
      const closeDialogBtn = document.getElementById("closeDialog");
      const cancelDialogBtn = document.getElementById("cancelDialog");
      const customFields = document.getElementById("customFields");
      const addCustomFieldBtn = document.getElementById("addCustomField");
      const groupSelect = document.getElementById("groupSelect");

      const statusLabels = {
        active: "–ê–∫—Ç–∏–≤–Ω—ã–π",
        closed: "–ó–∞–∫—Ä—ã—Ç",
        archived: "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω",
      };

      const priorityLabels = {
        low: "–ù–∏–∑–∫–∏–π",
        medium: "–°—Ä–µ–¥–Ω–∏–π",
        high: "–í—ã—Å–æ–∫–∏–π",
      };

      const coverPlaceholder =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
          `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200' fill='none'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%2310a37f'/><stop offset='1' stop-color='%2319b88f'/></linearGradient></defs><rect width='200' height='200' rx='20' fill='%23101827'/><rect x='16' y='16' width='168' height='168' rx='18' fill='%230d1521' stroke='url(%23g)' stroke-width='4'/><text x='100' y='110' fill='%2319b88f' font-family='Inter,Segoe UI,Arial' font-size='44' font-weight='800' text-anchor='middle'>HPT</text></svg>`
        );

      let viewMode = "cards";
      let projects = [];
      let groups = [];
      let selectedProjectId = null;
      const urlParams = new URLSearchParams(window.location.search);
      const initialGroupId = urlParams.get("group_id");
      let stageOptions = [];
      const PAGE_SIZE = 30;
      let visibleProjects = PAGE_SIZE;
      let projectFilterMeta = [];
      let customFieldFilters = [];

      closeDetailsBtn.addEventListener("click", (e) => {
        e.preventDefault();
        closeDetails();
      });

      detailOverlay.addEventListener("click", (e) => {
        if (e.target.classList.contains("overlay-backdrop")) {
          closeDetails();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeDetails();
        }
      });

      function resetFiltersState() {
        brandFilter.value = "";
        groupFilter.value = "";
        stageFilter.value = "";
        plannedFrom.value = "";
        plannedTo.value = "";
        showArchived.checked = false;
        statusCheckboxes.forEach((cb) => (cb.checked = false));
        customFieldFilters = [];
        updateCustomFiltersBadge();
      }

      function persistFilters() {
        const state = {
          brand: brandFilter.value.trim(),
          groupId: groupFilter.value,
          stageId: stageFilter.value,
          plannedFrom: plannedFrom.value,
          plannedTo: plannedTo.value,
          includeArchived: showArchived.checked,
          statuses: Array.from(statusCheckboxes)
            .filter((cb) => cb.checked)
            .map((cb) => cb.value),
          viewMode,
          customFilters: customFieldFilters,
        };
        localStorage.setItem(filterStorageKey, JSON.stringify(state));
      }

      function restoreFilters() {
        const raw = localStorage.getItem(filterStorageKey);
        if (!raw) return;
        try {
          const state = JSON.parse(raw) || {};
          brandFilter.value = state.brand || "";
          groupFilter.value = state.groupId || "";
          stageFilter.value = state.stageId || "";
          plannedFrom.value = state.plannedFrom || "";
          plannedTo.value = state.plannedTo || "";
          showArchived.checked = !!state.includeArchived;
          statusCheckboxes.forEach((cb) => {
            cb.checked = Array.isArray(state.statuses) ? state.statuses.includes(cb.value) : false;
          });
          applyViewMode(state.viewMode === "table" ? "table" : "cards");
          if (Array.isArray(state.customFilters)) {
            customFieldFilters = state.customFilters;
            updateCustomFiltersBadge();
          }
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–æ–≤", e);
          localStorage.removeItem(filterStorageKey);
        }
      }

      function updateCustomFiltersBadge() {
        const count = customFieldFilters.length;
        if (count > 0) {
          customFiltersBadge.hidden = false;
          customFiltersBadge.textContent = count;
        } else {
          customFiltersBadge.hidden = true;
        }
      }

      async function loadProjectFilterMeta(force = false) {
        if (projectFilterMeta.length && !force) return;
        const res = await fetch("/api/projects/custom-fields/filters");
        if (!res.ok) {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è");
        }
        projectFilterMeta = await res.json();
        customFieldFilters = customFieldFilters.filter((f) =>
          projectFilterMeta.some((m) => m.field_id === f.field_id)
        );
        updateCustomFiltersBadge();
      }

      function renderCustomFilterFields() {
        customFilterFields.innerHTML = "";
        projectFilterMeta.forEach((meta) => {
          const container = document.createElement("div");
          container.className = "filter-field";
          container.dataset.fieldId = meta.field_id;
          const preset = customFieldFilters.find((f) => f.field_id === meta.field_id) || {};
          const label = document.createElement("label");
          label.textContent = meta.label_ru || meta.field_id;
          container.appendChild(label);

          if (meta.type === "number") {
            const row = document.createElement("div");
            row.className = "row";
            const from = document.createElement("input");
            from.type = "number";
            from.className = "inline-input";
            from.placeholder = "–û—Ç";
            from.value = preset.value_from ?? "";
            const to = document.createElement("input");
            to.type = "number";
            to.className = "inline-input";
            to.placeholder = "–î–æ";
            to.value = preset.value_to ?? "";
            row.append(from, to);
            container.appendChild(row);
          } else if (meta.type === "select" || meta.type === "enum") {
            const select = document.createElement("select");
            select.multiple = true;
            select.size = Math.min(6, (meta.options || []).length || 4);
            select.className = "inline-input";
            (meta.options || []).forEach((opt) => {
              const option = document.createElement("option");
              option.value = opt.value;
              option.textContent = `${opt.value} (${opt.count})`;
              if ((preset.values || []).includes(opt.value)) option.selected = true;
              select.appendChild(option);
            });
            container.appendChild(select);
          } else if (meta.type === "checkbox" || meta.type === "boolean") {
            const select = document.createElement("select");
            select.className = "inline-input";
            [
              { value: "", label: "–õ—é–±–æ–µ" },
              { value: "true", label: "–î–∞" },
              { value: "false", label: "–ù–µ—Ç" },
            ].forEach((opt) => {
              const option = document.createElement("option");
              option.value = opt.value;
              option.textContent = opt.label;
              if (
                (preset.bool === true && opt.value === "true") ||
                (preset.bool === false && opt.value === "false") ||
                (preset.bool === undefined && opt.value === "")
              ) {
                option.selected = true;
              }
              select.appendChild(option);
            });
            container.appendChild(select);
          } else if (meta.type === "date") {
            const row = document.createElement("div");
            row.className = "row";
            const from = document.createElement("input");
            from.type = "date";
            from.className = "inline-input";
            from.placeholder = "–û—Ç";
            from.value = preset.date_from ?? "";
            const to = document.createElement("input");
            to.type = "date";
            to.className = "inline-input";
            to.placeholder = "–î–æ";
            to.value = preset.date_to ?? "";
            row.append(from, to);
            container.appendChild(row);
          } else {
            const input = document.createElement("input");
            input.className = "inline-input";
            input.placeholder = "–°–æ–¥–µ—Ä–∂–∏—Ç‚Ä¶";
            input.value = preset.value || "";
            container.appendChild(input);
          }

          customFilterFields.appendChild(container);
        });
      }

      function collectCustomFiltersFromUi() {
        const filters = [];
        projectFilterMeta.forEach((meta) => {
          const block = customFilterFields.querySelector(`[data-field-id="${meta.field_id}"]`);
          if (!block) return;
          if (meta.type === "number") {
            const [from, to] = block.querySelectorAll("input");
            const value_from = from.value ? Number(from.value) : null;
            const value_to = to.value ? Number(to.value) : null;
            if (value_from !== null || value_to !== null) {
              filters.push({ field_id: meta.field_id, type: "number", value_from, value_to });
            }
          } else if (meta.type === "select" || meta.type === "enum") {
            const select = block.querySelector("select");
            const values = Array.from(select.selectedOptions).map((o) => o.value);
            if (values.length) {
              filters.push({ field_id: meta.field_id, type: "select", values });
            }
          } else if (meta.type === "checkbox" || meta.type === "boolean") {
            const select = block.querySelector("select");
            if (select.value === "true") {
              filters.push({ field_id: meta.field_id, type: "checkbox", bool: true });
            } else if (select.value === "false") {
              filters.push({ field_id: meta.field_id, type: "checkbox", bool: false });
            }
          } else if (meta.type === "date") {
            const [from, to] = block.querySelectorAll("input");
            const date_from = from.value || null;
            const date_to = to.value || null;
            if (date_from || date_to) {
              filters.push({ field_id: meta.field_id, type: "date", date_from, date_to });
            }
          } else {
            const input = block.querySelector("input");
            if (input.value.trim()) {
              filters.push({ field_id: meta.field_id, type: "text", value: input.value.trim() });
            }
          }
        });
        return filters;
      }

      async function openCustomFilters() {
        try {
          await loadProjectFilterMeta();
          renderCustomFilterFields();
          customFilterPanel.hidden = false;
        } catch (err) {
          alert(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã");
        }
      }

      function closeCustomFilters() {
        customFilterPanel.hidden = true;
      }

      function formatDate(val) {
        return val ? new Date(val).toLocaleDateString("ru-RU") : "‚Äî";
      }

      function getGroupName(id) {
        const group = groups.find((g) => g.id === id);
        return group ? group.name : "";
      }

      function currentStageName(project) {
        if (!project.current_gtm_stage_id) return "‚Äî";
        const stage = project.gtm_stages.find((s) => s.id === project.current_gtm_stage_id);
        return stage ? stage.title || stage.name || "‚Äî" : "‚Äî";
      }

      function renderSummary() {
        const active = projects.filter((p) => p.status === "active").length;
        const closed = projects.filter((p) => p.status === "closed").length;
        const archived = projects.filter((p) => p.status === "archived").length;
        summary.innerHTML = `
          <div class="flex" style="gap: 12px; align-items: center">
            <strong>–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤:</strong> ${projects.length}
            <span class="chip">–ê–∫—Ç–∏–≤–Ω—ã–µ: ${active}</span>
            <span class="chip">–ó–∞–∫—Ä—ã—Ç—ã–µ: ${closed}</span>
            <span class="chip">–ê—Ä—Ö–∏–≤: ${archived}</span>
          </div>
        `;
      }

      function projectCoverUrl(project) {
        const images = project.images || [];
        const cover = images.find((i) => i.is_cover) || images[0];
        return cover ? `/api/projects/${project.id}/images/${cover.id}/download` : null;
      }

      function taskProgress(task) {
        const subtasks = task.subtasks || [];
        if (subtasks.length) {
          const done = subtasks.filter((s) => s.done).length;
          return subtasks.length ? done / subtasks.length : 0;
        }
        if (task.status === "done") return 1;
        if (task.status === "in_progress") return 0.5;
        return 0;
      }

      function stageProgress(project, stage) {
        const relatedTasks = (project.tasks || []).filter((t) => t.gtm_stage_id === stage.id);
        if (!relatedTasks.length) {
          if (stage.status === "done") return 1;
          if (stage.status === "in_progress") return 0.5;
          return 0;
        }
        const sum = relatedTasks.reduce((acc, task) => acc + taskProgress(task), 0);
        return sum / relatedTasks.length;
      }

      function projectProgress(project) {
        const stages = project.gtm_stages || [];
        if (!stages.length) return { percent: 0, label: "–ù–µ—Ç —ç—Ç–∞–ø–æ–≤" };
        const scores = stages.map((stage) => stageProgress(project, stage));
        const percent = Math.round((scores.reduce((a, b) => a + b, 0) / stages.length) * 100);
        const completed = Math.round(scores.filter((s) => s >= 0.999).length);
        return { percent, label: `${completed}/${stages.length} –∑–∞–≤–µ—Ä—à–µ–Ω–æ` };
      }

      function updateLoadMoreState() {
        const hasMore = projects.length > visibleProjects;
        if (viewMode === "cards" && hasMore) {
          loadMoreRow.style.display = "flex";
          loadMoreBtn.disabled = false;
        } else {
          loadMoreRow.style.display = "none";
          loadMoreBtn.disabled = true;
        }
      }

      function renderCardView() {
        cardView.innerHTML = "";
        const pagedProjects = projects.slice(0, visibleProjects);
        pagedProjects.forEach((project) => {
          const card = document.createElement("div");
          card.className = "card project-card";
          card.dataset.id = project.id;
          const cover = projectCoverUrl(project);
          const progress = projectProgress(project);
          card.innerHTML = `
            <div>
              <img class="card-image" src="${cover || coverPlaceholder}" alt="–û–±–ª–æ–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞" />
            </div>
            <div class="flex" style="gap: 8px; flex-direction: column; align-items: flex-start;">
              <div class="flex space-between" style="width: 100%; align-items: start">
                <div>
                  <h3 style="margin: 0">${project.name}</h3>
                  <p class="muted" style="margin: 2px 0 0">${getGroupName(project.group_id)} ¬∑ ${project.brand}</p>
                </div>
                <span class="badge ${project.status === "archived" ? "archived" : project.status === "closed" ? "closed" : ""}">${statusLabels[project.status] || project.status}</span>
              </div>
              <div class="flex" style="gap: 8px; flex-wrap: wrap; width: 100%">
                <span class="chip">–†—ã–Ω–æ–∫: ${project.market || "‚Äî"}</span>
                <span class="chip">GTM: ${currentStageName(project)}</span>
                <span class="chip">–ü–ª–∞–Ω: ${formatDate(project.planned_launch)}</span>
                <span class="chip">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${project.priority ? priorityLabels[project.priority] : "‚Äî"}</span>
              </div>
              <div style="width: 100%">
                <div class="progress-bar"><div class="progress-fill" style="width:${progress.percent}%"></div></div>
                <small class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress.label}</small>
              </div>
              <p class="muted" style="margin: 0">${project.short_description || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</p>
              <div class="flex space-between" style="align-items: center; width: 100%">
                <small class="muted">–°–æ–∑–¥–∞–Ω–æ: ${formatDate(project.created_at)}</small>
                <div class="flex" style="gap: 8px">
                  <button class="ghost" data-action="open-project">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ–µ–∫—Ç</button>
                  <button class="ghost" data-action="open">–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                </div>
              </div>
            </div>
          `;
          card.addEventListener("click", () => (window.location.href = `/project.html?id=${project.id}`));
          card.addEventListener("contextmenu", (e) => openContextMenu(e, project));
          card.querySelector("button[data-action='open']").addEventListener("click", (e) => {
            e.stopPropagation();
            openDetails(project.id);
          });
          card.querySelector("button[data-action='open-project']").addEventListener("click", (e) => {
            e.stopPropagation();
            window.location.href = `/project.html?id=${project.id}`;
          });
          cardView.appendChild(card);
        });
        updateLoadMoreState();
      }

      function renderTableView() {
        projectRows.innerHTML = "";
        projects.forEach((project) => {
          const tr = document.createElement("tr");
          tr.dataset.id = project.id;
          if (project.status === "archived") tr.classList.add("archived");
          tr.innerHTML = `
            <td>${project.name}</td>
            <td>${getGroupName(project.group_id)}</td>
            <td>${project.brand}</td>
            <td>${statusLabels[project.status] || project.status}</td>
            <td>${currentStageName(project)}</td>
            <td>${formatDate(project.planned_launch)}</td>
            <td>${project.priority ? priorityLabels[project.priority] : "‚Äî"}</td>
            <td>
              <div class="table-actions">
                <button data-action="open">–û—Ç–∫—Ä—ã—Ç—å</button>
                <button data-action="preview">–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</button>
              </div>
            </td>
          `;
          tr.addEventListener("click", () => openDetails(project.id));
          tr.querySelector("button[data-action='open']").addEventListener("click", (e) => {
            e.stopPropagation();
            window.location.href = `/project.html?id=${project.id}`;
          });
          tr.querySelector("button[data-action='preview']").addEventListener("click", (e) => {
            e.stopPropagation();
            openDetails(project.id);
          });
          tr.addEventListener("contextmenu", (e) => openContextMenu(e, project));
          projectRows.appendChild(tr);
        });
      }

      function renderStageFilter() {
        const currentValue = stageFilter.value;
        stageOptions = [];
        const stageMap = new Map();
        projects.forEach((p) => {
          p.gtm_stages.forEach((s) => {
            if (!stageMap.has(s.id)) stageMap.set(s.id, s.title || s.name);
          });
        });
        stageOptions = Array.from(stageMap.entries());
        stageFilter.innerHTML = '<option value="">–í—Å–µ —ç—Ç–∞–ø—ã</option>' +
          stageOptions.map(([id, name]) => `<option value="${id}">${name}</option>`).join("");
        if (currentValue) stageFilter.value = currentValue;
      }

      function openDetails(id) {
        selectedProjectId = id;
        const project = projects.find((p) => p.id === id);
        if (!project) return;
        detailOverlay.classList.add("active");
        const customFieldsBlock = Object.entries(project.custom_fields || {})
          .map(([k, v]) => `<span class="chip">${k}: ${v ?? "‚Äî"}</span>`)
          .join(" ");
        detailContent.innerHTML = `
          <div class="flex space-between" style="align-items: start">
            <div>
              <h2 style="margin: 0">${project.name}</h2>
              <p class="muted" style="margin: 2px 0 0">${getGroupName(project.group_id)} ¬∑ ${project.brand}</p>
            </div>
            <span class="badge ${project.status === "archived" ? "archived" : project.status === "closed" ? "closed" : ""}">${statusLabels[project.status] || project.status}</span>
          </div>
          <div class="row">
            <div class="card" style="padding: 12px">
              <strong>GTM-—ç—Ç–∞–ø</strong>
              <div>${currentStageName(project)}</div>
            </div>
            <div class="card" style="padding: 12px">
              <strong>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</strong>
              <div>${formatDate(project.planned_launch)}</div>
            </div>
            <div class="card" style="padding: 12px">
              <strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞</strong>
              <div>${formatDate(project.actual_launch)}</div>
            </div>
            <div class="card" style="padding: 12px">
              <strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</strong>
              <div>${project.priority ? priorityLabels[project.priority] : "‚Äî"}</div>
            </div>
            <div class="card" style="padding: 12px">
              <strong>MOQ</strong>
              <div>${project.moq ?? "‚Äî"}</div>
            </div>
            <div class="card" style="padding: 12px">
              <strong>Promo (Price)</strong>
              <div>${project.promo_price ?? "‚Äî"}</div>
            </div>
            <div class="card" style="padding: 12px">
              <strong>RRP (Price)</strong>
              <div>${project.rrp_price ?? "‚Äî"}</div>
            </div>
            <div class="card" style="padding: 12px">
              <strong>FOB —Ü–µ–Ω–∞</strong>
              <div>${project.fob_price ?? "‚Äî"}</div>
            </div>
          </div>
          <div class="card" style="padding: 12px">
            <strong>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</strong>
            <div class="muted">${project.short_description || "‚Äî"}</div>
          </div>
          <div class="card" style="padding: 12px">
            <strong>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</strong>
            <div class="muted">${project.full_description || "‚Äî"}</div>
          </div>
          ${customFieldsBlock ? `<div class="card" style="padding: 12px"><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</strong><div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 8px">${customFieldsBlock}</div></div>` : ""}
          <div class="flex" style="gap: 10px; margin-top: 8px">
            <button class="ghost" onclick="openEdit('${project.id}')">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            ${project.status === "archived" ? `<button class="ghost" onclick="restoreProject('${project.id}')">‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>` : `<button class="ghost" onclick="archiveProject('${project.id}')">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`}
            <button class="ghost" onclick="deleteProject('${project.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
      }

      function closeDetails() {
        detailOverlay.classList.remove("active");
      }

      function addCustomFieldRow(key = "", value = "") {
        const row = document.createElement("div");
        row.className = "flex";
        row.style.gap = "8px";
        row.innerHTML = `
          <input placeholder="–ö–ª—é—á" value="${key}" />
          <input placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="${value}" />
          <button type="button" class="ghost">‚úï</button>
        `;
        row.querySelector("button").addEventListener("click", () => row.remove());
        customFields.appendChild(row);
      }

      function openCreate() {
        dialogTitle.textContent = "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç";
        projectForm.dataset.mode = "create";
        projectForm.dataset.id = "";
        projectForm.reset();
        projectForm.group_id.value = groupFilter.value || "";
        projectForm.status.value = "active";
        projectForm.moq.value = "";
        projectForm.promo_price.value = "";
        projectForm.rrp_price.value = "";
        projectForm.fob_price.value = "";
        customFields.innerHTML = "";
        dialog.showModal();
      }

      function openEdit(id) {
        const project = projects.find((p) => p.id === id);
        if (!project) return;
        dialogTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞";
        projectForm.dataset.mode = "edit";
        projectForm.dataset.id = id;
        projectForm.name.value = project.name;
        projectForm.group_id.value = project.group_id;
        projectForm.brand.value = project.brand;
        projectForm.market.value = project.market || "";
        projectForm.status.value = project.status;
        projectForm.planned_launch.value = project.planned_launch || "";
        projectForm.actual_launch.value = project.actual_launch || "";
        projectForm.priority.value = project.priority || "";
        projectForm.current_gtm_stage_id.value = project.current_gtm_stage_id || "";
        projectForm.short_description.value = project.short_description || "";
        projectForm.full_description.value = project.full_description || "";
        projectForm.moq.value = project.moq ?? "";
        projectForm.promo_price.value = project.promo_price ?? "";
        projectForm.rrp_price.value = project.rrp_price ?? "";
        projectForm.fob_price.value = project.fob_price ?? "";
        customFields.innerHTML = "";
        Object.entries(project.custom_fields || {}).forEach(([k, v]) => addCustomFieldRow(k, v ?? ""));
        dialog.showModal();
      }

      async function submitForm(event) {
        event.preventDefault();
        const formData = new FormData(projectForm);
        const payload = Object.fromEntries(formData.entries());
        payload.custom_fields = {};
        Array.from(customFields.children).forEach((row) => {
          const [keyInput, valueInput] = row.querySelectorAll("input");
          if (keyInput.value.trim()) {
            payload.custom_fields[keyInput.value.trim()] = valueInput.value || null;
          }
        });
        payload.planned_launch = payload.planned_launch || null;
        payload.actual_launch = payload.actual_launch || null;
        payload.current_gtm_stage_id = payload.current_gtm_stage_id || null;
        payload.priority = payload.priority || null;
        payload.moq = payload.moq ? Number(payload.moq) : null;
        payload.promo_price = payload.promo_price ? Number(payload.promo_price) : null;
        payload.rrp_price = payload.rrp_price ? Number(payload.rrp_price) : null;
        payload.fob_price = payload.fob_price ? Number(payload.fob_price) : null;

        const mode = projectForm.dataset.mode;
        if (mode === "create") {
          payload.gtm_stages = [];
          payload.tasks = [];
          payload.characteristics = [];
          payload.files = [];
          payload.images = [];
          payload.comments = [];
          payload.history = [];
          const res = await fetch("/api/projects", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç");
            return;
          }
          const created = await res.json();
          const projectId = created?.id || created?.project_id || created?.project?.id || null;
          if (!projectId) {
            alert("–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É. –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω.");
            dialog.close();
            await loadProjects();
            return;
          }
          window.location.href = `/project.html?id=${encodeURIComponent(projectId)}`;
          return;
        } else {
          const existing = projects.find((p) => p.id === projectForm.dataset.id);
          if (!existing) return;
          const updated = { ...existing, ...payload };
          const res = await fetch(`/api/projects/${existing.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç");
            return;
          }
        }
        dialog.close();
        await loadProjects();
      }

      function applyViewMode(mode) {
        viewMode = mode;
        if (viewMode === "cards") {
          cardView.style.display = "grid";
          tableView.style.display = "none";
          toggleViewBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü–µ–π";
        } else {
          cardView.style.display = "none";
          tableView.style.display = "block";
          toggleViewBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∏—Ç–∫–æ–π";
        }
        updateLoadMoreState();
      }

      function toggleView() {
        applyViewMode(viewMode === "cards" ? "table" : "cards");
        persistFilters();
      }

      function buildStatusParams(params) {
        statusCheckboxes.forEach((cb) => {
          if (cb.checked) params.append("status", cb.value);
        });
      }

      async function loadProjects() {
        await loadProjectFilterMeta();
        const payload = {
          include_archived: showArchived.checked,
          brand: brandFilter.value.trim() || null,
          group_id: groupFilter.value || null,
          current_stage_id: stageFilter.value || null,
          planned_from: plannedFrom.value || null,
          planned_to: plannedTo.value || null,
          statuses: Array.from(statusCheckboxes)
            .filter((cb) => cb.checked)
            .map((cb) => cb.value),
          filters: customFieldFilters,
        };
        const res = await fetch(`/api/projects/search`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã");
          return;
        }
        projects = await res.json();
        visibleProjects = PAGE_SIZE;
        renderStageFilter();
        renderSummary();
        renderCardView();
        renderTableView();
        if (selectedProjectId) openDetails(selectedProjectId);
      }

      async function loadGroups() {
        const res = await fetch("/api/groups?include_archived=true");
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã");
          return;
        }
        groups = await res.json();
        groupFilter.innerHTML =
          '<option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>' + groups.map((g) => `<option value="${g.id}">${g.name}</option>`).join("");
        groupSelect.innerHTML = groups.map((g) => `<option value="${g.id}">${g.name}</option>`).join("");
        restoreFilters();
        if (!groupFilter.value && initialGroupId) {
          groupFilter.value = initialGroupId;
        }
      }

      function closeContextMenu() {
        contextMenu.hidden = true;
      }

      function openContextMenu(event, project) {
        event.preventDefault();
        closeContextMenu();
        contextMenu.style.top = `${event.clientY}px`;
        contextMenu.style.left = `${event.clientX}px`;
        contextMenu.hidden = false;
        contextMenuList.innerHTML = "";
        const actions = [
          { label: "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É", fn: () => (window.location.href = `/project.html?id=${project.id}`) },
          { label: "–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä", fn: () => openDetails(project.id) },
          { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", fn: () => openEdit(project.id) },
          project.status === "archived"
            ? { label: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", fn: () => restoreProject(project.id) }
            : { label: "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å", fn: () => archiveProject(project.id) },
          project.status !== "closed"
            ? { label: "–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç", fn: () => changeStatus(project.id, "closed") }
            : { label: "–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º", fn: () => changeStatus(project.id, "active") },
          { label: "–£–¥–∞–ª–∏—Ç—å", fn: () => deleteProject(project.id) },
        ];
        actions.forEach((action) => {
          const li = document.createElement("li");
          li.textContent = action.label;
          li.addEventListener("click", () => {
            action.fn();
            closeContextMenu();
          });
          contextMenuList.appendChild(li);
        });
      }

      async function changeStatus(id, status) {
        const project = projects.find((p) => p.id === id);
        if (!project) return;
        const updated = { ...project, status };
        const res = await fetch(`/api/projects/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updated),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞");
          return;
        }
        await loadProjects();
      }

      async function archiveProject(id) {
        await changeStatus(id, "archived");
      }

      async function restoreProject(id) {
        await changeStatus(id, "closed");
      }

      async function deleteProject(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç? –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã, –∑–∞–¥–∞—á–∏ –∏ –≤–ª–æ–∂–µ–Ω–∏—è.")) return;
        const res = await fetch(`/api/projects/${id}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç");
          return;
        }
          selectedProjectId = null;
          closeDetails();
          await loadProjects();
        }

      function initContextMenuClosing() {
        document.addEventListener("click", (e) => {
          if (!contextMenu.contains(e.target)) closeContextMenu();
        });
        window.addEventListener("scroll", closeContextMenu);
      }

      async function exportProjects() {
        const params = new URLSearchParams();
        params.set("include_archived", showArchived.checked);
        if (brandFilter.value) params.set("brand", brandFilter.value.trim());
        if (groupFilter.value) params.set("group_id", groupFilter.value);
        if (stageFilter.value) params.set("current_stage_id", stageFilter.value);
        if (plannedFrom.value) params.set("planned_from", plannedFrom.value);
        if (plannedTo.value) params.set("planned_to", plannedTo.value);
        buildStatusParams(params);
        window.location.href = `/api/export/projects?${params.toString()}`;
      }

      applyFilters.addEventListener("click", () => {
        persistFilters();
        loadProjects();
      });
      resetFilters.addEventListener("click", () => {
        resetFiltersState();
        applyViewMode("cards");
        localStorage.removeItem(filterStorageKey);
        loadProjects();
      });
      openCustomFiltersBtn.addEventListener("click", openCustomFilters);
      closeCustomFiltersBtn.addEventListener("click", closeCustomFilters);
      customFilterPanel.querySelector(".backdrop").addEventListener("click", closeCustomFilters);
      applyCustomFiltersBtn.addEventListener("click", () => {
        customFieldFilters = collectCustomFiltersFromUi();
        updateCustomFiltersBadge();
        persistFilters();
        closeCustomFilters();
        loadProjects();
      });
      resetCustomFiltersBtn.addEventListener("click", () => {
        customFieldFilters = [];
        renderCustomFilterFields();
        updateCustomFiltersBadge();
        persistFilters();
      });
      toggleViewBtn.addEventListener("click", toggleView);
      newProjectBtn.addEventListener("click", openCreate);
      exportProjectsBtn.addEventListener("click", exportProjects);
      projectForm.addEventListener("submit", submitForm);
      addCustomFieldBtn.addEventListener("click", () => addCustomFieldRow());
      loadMoreBtn.addEventListener("click", () => {
        visibleProjects = Math.min(visibleProjects + PAGE_SIZE, projects.length);
        renderCardView();
      });
      closeDialogBtn.addEventListener("click", () => dialog.close());
      cancelDialogBtn.addEventListener("click", () => dialog.close());
      initContextMenuClosing();

      applyViewMode(viewMode);
      restoreFilters();
      loadGroups().then(loadProjects);
    </script>
    <footer class="site-footer">
      <small>Made by Smuk Marian / 2025</small>
    </footer>
  </body>
</html>
