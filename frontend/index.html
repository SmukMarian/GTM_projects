<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) =>
          value === "dark" || value === "light" || value === "system" ? value : null;
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Projects Tracker ‚Äî –î–∞—à–±–æ—Ä–¥</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f3f5f9;
        --bg-alt: #eef1f6;
        --surface: #ffffff;
        --surface-muted: #f7f8fc;
        --text: #0f172a;
        --muted: #475569;
        --border: #d9e0ea;
        --divider: rgba(148, 163, 184, 0.35);
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
        --warning: #fbbf24;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0e1218;
        --bg-alt: #0b1017;
        --surface: #111827;
        --surface-muted: #161f30;
        --text: #e6edf3;
        --muted: #9aa6b6;
        --border: #1f2937;
        --divider: rgba(148, 163, 184, 0.25);
        --shadow: 0 22px 50px rgba(0, 0, 0, 0.5);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
        --warning: #facc15;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        color: var(--text);
      }

      .page {
        max-width: 1240px;
        margin: 0 auto;
        padding: 32px 20px 88px;
      }

      .page > header {
        margin-bottom: 28px;
      }

      .page > :where(.card, .layout-two, #dashboardError) {
        margin-top: 20px;
      }

      .app-shell {
        max-width: 1280px;
        margin: 0 auto;
        padding: 14px 18px 0;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        position: sticky;
        top: 12px;
        z-index: 900;
      }

      .logo {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: var(--text);
        text-decoration: none;
      }

      .logo img {
        width: 36px;
        height: 36px;
      }

      nav { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

      nav a {
        padding: 8px 12px;
        border-radius: 12px;
        text-decoration: none;
        color: var(--text);
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      nav a:hover { box-shadow: var(--shadow); }

      header {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }

      h1 {
        margin: 0;
        font-size: 2rem;
        letter-spacing: -0.01em;
      }

      p.lead {
        margin: 4px 0 0;
        color: var(--muted);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 8px 14px;
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 999px;
        box-shadow: 0 1px 0 var(--divider);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.78rem;
      }

      .alert {
        margin-bottom: 16px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(239, 68, 68, 0.06));
        color: var(--danger);
        font-weight: 700;
      }

      .card {
        background: var(--surface);
        color: var(--text);
        border-radius: 16px;
        padding: 18px 18px 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }

      .card h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.15rem;
      }

      .card p {
        margin-top: 0;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 14px;
      }

      .kpi {
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .kpi:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .kpi strong {
        font-size: 1.3rem;
      }

      .muted {
        color: var(--muted);
      }

      .progress {
        margin-top: 6px;
        height: 8px;
        background: var(--surface);
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .progress span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--accent) 0%, var(--accent-strong) 100%);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 10px;
        background: var(--surface-muted);
        border: 1px solid var(--border);
        color: var(--muted);
        font-weight: 600;
      }

      .layout-two {
        display: grid;
        grid-template-columns: 1.3fr 1fr;
        gap: 18px;
      }

      @media (max-width: 960px) {
        .layout-two {
          grid-template-columns: 1fr;
        }
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .recent-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }

      @media (max-width: 900px) {
        .recent-grid {
          grid-template-columns: 1fr;
        }
      }

      .change-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px 16px;
        background: var(--surface-muted);
        min-height: 120px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .change-card header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .card-footer {
        display: flex;
        justify-content: center;
        padding-top: 14px;
      }

      .card-footer button {
        min-width: 180px;
      }

      th,
      td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      th {
        color: var(--muted);
        font-size: 0.95rem;
        letter-spacing: 0.01em;
      }

      tr:hover td {
        background: var(--surface-muted);
      }

      tr.overdue {
        background: rgba(239, 68, 68, 0.08);
      }

      tr:hover {
        background: var(--surface-muted);
      }

      .list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 10px;
      }

      .list li {
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--surface-muted);
      }

      .empty-state {
        text-align: center;
        color: var(--muted);
        padding: 10px 4px;
      }

      .group-card {
        border: 1px solid var(--border);
        padding: 14px;
        border-radius: 14px;
        background: var(--surface-muted);
        display: flex;
        flex-direction: column;
        gap: 6px;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
      }

      .group-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .risk {
        color: var(--danger);
        font-weight: 600;
      }

      .risk-block li {
        border-left: 4px solid var(--danger);
      }

      .actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .actions a,
      button,
      select,
      input {
        font: inherit;
      }

      button,
      .ghost {
        cursor: pointer;
        border-radius: 10px;
        padding: 10px 14px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
        transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        color: #fff;
        border: none;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .ghost {
        background: var(--surface-muted);
      }

      label.field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-weight: 600;
        color: var(--muted);
      }

      .checkbox {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--muted);
        flex-wrap: wrap;
      }

      .checkbox span {
        display: inline-flex;
        align-items: center;
        line-height: 1.3;
      }

      .checkbox input[type="checkbox"] {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 6px;
        border: 2px solid var(--border);
        background: var(--surface);
        position: relative;
        transition: border-color 0.2s ease, background-color 0.2s ease;
      }

      .checkbox input[type="checkbox"]:checked {
        border-color: var(--accent);
        background: var(--accent-soft);
      }

      .checkbox input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        inset: 3px 5px;
        border: solid var(--accent);
        border-width: 0 0 3px 3px;
        transform: rotate(-45deg);
      }

      select,
      input[type="text"],
      input[type="date"] {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
      }

      a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
      }

      a:hover {
        text-decoration: underline;
      }

      .context-menu {
        position: fixed;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        min-width: 220px;
        z-index: 1000;
        padding: 8px 0;
      }

      .context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu li {
        padding: 8px 16px;
      }

      .context-menu li a,
      .context-menu li button {
        color: var(--text);
        text-decoration: none;
        background: transparent;
        border: none;
        cursor: pointer;
        width: 100%;
        text-align: left;
        font: inherit;
        padding: 0;
      }

      .context-menu li:hover {
        background: var(--accent-soft);
      }

      .theme-menu {
        position: relative;
      }

      .theme-menu summary {
        list-style: none;
        display: grid;
        place-items: center;
        padding: 6px;
        min-width: 38px;
        min-height: 38px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        cursor: pointer;
        user-select: none;
      }

      .theme-menu summary::-webkit-details-marker {
        display: none;
      }

      .theme-menu[open] summary {
        box-shadow: var(--shadow);
        background: var(--surface);
      }

      .theme-menu-dropdown {
        position: absolute;
        right: 0;
        top: calc(100% + 8px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 6px;
        display: none;
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
        width: max-content;
        z-index: 950;
      }

      .theme-menu[open] .theme-menu-dropdown {
        display: flex;
      }

      .theme-menu-dropdown button {
        border: none;
        background: transparent;
        color: var(--text);
        text-align: left;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: center;
        min-width: 0;
      }

      .theme-menu-dropdown button:hover,
      .theme-menu-dropdown button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .site-footer {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 18px 48px;
        text-align: center;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div class="topbar">
        <a class="logo" href="/index.html" aria-label="Projects Tracker">
          <img src="/favicon.svg" alt="Projects Tracker" />
          <div>Projects Tracker</div>
        </a>
        <nav aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <a href="/index.html">–î–∞—à–±–æ—Ä–¥</a>
          <a href="/groups.html">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</a>
          <a href="/projects.html">–ü—Ä–æ–µ–∫—Ç—ã</a>
          <a href="/priority-tasks.html">–í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
          <a href="/templates.html">–®–∞–±–ª–æ–Ω—ã</a>
          <a href="/characteristics-board.html">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</a>
          <details class="theme-menu">
            <summary aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
              <span aria-hidden="true">üåó</span>
              <span class="theme-menu-label" data-theme-state>–¢–µ–º–∞</span>
            </summary>
            <div class="theme-menu-dropdown" role="menu" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
              <button type="button" role="menuitem" data-theme-select="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="system">üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="dark">üåô –¢—ë–º–Ω–∞—è</button>
            </div>
          </details>
        </nav>
      </div>
    </div>
    <div class="page">
      <header>
        <div>
          <div class="pill">–î–∞—à–±–æ—Ä–¥</div>
          <h1>Projects Tracker</h1>
          <p class="lead">–°–≤–æ–¥–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º, —Ä–∏—Å–∫–∞–º –∏ –±–ª–∏–∂–∞–π—à–∏–º –¥–µ–¥–ª–∞–π–Ω–∞–º</p>
        </div>
      </header>

      <div class="card" aria-label="–§–∏–ª—å—Ç—Ä—ã –¥–∞—à–±–æ—Ä–¥–∞">
        <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
        <div class="grid" style="align-items: end">
          <label class="field">
            –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
            <select id="groupFilter">
              <option value="">–í—Å–µ</option>
            </select>
          </label>
          <label class="field">
            –ë—Ä–µ–Ω–¥
            <input id="brandFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Haier" />
          </label>
          <label class="field">
            –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞
            <select id="statusFilter">
              <option value="">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
              <option value="closed">–ó–∞–∫—Ä—ã—Ç</option>
              <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω</option>
            </select>
          </label>
          <label class="checkbox">
            <input id="showArchived" type="checkbox" />
            <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã</span>
          </label>
        </div>
        <div class="actions" style="margin-top: 12px">
          <button id="applyFilters" class="primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button id="resetFilters" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
      </div>

      <div class="card priority-cta" aria-label="–°–≤–æ–¥–∫–∞ –≤–∞–∂–Ω—ã—Ö –∑–∞–¥–∞—á">
        <div class="card-header">
          <h2>–í–∞–∂–Ω—ã–µ –∏ —Å—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
          <a class="primary" href="/priority-tasks.html">–û—Ç–∫—Ä—ã—Ç—å —Å–≤–æ–¥–∫—É</a>
        </div>
        <p>
          –ë—ã—Å—Ç—Ä—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–¥–∞—á —Å –æ—Ç–º–µ—Ç–∫–∞–º–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏. –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç —Å—Ä–∞–∑—É –Ω–∞ –Ω—É–∂–Ω–æ–π –∑–∞–¥–∞—á–µ –∏
          —Å–≤–µ—Ä–∏—Ç—å—Å—è —Å–æ —Å—Ä–æ–∫–∞–º–∏.
        </p>
      </div>

      <div id="dashboardError" class="alert" hidden role="alert"></div>

      <div class="card">
        <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
        <div class="kpi-grid" id="kpiGrid"></div>
      </div>

      <div class="layout-two">
        <div class="card">
          <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –±—Ä–µ–Ω–¥–∞–º</h2>
          <div id="brandList" class="list"></div>
        </div>
        <div class="card">
          <h2>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ GTM</h2>
          <div id="gtmProgress" class="list"></div>
        </div>
      </div>

      <div class="layout-two">
        <div class="card risk-block">
          <h2>–†–∏—Å–∫–∏</h2>
          <ul id="riskList" class="list"></ul>
        </div>
        <div class="card">
          <h2>–ë–ª–∏–∂–∞–π—à–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã</h2>
          <table id="upcomingTable"></table>
        </div>
      </div>

      <div class="card">
        <h2>–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</h2>
        <div id="groupGrid" class="grid"></div>
      </div>

    </div>

    <div id="contextMenu" class="context-menu" hidden>
      <ul id="contextMenuList"></ul>
    </div>

    <script src="/theme.js" defer></script>
    <script>
      const kpiGrid = document.getElementById("kpiGrid");
      const statusList = document.getElementById("statusSummary");
      const groupGrid = document.getElementById("groupGrid");
      const upcomingTable = document.getElementById("upcomingTable");
      const groupFilter = document.getElementById("groupFilter");
      const brandFilter = document.getElementById("brandFilter");
      const statusFilter = document.getElementById("statusFilter");
      const showArchived = document.getElementById("showArchived");
      const applyFilters = document.getElementById("applyFilters");
      const resetFilters = document.getElementById("resetFilters");
      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");
      const brandList = document.getElementById("brandList");
      const gtmProgress = document.getElementById("gtmProgress");
      const riskList = document.getElementById("riskList");
      const dashboardError = document.getElementById("dashboardError");
      const filterStorageKey = "hpt-dashboard-filters";

      async function loadGroupsForFilter() {
        const res = await fetch("/api/groups?include_archived=true");
        if (!res.ok) return;
        const groups = await res.json();
        groups.forEach((g) => {
          const option = document.createElement("option");
          option.value = g.id;
          option.textContent = g.name;
          groupFilter.appendChild(option);
        });
        restoreFilters();
      }

      function persistFilters() {
        const state = {
          groupId: groupFilter.value,
          brand: brandFilter.value.trim(),
          status: statusFilter.value,
          includeArchived: showArchived.checked,
        };
        localStorage.setItem(filterStorageKey, JSON.stringify(state));
      }

      function restoreFilters() {
        const raw = localStorage.getItem(filterStorageKey);
        if (!raw) return;
        try {
          const state = JSON.parse(raw) || {};
          groupFilter.value = state.groupId || "";
          brandFilter.value = state.brand || "";
          statusFilter.value = state.status || "";
          showArchived.checked = !!state.includeArchived;
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã", e);
          localStorage.removeItem(filterStorageKey);
        }
      }

      function renderKPIs(kpis) {
        kpiGrid.innerHTML = "";
        const total = kpis.total_projects || 0;
        const active = kpis.active || 0;
        const closed = kpis.closed || 0;
        const archived = kpis.archived || 0;
        const completion = kpis.completion_rate || 0;
        const overdueProjects = kpis.overdue_projects || 0;
        const overdueRate = kpis.overdue_rate || 0;
        const activeGroups = kpis.active_groups || 0;
        const riskyGroups = kpis.risky_groups || 0;
        const items = [
          {
            title: "–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤",
            value: total,
            note: `${active} –∞–∫—Ç–∏–≤–Ω—ã—Ö, ${closed} –∑–∞–∫—Ä—ã—Ç—ã—Ö, ${archived} –∞—Ä—Ö–∏–≤–Ω—ã—Ö`,
            percent: completion,
            hint: "–î–æ–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤",
          },
          {
            title: "–ü—Ä–æ–µ–∫—Ç—ã —Å —Ä–∏—Å–∫–∞–º–∏",
            value: overdueProjects,
            note: `–†–∏—Å–∫ –≤ ${Math.round(overdueRate * 100)}% –ø—Ä–æ–µ–∫—Ç–æ–≤`,
            percent: overdueRate,
            hint: "–ü—Ä–æ—Å—Ä–æ—á–∫–∏ –∏–ª–∏ —Ä—É—á–Ω–æ–π —Ñ–ª–∞–≥ —Ä–∏—Å–∫–∞",
          },
          {
            title: "–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã",
            value: activeGroups,
            note: `${riskyGroups} —Å —Ä–∏—Å–∫–∞–º–∏`,
            percent: riskyGroups && activeGroups ? riskyGroups / activeGroups : 0,
            hint: "–ê–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –≥—Ä—É–ø–ø—ã",
          },
        ];

        items.forEach((item) => {
          const div = document.createElement("div");
          div.className = "kpi";
          div.innerHTML = `<div class="muted">${item.title}</div><strong>${item.value}</strong><div class="muted">${item.note}</div>`;
          const progress = document.createElement("div");
          progress.className = "progress";
          const span = document.createElement("span");
          span.style.width = `${Math.min(item.percent * 100, 100)}%`;
          progress.title = item.hint;
          progress.appendChild(span);
          div.appendChild(progress);
          kpiGrid.appendChild(div);
        });
      }

      function renderBrands(brands) {
        brandList.innerHTML = "";
        if (!brands || !brands.length) {
          brandList.innerHTML = '<p class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –±—Ä–µ–Ω–¥–∞–º</p>';
          return;
        }
        const max = Math.max(...brands.map((b) => b.projects));
        brands.forEach((item) => {
          const li = document.createElement("div");
          li.className = "kpi";
          const pct = Math.round((item.projects / max) * 100);
          li.innerHTML = `<div><strong>${item.brand}</strong></div><div class="muted">${item.projects} –ø—Ä–æ–µ–∫—Ç(–æ–≤)</div>`;
          const bar = document.createElement("div");
          bar.className = "progress";
          const span = document.createElement("span");
          span.style.width = `${pct}%`;
          bar.appendChild(span);
          li.appendChild(bar);
          brandList.appendChild(li);
        });
      }

      function renderGtmProgress(dist) {
        gtmProgress.innerHTML = "";
        if (!dist || (!dist.early && !dist.middle && !dist.late && !dist.none)) {
          gtmProgress.innerHTML = '<p class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ GTM</p>';
          return;
        }
        const rows = [
          { label: "–°—Ç–∞—Ä—Ç–æ–≤—ã–µ —ç—Ç–∞–ø—ã", value: dist.early || 0 },
          { label: "–°–µ—Ä–µ–¥–∏–Ω–∞", value: dist.middle || 0 },
          { label: "–§–∏–Ω–∞–ª", value: dist.late || 0 },
          { label: "–ë–µ–∑ —ç—Ç–∞–ø–æ–≤", value: dist.none || 0 },
        ];
        const max = Math.max(...rows.map((r) => r.value), 1);
        rows.forEach((row) => {
          const card = document.createElement("div");
          card.className = "kpi";
          const pct = Math.round((row.value / max) * 100);
          card.innerHTML = `<div><strong>${row.label}</strong></div><div class="muted">${row.value} –ø—Ä–æ–µ–∫—Ç(–æ–≤)</div>`;
          const bar = document.createElement("div");
          bar.className = "progress";
          const span = document.createElement("span");
          span.style.width = `${pct}%`;
          bar.appendChild(span);
          card.appendChild(bar);
          gtmProgress.appendChild(card);
        });
      }

      function renderGroups(groups) {
        groupGrid.innerHTML = "";
        if (!groups || !groups.length) {
          groupGrid.innerHTML = '<p class="empty-state">–ù–µ—Ç –≥—Ä—É–ø–ø –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É</p>';
          return;
        }
        groups.forEach((group) => {
          const card = document.createElement("div");
          card.className = "group-card";
          card.dataset.groupId = group.id;
          const risk = group.risk ? '<span class="risk">‚ö†Ô∏è –†–∏—Å–∫</span>' : "";
          card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${group.name}</strong>${risk}</div><div class="muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: ${group.active_projects}</div><a href="/groups.html?group=${group.id}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –≥—Ä—É–ø–ø—É</a>`;
          card.addEventListener("click", () => {
            window.location.href = `/groups.html?group=${group.id}`;
          });
          card.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            openContextMenu(event, "group", group);
          });
          groupGrid.appendChild(card);
        });
      }

      function renderUpcoming(rows) {
        const header = `<tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ì—Ä—É–ø–ø–∞</th><th>–¢–∏–ø</th><th>–≠–ª–µ–º–µ–Ω—Ç</th><th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</th><th>Œî –¥–Ω–µ–π</th></tr>`;
        if (!rows || !rows.length) {
          upcomingTable.innerHTML = header + '<tr><td colspan="6" class="empty-state">–ù–µ—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –¥–∞—Ç</td></tr>';
          return;
        }
        const body = rows
          .map((row) => {
            const overdue = row.days_delta < 0;
            const marker = row.risk || overdue ? "‚ö†Ô∏è" : "";
            return `<tr class="${overdue ? "overdue" : ""}" data-project-id="${row.project_id}" data-group-id="${row.group_id}"><td><a href="/project.html?id=${row.project_id}">${row.project_name}</a></td><td>${row.group_name}</td><td>${row.kind === "gtm_stage" ? "GTM-—ç—Ç–∞–ø" : "–ó–∞–¥–∞—á–∞"}</td><td>${row.title}</td><td>${row.planned_date}</td><td>${row.days_delta} ${marker}</td></tr>`;
          })
          .join("");
        upcomingTable.innerHTML = header + body;

        Array.from(upcomingTable.querySelectorAll("tr[data-project-id]"))
          .forEach((row) => {
            row.addEventListener("contextmenu", (event) => {
              event.preventDefault();
              openContextMenu(event, "project", {
                id: row.dataset.projectId,
                group_id: row.dataset.groupId,
                name: row.querySelector("a")?.textContent || "–ü—Ä–æ–µ–∫—Ç",
              });
            });
          });
      }

      function renderRisks(items) {
        riskList.innerHTML = "";
        if (!items || !items.length) {
          riskList.innerHTML = '<p class="empty-state">–ù–µ—Ç —Ä–∏—Å–∫–æ–≤</p>';
          return;
        }
        items.forEach((item) => {
          const li = document.createElement("li");
          li.innerHTML = `<div><strong><a href="/project.html?id=${item.project_id}">${item.project_name}</a></strong> <span class="muted">(${item.group_name})</span></div><div class="risk">${item.reason}${item.overdue_days ? ` ¬∑ ${item.overdue_days} –¥–Ω.` : ""}</div>`;
          li.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            openContextMenu(event, "project", {
              id: item.project_id,
              group_id: null,
              name: item.project_name,
            });
          });
          riskList.appendChild(li);
        });
      }

      function openContextMenu(event, type, data) {
        const actions = [];
        if (type === "group") {
          actions.push({ label: "–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É", href: `/groups.html?group=${data.id}` });
          actions.push({
            label: "–§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ",
            action: () => {
              groupFilter.value = data.id;
              persistFilters();
              loadDashboard();
            },
          });
        } else if (type === "project") {
          actions.push({ label: "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç", href: `/project.html?id=${data.id}` });
          if (data.group_id) {
            actions.push({
              label: "–§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ –ø—Ä–æ–µ–∫—Ç–∞",
              action: () => {
                groupFilter.value = data.group_id;
                persistFilters();
                loadDashboard();
              },
            });
          }
        }

        contextMenuList.innerHTML = "";
        actions.forEach((item) => {
          const li = document.createElement("li");
          if (item.href) {
            const link = document.createElement("a");
            link.href = item.href;
            link.target = "_blank";
            link.textContent = item.label;
            li.appendChild(link);
          } else if (item.action) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = item.label;
            btn.addEventListener("click", () => {
              hideContextMenu();
              item.action();
            });
            li.appendChild(btn);
          }
          contextMenuList.appendChild(li);
        });

        contextMenu.style.left = `${event.clientX}px`;
        contextMenu.style.top = `${event.clientY}px`;
        contextMenu.hidden = false;
      }

      function hideContextMenu() {
        contextMenu.hidden = true;
      }

      window.addEventListener("click", hideContextMenu);
      window.addEventListener("contextmenu", (event) => {
        if (!contextMenu.contains(event.target)) return;
        event.preventDefault();
      });

      async function loadDashboard() {
        dashboardError.hidden = true;
        const url = new URL(window.location.origin + "/api/dashboard");
        if (groupFilter.value) url.searchParams.set("group_id", groupFilter.value);
        if (brandFilter.value) url.searchParams.set("brand", brandFilter.value);
        if (statusFilter.value) url.searchParams.set("statuses", statusFilter.value);
        if (showArchived.checked) url.searchParams.set("include_archived", "true");

        try {
          const res = await fetch(url.toString());
          if (!res.ok) {
            throw new Error(await res.text());
          }
          const payload = await res.json();
          renderKPIs(payload.kpis || {});
          renderBrands(payload.brands || []);
          renderGtmProgress(payload.gtm_distribution || []);
          renderGroups(payload.groups || []);
          renderRisks(payload.risk_projects || []);
          renderUpcoming(payload.upcoming || []);
        } catch (err) {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥", err);
          dashboardError.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥: ${err.message || err}`;
          dashboardError.hidden = false;
          renderKPIs({ total_projects: 0, active: 0, closed: 0, archived: 0, completion_rate: 0, overdue_projects: 0, overdue_rate: 0, active_groups: 0, risky_groups: 0 });
          renderBrands([]);
          renderGtmProgress([]);
          renderGroups([]);
          renderRisks([]);
          renderUpcoming([]);
        }
      }

      function resetFiltersState() {
        groupFilter.value = "";
        brandFilter.value = "";
        statusFilter.value = "";
        showArchived.checked = false;
      }

      applyFilters.addEventListener("click", () => {
        persistFilters();
        loadDashboard();
      });

      resetFilters.addEventListener("click", () => {
        resetFiltersState();
        localStorage.removeItem(filterStorageKey);
        loadDashboard();
      });

      showArchived.addEventListener("change", () => {
        persistFilters();
        loadDashboard();
      });

      restoreFilters();
      loadGroupsForFilter().then(loadDashboard);
    </script>
    <footer class="site-footer">
      <small>Made by Smuk Marian / 2025</small>
    </footer>
  </body>
</html>
