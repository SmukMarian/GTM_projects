<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) =>
          value === "dark" || value === "light" || value === "system" ? value : null;
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <title>Haier Project Tracker ‚Äî –ó–∞–≥–ª—É—à–∫–∞</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f6f7fb;
        --bg-gradient: radial-gradient(circle at 20% 20%, rgba(16, 163, 127, 0.12), transparent 32%),
          radial-gradient(circle at 80% 0%, rgba(16, 163, 127, 0.1), transparent 30%);
        --surface: #ffffff;
        --surface-muted: #f8fafc;
        --text: #0f172a;
        --muted: #475569;
        --border: #e2e8f0;
        --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0d1117;
        --bg-gradient: radial-gradient(circle at 20% 20%, rgba(16, 163, 127, 0.2), transparent 32%),
          radial-gradient(circle at 80% 0%, rgba(16, 163, 127, 0.16), transparent 30%);
        --surface: #161b22;
        --surface-muted: #1e2633;
        --text: #e6edf3;
        --muted: #9ba7b5;
        --border: #2d333b;
        --shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
      }

      body {
        max-width: 960px;
        margin: 0 auto;
        padding: 48px 24px 64px;
        background-color: var(--bg);
        background-image: var(--bg-gradient);
        color: var(--text);
      }

      h1 {
        margin-bottom: 0.25rem;
        font-size: 2rem;
      }

      .pill {
        display: inline-block;
        padding: 6px 12px;
        background: var(--accent-soft);
        color: var(--accent);
        border-radius: 999px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.75rem;
      }

      .card {
        background: var(--surface);
        color: var(--text);
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-top: 20px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .grid .card {
        margin-top: 0;
      }

      ul {
        padding-left: 18px;
      }

      code {
        background: var(--surface-muted);
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      footer {
        margin-top: 32px;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .context-menu {
        position: fixed;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: var(--shadow);
        min-width: 220px;
        z-index: 1000;
        padding: 8px 0;
      }

      .context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu li {
        padding: 8px 16px;
      }

      .context-menu li a,
      .context-menu li button {
        color: var(--text);
        text-decoration: none;
        background: transparent;
        border: none;
        cursor: pointer;
        width: 100%;
        text-align: left;
        font: inherit;
        padding: 0;
      }

      .context-menu li:hover {
        background: var(--accent-soft);
      }

      .theme-toggle-group {
        position: fixed;
        top: 16px;
        right: 16px;
        display: inline-flex;
        gap: 6px;
        padding: 6px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 999px;
        box-shadow: var(--shadow);
        z-index: 1000;
      }

      .theme-toggle-group button {
        border: none;
        background: transparent;
        color: var(--text);
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s ease, background-color 0.2s ease, color 0.2s ease;
      }

      .theme-toggle-group button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      }

      .theme-toggle-group button:hover {
        transform: translateY(-2px);
        background-color: var(--surface-muted);
      }
    </style>
  </head>
  <body>
    <div class="theme-toggle-group" role="group" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
      <button type="button" data-theme-select="light" aria-pressed="false" aria-label="–í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É">‚òÄÔ∏è</button>
      <button type="button" data-theme-select="system" aria-pressed="false" aria-label="–°–ª–µ–¥–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º">üñ•Ô∏è</button>
      <button type="button" data-theme-select="dark" aria-pressed="false" aria-label="–í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É">üåô</button>
    </div>
    <span class="pill">–î–∞—à–±–æ—Ä–¥</span>
    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap">
      <h1 style="margin: 0">Haier Project Tracker</h1>
      <a href="/groups.html" style="font-weight: 600">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–º –≥—Ä—É–ø–ø–∞–º ‚Üí</a>
      <a href="/projects.html" style="font-weight: 600">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º ‚Üí</a>
    </div>
    <p>
      –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–µ–∫—Ç–æ–≤, —Å–≤–æ–¥–∫—É –ø–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–º –≥—Ä—É–ø–ø–∞–º, –±–ª–∏–∂–∞–π—à–∏–µ –≤–∞–∂–Ω—ã–µ –¥–∞—Ç—ã –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ JSON-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —á–µ—Ä–µ–∑ API FastAPI.
    </p>

    <div class="card">
      <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
      <div class="grid" style="align-items: end">
        <label class="card">
          <span>–ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</span>
          <select id="groupFilter">
            <option value="">–í—Å–µ</option>
          </select>
        </label>
        <label class="card">
          <span>–ë—Ä–µ–Ω–¥</span>
          <input id="brandFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Haier" />
        </label>
        <label class="card">
          <span>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞</span>
          <select id="statusFilter">
            <option value="">–í—Å–µ</option>
            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
            <option value="closed">–ó–∞–∫—Ä—ã—Ç</option>
            <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω</option>
          </select>
        </label>
        <label class="card" style="gap: 8px; display: flex; align-items: center">
          <input id="showArchived" type="checkbox" />
          <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –≥—Ä—É–ø–ø—ã</span>
        </label>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap">
        <button id="applyFilters">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="resetFilters" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h2>
        <ul id="statusSummary"></ul>
      </div>
      <div class="card">
        <h2>–ë–ª–∏–∂–∞–π—à–∏–µ –≤–∞–∂–Ω—ã–µ –¥–∞—Ç—ã</h2>
        <table id="upcomingTable" style="width: 100%; border-collapse: collapse"></table>
      </div>
    </div>

    <div class="card">
      <h2>–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</h2>
      <div id="groupGrid" class="grid"></div>
    </div>

    <div class="card">
      <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h2>
      <ul id="recentChanges" style="max-height: 320px; overflow: auto"></ul>
    </div>

    <footer>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ; —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ RU/EN –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ä—è–¥–æ–º. –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞
      –≤ –≥—Ä—É–ø–ø—ã –∏ –ø—Ä–æ–µ–∫—Ç—ã.</footer>

    <div id="contextMenu" class="context-menu" hidden>
      <ul id="contextMenuList"></ul>
    </div>

    <script src="/theme.js" defer></script>
    <script>
      const statusList = document.getElementById("statusSummary");
      const groupGrid = document.getElementById("groupGrid");
      const upcomingTable = document.getElementById("upcomingTable");
      const recentList = document.getElementById("recentChanges");
      const groupFilter = document.getElementById("groupFilter");
      const brandFilter = document.getElementById("brandFilter");
      const statusFilter = document.getElementById("statusFilter");
      const showArchived = document.getElementById("showArchived");
      const applyFilters = document.getElementById("applyFilters");
      const resetFilters = document.getElementById("resetFilters");
      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");
      const filterStorageKey = "hpt-dashboard-filters";

      async function loadGroupsForFilter() {
        const res = await fetch("/api/groups?include_archived=true");
        if (!res.ok) return;
        const groups = await res.json();
        groups.forEach((g) => {
          const option = document.createElement("option");
          option.value = g.id;
          option.textContent = g.name;
          groupFilter.appendChild(option);
        });
        restoreFilters();
      }

      function persistFilters() {
        const state = {
          groupId: groupFilter.value,
          brand: brandFilter.value.trim(),
          status: statusFilter.value,
          includeArchived: showArchived.checked,
        };
        localStorage.setItem(filterStorageKey, JSON.stringify(state));
      }

      function restoreFilters() {
        const raw = localStorage.getItem(filterStorageKey);
        if (!raw) return;
        try {
          const state = JSON.parse(raw) || {};
          groupFilter.value = state.groupId || "";
          brandFilter.value = state.brand || "";
          statusFilter.value = state.status || "";
          showArchived.checked = !!state.includeArchived;
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã", e);
          localStorage.removeItem(filterStorageKey);
        }
      }

      function renderStatus(summary) {
        statusList.innerHTML = "";
        const entries = [
          { label: "–ê–∫—Ç–∏–≤–Ω—ã–µ", value: summary.active },
          { label: "–ó–∞–∫—Ä—ã—Ç—ã–µ", value: summary.closed },
          { label: "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", value: summary.archived },
        ];
        entries.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = `${item.label}: ${item.value}`;
          statusList.appendChild(li);
        });
      }

        function renderGroups(groups) {
          groupGrid.innerHTML = "";
          groups.forEach((group) => {
            const card = document.createElement("div");
            card.className = "card";
            card.dataset.groupId = group.id;
            const risk = group.risk ? " ‚ö†Ô∏è" : "";
            card.innerHTML = `<strong><a href="/groups.html?group=${group.id}">${group.name}</a></strong>${risk}<br />–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: ${group.active_projects}`;
            card.addEventListener("contextmenu", (event) => {
              event.preventDefault();
              openContextMenu(event, "group", group);
            });
            groupGrid.appendChild(card);
          });
        }

      function renderUpcoming(rows) {
        if (!rows.length) {
          upcomingTable.innerHTML = "<tr><td>–ù–µ—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –¥–∞—Ç</td></tr>";
          return;
        }
          const header = `<tr><th align="left">–ü—Ä–æ–µ–∫—Ç</th><th align="left">–ì—Ä—É–ø–ø–∞</th><th align="left">–¢–∏–ø</th><th align="left">–≠–ª–µ–º–µ–Ω—Ç</th><th align="left">–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</th><th align="left">Œî –¥–Ω–µ–π</th></tr>`;
          const body = rows
            .map((row) => {
              const marker = row.risk || row.days_delta < 0 ? "‚ö†Ô∏è" : "";
              return `<tr data-project-id="${row.project_id}" data-group-id="${row.group_id}"><td><a href="/project.html?id=${row.project_id}">${row.project_name}</a></td><td>${row.group_name}</td><td>${row.kind === "gtm_stage" ? "GTM-—ç—Ç–∞–ø" : "–ó–∞–¥–∞—á–∞"}</td><td>${row.title}</td><td>${row.planned_date}</td><td>${row.days_delta} ${marker}</td></tr>`;
            })
            .join("");
          upcomingTable.innerHTML = header + body;

          Array.from(upcomingTable.querySelectorAll("tr[data-project-id]"))
            .forEach((row) => {
              row.addEventListener("contextmenu", (event) => {
                event.preventDefault();
                openContextMenu(event, "project", {
                  id: row.dataset.projectId,
                  group_id: row.dataset.groupId,
                  name: row.querySelector("a")?.textContent || "–ü—Ä–æ–µ–∫—Ç",
                });
              });
            });
        }

      function renderChanges(items) {
        recentList.innerHTML = "";
        if (!items.length) {
          recentList.innerHTML = "<li>–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>";
          return;
        }
        items.forEach((item) => {
          const li = document.createElement("li");
          const date = new Date(item.occurred_at).toLocaleString();
          li.innerHTML = `<strong><a href="/project.html?id=${item.project_id}">${item.project_name}</a></strong> (${item.group_name}) ‚Äî ${item.summary}<br /><small>${date}</small>`;
          if (item.details) {
            li.innerHTML += `<div>${item.details}</div>`;
          }
          li.dataset.projectId = item.project_id;
          li.dataset.groupId = item.group_id;
          li.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            openContextMenu(event, "project", {
              id: item.project_id,
              group_id: item.group_id,
              name: item.project_name,
            });
          });
          recentList.appendChild(li);
        });
      }

      function openContextMenu(event, type, data) {
        const actions = [];
        if (type === "group") {
          actions.push({ label: "–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É", href: `/groups.html?group=${data.id}` });
          actions.push({
            label: "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç—É –≥—Ä—É–ø–ø—É",
            action: () => {
              groupFilter.value = data.id;
              loadDashboard();
            },
          });
        } else if (type === "project") {
          actions.push({ label: "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç", href: `/project.html?id=${data.id}` });
          if (data.group_id) {
            actions.push({
              label: "–§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ –ø—Ä–æ–µ–∫—Ç–∞",
              action: () => {
                groupFilter.value = data.group_id;
                loadDashboard();
              },
            });
          }
        }

        contextMenuList.innerHTML = "";
        actions.forEach((item) => {
          const li = document.createElement("li");
          if (item.href) {
            const link = document.createElement("a");
            link.href = item.href;
            link.target = "_blank";
            link.textContent = item.label;
            li.appendChild(link);
          } else if (item.action) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = item.label;
            btn.addEventListener("click", () => {
              hideContextMenu();
              item.action();
            });
            li.appendChild(btn);
          }
          contextMenuList.appendChild(li);
        });

        contextMenu.style.left = `${event.clientX}px`;
        contextMenu.style.top = `${event.clientY}px`;
        contextMenu.hidden = false;
      }

      function hideContextMenu() {
        contextMenu.hidden = true;
      }

      window.addEventListener("click", hideContextMenu);
      window.addEventListener("contextmenu", (event) => {
        if (!contextMenu.contains(event.target)) return;
        event.preventDefault();
      });

      async function loadDashboard() {
        const url = new URL(window.location.origin + "/api/dashboard");
        if (groupFilter.value) url.searchParams.set("group_id", groupFilter.value);
        if (brandFilter.value) url.searchParams.set("brand", brandFilter.value);
        if (statusFilter.value) url.searchParams.set("statuses", statusFilter.value);
        if (showArchived.checked) url.searchParams.set("include_archived", "true");

        const res = await fetch(url.toString());
        if (!res.ok) {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥", await res.text());
          return;
        }
        const payload = await res.json();
        renderStatus(payload.statuses);
        renderGroups(payload.groups);
        renderUpcoming(payload.upcoming);
        renderChanges(payload.recent_changes);
      }

      function resetFiltersState() {
        groupFilter.value = "";
        brandFilter.value = "";
        statusFilter.value = "";
        showArchived.checked = false;
      }

      applyFilters.addEventListener("click", () => {
        persistFilters();
        loadDashboard();
      });

      resetFilters.addEventListener("click", () => {
        resetFiltersState();
        localStorage.removeItem(filterStorageKey);
        loadDashboard();
      });

      restoreFilters();
      loadGroupsForFilter().then(loadDashboard);
    </script>
  </body>
</html>
