<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>–®–∞–±–ª–æ–Ω—ã ‚Äî Projects Tracker</title>
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) => (value === "dark" || value === "light" || value === "system" ? value : null);
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f3f5f9;
        --bg-alt: #eef1f6;
        --surface: #ffffff;
        --surface-muted: #f7f8fc;
        --text: #0f172a;
        --muted: #475569;
        --border: #d9e0ea;
        --divider: rgba(148, 163, 184, 0.35);
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --accent: #10a37f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0e1218;
        --bg-alt: #0b1017;
        --surface: #111827;
        --surface-muted: #161f30;
        --text: #e6edf3;
        --muted: #9aa6b6;
        --border: #1f2937;
        --divider: rgba(148, 163, 184, 0.25);
        --shadow: 0 22px 50px rgba(0, 0, 0, 0.5);
        --accent: #10a37f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        color: var(--text);
      }

      .theme-menu {
        position: relative;
      }

      .theme-menu summary {
        list-style: none;
        display: grid;
        place-items: center;
        padding: 6px;
        min-width: 38px;
        min-height: 38px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        cursor: pointer;
        user-select: none;
      }

      .theme-menu summary::-webkit-details-marker {
        display: none;
      }

      .theme-menu[open] summary {
        box-shadow: var(--shadow);
        background: var(--surface);
      }

      .theme-menu-dropdown {
        position: absolute;
        right: 0;
        top: calc(100% + 8px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 6px;
        display: none;
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
        width: max-content;
        z-index: 1000;
      }

      .theme-menu[open] .theme-menu-dropdown {
        display: flex;
      }

      .theme-menu-dropdown button {
        border: none;
        background: transparent;
        color: var(--text);
        text-align: left;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: center;
        min-width: 0;
      }

      .theme-menu-dropdown button:hover,
      .theme-menu-dropdown button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .app-shell {
        max-width: 1280px;
        margin: 0 auto;
        padding: 14px 18px 0;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        position: sticky;
        top: 12px;
        z-index: 900;
      }

      .logo {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: var(--text);
        text-decoration: none;
      }

      .logo img {
        width: 36px;
        height: 36px;
      }

      nav {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      nav a {
        padding: 8px 12px;
        border-radius: 12px;
        text-decoration: none;
        color: var(--text);
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      nav a:hover {
        box-shadow: var(--shadow);
      }

      .page {
        max-width: 1240px;
        margin: 0 auto;
        padding: 32px 20px 88px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .pill {
        display: inline-flex;
        padding: 8px 14px;
        background: var(--surface-muted);
        border-radius: 999px;
        border: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 700;
        font-size: 0.85rem;
      }

      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      button {
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        color: var(--text);
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      button.primary {
        background: var(--accent);
        color: #fff;
        border: none;
        box-shadow: 0 12px 30px rgba(16, 163, 127, 0.2);
      }

      button.ghost {
        background: transparent;
        border-color: transparent;
      }

      button.danger {
        background: var(--danger);
        color: #fff;
        border: none;
      }

      .muted {
        color: var(--muted);
        font-size: 0.95rem;
      }

      .split-panel {
        display: grid;
        grid-template-columns: minmax(260px, 1fr) minmax(0, 2fr);
        gap: 16px;
      }

      .template-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .template-list-item {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: var(--surface-muted);
        display: flex;
        flex-direction: column;
        gap: 6px;
        cursor: pointer;
      }

      .template-list-item[data-active="true"] {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-soft);
      }

      .template-list-item header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .template-detail {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        background: var(--surface-muted);
        min-height: 320px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .template-detail input,
      .template-detail textarea,
      .template-detail select {
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 8px 10px;
        background: var(--surface);
        color: var(--text);
        font: inherit;
        flex: 1 1 auto;
        max-width: 100%;
      }

      .template-detail label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
      }

      .template-description {
        min-height: 110px;
      }

      .detail-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .detail-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .stage-stack,
      .section-stack {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .stage-card,
      .section-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: var(--surface);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .stage-card-header,
      .section-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .task-card,
      .field-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        background: var(--surface-muted);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .subtask-list,
      .field-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .subtask-row,
      .field-row {
        display: grid;
        grid-template-columns: 1fr 100px auto;
        gap: 8px;
        align-items: center;
      }

      .field-row {
        grid-template-columns: repeat(3, minmax(0, 1fr)) 110px auto;
      }

      .subtask-row input[type="text"] {
        grid-column: span 1;
      }

      .empty-state {
        padding: 16px;
        border-radius: 12px;
        border: 1px dashed var(--border);
        text-align: center;
        color: var(--muted);
      }

      .pill.badge {
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 0.8rem;
      }

      @media (max-width: 900px) {
        .split-panel {
          grid-template-columns: 1fr;
        }
      }

      .site-footer {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 18px 48px;
        text-align: center;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }
    </style>
    <script defer src="/theme.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <div class="topbar">
        <a class="logo" href="/index.html" aria-label="Projects Tracker">
          <img src="/favicon.svg" alt="Projects Tracker" />
          <div>Projects Tracker</div>
        </a>
        <nav aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <a href="/index.html">–î–∞—à–±–æ—Ä–¥</a>
          <a href="/groups.html">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</a>
          <a href="/projects.html">–ü—Ä–æ–µ–∫—Ç—ã</a>
          <a href="/priority-tasks.html">–í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
          <a href="/templates.html">–®–∞–±–ª–æ–Ω—ã</a>
          <details class="theme-menu">
            <summary aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
              <span aria-hidden="true">üåó</span>
              <span class="theme-menu-label" data-theme-state>–¢–µ–º–∞</span>
            </summary>
            <div class="theme-menu-dropdown" role="menu" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
              <button type="button" role="menuitem" data-theme-select="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="system">üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="dark">üåô –¢—ë–º–Ω–∞—è</button>
            </div>
          </details>
        </nav>
      </div>
    </div>
    <div class="page">
      <div class="card">
        <div class="toolbar" style="justify-content: space-between; align-items: flex-start">
          <div>
            <span class="pill">–®–∞–±–ª–æ–Ω—ã</span>
            <h1 style="margin: 6px 0 4px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GTM –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏</h1>
            <p class="muted" style="margin: 0">
              –°–æ–∑–¥–∞–≤–∞–π—Ç–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —ç—Ç–∞–ø–æ–≤ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.
            </p>
          </div>
          <div class="toolbar">
            <button class="primary" id="newGtm">+ –®–∞–±–ª–æ–Ω GTM</button>
            <button class="primary" id="newChar">+ –®–∞–±–ª–æ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</button>
          </div>
        </div>
      </div>

      <section class="card template-section">
        <div class="stage-card-header">
          <div>
            <h2 style="margin: 0">–®–∞–±–ª–æ–Ω—ã GTM-—ç—Ç–∞–ø–æ–≤</h2>
            <p class="muted" style="margin: 0">–≠—Ç–∞–ø—ã, –∑–∞–¥–∞—á–∏ –∏ –ø–æ–¥–∑–∞–¥–∞—á–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>
          </div>
          <div class="toolbar">
            <button id="refreshGtm">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <div class="split-panel">
          <div class="template-list" id="gtmList"></div>
          <div class="template-detail" id="gtmDetail"></div>
        </div>
      </section>

      <section class="card template-section">
        <div class="stage-card-header">
          <div>
            <h2 style="margin: 0">–®–∞–±–ª–æ–Ω—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</h2>
            <p class="muted" style="margin: 0">–°–µ–∫—Ü–∏–∏ –∏ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç–∞–º.</p>
          </div>
          <div class="toolbar">
            <button id="refreshChar">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <div class="split-panel">
          <div class="template-list" id="charList"></div>
          <div class="template-detail" id="charDetail"></div>
        </div>
      </section>
    </div>

    <script>
      const gtmList = document.getElementById("gtmList");
      const gtmDetail = document.getElementById("gtmDetail");
      const charList = document.getElementById("charList");
      const charDetail = document.getElementById("charDetail");
      const newGtmBtn = document.getElementById("newGtm");
      const newCharBtn = document.getElementById("newChar");
      document.getElementById("refreshGtm").addEventListener("click", () => loadTemplates(gtmState.activeId, charState.activeId));
      document.getElementById("refreshChar").addEventListener("click", () => loadTemplates(gtmState.activeId, charState.activeId));

      const clone = (value) => (window.structuredClone ? structuredClone(value) : JSON.parse(JSON.stringify(value)));
      const createId = () =>
        window.crypto && crypto.randomUUID
          ? crypto.randomUUID()
          : "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
              const r = (Math.random() * 16) | 0;
              const v = c === "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            });

      const gtmState = { list: [], activeId: null, draft: null, dirty: false };
      const charState = { list: [], activeId: null, draft: null, dirty: false };

      async function loadTemplates(nextGtmId = null, nextCharId = null) {
        const [gtmRes, charRes] = await Promise.all([
          fetch("/api/gtm-templates"),
          fetch("/api/characteristic-templates"),
        ]);
        gtmState.list = gtmRes.ok ? await gtmRes.json() : [];
        charState.list = charRes.ok ? await charRes.json() : [];
        renderGtmList();
        renderCharList();
        if (nextGtmId && gtmState.list.some((tpl) => tpl.id === nextGtmId)) {
          selectGtmTemplate(nextGtmId);
        } else if (gtmState.activeId) {
          selectGtmTemplate(gtmState.activeId);
        } else {
          gtmState.draft = null;
          gtmState.activeId = null;
          renderGtmDetail();
        }
        if (nextCharId && charState.list.some((tpl) => tpl.id === nextCharId)) {
          selectCharTemplate(nextCharId);
        } else if (charState.activeId) {
          selectCharTemplate(charState.activeId);
        } else {
          charState.draft = null;
          charState.activeId = null;
          renderCharDetail();
        }
      }

      function renderGtmList() {
        gtmList.innerHTML = "";
        if (!gtmState.list.length) {
          gtmList.innerHTML = "<div class='empty-state'>–®–∞–±–ª–æ–Ω—ã GTM –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</div>";
          return;
        }
        gtmState.list.forEach((tpl) => {
          const card = document.createElement("div");
          card.className = "template-list-item";
          if (tpl.id === gtmState.activeId) card.dataset.active = "true";
          const header = document.createElement("header");
          const title = document.createElement("strong");
          title.textContent = tpl.name;
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "ghost danger";
          deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
          deleteBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            deleteGtmTemplate(tpl.id);
          });
          header.append(title, deleteBtn);
          const meta = document.createElement("div");
          const stages = tpl.stages?.length || 0;
          const tasks = tpl.tasks?.length || 0;
          meta.className = "muted";
          meta.textContent = `–≠—Ç–∞–ø–æ–≤: ${stages} ¬∑ –ó–∞–¥–∞—á: ${tasks}`;
          card.append(header, meta);
          card.tabIndex = 0;
          card.addEventListener("click", () => selectGtmTemplate(tpl.id));
          card.addEventListener("keydown", (event) => {
            if (event.key === "Enter") selectGtmTemplate(tpl.id);
          });
          gtmList.appendChild(card);
        });
      }

      function renderCharList() {
        charList.innerHTML = "";
        if (!charState.list.length) {
          charList.innerHTML = "<div class='empty-state'>–®–∞–±–ª–æ–Ω—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</div>";
          return;
        }
        charState.list.forEach((tpl) => {
          const card = document.createElement("div");
          card.className = "template-list-item";
          if (tpl.id === charState.activeId) card.dataset.active = "true";
          const header = document.createElement("header");
          const title = document.createElement("strong");
          title.textContent = tpl.name;
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "ghost danger";
          deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
          deleteBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            deleteCharTemplate(tpl.id);
          });
          header.append(title, deleteBtn);
          const meta = document.createElement("div");
          const sections = tpl.sections?.length || 0;
          const fields = tpl.sections?.reduce((sum, section) => sum + (section.fields?.length || 0), 0) || 0;
          meta.className = "muted";
          meta.textContent = `–°–µ–∫—Ü–∏–π: ${sections} ¬∑ –ü–æ–ª–µ–π: ${fields}`;
          card.append(header, meta);
          card.tabIndex = 0;
          card.addEventListener("click", () => selectCharTemplate(tpl.id));
          card.addEventListener("keydown", (event) => {
            if (event.key === "Enter") selectCharTemplate(tpl.id);
          });
          charList.appendChild(card);
        });
      }

      function selectGtmTemplate(templateId) {
        const template = gtmState.list.find((tpl) => tpl.id === templateId);
        if (!template) return;
        gtmState.activeId = templateId;
        gtmState.draft = clone(template);
        gtmState.draft.stages = gtmState.draft.stages || [];
        gtmState.draft.tasks = gtmState.draft.tasks || [];
        gtmState.dirty = false;
        renderGtmList();
        renderGtmDetail();
      }

      function selectCharTemplate(templateId) {
        const template = charState.list.find((tpl) => tpl.id === templateId);
        if (!template) return;
        charState.activeId = templateId;
        charState.draft = clone(template);
        charState.draft.sections = charState.draft.sections || [];
        charState.draft.sections.forEach((section) => {
          section.fields = section.fields || [];
        });
        charState.dirty = false;
        renderCharList();
        renderCharDetail();
      }

      function renderGtmDetail() {
        gtmDetail.innerHTML = "";
        const draft = gtmState.draft;
        if (!draft) {
          gtmDetail.innerHTML = "<div class='empty-state'>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —à–∞–±–ª–æ–Ω GTM.</div>";
          return;
        }
        const header = document.createElement("div");
        header.className = "detail-header";
        const nameLabel = document.createElement("label");
        nameLabel.textContent = "–ù–∞–∑–≤–∞–Ω–∏–µ";
        const nameInput = document.createElement("input");
        nameInput.value = draft.name || "";
        nameInput.addEventListener("input", (event) => {
          draft.name = event.target.value;
          markGtmDirty();
        });
        nameLabel.appendChild(nameInput);
        const descLabel = document.createElement("label");
        descLabel.textContent = "–û–ø–∏—Å–∞–Ω–∏–µ";
        const descInput = document.createElement("textarea");
        descInput.rows = 4;
        descInput.className = "template-description";
        descInput.value = draft.description || "";
        descInput.addEventListener("input", (event) => {
          draft.description = event.target.value || null;
          markGtmDirty();
        });
        descLabel.appendChild(descInput);
        const actions = document.createElement("div");
        actions.className = "detail-actions";
        const resetBtn = document.createElement("button");
        resetBtn.id = "gtmResetBtn";
        resetBtn.textContent = "–°–±—Ä–æ—Å–∏—Ç—å";
        resetBtn.addEventListener("click", () => selectGtmTemplate(draft.id));
        const saveBtn = document.createElement("button");
        saveBtn.id = "gtmSaveBtn";
        saveBtn.className = "primary";
        saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        saveBtn.addEventListener("click", saveGtmTemplate);
        actions.append(resetBtn, saveBtn);
        header.append(nameLabel, descLabel, actions);
        gtmDetail.appendChild(header);

        const stageStack = document.createElement("div");
        stageStack.className = "stage-stack";
        const stages = [...(draft.stages || [])].sort((a, b) => a.order - b.order);
        stages.forEach((stage, index) => stageStack.appendChild(createStageCard(stage, index, stages.length)));
        const addStageBtn = document.createElement("button");
        addStageBtn.className = "ghost";
        addStageBtn.textContent = "+ –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø";
        addStageBtn.addEventListener("click", addGtmStage);
        gtmDetail.append(stageStack, addStageBtn);
        updateGtmDirtyState();
      }

      function createStageCard(stage, index, total) {
        const card = document.createElement("div");
        card.className = "stage-card";
        const header = document.createElement("div");
        header.className = "stage-card-header";
        const titleInput = document.createElement("input");
        titleInput.value = stage.title || "";
        titleInput.placeholder = "–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞";
        titleInput.addEventListener("input", (event) => {
          stage.title = event.target.value;
          markGtmDirty();
        });
        const headerActions = document.createElement("div");
        headerActions.className = "toolbar";
        const upBtn = document.createElement("button");
        upBtn.textContent = "‚Üë";
        upBtn.disabled = index === 0;
        upBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          moveGtmStage(stage.id, -1);
        });
        const downBtn = document.createElement("button");
        downBtn.textContent = "‚Üì";
        downBtn.disabled = index === total - 1;
        downBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          moveGtmStage(stage.id, 1);
        });
        const delBtn = document.createElement("button");
        delBtn.className = "ghost danger";
        delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
        delBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          deleteGtmStage(stage.id);
        });
        headerActions.append(upBtn, downBtn, delBtn);
        header.append(titleInput, headerActions);
        const desc = document.createElement("textarea");
        desc.rows = 2;
        desc.placeholder = "–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–∞–ø–∞";
        desc.value = stage.description || "";
        desc.addEventListener("input", (event) => {
          stage.description = event.target.value || null;
          markGtmDirty();
        });
        card.append(header, desc);

        const tasksWrapper = document.createElement("div");
        tasksWrapper.className = "stage-stack";
        const tasks = (gtmState.draft.tasks || []).filter((task) => task.gtm_stage_id === stage.id);
        tasks.forEach((task) => tasksWrapper.appendChild(createTaskCard(task)));
        const addTaskBtn = document.createElement("button");
        addTaskBtn.className = "ghost";
        addTaskBtn.textContent = "+ –ó–∞–¥–∞—á–∞";
        addTaskBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          addGtmTask(stage.id);
        });
        tasksWrapper.appendChild(addTaskBtn);
        card.appendChild(tasksWrapper);
        return card;
      }

      function createTaskCard(task) {
        const card = document.createElement("div");
        card.className = "task-card";
        const title = document.createElement("input");
        title.value = task.title || "";
        title.placeholder = "–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏";
        title.addEventListener("input", (event) => {
          task.title = event.target.value;
          markGtmDirty();
        });
        const desc = document.createElement("textarea");
        desc.rows = 2;
        desc.placeholder = "–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏";
        desc.value = task.description || "";
        desc.addEventListener("input", (event) => {
          task.description = event.target.value || null;
          markGtmDirty();
        });
        const subtaskList = document.createElement("div");
        subtaskList.className = "subtask-list";
        (task.subtasks || []).sort((a, b) => a.order - b.order).forEach((subtask) => {
          const row = document.createElement("div");
          row.className = "subtask-row";
          const subInput = document.createElement("input");
          subInput.type = "text";
          subInput.value = subtask.title || "";
          subInput.placeholder = "–ü–æ–¥–∑–∞–¥–∞—á–∞";
          subInput.addEventListener("input", (event) => {
            subtask.title = event.target.value;
            markGtmDirty();
          });
          const orderInput = document.createElement("input");
          orderInput.type = "number";
          orderInput.value = subtask.order ?? 0;
          orderInput.addEventListener("input", (event) => {
            subtask.order = Number(event.target.value) || 0;
            markGtmDirty();
          });
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "ghost danger";
          deleteBtn.textContent = "√ó";
          deleteBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            deleteGtmSubtask(task.id, subtask.id);
          });
          row.append(subInput, orderInput, deleteBtn);
          subtaskList.appendChild(row);
        });
        const addSubtaskBtn = document.createElement("button");
        addSubtaskBtn.className = "ghost";
        addSubtaskBtn.textContent = "+ –ü–æ–¥–∑–∞–¥–∞—á–∞";
        addSubtaskBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          addGtmSubtask(task.id);
        });
        const actions = document.createElement("div");
        actions.className = "detail-actions";
        const deleteTaskBtn = document.createElement("button");
        deleteTaskBtn.className = "ghost danger";
        deleteTaskBtn.textContent = "–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É";
        deleteTaskBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          deleteGtmTask(task.id);
        });
        actions.appendChild(deleteTaskBtn);
        card.append(title, desc, subtaskList, addSubtaskBtn, actions);
        return card;
      }

      function markGtmDirty() {
        gtmState.dirty = true;
        updateGtmDirtyState();
      }

      function updateGtmDirtyState() {
        const saveBtn = document.getElementById("gtmSaveBtn");
        const resetBtn = document.getElementById("gtmResetBtn");
        if (saveBtn) saveBtn.disabled = !gtmState.dirty;
        if (resetBtn) resetBtn.disabled = !gtmState.dirty;
      }

      function addGtmStage() {
        if (!gtmState.draft) return;
        const order = (gtmState.draft.stages || []).length;
        const stage = {
          id: createId(),
          title: `–ù–æ–≤—ã–π —ç—Ç–∞–ø ${order + 1}`,
          description: null,
          order,
          planned_start: null,
          planned_end: null,
          actual_end: null,
          status: "not_started",
          risk_flag: false,
          checklist: [],
        };
        gtmState.draft.stages = [...(gtmState.draft.stages || []), stage];
        markGtmDirty();
        renderGtmDetail();
      }

      function moveGtmStage(stageId, delta) {
        if (!gtmState.draft?.stages) return;
        const sorted = [...gtmState.draft.stages].sort((a, b) => a.order - b.order);
        const index = sorted.findIndex((stage) => stage.id === stageId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= sorted.length) return;
        [sorted[index], sorted[target]] = [sorted[target], sorted[index]];
        sorted.forEach((stage, idx) => (stage.order = idx));
        gtmState.draft.stages = sorted;
        markGtmDirty();
        renderGtmDetail();
      }

      function deleteGtmStage(stageId) {
        if (!gtmState.draft?.stages) return;
        gtmState.draft.stages = gtmState.draft.stages.filter((stage) => stage.id !== stageId);
        gtmState.draft.stages.forEach((stage, idx) => (stage.order = idx));
        gtmState.draft.tasks = (gtmState.draft.tasks || []).filter((task) => task.gtm_stage_id !== stageId);
        markGtmDirty();
        renderGtmDetail();
      }

      function addGtmTask(stageId) {
        if (!gtmState.draft) return;
        const task = {
          id: createId(),
          title: "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
          description: null,
          status: "todo",
          due_date: null,
          important: false,
          gtm_stage_id: stageId,
          subtasks: [],
          comments: [],
        };
        gtmState.draft.tasks = [...(gtmState.draft.tasks || []), task];
        markGtmDirty();
        renderGtmDetail();
      }

      function deleteGtmTask(taskId) {
        if (!gtmState.draft) return;
        gtmState.draft.tasks = (gtmState.draft.tasks || []).filter((task) => task.id !== taskId);
        markGtmDirty();
        renderGtmDetail();
      }

      function addGtmSubtask(taskId) {
        const task = gtmState.draft?.tasks?.find((t) => t.id === taskId);
        if (!task) return;
        const subtask = { id: createId(), title: "–ü–æ–¥–∑–∞–¥–∞—á–∞", done: false, order: task.subtasks?.length || 0 };
        task.subtasks = [...(task.subtasks || []), subtask];
        markGtmDirty();
        renderGtmDetail();
      }

      function deleteGtmSubtask(taskId, subtaskId) {
        const task = gtmState.draft?.tasks?.find((t) => t.id === taskId);
        if (!task) return;
        task.subtasks = (task.subtasks || []).filter((sub) => sub.id !== subtaskId);
        markGtmDirty();
        renderGtmDetail();
      }

      async function saveGtmTemplate() {
        if (!gtmState.draft) return;
        const res = await fetch(`/api/gtm-templates/${gtmState.draft.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(gtmState.draft),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω GTM");
          return;
        }
        gtmState.dirty = false;
        await loadTemplates(gtmState.draft.id, charState.activeId);
      }

      async function deleteGtmTemplate(templateId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω GTM?")) return;
        const res = await fetch(`/api/gtm-templates/${templateId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω");
          return;
        }
        if (gtmState.activeId === templateId) {
          gtmState.activeId = null;
          gtmState.draft = null;
        }
        await loadTemplates(gtmState.activeId, charState.activeId);
      }

      function renderCharDetail() {
        charDetail.innerHTML = "";
        const draft = charState.draft;
        if (!draft) {
          charDetail.innerHTML = "<div class='empty-state'>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —à–∞–±–ª–æ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.</div>";
          return;
        }
        const header = document.createElement("div");
        header.className = "detail-header";
        const nameLabel = document.createElement("label");
        nameLabel.textContent = "–ù–∞–∑–≤–∞–Ω–∏–µ";
        const nameInput = document.createElement("input");
        nameInput.value = draft.name || "";
        nameInput.addEventListener("input", (event) => {
          draft.name = event.target.value;
          markCharDirty();
        });
        nameLabel.appendChild(nameInput);
        const descLabel = document.createElement("label");
        descLabel.textContent = "–û–ø–∏—Å–∞–Ω–∏–µ";
        const descInput = document.createElement("textarea");
        descInput.rows = 4;
        descInput.className = "template-description";
        descInput.value = draft.description || "";
        descInput.addEventListener("input", (event) => {
          draft.description = event.target.value || null;
          markCharDirty();
        });
        descLabel.appendChild(descInput);
        const actions = document.createElement("div");
        actions.className = "detail-actions";
        const resetBtn = document.createElement("button");
        resetBtn.id = "charResetBtn";
        resetBtn.textContent = "–°–±—Ä–æ—Å–∏—Ç—å";
        resetBtn.addEventListener("click", () => selectCharTemplate(draft.id));
        const saveBtn = document.createElement("button");
        saveBtn.id = "charSaveBtn";
        saveBtn.className = "primary";
        saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        saveBtn.addEventListener("click", saveCharTemplate);
        actions.append(resetBtn, saveBtn);
        header.append(nameLabel, descLabel, actions);
        charDetail.appendChild(header);

        const sectionStack = document.createElement("div");
        sectionStack.className = "section-stack";
        const sections = [...(draft.sections || [])].sort((a, b) => a.order - b.order);
        sections.forEach((section, index) => sectionStack.appendChild(createCharSectionCard(section, index, sections.length)));
        const addSectionBtn = document.createElement("button");
        addSectionBtn.className = "ghost";
        addSectionBtn.textContent = "+ –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é";
        addSectionBtn.addEventListener("click", addCharSection);
        charDetail.append(sectionStack, addSectionBtn);
        updateCharDirtyState();
      }

      function createCharSectionCard(section, index, total) {
        const card = document.createElement("div");
        card.className = "section-card";
        const header = document.createElement("div");
        header.className = "section-card-header";
        const titleInput = document.createElement("input");
        titleInput.value = section.title || "";
        titleInput.placeholder = "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–∏";
        titleInput.addEventListener("input", (event) => {
          section.title = event.target.value;
          markCharDirty();
        });
        const orderInput = document.createElement("input");
        orderInput.type = "number";
        orderInput.value = section.order ?? index;
        orderInput.style.maxWidth = "90px";
        orderInput.addEventListener("input", (event) => {
          section.order = Number(event.target.value) || 0;
          markCharDirty();
        });
        const headerActions = document.createElement("div");
        headerActions.className = "toolbar";
        const upBtn = document.createElement("button");
        upBtn.textContent = "‚Üë";
        upBtn.disabled = index === 0;
        upBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          moveCharSection(section.id, -1);
        });
        const downBtn = document.createElement("button");
        downBtn.textContent = "‚Üì";
        downBtn.disabled = index === total - 1;
        downBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          moveCharSection(section.id, 1);
        });
        const delBtn = document.createElement("button");
        delBtn.className = "ghost danger";
        delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
        delBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          deleteCharSection(section.id);
        });
        headerActions.append(upBtn, downBtn, delBtn);
        header.append(titleInput, orderInput, headerActions);
        card.appendChild(header);

        const fieldList = document.createElement("div");
        fieldList.className = "field-list";
        const fields = [...(section.fields || [])].sort((a, b) => a.order - b.order);
        fields.forEach((field, idx) => fieldList.appendChild(createCharFieldRow(section.id, field, idx, fields.length)));
        const addFieldBtn = document.createElement("button");
        addFieldBtn.className = "ghost";
        addFieldBtn.textContent = "+ –ü–æ–ª–µ";
        addFieldBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          addCharField(section.id);
        });
        card.append(fieldList, addFieldBtn);
        return card;
      }

      function createCharFieldRow(sectionId, field, index, total) {
        const row = document.createElement("div");
        row.className = "field-row";
        const labelRu = document.createElement("input");
        labelRu.value = field.label_ru || "";
        labelRu.placeholder = "Label RU";
        labelRu.addEventListener("input", (event) => {
          field.label_ru = event.target.value;
          markCharDirty();
        });
        const labelEn = document.createElement("input");
        labelEn.value = field.label_en || "";
        labelEn.placeholder = "Label EN";
        labelEn.addEventListener("input", (event) => {
          field.label_en = event.target.value;
          markCharDirty();
        });
        const typeSelect = document.createElement("select");
        ["text", "number", "select", "checkbox", "other"].forEach((type) => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type;
          if (field.field_type === type) option.selected = true;
          typeSelect.appendChild(option);
        });
        typeSelect.addEventListener("change", (event) => {
          field.field_type = event.target.value;
          markCharDirty();
        });
        const orderInput = document.createElement("input");
        orderInput.type = "number";
        orderInput.value = field.order ?? index;
        orderInput.addEventListener("input", (event) => {
          field.order = Number(event.target.value) || 0;
          markCharDirty();
        });
        const actions = document.createElement("div");
        actions.className = "detail-actions";
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "ghost danger";
        deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
        deleteBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          deleteCharField(sectionId, field.id);
        });
        actions.appendChild(deleteBtn);
        row.append(labelRu, labelEn, typeSelect, orderInput, actions);
        return row;
      }

      function markCharDirty() {
        charState.dirty = true;
        updateCharDirtyState();
      }

      function updateCharDirtyState() {
        const saveBtn = document.getElementById("charSaveBtn");
        const resetBtn = document.getElementById("charResetBtn");
        if (saveBtn) saveBtn.disabled = !charState.dirty;
        if (resetBtn) resetBtn.disabled = !charState.dirty;
      }

      function addCharSection() {
        if (!charState.draft) return;
        const section = { id: createId(), title: "–ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è", order: (charState.draft.sections || []).length, fields: [] };
        charState.draft.sections = [...(charState.draft.sections || []), section];
        markCharDirty();
        renderCharDetail();
      }

      function moveCharSection(sectionId, delta) {
        if (!charState.draft?.sections) return;
        const sorted = [...charState.draft.sections].sort((a, b) => a.order - b.order);
        const index = sorted.findIndex((section) => section.id === sectionId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= sorted.length) return;
        [sorted[index], sorted[target]] = [sorted[target], sorted[index]];
        sorted.forEach((section, idx) => (section.order = idx));
        charState.draft.sections = sorted;
        markCharDirty();
        renderCharDetail();
      }

      function deleteCharSection(sectionId) {
        if (!charState.draft?.sections) return;
        charState.draft.sections = charState.draft.sections.filter((section) => section.id !== sectionId);
        charState.draft.sections.forEach((section, idx) => (section.order = idx));
        markCharDirty();
        renderCharDetail();
      }

      function addCharField(sectionId) {
        const section = charState.draft?.sections?.find((s) => s.id === sectionId);
        if (!section) return;
        const field = {
          id: createId(),
          label_ru: "–ü–∞—Ä–∞–º–µ—Ç—Ä RU",
          label_en: "Parameter EN",
          value_ru: null,
          value_en: null,
          field_type: "text",
          order: section.fields?.length || 0,
        };
        section.fields = [...(section.fields || []), field];
        markCharDirty();
        renderCharDetail();
      }

      function deleteCharField(sectionId, fieldId) {
        const section = charState.draft?.sections?.find((s) => s.id === sectionId);
        if (!section) return;
        section.fields = section.fields.filter((field) => field.id !== fieldId);
        section.fields.forEach((field, idx) => (field.order = idx));
        markCharDirty();
        renderCharDetail();
      }

      async function saveCharTemplate() {
        if (!charState.draft) return;
        const res = await fetch(`/api/characteristic-templates/${charState.draft.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(charState.draft),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫");
          return;
        }
        charState.dirty = false;
        await loadTemplates(gtmState.activeId, charState.draft.id);
      }

      async function deleteCharTemplate(templateId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫?")) return;
        const res = await fetch(`/api/characteristic-templates/${templateId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω");
          return;
        }
        if (charState.activeId === templateId) {
          charState.activeId = null;
          charState.draft = null;
        }
        await loadTemplates(gtmState.activeId, null);
      }

      newGtmBtn.addEventListener("click", async () => {
        const res = await fetch("/api/gtm-templates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω GTM", description: null, stages: [], tasks: [] }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω GTM");
          return;
        }
        const created = await res.json();
        await loadTemplates(created.id, charState.activeId);
      });

      newCharBtn.addEventListener("click", async () => {
        const res = await fetch("/api/characteristic-templates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫", description: null, sections: [] }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫");
          return;
        }
        const created = await res.json();
        await loadTemplates(gtmState.activeId, created.id);
      });

      loadTemplates();
    </script>
    <footer class="site-footer">
      <small>Made by Smuk Marian / 2025</small>
    </footer>
  </body>
</html>
