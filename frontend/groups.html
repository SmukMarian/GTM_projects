<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) =>
          value === "dark" || value === "light" || value === "system" ? value : null;
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî Haier Project Tracker</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f3f5f9;
        --bg-alt: #eef1f6;
        --surface: #ffffff;
        --surface-muted: #f7f8fc;
        --text: #0f172a;
        --muted: #475569;
        --border: #d9e0ea;
        --divider: rgba(148, 163, 184, 0.35);
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0e1218;
        --bg-alt: #0b1017;
        --surface: #111827;
        --surface-muted: #161f30;
        --text: #e6edf3;
        --muted: #9aa6b6;
        --border: #1f2937;
        --divider: rgba(148, 163, 184, 0.25);
        --shadow: 0 22px 50px rgba(0, 0, 0, 0.5);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
      }

      body {
        margin: 0 auto;
        max-width: 1220px;
        padding: 36px 22px 78px;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
        color: var(--text);
      }

      a {
        color: var(--accent);
      }

      h1 {
        margin: 4px 0 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--surface-muted);
        color: var(--accent);
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid var(--border);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin: 16px 0;
      }

      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 9px 14px;
        border-radius: 12px;
        color: var(--text);
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
        border-color: var(--accent);
        color: #fff;
        font-weight: 700;
        box-shadow: 0 12px 30px rgba(16, 163, 127, 0.2);
      }

      button.ghost {
        background: transparent;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 18px 18px 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 14px;
      }

      .group-card {
        display: grid;
        gap: 8px;
        grid-template-rows: auto auto 1fr auto;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        background: var(--accent-soft);
        color: var(--text);
      }

      .badge.archived {
        background: rgba(248, 113, 113, 0.15);
        color: #dc2626;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
      }

      th {
        color: var(--muted);
        letter-spacing: 0.01em;
        font-weight: 600;
      }

      tr.archived {
        background: var(--surface-muted);
        color: var(--muted);
      }

      label {
        display: grid;
        gap: 6px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font: inherit;
        background: var(--surface-muted);
        color: var(--text);
      }

      .flex {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .space-between {
        justify-content: space-between;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--surface-muted);
        border-radius: 999px;
        font-size: 0.9rem;
      }

      .muted {
        color: var(--muted);
      }

      dialog {
        border: none;
        border-radius: 14px;
        padding: 0;
        box-shadow: var(--shadow);
        background: var(--surface);
        color: var(--text);
      }

      dialog::backdrop {
        background: rgba(15, 23, 42, 0.45);
      }

      .dialog-body {
        padding: 20px;
        min-width: 520px;
        display: grid;
        gap: 12px;
      }

      .context-menu {
        position: fixed;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        min-width: 200px;
        z-index: 1000;
        padding: 8px 0;
      }

      .context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu li {
        padding: 8px 14px;
      }

      .context-menu li:hover {
        background: var(--accent-soft);
      }

      .context-menu button {
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
        padding: 0;
        font: inherit;
        cursor: pointer;
      }

      .detail-panel {
        margin-top: 16px;
        display: grid;
        gap: 8px;
      }

      .theme-toggle-group {
        position: fixed;
        top: 16px;
        right: 16px;
        display: inline-flex;
        gap: 6px;
        padding: 6px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 999px;
        box-shadow: var(--shadow);
        z-index: 1200;
      }

      .theme-toggle-group button {
        border: none;
        background: transparent;
        color: var(--text);
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s ease, background-color 0.2s ease, color 0.2s ease;
      }

      .theme-toggle-group button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      }

      .theme-toggle-group button:hover {
        transform: translateY(-2px);
        background-color: var(--surface-muted);
      }
    </style>
  </head>
  <body>
    <div class="theme-toggle-group" role="group" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
      <button type="button" data-theme-select="light" aria-pressed="false" aria-label="–í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É">‚òÄÔ∏è</button>
      <button type="button" data-theme-select="system" aria-pressed="false" aria-label="–°–ª–µ–¥–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º">üñ•Ô∏è</button>
      <button type="button" data-theme-select="dark" aria-pressed="false" aria-label="–í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É">üåô</button>
    </div>
    <div class="flex space-between">
      <div>
        <div class="pill">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</div>
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h1>
        <p class="muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã, —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ –±—Ä–µ–Ω–¥–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –ø–æ–ª—è–º. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
      </div>
      <div class="flex" style="gap: 8px">
        <a href="/" title="–ö –¥–∞—à–±–æ—Ä–¥—É">‚üµ –î–∞—à–±–æ—Ä–¥</a>
        <a href="/projects.html" title="–ö —Å–ø–∏—Å–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤">–ü—Ä–æ–µ–∫—Ç—ã ‚Üí</a>
        <button id="toggleView" class="ghost">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü–µ–π</button>
        <button id="newGroup" class="primary">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
      </div>
    </div>

    <div class="card" style="margin: 16px 0">
      <h2 style="margin-top: 0">–§–∏–ª—å—Ç—Ä—ã</h2>
      <div class="grid">
        <label>
          –°—Ç–∞—Ç—É—Å
          <select id="statusFilter">
            <option value="">–í—Å–µ</option>
            <option value="active">–ê–∫—Ç–∏–≤–Ω–∞</option>
            <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</option>
          </select>
        </label>
        <label>
          –ë—Ä–µ–Ω–¥
          <input id="brandFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Haier" />
        </label>
        <label>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø–æ–ª–µ ‚Äî –∫–ª—é—á
          <input id="extraKeyFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–≥–∏–æ–Ω" />
        </label>
        <label>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø–æ–ª–µ ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ
          <input id="extraValueFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, EMEA" />
        </label>
        <label class="flex" style="margin-top: 22px">
          <input id="showArchived" type="checkbox" />
          <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ</span>
        </label>
      </div>
      <div class="toolbar" style="justify-content: flex-end">
        <button id="applyFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button id="resetFilters" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>

    <div id="summary" class="muted" style="margin-bottom: 12px"></div>

    <div id="cardView" class="grid"></div>

    <div id="tableView" class="card" style="display: none">
      <table>
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ë—Ä–µ–Ω–¥—ã</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</th>
          </tr>
        </thead>
        <tbody id="groupRows"></tbody>
      </table>
    </div>

    <div id="details" class="card" style="display: none">
      <h3 style="margin-top: 0">–ö–∞—Ä—Ç–æ—á–∫–∞ –≥—Ä—É–ø–ø—ã</h3>
      <div class="detail-panel" id="detailContent"></div>
    </div>

    <dialog id="groupDialog">
      <div class="dialog-body">
        <div class="flex space-between" style="align-items: start">
          <div>
            <h3 id="dialogTitle" style="margin: 0"></h3>
            <p class="muted" style="margin: 4px 0 0">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ.</p>
          </div>
          <button id="closeDialog" class="ghost">‚úï</button>
        </div>
        <form id="groupForm" class="detail-panel">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ <input name="name" required /></label>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ <textarea name="description" rows="3"></textarea></label>
          <label>
            –°—Ç–∞—Ç—É—Å
            <select name="status">
              <option value="active">–ê–∫—Ç–∏–≤–Ω–∞</option>
              <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</option>
            </select>
          </label>
          <label>–ë—Ä–µ–Ω–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) <input name="brands" placeholder="Haier, Casarte" /></label>
          <div>
            <div class="flex space-between" style="margin-bottom: 6px">
              <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</span>
              <button id="addExtraField" class="ghost" type="button">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
            </div>
            <div id="extraFields"></div>
          </div>
          <div class="flex" style="justify-content: flex-end; margin-top: 8px">
            <button type="button" id="cancelDialog" class="ghost">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </dialog>

    <div id="contextMenu" class="context-menu" hidden>
      <ul id="contextMenuList"></ul>
    </div>

    <script src="/theme.js" defer></script>
    <script>
      const statusFilter = document.getElementById("statusFilter");
      const brandFilter = document.getElementById("brandFilter");
      const extraKeyFilter = document.getElementById("extraKeyFilter");
      const extraValueFilter = document.getElementById("extraValueFilter");
      const showArchived = document.getElementById("showArchived");
      const applyFilters = document.getElementById("applyFilters");
      const resetFilters = document.getElementById("resetFilters");
      const toggleViewBtn = document.getElementById("toggleView");
      const newGroupBtn = document.getElementById("newGroup");
      const summary = document.getElementById("summary");
      const cardView = document.getElementById("cardView");
      const tableView = document.getElementById("tableView");
      const groupRows = document.getElementById("groupRows");
      const detailBlock = document.getElementById("details");
      const detailContent = document.getElementById("detailContent");
      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");
      const filterStorageKey = "hpt-groups-filters";

      const dialog = document.getElementById("groupDialog");
      const dialogTitle = document.getElementById("dialogTitle");
      const groupForm = document.getElementById("groupForm");
      const closeDialogBtn = document.getElementById("closeDialog");
      const cancelDialogBtn = document.getElementById("cancelDialog");
      const extraFields = document.getElementById("extraFields");
      const addExtraFieldBtn = document.getElementById("addExtraField");

      let viewMode = "cards";
      let groups = [];
      let selectedGroupId = null;
      const urlParams = new URLSearchParams(window.location.search);
      const initialGroupId = urlParams.get("group");
      let editingGroupId = null;

      function hideContextMenu() {
        contextMenu.hidden = true;
      }

      function showContextMenu(x, y, actions) {
        contextMenuList.innerHTML = "";
        actions.forEach((action) => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.textContent = action.label;
          btn.addEventListener("click", () => {
            hideContextMenu();
            action.onClick();
          });
          li.appendChild(btn);
          contextMenuList.appendChild(li);
        });
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        contextMenu.hidden = false;
      }

      document.addEventListener("click", hideContextMenu);
      document.addEventListener("contextmenu", (e) => {
        if (!contextMenu.contains(e.target)) return;
        e.preventDefault();
      });

      function renderSummary() {
        const active = groups.filter((g) => g.status === "active").length;
        const archived = groups.filter((g) => g.status === "archived").length;
        summary.textContent = `–ù–∞–π–¥–µ–Ω–æ –≥—Ä—É–ø–ø: ${groups.length}. –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${active}. –ê—Ä—Ö–∏–≤–Ω—ã—Ö: ${archived}.`;
      }

      function renderBrands(list) {
        if (!list || list.length === 0) return "‚Äî";
        return list.map((b) => `<span class="chip">${b}</span>`).join(" ");
      }

      function renderExtra(extra) {
        const entries = Object.entries(extra || {});
        if (entries.length === 0) return "‚Äî";
        return entries
          .map(([k, v]) => `<span class="chip"><strong>${k}:</strong> ${v ?? ""}</span>`)
          .join(" ");
      }

      function renderCardView() {
        cardView.innerHTML = "";
        groups.forEach((group) => {
          const card = document.createElement("div");
          card.className = "card group-card";
          if (group.status === "archived") {
            card.style.opacity = 0.9;
          }
          const title = document.createElement("div");
          title.className = "flex space-between";
          title.innerHTML = `<strong>${group.name}</strong> <span class="badge ${group.status === "archived" ? "archived" : ""}">${
            group.status === "archived" ? "–ê—Ä—Ö–∏–≤" : "–ê–∫—Ç–∏–≤–Ω–∞"
          }</span>`;
          const desc = document.createElement("p");
          desc.className = "muted";
          desc.textContent = group.description || "–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
          const brands = document.createElement("div");
          brands.innerHTML = `<strong>–ë—Ä–µ–Ω–¥—ã:</strong> ${renderBrands(group.brands)}`;
          const extras = document.createElement("div");
          extras.innerHTML = `<strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è:</strong> ${renderExtra(group.extra_fields)}`;
          card.append(title, desc, brands, extras);
          card.addEventListener("click", () => openDetails(group.id));
          card.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            showGroupMenu(e.clientX, e.clientY, group);
          });
          cardView.appendChild(card);
        });
      }

      function renderTableView() {
        groupRows.innerHTML = "";
        groups.forEach((group) => {
          const tr = document.createElement("tr");
          tr.dataset.id = group.id;
          if (group.status === "archived") tr.classList.add("archived");
          tr.innerHTML = `
            <td>${group.name}</td>
            <td>${group.status === "archived" ? "–ê—Ä—Ö–∏–≤" : "–ê–∫—Ç–∏–≤–Ω–∞"}</td>
            <td>${group.brands.join(", ") || "‚Äî"}</td>
            <td>${group.description || "‚Äî"}</td>
            <td>${renderExtra(group.extra_fields)}</td>
          `;
          tr.addEventListener("click", () => openDetails(group.id));
          tr.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            showGroupMenu(e.clientX, e.clientY, group);
          });
          groupRows.appendChild(tr);
        });
      }

      function showGroupMenu(x, y, group) {
        showContextMenu(x, y, [
          { label: "–û—Ç–∫—Ä—ã—Ç—å", onClick: () => openDetails(group.id) },
          { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", onClick: () => openEdit(group) },
          {
            label: group.status === "archived" ? "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å",
            onClick: () => toggleArchive(group),
          },
          { label: "–£–¥–∞–ª–∏—Ç—å", onClick: () => deleteGroup(group) },
        ]);
      }

      function openDetails(id) {
        selectedGroupId = id;
        const group = groups.find((g) => g.id === id);
        if (!group) return;
        detailBlock.style.display = "block";
        detailContent.innerHTML = `
          <div class="flex space-between">
            <div>
              <h4 style="margin: 0">${group.name}</h4>
              <div class="muted">${group.status === "archived" ? "–ê—Ä—Ö–∏–≤–Ω–∞—è" : "–ê–∫—Ç–∏–≤–Ω–∞—è"}</div>
            </div>
            <div class="flex" style="gap: 8px">
              <button class="ghost" onclick="openEditById('${group.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="ghost" onclick="toggleArchiveById('${group.id}')">${
                group.status === "archived" ? "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å"
              }</button>
            </div>
          </div>
          <div><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${group.description || "‚Äî"}</div>
          <div><strong>–ë—Ä–µ–Ω–¥—ã:</strong> ${renderBrands(group.brands)}</div>
          <div><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è:</strong> ${renderExtra(group.extra_fields)}</div>
        `;
      }

      window.openEditById = (id) => {
        const group = groups.find((g) => g.id === id);
        if (group) openEdit(group);
      };

      window.toggleArchiveById = (id) => {
        const group = groups.find((g) => g.id === id);
        if (group) toggleArchive(group);
      };

      function resetExtraFields() {
        extraFields.innerHTML = "";
      }

      function addExtraFieldRow(key = "", value = "") {
        const wrapper = document.createElement("div");
        wrapper.className = "flex";
        wrapper.style.gap = "8px";
        const keyInput = document.createElement("input");
        keyInput.placeholder = "–ö–ª—é—á";
        keyInput.value = key;
        const valueInput = document.createElement("input");
        valueInput.placeholder = "–ó–Ω–∞—á–µ–Ω–∏–µ";
        valueInput.value = value;
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "ghost";
        removeBtn.textContent = "‚úï";
        removeBtn.addEventListener("click", () => wrapper.remove());
        wrapper.append(keyInput, valueInput, removeBtn);
        extraFields.appendChild(wrapper);
      }

      function openCreate() {
        editingGroupId = null;
        dialogTitle.textContent = "–ù–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞";
        groupForm.reset();
        resetExtraFields();
        dialog.showModal();
      }

      function openEdit(group) {
        editingGroupId = group.id;
        dialogTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã";
        groupForm.elements.name.value = group.name;
        groupForm.elements.description.value = group.description || "";
        groupForm.elements.status.value = group.status;
        groupForm.elements.brands.value = group.brands.join(", ");
        resetExtraFields();
        Object.entries(group.extra_fields || {}).forEach(([k, v]) => addExtraFieldRow(k, v));
        dialog.showModal();
      }

      function collectExtraFields() {
        const data = {};
        extraFields.querySelectorAll("div.flex").forEach((row) => {
          const [keyInput, valueInput] = row.querySelectorAll("input");
          const key = keyInput.value.trim();
          if (!key) return;
          data[key] = valueInput.value;
        });
        return data;
      }

      async function submitForm(event) {
        event.preventDefault();
        const formData = new FormData(groupForm);
        const payload = {
          name: formData.get("name"),
          description: formData.get("description") || null,
          status: formData.get("status"),
          brands: (formData.get("brands") || "")
            .split(",")
            .map((b) => b.trim())
            .filter(Boolean),
          extra_fields: collectExtraFields(),
        };

        if (editingGroupId) {
          const existing = groups.find((g) => g.id === editingGroupId);
          const body = { ...existing, ...payload, updated_at: new Date().toISOString() };
          await saveGroup(`/api/groups/${editingGroupId}`, body, "PUT");
        } else {
          await saveGroup("/api/groups", payload, "POST");
        }
        dialog.close();
        await loadGroups();
      }

      async function saveGroup(url, body, method) {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const detail = await res.text();
          alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É. ${detail}`);
        }
      }

      async function toggleArchive(group) {
        const updated = {
          ...group,
          status: group.status === "archived" ? "active" : "archived",
          updated_at: new Date().toISOString(),
        };
        await saveGroup(`/api/groups/${group.id}`, updated, "PUT");
        await loadGroups();
      }

      async function deleteGroup(group) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ¬´${group.name}¬ª? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;
        const res = await fetch(`/api/groups/${group.id}`, { method: "DELETE" });
        if (!res.ok) {
          const detail = await res.text();
          alert(detail || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É.");
          return;
        }
        if (selectedGroupId === group.id) {
          detailBlock.style.display = "none";
        }
        await loadGroups();
      }

      function applyViewMode(mode) {
        viewMode = mode;
        if (viewMode === "cards") {
          cardView.style.display = "grid";
          tableView.style.display = "none";
          toggleViewBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü–µ–π";
        } else {
          cardView.style.display = "none";
          tableView.style.display = "block";
          toggleViewBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∏—Ç–∫–æ–π";
        }
      }

      function toggleView() {
        applyViewMode(viewMode === "cards" ? "table" : "cards");
        persistFilters();
      }

      function resetFiltersState() {
        statusFilter.value = "";
        brandFilter.value = "";
        extraKeyFilter.value = "";
        extraValueFilter.value = "";
        showArchived.checked = false;
      }

      function persistFilters() {
        const state = {
          status: statusFilter.value,
          brand: brandFilter.value.trim(),
          extraKey: extraKeyFilter.value.trim(),
          extraValue: extraValueFilter.value.trim(),
          includeArchived: showArchived.checked,
          viewMode,
        };
        localStorage.setItem(filterStorageKey, JSON.stringify(state));
      }

      function restoreFilters() {
        const raw = localStorage.getItem(filterStorageKey);
        if (!raw) return;
        try {
          const state = JSON.parse(raw) || {};
          statusFilter.value = state.status || "";
          brandFilter.value = state.brand || "";
          extraKeyFilter.value = state.extraKey || "";
          extraValueFilter.value = state.extraValue || "";
          showArchived.checked = !!state.includeArchived;
          applyViewMode(state.viewMode === "table" ? "table" : "cards");
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –≥—Ä—É–ø–ø", e);
          localStorage.removeItem(filterStorageKey);
        }
      }

      async function loadGroups() {
        const params = new URLSearchParams();
        params.set("include_archived", showArchived.checked);
        if (statusFilter.value) params.append("status", statusFilter.value);
        if (brandFilter.value) params.set("brand", brandFilter.value.trim());
        if (extraKeyFilter.value) params.set("extra_key", extraKeyFilter.value.trim());
        if (extraValueFilter.value) params.set("extra_value", extraValueFilter.value.trim());
        const res = await fetch(`/api/groups?${params.toString()}`);
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã");
          return;
        }
        groups = await res.json();
        renderSummary();
        renderCardView();
        renderTableView();
        if (!selectedGroupId && initialGroupId && groups.some((g) => g.id === initialGroupId)) {
          selectedGroupId = initialGroupId;
        }
        if (selectedGroupId) openDetails(selectedGroupId);
      }

      applyFilters.addEventListener("click", () => {
        persistFilters();
        loadGroups();
      });
      resetFilters.addEventListener("click", () => {
        resetFiltersState();
        applyViewMode("cards");
        localStorage.removeItem(filterStorageKey);
        loadGroups();
      });
      toggleViewBtn.addEventListener("click", toggleView);
      newGroupBtn.addEventListener("click", openCreate);
      groupForm.addEventListener("submit", submitForm);
      addExtraFieldBtn.addEventListener("click", () => addExtraFieldRow());
      closeDialogBtn.addEventListener("click", () => dialog.close());
      cancelDialogBtn.addEventListener("click", () => dialog.close());

      applyViewMode(viewMode);
      restoreFilters();
      loadGroups();
    </script>
  </body>
</html>
