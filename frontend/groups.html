<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) =>
          value === "dark" || value === "light" || value === "system" ? value : null;
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî Projects Tracker</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f3f5f9;
        --bg-alt: #eef1f6;
        --surface: #ffffff;
        --surface-muted: #f7f8fc;
        --text: #0f172a;
        --muted: #475569;
        --border: #d9e0ea;
        --divider: rgba(148, 163, 184, 0.35);
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0e1218;
        --bg-alt: #0b1017;
        --surface: #111827;
        --surface-muted: #161f30;
        --text: #e6edf3;
        --muted: #9aa6b6;
        --border: #1f2937;
        --divider: rgba(148, 163, 184, 0.25);
        --shadow: 0 22px 50px rgba(0, 0, 0, 0.5);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        color: var(--text);
      }

      .app-shell {
        max-width: 1280px;
        margin: 0 auto;
        padding: 16px 20px 0;
      }

      .page {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 20px 78px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        position: sticky;
        top: 12px;
        z-index: 5;
      }

      .logo {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: var(--text);
        text-decoration: none;
      }

      .logo img {
        width: 36px;
        height: 36px;
      }

      nav {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      nav a {
        padding: 8px 12px;
        border-radius: 12px;
        text-decoration: none;
        color: var(--text);
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      nav a:hover {
        box-shadow: var(--shadow);
      }

      .nav-dropdown {
        position: relative;
      }

      .nav-dropdown summary {
        list-style: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 12px;
        text-decoration: none;
        color: var(--text);
        border: 1px solid var(--border);
        background: var(--surface-muted);
        cursor: pointer;
        user-select: none;
      }

      .nav-dropdown summary::-webkit-details-marker {
        display: none;
      }

      .nav-dropdown[open] summary {
        box-shadow: var(--shadow);
        background: var(--surface);
      }

      .nav-dropdown-menu {
        position: absolute;
        left: 0;
        top: calc(100% + 8px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 8px;
        display: none;
        flex-direction: column;
        gap: 4px;
        min-width: 200px;
        z-index: 940;
      }

      .nav-dropdown[open] .nav-dropdown-menu {
        display: flex;
      }

      .nav-dropdown-menu a {
        padding: 10px 12px;
        border-radius: 10px;
        text-decoration: none;
        color: var(--text);
        white-space: nowrap;
      }

      .nav-dropdown-menu a:hover {
        background: var(--accent-soft);
        color: var(--accent);
      }

      a {
        color: var(--accent);
      }

      h1 {
        margin: 4px 0 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--surface-muted);
        color: var(--accent);
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid var(--border);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin: 16px 0;
      }

      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 9px 14px;
        border-radius: 12px;
        color: var(--text);
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
        border-color: var(--accent);
        color: #fff;
        font-weight: 700;
        box-shadow: 0 12px 30px rgba(16, 163, 127, 0.2);
      }

      button.ghost {
        background: transparent;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }

      .filters-card {
        margin: 18px 0;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 14px;
      }

      .filters-grid .form-field input,
      .filters-grid .form-field select,
      .filters-grid .form-field textarea {
        width: auto;
        min-width: 0;
      }

      .filter-actions {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .filter-actions .filter-trigger {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .badge-dot {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        padding: 2px 6px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--text);
        font-size: 12px;
        border: 1px solid var(--border);
        font-weight: 700;
      }

      .filter-buttons {
        display: inline-flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .filter-panel {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        z-index: 1100;
      }

      .filter-panel[hidden] {
        display: none;
      }

      .filter-panel .backdrop {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.38);
      }

      .filter-card {
        position: relative;
        margin: 0 auto;
        width: min(650px, 95vw);
        max-height: 100vh;
        background: var(--surface);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .filter-card header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--divider);
      }

      .filter-card .body {
        padding: 14px 16px 8px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .filter-card .footer {
        padding: 12px 16px;
        border-top: 1px solid var(--divider);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .filter-field label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .filter-field .row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .group-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 18px;
      }

      @media (max-width: 1080px) {
        .group-grid {
          grid-template-columns: 1fr;
        }
      }

      .group-card {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 12px;
        align-items: stretch;
      }

      .group-cover {
        width: 140px;
        height: 140px;
        border-radius: 12px;
        object-fit: cover;
        background: var(--surface-muted);
        border: 1px solid var(--border);
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: var(--surface-muted);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        background: var(--accent-soft);
        color: var(--text);
      }

      .badge.archived {
        background: rgba(248, 113, 113, 0.15);
        color: #dc2626;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
      }

      th {
        color: var(--muted);
        letter-spacing: 0.01em;
        font-weight: 600;
      }

      .table-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      tr.archived {
        background: var(--surface-muted);
        color: var(--muted);
      }

      label {
        display: grid;
        gap: 6px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font: inherit;
        background: var(--surface-muted);
        color: var(--text);
      }

      .form-dialog input,
      .form-dialog textarea,
      .form-dialog select {
        width: auto;
        min-width: 0;
      }

      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310a37f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        padding-right: 40px;
      }

      .form-field {
        display: grid;
        gap: 6px;
      }

      .checkbox {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        cursor: pointer;
      }

      .checkbox input {
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 6px;
        border: 2px solid var(--border);
        background: var(--surface);
        transition: border-color 0.2s ease, background-color 0.2s ease;
      }

      .checkbox input:checked {
        border-color: var(--accent);
        background-color: var(--accent-soft);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310a37f' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='5 13 10 17 19 7'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 14px;
      }

      .checkbox input:focus {
        outline: 2px solid var(--accent-soft);
        outline-offset: 2px;
      }

      .flex {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .group-projects {
        margin-top: 16px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
      }

      .group-project-card {
        display: grid;
        grid-template-columns: 96px 1fr;
        gap: 10px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--surface-muted);
        align-items: center;
      }

      .group-project-cover {
        width: 96px;
        height: 96px;
        object-fit: cover;
        border-radius: 10px;
        background: var(--surface);
        border: 1px solid var(--border);
      }

      .group-project-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 6px;
      }

      .space-between {
        justify-content: space-between;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--surface-muted);
        border-radius: 999px;
        font-size: 0.9rem;
      }

      .chip.warn {
        background: rgba(248, 113, 113, 0.15);
        color: #dc2626;
      }

      .muted {
        color: var(--muted);
      }

      dialog {
        border: none;
        border-radius: 14px;
        padding: 0;
        box-shadow: var(--shadow);
        background: var(--surface);
        color: var(--text);
        width: 100%;
        max-width: min(920px, 95vw);
      }

      dialog::backdrop {
        background: rgba(15, 23, 42, 0.45);
      }

      .dialog-body {
        padding: 20px;
        min-width: 520px;
        display: grid;
        gap: 16px;
      }

      .dialog-body.large {
        min-width: min(780px, 90vw);
      }

      .context-menu {
        position: fixed;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        min-width: 200px;
        z-index: 1000;
        padding: 8px 0;
      }

      .context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu li {
        padding: 8px 14px;
      }

      .context-menu li:hover {
        background: var(--accent-soft);
      }

      .context-menu button {
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
        padding: 0;
        font: inherit;
        cursor: pointer;
      }

      .detail-panel {
        margin-top: 16px;
        display: grid;
        gap: 8px;
      }

      .theme-menu {
        position: relative;
      }

      .theme-menu summary {
        list-style: none;
        display: grid;
        place-items: center;
        padding: 6px;
        min-width: 38px;
        min-height: 38px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        cursor: pointer;
        user-select: none;
      }

      .theme-menu summary::-webkit-details-marker {
        display: none;
      }

      .theme-menu[open] summary {
        box-shadow: var(--shadow);
        background: var(--surface);
      }

      .theme-menu-dropdown {
        position: absolute;
        right: 0;
        top: calc(100% + 8px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 6px;
        display: none;
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
        width: max-content;
        z-index: 1200;
      }

      .theme-menu[open] .theme-menu-dropdown {
        display: flex;
      }

      .theme-menu-dropdown button {
        border: none;
        background: transparent;
        color: var(--text);
        text-align: left;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: center;
        min-width: 0;
      }

      .theme-menu-dropdown button:hover,
      .theme-menu-dropdown button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .site-footer {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 20px 48px;
        text-align: center;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div class="topbar">
        <a class="logo" href="/index.html" aria-label="Projects Tracker">
          <img src="/favicon.svg" alt="Projects Tracker" />
          <div>Projects Tracker</div>
        </a>
        <nav aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <a href="/index.html">–î–∞—à–±–æ—Ä–¥</a>
          <a href="/groups.html">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</a>
          <a href="/projects.html">–ü—Ä–æ–µ–∫—Ç—ã</a>
          <a href="/priority-tasks.html">–í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
          <details class="nav-dropdown">
            <summary>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</summary>
            <div class="nav-dropdown-menu" role="menu" aria-label="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã">
              <a href="/templates.html" role="menuitem">–®–∞–±–ª–æ–Ω—ã</a>
              <a href="/characteristics-board.html" role="menuitem">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</a>
            </div>
          </details>
          <details class="theme-menu">
            <summary aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
              <span aria-hidden="true">üåó</span>
              <span class="theme-menu-label" data-theme-state>–¢–µ–º–∞</span>
            </summary>
            <div class="theme-menu-dropdown" role="menu" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
              <button type="button" role="menuitem" data-theme-select="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="system">üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è</button>
              <button type="button" role="menuitem" data-theme-select="dark">üåô –¢—ë–º–Ω–∞—è</button>
            </div>
          </details>
        </nav>
      </div>
    </div>
    <div class="page">
      <div class="flex space-between" style="align-items: baseline">
        <div>
          <div class="pill">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</div>
          <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h1>
          <p class="muted" style="margin: 0">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã, —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ –±—Ä–µ–Ω–¥–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –ø–æ–ª—è–º. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
        </div>
        <div class="flex" style="gap: 10px; align-items: center">
          <button id="toggleView" class="ghost">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü–µ–π</button>
          <button id="newGroup" class="primary">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
        </div>
      </div>

      <div class="card filters-card">
        <h2 style="margin: 0">–§–∏–ª—å—Ç—Ä—ã</h2>
        <div class="filters-grid">
          <label class="form-field">
            –°—Ç–∞—Ç—É—Å
            <select id="statusFilter">
              <option value="">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω–∞</option>
              <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</option>
            </select>
          </label>
          <label class="form-field">
            –ë—Ä–µ–Ω–¥
            <input id="brandFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Haier" />
          </label>
          <label class="form-field">
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø–æ–ª–µ ‚Äî –∫–ª—é—á
            <input id="extraKeyFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–≥–∏–æ–Ω" />
          </label>
          <label class="form-field">
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø–æ–ª–µ ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ
            <input id="extraValueFilter" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, EMEA" />
          </label>
        </div>
        <div class="filter-actions">
          <label class="checkbox">
            <input id="showArchived" type="checkbox" />
            <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ</span>
          </label>
          <div class="filter-trigger">
            <button id="openCustomFilters" class="ghost">–§–∏–ª—å—Ç—Ä—ã</button>
            <span id="customFiltersBadge" class="badge-dot" hidden>0</span>
          </div>
          <div class="filter-buttons">
            <button id="applyFilters" class="primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <button id="resetFilters" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <div id="summary" class="muted" style="margin-bottom: 12px"></div>

      <div id="cardView" class="group-grid"></div>

    <div id="tableView" class="card" style="display: none">
      <table>
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ë—Ä–µ–Ω–¥—ã</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="groupRows"></tbody>
      </table>
    </div>

    <div id="details" class="card" style="display: none">
      <h3 style="margin-top: 0">–ö–∞—Ä—Ç–æ—á–∫–∞ –≥—Ä—É–ø–ø—ã</h3>
      <div class="detail-panel" id="detailContent"></div>
    </div>

    <dialog id="groupDialog" class="form-dialog">
      <div class="dialog-body">
        <div class="flex space-between" style="align-items: start">
          <div>
            <h3 id="dialogTitle" style="margin: 0"></h3>
            <p class="muted" style="margin: 4px 0 0">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ.</p>
          </div>
          <button id="closeDialog" class="ghost">‚úï</button>
        </div>
        <form id="groupForm" class="detail-panel">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ <input name="name" required /></label>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ <textarea name="description" rows="3"></textarea></label>
          <label>
            –°—Ç–∞—Ç—É—Å
            <select name="status">
              <option value="active">–ê–∫—Ç–∏–≤–Ω–∞</option>
              <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</option>
            </select>
          </label>
          <label>–ë—Ä–µ–Ω–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) <input name="brands" placeholder="Haier, Casarte" /></label>
          <div>
            <div class="flex space-between" style="margin-bottom: 6px">
              <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</span>
              <button id="addExtraField" class="ghost" type="button">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
            </div>
            <div id="extraFields"></div>
          </div>
          <div class="flex" style="justify-content: flex-end; margin-top: 8px">
            <button type="button" id="cancelDialog" class="ghost">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </dialog>

    <dialog id="groupQuickView">
      <div class="dialog-body large">
        <div class="flex space-between" style="align-items: start">
          <div>
            <h3 id="quickViewTitle" style="margin: 0"></h3>
            <p id="quickViewSubtitle" class="muted" style="margin: 4px 0 0"></p>
          </div>
          <button id="closeQuickView" class="ghost" aria-label="–ó–∞–∫—Ä—ã—Ç—å –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">‚úï</button>
        </div>
        <div id="quickViewContent" class="detail-panel"></div>
      </div>
    </dialog>

    <div id="contextMenu" class="context-menu" hidden>
      <ul id="contextMenuList"></ul>
    </div>

    <div id="customFilterPanel" class="filter-panel" hidden>
      <div class="backdrop" aria-hidden="true"></div>
      <div class="filter-card">
        <header>
          <div>
            <p class="pill" style="margin: 0 0 4px">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</p>
            <strong>–§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø–æ–ª—è–º</strong>
          </div>
          <button id="closeCustomFilters" class="ghost" aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">‚úï</button>
        </header>
        <div class="body" id="customFilterFields"></div>
        <div class="footer">
          <button id="resetCustomFilters" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button id="applyCustomFilters" class="primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    </div>

    <script src="/theme.js" defer></script>
    <script>
      const statusFilter = document.getElementById("statusFilter");
      const brandFilter = document.getElementById("brandFilter");
      const extraKeyFilter = document.getElementById("extraKeyFilter");
      const extraValueFilter = document.getElementById("extraValueFilter");
      const showArchived = document.getElementById("showArchived");
      const applyFilters = document.getElementById("applyFilters");
      const resetFilters = document.getElementById("resetFilters");
      const toggleViewBtn = document.getElementById("toggleView");
      const newGroupBtn = document.getElementById("newGroup");
      const summary = document.getElementById("summary");
      const cardView = document.getElementById("cardView");
      const tableView = document.getElementById("tableView");
      const groupRows = document.getElementById("groupRows");
      const quickViewDialog = document.getElementById("groupQuickView");
      const quickViewContent = document.getElementById("quickViewContent");
      const quickViewTitle = document.getElementById("quickViewTitle");
      const quickViewSubtitle = document.getElementById("quickViewSubtitle");
      const closeQuickViewBtn = document.getElementById("closeQuickView");
      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");
      const openCustomFiltersBtn = document.getElementById("openCustomFilters");
      const closeCustomFiltersBtn = document.getElementById("closeCustomFilters");
      const applyCustomFiltersBtn = document.getElementById("applyCustomFilters");
      const resetCustomFiltersBtn = document.getElementById("resetCustomFilters");
      const customFilterPanel = document.getElementById("customFilterPanel");
      const customFilterFields = document.getElementById("customFilterFields");
      const customFiltersBadge = document.getElementById("customFiltersBadge");
      const filterStorageKey = "hpt-groups-filters";

      const dialog = document.getElementById("groupDialog");
      const dialogTitle = document.getElementById("dialogTitle");
      const groupForm = document.getElementById("groupForm");
      const closeDialogBtn = document.getElementById("closeDialog");
      const cancelDialogBtn = document.getElementById("cancelDialog");
      const extraFields = document.getElementById("extraFields");
      const addExtraFieldBtn = document.getElementById("addExtraField");

      let viewMode = "cards";
      let groups = [];
      let projects = [];
      const groupsCacheKey = "hpt-group-cache-v2";
      let selectedGroupId = null;
      const urlParams = new URLSearchParams(window.location.search);
      const initialGroupId = urlParams.get("group");
      let editingGroupId = null;
      let groupFilterMeta = [];
      let customFieldFilters = [];
      const coverPlaceholder =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
          `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200' fill='none'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%2310a37f'/><stop offset='1' stop-color='%2319b88f'/></linearGradient></defs><rect width='200' height='200' rx='20' fill='%23101827'/><rect x='16' y='16' width='168' height='168' rx='18' fill='%230d1521' stroke='url(%23g)' stroke-width='4'/><text x='100' y='110' fill='%2319b88f' font-family='Inter,Segoe UI,Arial' font-size='44' font-weight='800' text-anchor='middle'>HPT</text></svg>`
        );

      function hideContextMenu() {
        contextMenu.hidden = true;
      }

      function showContextMenu(x, y, actions) {
        contextMenuList.innerHTML = "";
        actions.forEach((action) => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.textContent = action.label;
          btn.addEventListener("click", () => {
            hideContextMenu();
            action.onClick();
          });
          li.appendChild(btn);
          contextMenuList.appendChild(li);
        });
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        contextMenu.hidden = false;
      }

      document.addEventListener("click", hideContextMenu);
      document.addEventListener("contextmenu", (e) => {
        if (!contextMenu.contains(e.target)) return;
        e.preventDefault();
      });

      function renderSummary() {
        const active = groups.filter((g) => g.status === "active").length;
        const archived = groups.filter((g) => g.status === "archived").length;
        summary.textContent = `–ù–∞–π–¥–µ–Ω–æ –≥—Ä—É–ø–ø: ${groups.length}. –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${active}. –ê—Ä—Ö–∏–≤–Ω—ã—Ö: ${archived}.`;
      }

      function renderBrands(list) {
        if (!list || list.length === 0) return "‚Äî";
        return list.map((b) => `<span class="chip">${b}</span>`).join(" ");
      }

      function renderExtra(extra) {
        const entries = Object.entries(extra || {});
        if (entries.length === 0) return "‚Äî";
        return entries
          .map(([k, v]) => `<span class="chip"><strong>${k}:</strong> ${v ?? ""}</span>`)
          .join(" ");
      }

      function renderGroupsState() {
        renderSummary();
        renderCardView();
        renderTableView();
        if (!selectedGroupId && initialGroupId && groups.some((g) => g.id === initialGroupId)) {
          selectedGroupId = initialGroupId;
        }
        if (selectedGroupId) openDetails(selectedGroupId);
      }

      function hydrateGroupsFromCache() {
        const cached = localStorage.getItem(groupsCacheKey);
        if (!cached) return;
        try {
          groups = JSON.parse(cached);
          renderGroupsState();
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–µ—à –≥—Ä—É–ø–ø", e);
          groups = [];
        }
      }

      function groupProjects(groupId) {
        return projects.filter((p) => p.group_id === groupId);
      }

      function projectCoverUrl(project) {
        const images = project.images || [];
        const cover = images.find((i) => i.is_cover) || images[0];
        return cover ? `/api/projects/${project.id}/images/${cover.id}/download` : null;
      }

      function groupCoverUrl(groupId) {
        const related = groupProjects(groupId);
        for (const project of related) {
          const cover = projectCoverUrl(project);
          if (cover) return cover;
        }
        return null;
      }

      function projectStageProgress(project) {
        const stages = project.gtm_stages || [];
        if (!stages.length) return 0;
        const done = stages.filter((s) => s.status === "done").length;
        return Math.round((done / stages.length) * 100);
      }

      function hasOverdue(project) {
        const today = new Date();
        const overdueStage = (project.gtm_stages || []).some(
          (s) => s.planned_end && ["done", "cancelled"].indexOf(s.status) === -1 && new Date(s.planned_end) < today
        );
        const overdueTask = (project.tasks || []).some(
          (t) => t.due_date && t.status !== "done" && new Date(t.due_date) < today
        );
        return overdueStage || overdueTask;
      }

      function groupStats(groupId) {
        const related = groupProjects(groupId);
        const total = related.length;
        const active = related.filter((p) => p.status === "active").length;
        const closed = related.filter((p) => p.status === "closed").length;
        const archived = related.filter((p) => p.status === "archived").length;
        const overdue = related.filter((p) => hasOverdue(p)).length;
        const avgProgress = total
          ? Math.round(related.reduce((acc, p) => acc + projectStageProgress(p), 0) / total)
          : 0;
        const completion = total ? Math.round((closed / total) * 100) : 0;
        return { total, active, closed, archived, overdue, avgProgress, completion };
      }

      function renderCardView() {
        cardView.innerHTML = "";
        groups.forEach((group) => {
          const card = document.createElement("div");
          card.className = "card group-card";
          if (group.status === "archived") {
            card.style.opacity = 0.9;
          }
          const related = groupProjects(group.id);
          const stats = groupStats(group.id);
          const cover = groupCoverUrl(group.id);
          card.innerHTML = `
            <div>
              <img class="group-cover" src="${cover || coverPlaceholder}" alt="–û–±–ª–æ–∂–∫–∞ –≥—Ä—É–ø–ø—ã" />
              <div class="muted" style="margin-top: 6px; font-size: 0.85rem">${
                related.length ? `–ü—Ä–æ–µ–∫—Ç–æ–≤: ${related.length}` : "–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤"
              }</div>
            </div>
            <div class="flex" style="gap: 10px; flex-direction: column; align-items: flex-start;">
              <div class="flex space-between" style="width: 100%; align-items: start">
                <div>
                  <h3 style="margin: 0">${group.name}</h3>
                  <p class="muted" style="margin: 2px 0 0">${group.description || "–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ"}</p>
                </div>
                <span class="badge ${group.status === "archived" ? "archived" : ""}">${
                  group.status === "archived" ? "–ê—Ä—Ö–∏–≤" : "–ê–∫—Ç–∏–≤–Ω–∞"
                }</span>
              </div>
              <div class="flex" style="gap: 6px; flex-wrap: wrap; width: 100%">
                <span class="chip">–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${stats.active}</span>
                <span class="chip">–ó–∞–∫—Ä—ã—Ç—ã—Ö: ${stats.closed}</span>
                <span class="chip">–ê—Ä—Ö–∏–≤: ${stats.archived}</span>
                <span class="chip">–ü—Ä–æ—Å—Ä–æ—á–∫–∏: ${stats.overdue}</span>
              </div>
              <div class="flex" style="gap: 6px; flex-wrap: wrap; width: 100%">
                <span class="chip">–ë—Ä–µ–Ω–¥—ã:</span> ${renderBrands(group.brands)}
              </div>
              <div class="flex" style="gap: 6px; flex-wrap: wrap; width: 100%">
                <span class="chip">–ü–æ–ª—è:</span> ${renderExtra(group.extra_fields)}
              </div>
              <div style="width: 100%">
                <div class="progress-bar"><div class="progress-fill" style="width:${stats.avgProgress}%"></div></div>
                <small class="muted">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å GTM: ${stats.avgProgress}% ¬∑ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${stats.completion}%</small>
              </div>
              <div class="flex" style="gap: 8px; width: 100%; justify-content: flex-end">
                <button class="ghost" data-action="details">–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                <button class="ghost" data-action="open-projects">–ü–µ—Ä–µ–π—Ç–∏ –≤ –≥—Ä—É–ø–ø—É</button>
              </div>
            </div>
          `;
          card.addEventListener("click", () => {
            window.location.href = `/projects.html?group_id=${group.id}`;
          });
          card.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            showGroupMenu(e.clientX, e.clientY, group);
          });
          card.querySelector("button[data-action='details']").addEventListener("click", (e) => {
            e.stopPropagation();
            openDetails(group.id);
          });
          card.querySelector("button[data-action='open-projects']").addEventListener("click", (e) => {
            e.stopPropagation();
            window.location.href = `/projects.html?group_id=${group.id}`;
          });
          cardView.appendChild(card);
        });
      }

      function renderTableView() {
        groupRows.innerHTML = "";
        groups.forEach((group) => {
          const tr = document.createElement("tr");
          tr.dataset.id = group.id;
          if (group.status === "archived") tr.classList.add("archived");
          tr.innerHTML = `
            <td>${group.name}</td>
            <td>${group.status === "archived" ? "–ê—Ä—Ö–∏–≤" : "–ê–∫—Ç–∏–≤–Ω–∞"}</td>
            <td>${group.brands.join(", ") || "‚Äî"}</td>
            <td>${group.description || "‚Äî"}</td>
            <td>${renderExtra(group.extra_fields)}</td>
            <td>
              <div class="table-actions">
                <button data-action="open">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</button>
                <button data-action="projects">–ü—Ä–æ–µ–∫—Ç—ã</button>
              </div>
            </td>
          `;
          tr.addEventListener("click", () => openDetails(group.id));
          tr.querySelector("button[data-action='open']").addEventListener("click", (e) => {
            e.stopPropagation();
            openDetails(group.id);
          });
          tr.querySelector("button[data-action='projects']").addEventListener("click", (e) => {
            e.stopPropagation();
            window.location.href = `/projects.html?group_id=${group.id}`;
          });
          tr.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            showGroupMenu(e.clientX, e.clientY, group);
          });
          groupRows.appendChild(tr);
        });
      }

      function showGroupMenu(x, y, group) {
        showContextMenu(x, y, [
          { label: "–û—Ç–∫—Ä—ã—Ç—å", onClick: () => openDetails(group.id) },
          { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", onClick: () => openEdit(group) },
          {
            label: group.status === "archived" ? "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å",
            onClick: () => toggleArchive(group),
          },
          { label: "–£–¥–∞–ª–∏—Ç—å", onClick: () => deleteGroup(group) },
        ]);
      }

      function openDetails(id) {
        selectedGroupId = id;
        const group = groups.find((g) => g.id === id);
        if (!group) return;
        const related = groupProjects(group.id);
        const stats = groupStats(group.id);
        quickViewTitle.textContent = group.name;
        quickViewSubtitle.textContent = `${group.status === "archived" ? "–ê—Ä—Ö–∏–≤–Ω–∞—è" : "–ê–∫—Ç–∏–≤–Ω–∞—è"} ¬∑ –ü—Ä–æ–µ–∫—Ç–æ–≤: ${related.length}`;
        const projectsBlock =
          related.length === 0
            ? '<p class="muted" style="margin:8px 0 0">–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>'
            : `<div class="group-projects">${related
                .map((project) => {
                  const cover = projectCoverUrl(project);
                  const progress = projectStageProgress(project);
                  const overdue = hasOverdue(project);
                  return `
                    <div class="group-project-card">
                      <img class="group-project-cover" src="${cover || coverPlaceholder}" alt="–û–±–ª–æ–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞" />
                      <div>
                        <div class="flex space-between" style="align-items:flex-start">
                          <div>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
                              <strong>${project.name}</strong>
                              <span class="chip">${project.market || "–†—ã–Ω–æ–∫ –Ω–µ —É–∫–∞–∑–∞–Ω"}</span>
                              ${project.priority ? `<span class="chip">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${project.priority}</span>` : ""}
                            </div>
                            <div class="muted" style="margin-top:2px">–ì—Ä—É–ø–ø–∞: ${group.name} ¬∑ –ë—Ä–µ–Ω–¥: ${project.brand || "‚Äî"}</div>
                          </div>
                          <span class="badge ${project.status === "archived" ? "archived" : project.status === "closed" ? "closed" : ""}">
                            ${project.status === "archived" ? "–ê—Ä—Ö–∏–≤" : project.status === "closed" ? "–ó–∞–∫—Ä—ã—Ç" : "–ê–∫—Ç–∏–≤–µ–Ω"}
                          </span>
                        </div>
                        <div class="progress-bar" style="margin:8px 0 4px"><div class="progress-fill" style="width:${progress}%"></div></div>
                        <div class="muted" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                          <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%</span>
                          ${overdue ? '<span class="chip warn">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–∫–∏</span>' : ""}
                          ${project.created_at ? `<span>–°–æ–∑–¥–∞–Ω: ${project.created_at.slice(0, 10)}</span>` : ""}
                        </div>
                        <div class="group-project-actions">
                          <button class="ghost" data-action="project-card" data-project-id="${project.id}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ–µ–∫—Ç</button>
                          <button class="ghost" data-action="project-list" data-project-id="${project.id}">–û—Ç–∫—Ä—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ</button>
                        </div>
                      </div>
                    </div>`;
                })
                .join("")}</div>`;
        quickViewContent.innerHTML = `
          <div class="card" style="padding:16px">
            <div class="flex" style="gap: 10px; flex-wrap: wrap">
              <span class="chip">–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${stats.active}</span>
              <span class="chip">–ó–∞–∫—Ä—ã—Ç—ã—Ö: ${stats.closed}</span>
              <span class="chip">–ê—Ä—Ö–∏–≤: ${stats.archived}</span>
              <span class="chip">–ü—Ä–æ—Å—Ä–æ—á–∫–∏: ${stats.overdue}</span>
            </div>
            <div style="margin-top: 12px">
              <div class="progress-bar"><div class="progress-fill" style="width:${stats.avgProgress}%"></div></div>
              <small class="muted">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å GTM: ${stats.avgProgress}% ¬∑ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${stats.completion}%</small>
            </div>
            <div class="detail-panel" style="margin-top: 12px">
              <div><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${group.description || "‚Äî"}</div>
              <div><strong>–ë—Ä–µ–Ω–¥—ã:</strong> ${renderBrands(group.brands)}</div>
              <div><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è:</strong> ${renderExtra(group.extra_fields)}</div>
            </div>
            <div class="flex" style="gap: 8px; flex-wrap: wrap; justify-content: flex-end; margin-top: 12px">
              <button class="ghost" data-action="edit-group">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="ghost" data-action="toggle-archive">${group.status === "archived" ? "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å"}</button>
              <button class="primary" data-action="open-group-projects">–ü–µ—Ä–µ–π—Ç–∏ –≤ –≥—Ä—É–ø–ø—É</button>
            </div>
          </div>
          <h4 style="margin:16px 0 8px">–ü—Ä–æ–µ–∫—Ç—ã –≥—Ä—É–ø–ø—ã</h4>
          ${projectsBlock}
        `;
        if (!quickViewDialog.open) {
          quickViewDialog.showModal();
        }
        const editBtn = quickViewContent.querySelector('[data-action="edit-group"]');
        if (editBtn) {
          editBtn.addEventListener("click", () => openEdit(group));
        }
        const toggleBtn = quickViewContent.querySelector('[data-action="toggle-archive"]');
        if (toggleBtn) {
          toggleBtn.addEventListener("click", () => toggleArchive(group));
        }
        const openGroupBtn = quickViewContent.querySelector('[data-action="open-group-projects"]');
        if (openGroupBtn) {
          openGroupBtn.addEventListener("click", () => {
            window.location.href = `/projects.html?group_id=${group.id}`;
          });
        }
        quickViewContent.querySelectorAll('[data-action="project-card"]').forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            window.location.href = `/project.html?id=${btn.dataset.projectId}`;
          });
        });
        quickViewContent.querySelectorAll('[data-action="project-list"]').forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            window.location.href = `/projects.html?id=${btn.dataset.projectId}`;
          });
        });
      }

      function resetExtraFields() {
        extraFields.innerHTML = "";
      }

      function addExtraFieldRow(key = "", value = "") {
        const wrapper = document.createElement("div");
        wrapper.className = "flex";
        wrapper.style.gap = "8px";
        const keyInput = document.createElement("input");
        keyInput.placeholder = "–ö–ª—é—á";
        keyInput.value = key;
        const valueInput = document.createElement("input");
        valueInput.placeholder = "–ó–Ω–∞—á–µ–Ω–∏–µ";
        valueInput.value = value;
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "ghost";
        removeBtn.textContent = "‚úï";
        removeBtn.addEventListener("click", () => wrapper.remove());
        wrapper.append(keyInput, valueInput, removeBtn);
        extraFields.appendChild(wrapper);
      }

      function openCreate() {
        editingGroupId = null;
        dialogTitle.textContent = "–ù–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞";
        groupForm.reset();
        resetExtraFields();
        dialog.showModal();
      }

      function openEdit(group) {
        editingGroupId = group.id;
        dialogTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã";
        groupForm.elements.name.value = group.name;
        groupForm.elements.description.value = group.description || "";
        groupForm.elements.status.value = group.status;
        groupForm.elements.brands.value = group.brands.join(", ");
        resetExtraFields();
        Object.entries(group.extra_fields || {}).forEach(([k, v]) => addExtraFieldRow(k, v));
        dialog.showModal();
      }

      function collectExtraFields() {
        const data = {};
        extraFields.querySelectorAll("div.flex").forEach((row) => {
          const [keyInput, valueInput] = row.querySelectorAll("input");
          const key = keyInput.value.trim();
          if (!key) return;
          data[key] = valueInput.value;
        });
        return data;
      }

      async function submitForm(event) {
        event.preventDefault();
        const formData = new FormData(groupForm);
        const payload = {
          name: formData.get("name"),
          description: formData.get("description") || null,
          status: formData.get("status"),
          brands: (formData.get("brands") || "")
            .split(",")
            .map((b) => b.trim())
            .filter(Boolean),
          extra_fields: collectExtraFields(),
        };

        if (editingGroupId) {
          const existing = groups.find((g) => g.id === editingGroupId);
          const body = { ...existing, ...payload, updated_at: new Date().toISOString() };
          await saveGroup(`/api/groups/${editingGroupId}`, body, "PUT");
        } else {
          await saveGroup("/api/groups", payload, "POST");
        }
        dialog.close();
        await loadGroups();
      }

      async function saveGroup(url, body, method) {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const detail = await res.text();
          alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É. ${detail}`);
        }
      }

      async function toggleArchive(group) {
        const updated = {
          ...group,
          status: group.status === "archived" ? "active" : "archived",
          updated_at: new Date().toISOString(),
        };
        await saveGroup(`/api/groups/${group.id}`, updated, "PUT");
        await loadGroups();
      }

      async function deleteGroup(group) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ¬´${group.name}¬ª? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;
        const res = await fetch(`/api/groups/${group.id}`, { method: "DELETE" });
        if (!res.ok) {
          const detail = await res.text();
          alert(detail || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É.");
          return;
        }
        if (selectedGroupId === group.id && quickViewDialog.open) {
          quickViewDialog.close();
        }
        await loadGroups();
      }

      function applyViewMode(mode) {
        viewMode = mode;
        if (viewMode === "cards") {
          cardView.style.display = "grid";
          tableView.style.display = "none";
          toggleViewBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü–µ–π";
        } else {
          cardView.style.display = "none";
          tableView.style.display = "block";
          toggleViewBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∏—Ç–∫–æ–π";
        }
      }

      function toggleView() {
        applyViewMode(viewMode === "cards" ? "table" : "cards");
        persistFilters();
      }

      function resetFiltersState() {
        statusFilter.value = "";
        brandFilter.value = "";
        extraKeyFilter.value = "";
        extraValueFilter.value = "";
        showArchived.checked = false;
        customFieldFilters = [];
        updateCustomFiltersBadge();
      }

      function persistFilters() {
        const state = {
          status: statusFilter.value,
          brand: brandFilter.value.trim(),
          extraKey: extraKeyFilter.value.trim(),
          extraValue: extraValueFilter.value.trim(),
          includeArchived: showArchived.checked,
          viewMode,
          customFilters: customFieldFilters,
        };
        localStorage.setItem(filterStorageKey, JSON.stringify(state));
      }

      function restoreFilters() {
        const raw = localStorage.getItem(filterStorageKey);
        if (!raw) return;
        try {
          const state = JSON.parse(raw) || {};
          statusFilter.value = state.status || "";
          brandFilter.value = state.brand || "";
          extraKeyFilter.value = state.extraKey || "";
          extraValueFilter.value = state.extraValue || "";
          showArchived.checked = !!state.includeArchived;
          applyViewMode(state.viewMode === "table" ? "table" : "cards");
          if (Array.isArray(state.customFilters)) {
            customFieldFilters = state.customFilters;
            updateCustomFiltersBadge();
          }
        } catch (e) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –≥—Ä—É–ø–ø", e);
          localStorage.removeItem(filterStorageKey);
        }
      }

      function updateCustomFiltersBadge() {
        const count = customFieldFilters.length;
        if (count > 0) {
          customFiltersBadge.hidden = false;
          customFiltersBadge.textContent = count;
        } else {
          customFiltersBadge.hidden = true;
        }
      }

      async function loadGroupFilterMeta(force = false) {
        if (groupFilterMeta.length && !force) return;
        try {
          const res = await fetch("/api/groups/custom-fields/filters");
          if (!res.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –≥—Ä—É–ø–ø");
          groupFilterMeta = await res.json();
        } catch (err) {
          console.warn(err);
          groupFilterMeta = [];
        }
        customFieldFilters = customFieldFilters.filter((f) =>
          groupFilterMeta.some((m) => m.field_id === f.field_id)
        );
        updateCustomFiltersBadge();
      }

      function renderGroupCustomFilters() {
        customFilterFields.innerHTML = "";
        groupFilterMeta.forEach((meta) => {
          const wrap = document.createElement("div");
          wrap.className = "filter-field";
          wrap.dataset.fieldId = meta.field_id;
          const preset = customFieldFilters.find((f) => f.field_id === meta.field_id) || {};
          const label = document.createElement("label");
          label.textContent = meta.label_ru || meta.field_id;
          wrap.appendChild(label);

          if (meta.type === "number") {
            const row = document.createElement("div");
            row.className = "row";
            const from = document.createElement("input");
            from.type = "number";
            from.className = "inline-input";
            from.placeholder = "–û—Ç";
            from.value = preset.value_from ?? "";
            const to = document.createElement("input");
            to.type = "number";
            to.className = "inline-input";
            to.placeholder = "–î–æ";
            to.value = preset.value_to ?? "";
            row.append(from, to);
            wrap.appendChild(row);
          } else if (meta.type === "select" || meta.type === "enum") {
            const select = document.createElement("select");
            select.multiple = true;
            select.size = Math.min(6, (meta.options || []).length || 4);
            select.className = "inline-input";
            (meta.options || []).forEach((opt) => {
              const option = document.createElement("option");
              option.value = opt.value;
              option.textContent = `${opt.value} (${opt.count})`;
              if ((preset.values || []).includes(opt.value)) option.selected = true;
              select.appendChild(option);
            });
            wrap.appendChild(select);
          } else if (meta.type === "checkbox" || meta.type === "boolean") {
            const select = document.createElement("select");
            select.className = "inline-input";
            [
              { value: "", label: "–õ—é–±–æ–µ" },
              { value: "true", label: "–î–∞" },
              { value: "false", label: "–ù–µ—Ç" },
            ].forEach((opt) => {
              const option = document.createElement("option");
              option.value = opt.value;
              option.textContent = opt.label;
              if (
                (preset.bool === true && opt.value === "true") ||
                (preset.bool === false && opt.value === "false") ||
                (preset.bool === undefined && opt.value === "")
              ) {
                option.selected = true;
              }
              select.appendChild(option);
            });
            wrap.appendChild(select);
          } else if (meta.type === "date") {
            const row = document.createElement("div");
            row.className = "row";
            const from = document.createElement("input");
            from.type = "date";
            from.className = "inline-input";
            from.placeholder = "–û—Ç";
            from.value = preset.date_from ?? "";
            const to = document.createElement("input");
            to.type = "date";
            to.className = "inline-input";
            to.placeholder = "–î–æ";
            to.value = preset.date_to ?? "";
            row.append(from, to);
            wrap.appendChild(row);
          } else {
            const input = document.createElement("input");
            input.className = "inline-input";
            input.placeholder = "–°–æ–¥–µ—Ä–∂–∏—Ç‚Ä¶";
            input.value = preset.value || "";
            wrap.appendChild(input);
          }

          customFilterFields.appendChild(wrap);
        });
      }

      function collectGroupFiltersFromUi() {
        const filters = [];
        groupFilterMeta.forEach((meta) => {
          const block = customFilterFields.querySelector(`[data-field-id="${meta.field_id}"]`);
          if (!block) return;
          if (meta.type === "number") {
            const [from, to] = block.querySelectorAll("input");
            const value_from = from.value ? Number(from.value) : null;
            const value_to = to.value ? Number(to.value) : null;
            if (value_from !== null || value_to !== null) {
              filters.push({ field_id: meta.field_id, type: "number", value_from, value_to });
            }
          } else if (meta.type === "select" || meta.type === "enum") {
            const select = block.querySelector("select");
            const values = Array.from(select.selectedOptions).map((o) => o.value);
            if (values.length) filters.push({ field_id: meta.field_id, type: "select", values });
          } else if (meta.type === "checkbox" || meta.type === "boolean") {
            const select = block.querySelector("select");
            if (select.value === "true") filters.push({ field_id: meta.field_id, type: "checkbox", bool: true });
            else if (select.value === "false") filters.push({ field_id: meta.field_id, type: "checkbox", bool: false });
          } else if (meta.type === "date") {
            const [from, to] = block.querySelectorAll("input");
            const date_from = from.value || null;
            const date_to = to.value || null;
            if (date_from || date_to) filters.push({ field_id: meta.field_id, type: "date", date_from, date_to });
          } else {
            const input = block.querySelector("input");
            if (input.value.trim()) filters.push({ field_id: meta.field_id, type: "text", value: input.value.trim() });
          }
        });
        return filters;
      }

      async function openCustomFilters() {
        try {
          await loadGroupFilterMeta();
          renderGroupCustomFilters();
          customFilterPanel.hidden = false;
        } catch (err) {
          alert(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã");
        }
      }

      function closeCustomFilters() {
        customFilterPanel.hidden = true;
      }

      async function loadProjectsForStats() {
        const res = await fetch("/api/projects?include_archived=true");
        if (!res.ok) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏");
          return;
        }
        projects = await res.json();
      }

      async function loadGroups() {
        try {
          await loadGroupFilterMeta();
          await loadProjectsForStats();
          const payload = {
            include_archived: showArchived.checked,
            statuses: statusFilter.value ? [statusFilter.value] : [],
            brand: brandFilter.value.trim() || null,
            extra_key: extraKeyFilter.value.trim() || null,
            extra_value: extraValueFilter.value.trim() || null,
            filters: customFieldFilters,
          };
          const res = await fetch(`/api/groups/search`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã");
            if (groups.length) {
              renderGroupsState();
            }
            return;
          }
          groups = await res.json();
          localStorage.setItem(groupsCacheKey, JSON.stringify(groups));
          renderGroupsState();
        } catch (err) {
          console.error(err);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã");
          hydrateGroupsFromCache();
        }
      }

      applyFilters.addEventListener("click", () => {
        persistFilters();
        loadGroups();
      });
      resetFilters.addEventListener("click", () => {
        resetFiltersState();
        applyViewMode("cards");
        localStorage.removeItem(filterStorageKey);
        loadGroups();
      });
      openCustomFiltersBtn.addEventListener("click", openCustomFilters);
      closeCustomFiltersBtn.addEventListener("click", closeCustomFilters);
      customFilterPanel.querySelector(".backdrop").addEventListener("click", closeCustomFilters);
      applyCustomFiltersBtn.addEventListener("click", () => {
        customFieldFilters = collectGroupFiltersFromUi();
        updateCustomFiltersBadge();
        persistFilters();
        closeCustomFilters();
        loadGroups();
      });
      resetCustomFiltersBtn.addEventListener("click", () => {
        customFieldFilters = [];
        renderGroupCustomFilters();
        updateCustomFiltersBadge();
        persistFilters();
      });
      toggleViewBtn.addEventListener("click", toggleView);
      newGroupBtn.addEventListener("click", openCreate);
      groupForm.addEventListener("submit", submitForm);
      addExtraFieldBtn.addEventListener("click", () => addExtraFieldRow());
      closeDialogBtn.addEventListener("click", () => dialog.close());
      cancelDialogBtn.addEventListener("click", () => dialog.close());
      closeQuickViewBtn.addEventListener("click", () => quickViewDialog.close());
      quickViewDialog.addEventListener("close", () => {
        selectedGroupId = null;
      });

      applyViewMode(viewMode);
      restoreFilters();
      hydrateGroupsFromCache();
      loadGroups();
    </script>
    <footer class="site-footer">
      <small>Made by Smuk Marian / 2025</small>
    </footer>
  </body>
</html>
