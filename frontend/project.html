<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="/theme.js" defer></script>
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) =>
          value === "dark" || value === "light" || value === "system" ? value : null;
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî Projects Tracker</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f3f5f9;
        --bg-alt: #eef1f6;
        --surface: #ffffff;
        --surface-muted: #f7f8fc;
        --text: #0f172a;
        --muted: #475569;
        --border: #d9e0ea;
        --divider: rgba(148, 163, 184, 0.35);
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
        --warning: #f59e0b;
        --flag-important-bg: #ffe6ef;
        --flag-important-text: #a80738;
        --flag-important-border: #ffb3c9;
        --flag-urgent-bg: #fff2e0;
        --flag-urgent-text: #b54708;
        --flag-urgent-border: #f5c997;
        --flag-risk-bg: #fff7d6;
        --flag-risk-text: #92400e;
        --flag-risk-border: #f4ce6a;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0e1218;
        --bg-alt: #0b1017;
        --surface: #111827;
        --surface-muted: #161f30;
        --text: #e6edf3;
        --muted: #9aa6b6;
        --border: #1f2937;
        --divider: rgba(148, 163, 184, 0.25);
        --shadow: 0 22px 50px rgba(0, 0, 0, 0.5);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
        --warning: #fbbf24;
        --flag-important-bg: rgba(255, 99, 150, 0.16);
        --flag-important-text: #ff9cbf;
        --flag-important-border: rgba(255, 99, 150, 0.5);
        --flag-urgent-bg: rgba(255, 183, 77, 0.18);
        --flag-urgent-text: #ffddb0;
        --flag-urgent-border: rgba(255, 183, 77, 0.5);
        --flag-risk-bg: rgba(250, 204, 21, 0.15);
        --flag-risk-text: #ffe79a;
        --flag-risk-border: rgba(250, 204, 21, 0.6);
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        color: var(--text);
      }

      .app-shell {
        max-width: 1280px;
        margin: 0 auto;
        padding: 14px 18px 0;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        position: sticky;
        top: 12px;
        z-index: 900;
      }

      .logo {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: var(--text);
        text-decoration: none;
      }

      .logo img {
        width: 36px;
        height: 36px;
      }

      nav {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      nav a {
        padding: 8px 12px;
        border-radius: 12px;
        text-decoration: none;
        color: var(--text);
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      nav a:hover {
        box-shadow: var(--shadow);
      }

      .page {
        max-width: 1240px;
        margin: 0 auto;
        padding: 32px 20px 88px;
      }

      a {
        color: var(--accent);
      }

      h1 {
        margin: 4px 0 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--surface-muted);
        color: var(--accent);
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid var(--border);
      }

      .inline-chip-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        color: inherit;
        cursor: pointer;
      }

      .inline-chip-btn:hover,
      .inline-chip-btn:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .inline-edit-input {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px 10px;
        background: var(--surface);
        color: inherit;
      }

      .inline-edit-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 18px 18px 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 16px;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        background: var(--accent-soft);
        color: var(--text);
      }

      .badge.archived {
        background: rgba(248, 113, 113, 0.15);
        color: #dc2626;
      }

      .badge.closed {
        background: var(--surface-muted);
        color: var(--text);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 12px;
      }

      .toolbar.stage-toolbar {
        margin-top: 0;
        margin-bottom: 16px;
      }

      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 9px 14px;
        border-radius: 12px;
        color: var(--text);
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
        border-color: var(--accent);
        color: #fff;
        font-weight: 700;
        box-shadow: 0 12px 30px rgba(16, 163, 127, 0.2);
      }

      button.ghost {
        background: transparent;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      label {
        display: grid;
        gap: 6px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font: inherit;
        background: var(--surface-muted);
        color: var(--text);
      }

      textarea {
        resize: vertical;
      }

      .grid-two {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }

      .table-scroll {
        overflow-x: auto;
      }

      .view-switch {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .view-switch button {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        padding: 6px 12px;
        cursor: pointer;
      }

      .view-switch button.active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
        font-weight: 600;
      }

      .gtm-shell {
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: linear-gradient(135deg, var(--surface) 0%, var(--surface-muted) 100%);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 16px;
      }

      .gtm-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }

      .gtm-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
        background: var(--surface);
        border: 1px dashed var(--divider);
        border-radius: 12px;
        padding: 12px;
      }

      .gtm-meta-tile {
        display: grid;
        gap: 4px;
      }

      .gtm-meta-tile strong {
        font-size: 1.05rem;
      }

      .stage-card {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 12px;
        background: radial-gradient(circle at 12% 20%, var(--surface-muted) 0, var(--surface) 35%);
        box-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
      }

      .stage-card.collapsed {
        padding-bottom: 8px;
      }

      .stage-card.collapsed .stage-description,
      .stage-card.collapsed .stage-progress,
      .stage-card.collapsed .stage-meta-grid,
      .stage-card.collapsed .stage-controls,
      .stage-card.collapsed .stage-task-list,
      .stage-card.collapsed .stage-info-row {
        display: none;
      }

      .stage-header {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
      }

      .stage-title-line {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .stage-rank {
        width: 36px;
        height: 36px;
        display: grid;
        place-items: center;
        border-radius: 12px;
        background: var(--accent-soft);
        color: var(--accent);
        font-weight: 800;
        border: 1px solid var(--accent);
        box-shadow: inset 0 0 0 2px rgba(16, 163, 127, 0.12);
      }

      .stage-heading {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .stage-heading .muted {
        font-size: 0.92rem;
      }

      .stage-info-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-top: 8px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: var(--surface-muted);
        border-radius: 8px;
        font-size: 0.85rem;
        border: 1px solid transparent;
      }

      .chip.pill {
        border-radius: 999px;
        background: var(--surface);
        border-color: var(--border);
        padding: 6px 12px;
        font-weight: 600;
      }

      .stage-stat {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 140px;
        padding: 6px 10px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--divider);
      }

      .stage-stat strong {
        font-size: 1rem;
      }

      .stage-dates {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
        margin-top: 8px;
      }

      .stage-dates .chip {
        border-style: dashed;
        font-weight: 600;
        background: var(--surface);
      }

      .chip.warn {
        background: var(--flag-risk-bg);
        color: var(--flag-risk-text);
        border-color: var(--flag-risk-border);
        font-weight: 600;
      }

      .flag-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 600;
        border: 1px solid transparent;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .flag-important {
        background: var(--flag-important-bg);
        color: var(--flag-important-text);
        border-color: var(--flag-important-border);
      }

      .flag-urgent {
        background: var(--flag-urgent-bg);
        color: var(--flag-urgent-text);
        border-color: var(--flag-urgent-border);
      }

      .flag-risk {
        background: var(--flag-risk-bg);
        color: var(--flag-risk-text);
        border-color: var(--flag-risk-border);
      }

      .stage-description {
        margin-top: 4px;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .stage-description.empty {
        font-style: italic;
      }

      .stage-progress {
        margin-top: 10px;
      }

      .stage-meta-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .stage-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 12px;
        align-items: center;
      }

      .stage-task-list {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid var(--divider);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .compact-toolbar {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
        margin-bottom: 8px;
      }

      .compact-toolbar .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        color: var(--text);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .filter-chip strong {
        font-weight: 700;
      }

      .filter-chip.active {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: var(--accent-strong);
        box-shadow: 0 4px 14px rgba(16, 163, 127, 0.18);
      }

      .compact-toolbar-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
      }

      .pill-input {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      .pill-input input {
        border: none;
        outline: none;
        background: transparent;
      }

      .pill-input input::placeholder {
        color: var(--muted);
      }

      .compact-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 640px;
      }

      .compact-table th,
      .compact-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        vertical-align: top;
      }

      .compact-table th {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
        background: var(--surface-muted);
      }

      .compact-table tbody tr:nth-child(even) {
        background: rgba(148, 163, 184, 0.08);
      }

      .compact-table .chip {
        margin-right: 4px;
      }

      .table-actions {
        display: inline-flex;
        gap: 6px;
        flex-wrap: initial;
      }

      .compact-row-title {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .priority-bar {
        position: relative;
        padding-inline-start: 12px;
      }

      .priority-bar::before {
        content: "";
        position: absolute;
        inset: 2px auto 2px 0;
        width: 6px;
        border-radius: 999px;
        background: var(--divider);
      }

      .priority-high::before {
        background: linear-gradient(180deg, #f97316, #ea580c);
      }

      .priority-medium::before {
        background: linear-gradient(180deg, #22c55e, #16a34a);
      }

      .priority-low::before {
        background: linear-gradient(180deg, #0ea5e9, #0284c7);
      }

      .compact-actions-inline {
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .micro-progress {
        position: relative;
        height: 8px;
        border-radius: 999px;
        background: var(--surface-muted);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .micro-progress span {
        position: absolute;
        inset: 0;
        display: block;
        border-radius: inherit;
        background: linear-gradient(90deg, var(--accent), var(--accent-strong));
        transition: width 0.2s ease;
      }

      .micro-progress.warn span {
        background: linear-gradient(90deg, #f97316, #ea580c);
      }

      .micro-progress.danger span {
        background: linear-gradient(90deg, #ef4444, #dc2626);
      }

      .tag-mini {
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--surface-muted);
        border: 1px solid var(--border);
        font-size: 0.82rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .tag-mini.positive {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent-strong);
      }

      .tag-mini.warn {
        background: var(--flag-urgent-bg);
        border-color: var(--flag-urgent-border);
        color: var(--flag-urgent-text);
      }

      .tag-mini.negative {
        background: var(--flag-risk-bg);
        border-color: var(--flag-risk-border);
        color: var(--flag-risk-text);
      }

      .icon-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border: none;
        border-radius: 8px;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease;
      }

      .icon-button:hover {
        background: var(--surface-muted);
        color: var(--text);
      }

      .icon-button.danger {
        color: var(--danger);
      }

      .kanban-board {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 6px;
      }

      .kanban-column {
        flex: 1;
        min-width: 220px;
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 14px;
        display: flex;
        flex-direction: column;
      }

      .kanban-column-header {
        padding: 12px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .kanban-column-body {
        padding: 0 12px 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 160px;
      }

      .kanban-column.drop-ready {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-soft);
      }

      .kanban-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        cursor: grab;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .kanban-card.dragging {
        opacity: 0.6;
      }

      .kanban-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .kanban-empty {
        font-size: 0.85rem;
        color: var(--muted);
        font-style: italic;
      }

      .stage-task-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .task-card.compact {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: var(--surface-muted);
      }

      .task-inline-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .icon-button {
        border-radius: 999px;
        width: 34px;
        height: 34px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        font-size: 0.9rem;
      }

      .icon-button:hover {
        background: var(--surface);
      }

      .comment-trigger {
        min-width: 48px;
        padding: 0 12px;
        justify-content: center;
        gap: 6px;
      }

      .comment-trigger .count {
        font-weight: 700;
      }

      .comment-block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .checkbox-lite {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        font-weight: 600;
      }

      .checkbox-lite input {
        accent-color: var(--accent);
        width: 18px;
        height: 18px;
      }

      .comment-block {
        margin-top: 14px;
        padding: 16px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: var(--surface);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .comment-list {
        list-style: none;
        padding: 0;
        margin: 0 0 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #discussionList {
        max-height: 45vh;
        overflow-y: auto;
        padding-right: 4px;
      }

      .discussion-body {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .comment-item {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      .comment-editor {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .comment-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .muted {
        color: var(--muted);
        font-size: 0.95rem;
      }

      .context-menu {
        position: absolute;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        padding: 6px 0;
        display: none;
        z-index: 20;
      }

      .context-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
        min-width: 200px;
      }

      .context-menu li {
        padding: 10px 14px;
        cursor: pointer;
      }

      .context-menu li:hover {
        background: var(--accent-soft);
      }

      .context-menu li.disabled {
        color: var(--muted);
        cursor: not-allowed;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .modal {
        background: var(--surface);
        padding: 20px;
        border-radius: 14px;
        width: min(640px, 92vw);
        max-height: 90vh;
        overflow: auto;
        box-shadow: var(--shadow);
      }

      .modal.modal-wide {
        width: min(820px, 96vw);
      }

      .modal.modal-tall {
        width: min(820px, 96vw);
        max-height: 80vh;
      }

      .modal-heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }

      .modal h3 {
        margin: 0 0 10px;
      }

      .modal form {
        display: grid;
        gap: 10px;
      }

      .modal form label {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .modal form input,
      .modal form select,
      .modal form textarea {
        width: auto;
        min-width: 0;
      }

      .modal form .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }

      .task-flags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .flag-checkbox {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        font-weight: 600;
      }

      .flag-checkbox input {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
      }

      .flag-select {
        flex: 1;
        min-width: 220px;
      }

      .modal form .checkbox-row {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        font-weight: 600;
      }

      .modal .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        flex-wrap: wrap;
        margin-top: 4px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }

      th,
      td {
        border: 1px solid var(--border);
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: var(--surface-muted);
        font-weight: 700;
      }

      .inline-input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px 8px;
        background: var(--surface-muted);
        color: var(--text-primary);
        min-height: 36px;
        resize: vertical;
      }

      .inline-input:focus {
        outline: 2px solid var(--accent);
        background: var(--surface);
      }

      .inline-checkbox {
        width: 20px;
        height: 20px;
      }

      .inline-status {
        font-size: 0.85rem;
        color: var(--muted);
      }

      tr.saving td {
        background: color-mix(in srgb, var(--accent-soft) 40%, transparent);
      }

      tr.save-error td {
        background: color-mix(in srgb, #ef4444 18%, transparent);
      }

      .task-card {
        position: relative;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px 14px 12px;
        background: linear-gradient(135deg, var(--surface) 0%, var(--surface-muted) 90%);
        margin-bottom: 14px;
        box-shadow: var(--shadow);
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      }

      .task-card::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        padding: 1px;
        background: linear-gradient(120deg, rgba(16, 163, 127, 0.28), rgba(59, 130, 246, 0.18));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }

      .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.18);
      }

      .task-card.task-highlight {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.2), 0 16px 32px rgba(15, 23, 42, 0.18);
      }

      .task-card.collapsed .task-details,
      .task-card.collapsed .task-inline-actions,
      .task-card.collapsed .task-description,
      .task-card.collapsed .subtasks,
      .task-card.collapsed .subtask-inline,
      .task-card.collapsed .task-meta-grid {
        display: none;
      }

      .task-head {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
      }

      .task-title-block {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .task-rank {
        min-width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        background: var(--surface);
        border: 1px dashed var(--border);
        font-weight: 700;
      }

      .task-top-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .task-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 8px 0;
      }

      .task-description {
        color: var(--muted);
        font-size: 0.94rem;
        margin-bottom: 4px;
      }

      .task-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 6px;
      }

      .task-meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px;
        margin: 8px 0;
      }

      .task-meta-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 10px;
        border-radius: 10px;
        background: var(--surface);
        border: 1px solid var(--border);
        font-size: 0.92rem;
      }

      .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: var(--surface-muted);
        border-radius: 10px;
        font-size: 0.85rem;
      }

      .status-chip.todo {
        background: #eef2ff;
        color: #312e81;
      }

      .status-chip.in_progress {
        background: #e0f2fe;
        color: #075985;
      }

      .status-chip.done {
        background: #ecfdf3;
        color: #166534;
      }

      .task-board {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }

      .task-column {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        background: var(--surface);
      }

      .tag {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 4px 8px;
        border-radius: 8px;
        background: var(--surface-muted);
        font-size: 0.85rem;
      }

      .tag.due-overdue {
        background: #fef2f2;
        color: #991b1b;
      }

      .tag.due-soon {
        background: #fffbeb;
        color: #92400e;
      }

      .subtasks {
        margin-top: 10px;
        padding-left: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .subtasks li {
        list-style: none;
        margin: 0;
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--surface-muted);
        border: 1px solid var(--border);
      }

      .subtasks li input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
      }

      .subtask-title {
        flex: 1;
        padding: 4px 6px;
        border-radius: 6px;
        min-height: 20px;
      }

      .subtask-actions {
        display: flex;
        gap: 6px;
      }

      .subtask-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 6px;
      }

      .inline-input,
      .inline-textarea,
      .inline-select {
        width: 100%;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
      }

      .inline-textarea {
        min-height: 34px;
        resize: vertical;
      }

      .filters-card {
        margin: 8px 0 14px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--surface-muted);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filters-card .actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .checkbox-lite {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }

      .checkbox-lite input {
        width: 16px;
        height: 16px;
        accent-color: var(--accent);
      }

      .progress-line {
        width: 100%;
        height: 6px;
        background: var(--surface-muted);
        border-radius: 999px;
        overflow: hidden;
      }

      .progress-line .fill {
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
      }

      .rich-editor {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--surface);
      }

      .rich-editor-toolbar {
        display: flex;
        gap: 6px;
        padding: 6px;
        border-bottom: 1px solid var(--border);
        background: var(--surface-muted);
      }

      .rich-editor-toolbar button {
        border: 1px solid var(--border);
        padding: 4px 8px;
        border-radius: 8px;
        background: var(--surface);
      }

      .rich-editor-area {
        padding: 8px;
        min-height: 60px;
        border-top: 1px solid var(--border);
      }

      .rich-editor-area:empty:before {
        content: attr(data-placeholder);
        color: var(--muted);
      }

      .rich-editor.compact {
        box-shadow: none;
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      .rich-editor.compact .rich-editor-toolbar {
        border-radius: 8px 8px 0 0;
      }

      .rich-editor.compact .rich-editor-area {
        min-height: 70px;
        border: none;
        border-top: 1px solid var(--border);
      }

      .comment-list {
        margin: 10px 0 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 10px;
      }

      .comment-item {
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .comment-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .comment-editor {
        margin-top: 8px;
      }

      .history-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 6px;
      }

      .history-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--surface);
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px;
      }

      @media (max-width: 1200px) {
        .gallery-grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }

      @media (max-width: 980px) {
        .gallery-grid {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }

      @media (max-width: 720px) {
        .gallery-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .image-card {
        position: relative;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: var(--surface);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-soft);
        content-visibility: auto;
        contain-intrinsic-size: 280px 320px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .image-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .image-thumb {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        background: var(--surface-muted);
        display: block;
        cursor: pointer;
      }

      .image-meta {
        padding: 8px 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .image-card .toolbar {
        gap: 6px;
        flex-wrap: wrap;
      }

      .cover-chip {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--accent);
        color: #fff;
        padding: 4px 8px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.75rem;
        box-shadow: var(--shadow);
      }

      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1500;
        padding: 24px;
      }

      .lightbox[data-open="true"] {
        display: flex;
      }

      .lightbox-content {
        position: relative;
        max-width: min(1080px, 90vw);
        max-height: 90vh;
        background: var(--surface);
        border-radius: 16px;
        padding: 12px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .lightbox img {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 12px;
        object-fit: contain;
        background: var(--surface-muted);
      }

      .lightbox .lightbox-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .lightbox .nav-buttons {
        display: flex;
        gap: 8px;
      }

      .file-table {
        width: 100%;
        border-collapse: collapse;
      }

      .file-table th,
      .file-table td {
        border-bottom: 1px solid var(--border);
        padding: 10px 8px;
        text-align: left;
      }

      .theme-menu {
        position: relative;
      }

      .theme-menu summary {
        list-style: none;
        display: grid;
        place-items: center;
        min-width: 38px;
        min-height: 38px;
        padding: 6px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        cursor: pointer;
        user-select: none;
      }

      .theme-menu summary::-webkit-details-marker {
        display: none;
      }

      .theme-menu[open] summary {
        box-shadow: var(--shadow);
        background: var(--surface);
      }

      .theme-menu-dropdown {
        position: absolute;
        right: 0;
        top: calc(100% + 6px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 6px;
        display: none;
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
        width: max-content;
        z-index: 1200;
      }

      .theme-menu[open] .theme-menu-dropdown {
        display: flex;
      }

      .theme-menu-dropdown button {
        border: none;
        background: transparent;
        color: var(--text);
        text-align: center;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-width: 0;
      }

      .theme-menu-dropdown button:hover,
      .theme-menu-dropdown button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .project-hero {
        display: flex;
        gap: 22px;
        align-items: flex-start;
        align-self: stretch;
      }

      .project-hero-left {
        display: flex;
        flex-direction: column;
        gap: 14px;
        flex: 2 1 520px;
        min-width: 0;
      }

      .project-hero-right {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex: 1 1 320px;
        max-width: 420px;
      }

      .cover-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 14px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
        max-width: 420px;
        width: 100%;
        flex: 1 1 auto;
        align-self: flex-start;
      }

      .title-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .icon-btn {
        width: 38px;
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      .icon-btn:hover {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .cover-frame {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: var(--surface-muted);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-soft);
        width: 100%;
        max-width: 420px;
        min-height: 0;
        padding: 0;
      }

      .cover-frame img {
        display: block;
        width: 100%;
        max-width: 100%;
        height: auto;
        object-fit: contain;
        background: var(--surface-muted);
        margin: 0 auto;
      }

      .cover-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: var(--muted-text);
        text-align: center;
        padding: 20px 16px;
        min-height: 160px;
      }

      .cover-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .cover-actions-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: stretch;
      }

      .cover-actions-row > button {
        flex: 1;
      }

      .cover-actions-row.single {
        justify-content: center;
      }

      .cover-actions-row.single button {
        width: 100%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
      }

      @media (max-width: 1100px) {
        .project-hero {
          flex-direction: column;
        }

        .project-hero-right {
          width: 100%;
          max-width: none;
          align-self: stretch;
        }

        .cover-card,
        .cover-frame {
          max-width: 100%;
          align-self: center;
        }
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
      }

      .meta-tile {
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .meta-tile span {
        color: var(--muted-text);
        font-size: 12px;
      }

      .custom-fields-panel {
        margin-top: 16px;
        border: 1px dashed var(--border);
        border-radius: 14px;
        padding: 12px;
        background: var(--surface-muted);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .custom-fields-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
      }

      .custom-fields-panel-header .muted {
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
      }

      .custom-fields-panel-header strong {
        font-size: 1rem;
      }

      .custom-fields-panel-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .custom-field-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 0;
      }

      .custom-field-chip {
        display: inline-flex;
        flex-direction: column;
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
        min-width: 160px;
      }

      .custom-field-chip span {
        font-size: 12px;
        color: var(--muted-text);
      }

      .custom-fields-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--surface-muted);
      }

      .custom-field-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: flex-end;
      }

      .custom-field-row label {
        flex: 1 1 200px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .custom-field-row input {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--surface);
        font: inherit;
        color: var(--text);
      }

      .custom-field-row button {
        white-space: nowrap;
        height: 40px;
      }

      .custom-field-row-actions {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .custom-field-row .icon-only {
        min-width: 0;
        padding: 8px 10px;
      }

      .progress-shell {
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .risk-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--surface);
        font-weight: 600;
      }

      .risk-chip.warn {
        background: var(--flag-risk-bg);
        color: var(--flag-risk-text);
        border-color: var(--flag-risk-border);
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background: var(--border);
        border-radius: 999px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-strong, #2dd4bf));
        transition: width 0.3s ease;
      }

      .site-footer {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 18px 48px;
        text-align: center;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted-text);
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div class="topbar">
        <a class="logo" href="/index.html" aria-label="Projects Tracker">
          <img src="/favicon.svg" alt="Projects Tracker" />
          <div>Projects Tracker</div>
        </a>
        <nav aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <a href="/index.html">–î–∞—à–±–æ—Ä–¥</a>
          <a href="/groups.html">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</a>
          <a href="/projects.html">–ü—Ä–æ–µ–∫—Ç—ã</a>
          <a href="/priority-tasks.html">–í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏</a>
          <a href="/templates.html">–®–∞–±–ª–æ–Ω—ã</a>
          <details class="theme-menu">
            <summary aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
              <span aria-hidden="true" data-theme-state>üåó</span>
            </summary>
            <div class="theme-menu-dropdown" role="menu" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
              <button type="button" role="menuitem" data-theme-select="light" title="–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">‚òÄÔ∏è</button>
              <button type="button" role="menuitem" data-theme-select="system" title="–°–∏—Å—Ç–µ–º–Ω–∞—è —Ç–µ–º–∞">üñ•Ô∏è</button>
              <button type="button" role="menuitem" data-theme-select="dark" title="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞">üåô</button>
            </div>
          </details>
        </nav>
      </div>
    </div>
    <div class="page">
      <div id="project-card" class="card">
      <div class="project-hero">
        <div class="project-hero-left">
          <div style="display: flex; justify-content: space-between; gap: 12px; align-items: center; flex-wrap: wrap">
            <div>
              <p class="pill">–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</p>
              <div class="title-row">
                <h1 id="project-name" style="margin: 0">–ü—Ä–æ–µ–∫—Ç</h1>
                <button id="edit-basics" class="icon-btn" type="button" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã">‚úèÔ∏è</button>
              </div>
              <div class="flex" style="gap: 8px; align-items: center; flex-wrap: wrap">
                <span class="chip" id="project-short-id">ID ‚Äî</span>
                <button class="ghost" type="button" id="copy-id">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
              </div>
            </div>
            <div id="project-badges" style="display: flex; gap: 8px; flex-wrap: wrap"></div>
          </div>
          <div id="project-meta" class="muted"></div>
          <div class="meta-grid">
            <div class="meta-tile">
              <span>–ì—Ä—É–ø–ø–∞</span>
              <strong id="project-group">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–ë—Ä–µ–Ω–¥</span>
              <strong id="project-brand">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–†—ã–Ω–æ–∫</span>
              <strong id="project-market">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞</span>
              <strong id="project-planned">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞</span>
              <strong id="project-actual">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>MOQ</span>
              <strong id="project-moq">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>Promo (Price)</span>
              <strong id="project-promo">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>RRP (Price)</span>
              <strong id="project-rrp">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>FOB —Ü–µ–Ω–∞</span>
              <strong id="project-fob">‚Äî</strong>
            </div>
          </div>
          <div class="custom-fields-panel" aria-live="polite">
            <div class="custom-fields-panel-header">
              <div>
                <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</div>
                <strong id="custom-fields-summary">–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</strong>
              </div>
              <div class="custom-fields-panel-actions">
                <button class="ghost" type="button" id="add-custom-field">‚ûï –ü–æ–ª–µ</button>
                <button class="ghost" type="button" id="edit-custom-fields">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>
            <div id="project-custom-fields" class="custom-field-badges" aria-live="polite"></div>
          </div>
          <div class="progress-shell">
            <div style="display:flex; justify-content: space-between; align-items:center; gap: 8px; flex-wrap: wrap">
              <div style="display:flex; flex-direction: column; gap: 4px">
                <span class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ GTM-—ç—Ç–∞–ø–∞–º</span>
                <strong id="gtm-progress-label">–ù–µ—Ç —ç—Ç–∞–ø–æ–≤</strong>
              </div>
              <div id="gtm-progress-badge" class="badge">0%</div>
              <div class="risk-chip" id="project-risk">–†–∏—Å–∫–∏: –Ω–µ—Ç</div>
            </div>
            <div class="progress-bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ GTM">
              <div id="gtm-progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <p id="project-desc" class="muted"></p>
          <div class="toolbar" style="gap: 8px; flex-wrap: wrap; margin-top: 4px">
            <button class="ghost" id="open-characteristics">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ‚Üí</button>
          </div>
        </div>
        <div class="project-hero-right">
          <div class="cover-card">
            <div class="cover-frame" id="cover-frame">
              <div id="cover-placeholder" class="cover-placeholder">
                <div style="font-size: 28px">üñºÔ∏è</div>
                <div>–î–æ–±–∞–≤—å—Ç–µ –æ–±–ª–æ–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞</div>
              </div>
              <img id="cover-image" alt="–û–±–ª–æ–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞" style="display: none" />
            </div>
            <div class="cover-actions">
              <div class="cover-actions-row">
                <button class="primary" onclick="triggerCoverUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å / –∑–∞–º–µ–Ω–∏—Ç—å</button>
                <button class="ghost" onclick="clearCover()" id="clear-cover" disabled>–°–Ω—è—Ç—å –æ–±–ª–æ–∂–∫—É</button>
              </div>
              <div class="cover-actions-row single">
                <button class="ghost" onclick="scrollToGallery()">–ì–∞–ª–µ—Ä–µ—è</button>
              </div>
            </div>
            <input type="file" id="coverUpload" accept="image/*" style="display: none" />
          </div>
        </div>
      </div>
    </div>

    

    <div class="card">
      <div class="gtm-shell">
        <div class="stage-header" style="margin-bottom: 8px">
          <div class="stage-title-line">
            <div class="stage-rank" aria-hidden="true">G</div>
            <div class="stage-heading">
              <h2 style="margin: 0">GTM-—ç—Ç–∞–ø—ã</h2>
              <span class="muted">–†–∞–±–æ—á–∏–π –ø–ª–∞–Ω –≤—ã–≤–æ–¥–∞ –ø—Ä–æ–¥—É–∫—Ç–∞, —ç—Ç–∞–ø—ã –∏ –∑–∞–¥–∞—á–∏</span>
            </div>
          </div>
          <div class="view-switch" id="stageViewSwitch" role="group" aria-label="–í–∏–¥ —ç—Ç–∞–ø–æ–≤">
            <button type="button" data-stage-view="cards">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button type="button" data-stage-view="table">–¢–∞–±–ª–∏—Ü–∞</button>
          </div>
        </div>

        <div class="gtm-meta" aria-live="polite">
          <div class="gtm-meta-tile">
            <span class="muted">–≠—Ç–∞–ø–æ–≤ –≤ –ø–ª–∞–Ω–µ</span>
            <strong id="gtm-stage-count">‚Äî</strong>
          </div>
          <div class="gtm-meta-tile">
            <span class="muted">–ó–∞–¥–∞—á–∏ –ø–æ —ç—Ç–∞–ø–∞–º</span>
            <strong id="gtm-task-count">‚Äî</strong>
          </div>
          <div class="gtm-meta-tile">
            <span class="muted">–ì–æ—Ç–æ–≤–æ</span>
            <strong id="gtm-done-count">‚Äî</strong>
          </div>
        </div>

        <div class="gtm-toolbar">
          <div class="toolbar stage-toolbar" style="margin: 0">
            <button class="primary" onclick="openStageForm()">–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø</button>
            <select id="templateSelect"></select>
            <button onclick="applyTemplate()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
            <button onclick="saveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</button>
            <button onclick="triggerImport()">–ò–º–ø–æ—Ä—Ç Excel</button>
            <button onclick="exportStages()">–≠–∫—Å–ø–æ—Ä—Ç Excel</button>
            <input type="file" id="importInput" accept=".xlsx" style="display: none" />
          </div>
        </div>

        <div id="stages"></div>
      </div>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h2>
        <div class="view-switch" id="taskViewSwitch" role="group" aria-label="–í–∏–¥ –∑–∞–¥–∞—á">
          <button type="button" data-task-view="table">–¢–∞–±–ª–∏—Ü–∞</button>
          <button type="button" data-task-view="kanban">–ö–∞–Ω–±–∞–Ω</button>
        </div>
      </div>
      <p class="muted" style="margin-top: 0">
        –ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –∏ –∫–∞–Ω–±–∞–Ω, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤–Ω–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —ç—Ç–∞–ø–æ–≤.
      </p>
      <div class="compact-toolbar">
        <div class="chip-row" id="taskFilterChips">
          <button class="filter-chip" data-filter-group="status" data-value="todo">ToDo</button>
          <button class="filter-chip" data-filter-group="status" data-value="in_progress">–í —Ä–∞–±–æ—Ç–µ</button>
          <button class="filter-chip" data-filter-group="status" data-value="done">–ì–æ—Ç–æ–≤–æ</button>
          <button class="filter-chip" data-filter-group="due" data-value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</button>
          <button class="filter-chip" data-filter-group="due" data-value="soon">7 –¥–Ω–µ–π</button>
          <button class="filter-chip" data-filter-group="flag" data-value="important">–í–∞–∂–Ω–æ</button>
          <button class="filter-chip" data-filter-group="flag" data-value="urgent">–°—Ä–æ—á–Ω–æ</button>
        </div>
        <div class="compact-toolbar-actions">
          <label class="pill-input" for="taskSearchInput">
            <span aria-hidden="true">üîé</span>
            <input id="taskSearchInput" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é" />
          </label>
          <select id="taskStageFilter" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–ø—É"></select>
          <button class="ghost" id="taskResetFilters">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
      <div class="muted" id="taskFilterSummary" style="margin: 4px 0 8px"></div>
      <div id="taskCompactContent" class="table-scroll"></div>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ì–∞–ª–µ—Ä–µ—è –∏ –æ–±–ª–æ–∂–∫–∞</h2>
        <div class="toolbar" style="margin: 0">
          <button class="ghost" onclick="downloadAllImages()">–°–∫–∞—á–∞—Ç—å –≤—Å–µ</button>
          <button class="primary" onclick="triggerImageUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
        </div>
      </div>
      <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –æ–±–ª–æ–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ –º–µ–Ω—é –∏–ª–∏ –∫–Ω–æ–ø–∫—É. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤.</p>
      <div id="gallery" class="gallery-grid"></div>
      <input type="file" id="imageUploadInput" accept="image/*" style="display: none" multiple />
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–§–∞–π–ª—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="openFileModal()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        </div>
      </div>
      <p class="muted">–§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –ø—Ä–∞–≤–æ–∫.</p>
      <table class="file-table">
        <thead>
          <tr>
            <th>–ò–º—è</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="fileTable"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É</h2>
        <div style="display:flex; flex-direction: column; gap: 8px; width: 100%;">
          <div id="projectCommentEditor" class="rich-editor" style="max-width: 640px">
            <div class="rich-editor-toolbar">
              <button type="button" onclick="formatSelection('bold')">B</button>
              <button type="button" onclick="formatSelection('italic')"><em>I</em></button>
              <button type="button" onclick="formatSelection('insertUnorderedList')">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
              <button type="button" onclick="addLinkToSelection()">–°—Å—ã–ª–∫–∞</button>
            </div>
            <div id="projectCommentArea" class="rich-editor-area" contenteditable="true" aria-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –ø—Ä–æ–µ–∫—Ç—É"></div>
          </div>
          <div class="toolbar" style="margin:0; gap: 8px; flex-wrap: wrap; align-items: center;">
            <button class="primary" onclick="addProjectComment()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="ghost" onclick="clearEditor('projectCommentArea')">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </div>
      </div>
      <ul id="projectComments" class="comment-list"></ul>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
        <div class="toolbar" style="margin: 0">
          <button class="ghost" onclick="addHistoryEvent()">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        </div>
      </div>
      <details id="historyAccordion" class="card" style="background: var(--surface-muted); margin: 0">
        <summary style="cursor: pointer; display:flex; align-items:center; gap:6px; font-weight:700">–ò—Å—Ç–æ—Ä–∏—è (—Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</summary>
        <div id="history" style="margin-top: 8px"></div>
      </details>
    </div>

    <div id="lightbox" class="lightbox" data-open="false" aria-label="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
      <div class="lightbox-content">
        <img id="lightboxImage" alt="" />
        <div class="lightbox-actions">
          <div>
            <div id="lightboxTitle" style="font-weight:700"></div>
            <div id="lightboxCaption" class="muted"></div>
          </div>
          <div class="nav-buttons">
            <button class="ghost" onclick="prevLightbox()">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–µ–µ</button>
            <button class="ghost" onclick="nextLightbox()">–°–ª–µ–¥—É—é—â–µ–µ ‚Üí</button>
            <button onclick="closeLightbox()">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <div id="contextMenu" class="context-menu">
      <ul id="contextMenuList"></ul>
    </div>

    <div id="basicsModal" class="modal-backdrop">
      <div class="modal modal-wide">
        <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞</h3>
        <form id="projectBasicsForm">
          <div class="grid-two">
            <label>
              –ù–∞–∑–≤–∞–Ω–∏–µ
              <input id="basicName" required />
            </label>
            <label>
              –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
              <select id="basicGroup" required></select>
            </label>
          </div>
          <div class="grid-two">
            <label>
              –ë—Ä–µ–Ω–¥
              <input id="basicBrand" required />
            </label>
            <label>
              –†—ã–Ω–æ–∫/—Ä–µ–≥–∏–æ–Ω
              <input id="basicMarket" />
            </label>
          </div>
          <div class="grid-two">
            <label>
              –°—Ç–∞—Ç—É—Å
              <select id="basicStatus">
                <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                <option value="closed">–ó–∞–∫—Ä—ã—Ç</option>
                <option value="archived">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω</option>
              </select>
            </label>
            <label>
              –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
              <select id="basicPriority">
                <option value="">–ù–µ –∑–∞–¥–∞–Ω</option>
                <option value="low">–ù–∏–∑–∫–∏–π</option>
                <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              </select>
            </label>
          </div>
          <div class="grid-two">
            <label>
              –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞
              <input type="date" id="basicPlanned" />
            </label>
            <label>
              –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞
              <input type="date" id="basicActual" />
            </label>
          </div>
          <div class="grid-two">
            <label>
              MOQ
              <input type="number" step="0.01" id="basicMoq" />
            </label>
            <label>
              Promo (Price)
              <input type="number" step="0.01" id="basicPromo" />
            </label>
          </div>
          <div class="grid-two">
            <label>
              RRP (Price)
              <input type="number" step="0.01" id="basicRrp" />
            </label>
            <label>
              FOB —Ü–µ–Ω–∞
              <input type="number" step="0.01" id="basicFob" />
            </label>
          </div>
          <label>
            –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            <textarea id="basicShort" rows="2"></textarea>
          </label>
          <label>
            –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            <textarea id="basicFull" rows="4"></textarea>
          </label>
          <div class="custom-fields-form">
            <div style="display:flex; justify-content: space-between; align-items:center; flex-wrap: wrap; gap: 8px">
              <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</strong>
              <button type="button" class="ghost" id="basicAddCustomField">‚ûï –ü–æ–ª–µ</button>
            </div>
            <div id="basicCustomFields"></div>
          </div>
          <div class="modal-actions">
            <button type="button" onclick="closeBasicsModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modal" class="modal-backdrop">
      <div class="modal">
        <h3 id="modalTitle">–≠—Ç–∞–ø</h3>
        <form id="stageForm">
          <input type="hidden" id="stageId" />
          <div class="grid-two">
            <label>
              –ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞
              <input required id="stageTitle" />
            </label>
            <label>
              –ü–æ—Ä—è–¥–æ–∫
              <input type="number" id="stageOrder" min="0" />
            </label>
          </div>
          <label>
            –û–ø–∏—Å–∞–Ω–∏–µ
            <div class="rich-editor compact">
              <div class="rich-editor-toolbar">
                <button type="button" onclick="applyEditorCommand(stageDescriptionArea, 'bold')">B</button>
                <button type="button" onclick="applyEditorCommand(stageDescriptionArea, 'italic')"><em>I</em></button>
                <button type="button" onclick="applyEditorCommand(stageDescriptionArea, 'insertUnorderedList')">‚Ä¢</button>
                <button type="button" onclick="applyEditorCommand(stageDescriptionArea, 'insertOrderedList')">1.</button>
                <button type="button" onclick="addLinkToSelection()">–°—Å—ã–ª–∫–∞</button>
              </div>
              <div id="stageDescriptionArea" class="rich-editor-area" contenteditable="true"></div>
            </div>
          </label>
          <div class="grid-two">
            <label>
              –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
              <input type="date" id="stagePlannedStart" />
            </label>
            <label>
              –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
              <input type="date" id="stagePlannedEnd" />
            </label>
          </div>
          <div class="grid-two">
            <label>
              –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
              <input type="date" id="stageActualEnd" />
            </label>
            <label>
              –°—Ç–∞—Ç—É—Å
              <select id="stageStatus">
                <option value="not_started">–ù–µ –Ω–∞—á–∞—Ç</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
              </select>
            </label>
          </div>
          <label style="display: flex; align-items: center; gap: 8px">
            <input type="checkbox" id="stageRisk" /> –û—Ç–º–µ—Ç–∏—Ç—å —Ä–∏—Å–∫
          </label>
          <div class="modal-actions">
            <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>

      <div id="taskModal" class="modal-backdrop">
        <div class="modal modal-wide">
          <h3 id="taskModalTitle">–ó–∞–¥–∞—á–∞</h3>
          <form id="taskForm">
            <input type="hidden" id="taskId" />
            <div class="form-grid">
              <label>
                –ó–∞–≥–æ–ª–æ–≤–æ–∫
                <input required id="taskTitle" />
              </label>
              <label>
                GTM-—ç—Ç–∞–ø
                <select id="taskGtmStage" required></select>
              </label>
            </div>
            <div class="form-grid">
              <label>
                –°—Ç–∞—Ç—É—Å
                <select id="taskStatus">
                  <option value="todo">ToDo</option>
                  <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                  <option value="done">–ì–æ—Ç–æ–≤–æ</option>
                </select>
              </label>
              <label>
                –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                <input type="date" id="taskDueDate" />
              </label>
            </div>
            <label>
              –û–ø–∏—Å–∞–Ω–∏–µ
              <textarea id="taskDescription" rows="3" placeholder="–î–µ—Ç–∞–ª–∏ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–¥–∞—á–∏"></textarea>
            </label>
            <div class="task-flags-row">
              <label class="flag-checkbox">
                <input type="checkbox" id="taskImportant" />
                <span>–í–∞–∂–Ω–∞—è –∑–∞–¥–∞—á–∞</span>
              </label>
              <label class="flag-select">
                –°—Ä–æ—á–Ω–æ—Å—Ç—å
                <select id="taskUrgency">
                  <option value="normal">–û–±—ã—á–Ω–∞—è</option>
                  <option value="high">–°—Ä–æ—á–Ω–æ</option>
                </select>
              </label>
            </div>
            <div class="modal-actions">
              <button type="button" onclick="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
              <button class="primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>

      <div id="fileModal" class="modal-backdrop">
        <div class="modal modal-wide">
          <h3 id="fileModalTitle">–ù–æ–≤—ã–π —Ñ–∞–π–ª</h3>
          <form id="fileForm">
            <input type="hidden" id="fileId" />
            <label id="fileUploadRow">
              –§–∞–π–ª
              <input type="file" id="fileInput" required />
              <span class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –≤–ª–æ–∂–µ–Ω–∏—è</span>
            </label>
            <label>
              –ò–º—è —Ñ–∞–π–ª–∞
              <input id="fileName" placeholder="–ò–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è" />
            </label>
            <label>
              –û–ø–∏—Å–∞–Ω–∏–µ
              <textarea id="fileDescription" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –∑–∞–º–µ—Ç–∫–∞"></textarea>
            </label>
            <label>
              –ö–∞—Ç–µ–≥–æ—Ä–∏—è
              <input id="fileCategory" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º–∞—Ä–∫–µ—Ç–∏–Ω–≥" />
            </label>
            <div class="modal-actions">
              <button type="button" onclick="closeFileModal()">–û—Ç–º–µ–Ω–∞</button>
              <button class="primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>

      <div id="discussionModal" class="modal-backdrop">
        <div class="modal modal-tall">
          <div class="modal-heading">
            <h3 id="discussionTitle">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <button type="button" class="icon-button" id="closeDiscussionButton" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ">‚úï</button>
          </div>
          <div class="discussion-body">
            <ul id="discussionList" class="comment-list"></ul>
            <div id="discussionComposer"></div>
          </div>
        </div>
      </div>

    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const projectId = params.get("id");
      const focusTaskId = params.get("task");
      const stagesContainer = document.getElementById("stages");
      const templateSelect = document.getElementById("templateSelect");
      const importInput = document.getElementById("importInput");
      const editBasicsBtn = document.getElementById("edit-basics");
      const basicsModal = document.getElementById("basicsModal");
      const taskModal = document.getElementById("taskModal");
      const taskGtmStageSelect = document.getElementById("taskGtmStage");
      const taskFilterChips = document.getElementById("taskFilterChips");
      const taskStageFilter = document.getElementById("taskStageFilter");
      const taskFilterSummary = document.getElementById("taskFilterSummary");
      const taskResetFilters = document.getElementById("taskResetFilters");
      const taskSearchInput = document.getElementById("taskSearchInput");
      const taskUrgencyField = document.getElementById("taskUrgency");
      const discussionModal = document.getElementById("discussionModal");
      const discussionTitle = document.getElementById("discussionTitle");
      const discussionList = document.getElementById("discussionList");
      const discussionComposer = document.getElementById("discussionComposer");
      const closeDiscussionButton = document.getElementById("closeDiscussionButton");
      const stageViewSwitch = document.getElementById("stageViewSwitch");
      const gtmStageCount = document.getElementById("gtm-stage-count");
      const gtmTaskCount = document.getElementById("gtm-task-count");
      const gtmDoneCount = document.getElementById("gtm-done-count");
      const taskViewSwitch = document.getElementById("taskViewSwitch");
      const taskCompactContent = document.getElementById("taskCompactContent");

      const galleryContainer = document.getElementById("gallery");
      const imageUploadInput = document.getElementById("imageUploadInput");
      const fileTable = document.getElementById("fileTable");
      const fileModal = document.getElementById("fileModal");
      const fileModalTitle = document.getElementById("fileModalTitle");
      const fileForm = document.getElementById("fileForm");
      const fileIdField = document.getElementById("fileId");
      const fileInput = document.getElementById("fileInput");
      const fileUploadRow = document.getElementById("fileUploadRow");
      const fileNameInput = document.getElementById("fileName");
      const fileDescriptionInput = document.getElementById("fileDescription");
      const fileCategoryInput = document.getElementById("fileCategory");
      const projectCommentArea = document.getElementById("projectCommentArea");
      const projectCommentsList = document.getElementById("projectComments");
      const historyContainer = document.getElementById("history");
      const historyAccordion = document.getElementById("historyAccordion");
      const lightbox = document.getElementById("lightbox");
      const lightboxImage = document.getElementById("lightboxImage");
      const lightboxTitle = document.getElementById("lightboxTitle");
      const lightboxCaption = document.getElementById("lightboxCaption");

      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");
      const coverImage = document.getElementById("cover-image");
      const coverPlaceholder = document.getElementById("cover-placeholder");
      const coverUploadInput = document.getElementById("coverUpload");
      const clearCoverButton = document.getElementById("clear-cover");
      const gallerySection = document.getElementById("gallery");
      const projectGroupEl = document.getElementById("project-group");
      const projectBrandEl = document.getElementById("project-brand");
      const projectMarketEl = document.getElementById("project-market");
      const projectPlannedEl = document.getElementById("project-planned");
      const projectActualEl = document.getElementById("project-actual");
      const projectMoqEl = document.getElementById("project-moq");
      const projectPromoEl = document.getElementById("project-promo");
      const projectRrpEl = document.getElementById("project-rrp");
      const projectFobEl = document.getElementById("project-fob");
      const projectCustomFieldsEl = document.getElementById("project-custom-fields");
      const projectCustomFieldsSummary = document.getElementById("custom-fields-summary");
      const projectShortChip = document.getElementById("project-short-id");
      const copyIdBtn = document.getElementById("copy-id");
      const basicsForm = document.getElementById("projectBasicsForm");
      const stageDescriptionArea = document.getElementById("stageDescriptionArea");
      const basicName = document.getElementById("basicName");
      const basicGroup = document.getElementById("basicGroup");
      const basicBrand = document.getElementById("basicBrand");
      const basicMarket = document.getElementById("basicMarket");
      const basicStatus = document.getElementById("basicStatus");
      const basicPriority = document.getElementById("basicPriority");
      const basicPlanned = document.getElementById("basicPlanned");
      const basicActual = document.getElementById("basicActual");
      const basicMoq = document.getElementById("basicMoq");
      const basicPromo = document.getElementById("basicPromo");
      const basicRrp = document.getElementById("basicRrp");
      const basicFob = document.getElementById("basicFob");
      const basicShort = document.getElementById("basicShort");
      const basicFull = document.getElementById("basicFull");
      const basicCustomFields = document.getElementById("basicCustomFields");
      const basicAddCustomFieldBtn = document.getElementById("basicAddCustomField");
      const editCustomFieldsBtn = document.getElementById("edit-custom-fields");
      const addCustomFieldBtn = document.getElementById("add-custom-field");
      const openCharacteristicsBtn = document.getElementById("open-characteristics");
      const gtmProgressLabel = document.getElementById("gtm-progress-label");
      const gtmProgressFill = document.getElementById("gtm-progress-fill");
      const gtmProgressBadge = document.getElementById("gtm-progress-badge");
      const projectRiskEl = document.getElementById("project-risk");
      const taskStatusWeight = { not_started: 0, todo: 0, in_progress: 0.5, done: 1, cancelled: 0 };
      const transparentPixel = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
      const scheduleIdle =
        typeof requestIdleCallback === "function"
          ? (cb) => requestIdleCallback(cb, { timeout: 48 })
          : (cb) => setTimeout(() => cb({ timeRemaining: () => 0 }), 16);
      const cancelIdle = typeof cancelIdleCallback === "function" ? cancelIdleCallback : clearTimeout;
      async function maybeCreateBitmap(file) {
        if (typeof createImageBitmap === "function") {
          try {
            return await createImageBitmap(file);
          } catch (err) {
            console.warn("createImageBitmap failed, falling back to Image", err);
          }
        }

        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = reader.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function maybeDownscaleImage(file) {
        if (!file || !file.type?.startsWith("image/")) return file;

        let bitmap;
        try {
          bitmap = await maybeCreateBitmap(file);
        } catch (err) {
          console.warn("Preview decode failed, uploading original", err);
          return file;
        }

        const maxSide = 1600;
        const largestSide = Math.max(bitmap.width || 0, bitmap.height || 0);
        if (!largestSide || (largestSide <= maxSide && file.size <= 5 * 1024 * 1024)) {
          return file;
        }

        const scale = Math.min(1, maxSide / largestSide);
        const targetWidth = Math.max(1, Math.round((bitmap.width || 0) * scale));
        const targetHeight = Math.max(1, Math.round((bitmap.height || 0) * scale));

        const canvas = document.createElement("canvas");
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext("2d", { alpha: true });
        ctx.drawImage(bitmap, 0, 0, targetWidth, targetHeight);

        const originalType = (file.type || "image/jpeg").toLowerCase();
        const isPng = originalType.includes("png");
        const isWebp = originalType.includes("webp");
        const outputType = isPng ? "image/png" : isWebp ? "image/webp" : "image/jpeg";
        const quality = outputType === "image/jpeg" ? 0.82 : undefined;

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, outputType, quality));
        if (!blob || blob.size >= file.size * 0.95) {
          return file;
        }

        const nameWithoutExt = file.name.replace(/\.[^.]+$/, "") || "image";
        const extension = isPng ? "png" : isWebp ? "webp" : "jpg";
        return new File([blob], `${nameWithoutExt}.${extension}`, { type: outputType, lastModified: Date.now() });
      }
      const kanbanStatuses = [
        { key: "todo", label: "ToDo" },
        { key: "in_progress", label: "–í —Ä–∞–±–æ—Ç–µ" },
        { key: "done", label: "–ì–æ—Ç–æ–≤–æ" },
      ];

      let project = null;
      let groupInfo = null;
      let gtmTemplates = [];
      let gtmStages = [];
      let tasks = [];
      let groups = [];
      let images = [];
      let lightboxOrder = [];
      let lightboxIndex = 0;
      let galleryObserver = null;
      let files = [];
      let projectComments = [];
      let historyEvents = [];
      const stageViewKey = "hpt_stage_view_mode";
      const taskViewKey = "hpt_task_view_mode";
      const collapsedStagesKey = "hpt_collapsed_stages";
      const collapsedTasksKey = "hpt_collapsed_tasks";
      let stageViewMode = localStorage.getItem(stageViewKey) === "table" ? "table" : "cards";
      let taskViewMode = localStorage.getItem(taskViewKey) === "kanban" ? "kanban" : "table";
      let collapsedStages = new Set();
      let collapsedTasks = new Set();
      const taskFilterState = {
        statuses: new Set(),
        due: new Set(),
        flags: { important: false, urgent: false },
        stageId: "",
        search: "",
      };
      try {
        const storedStages = JSON.parse(localStorage.getItem(collapsedStagesKey) || "[]");
        if (Array.isArray(storedStages)) {
          collapsedStages = new Set(storedStages);
        }
      } catch (error) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö —ç—Ç–∞–ø–æ–≤", error);
        collapsedStages = new Set();
      }
      try {
        const storedCollapsed = JSON.parse(localStorage.getItem(collapsedTasksKey) || "[]");
        if (Array.isArray(storedCollapsed)) {
          collapsedTasks = new Set(storedCollapsed);
        }
      } catch (error) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–µ—Ä–Ω—É—Ç—ã—Ö –∑–∞–¥–∞—á", error);
        collapsedTasks = new Set();
      }
      let discussionContext = null;
      let focusTaskHandled = false;
      let draggedTaskId = null;

      basicsForm?.addEventListener("submit", saveBasics);
      basicAddCustomFieldBtn?.addEventListener("click", () => addBasicCustomFieldRow());
      editCustomFieldsBtn?.addEventListener("click", () => focusCustomFieldsEditor());
      addCustomFieldBtn?.addEventListener("click", () => focusCustomFieldsEditor(true));
      fileForm?.addEventListener("submit", handleFileSubmit);
      copyIdBtn?.addEventListener("click", copyProjectId);
      editBasicsBtn?.addEventListener("click", () => {
        fillBasicsForm();
        openBasicsModal();
      });
      openCharacteristicsBtn?.addEventListener("click", () => {
        window.location.href = `/characteristics.html?id=${projectId}`;
      });
      stageViewSwitch?.addEventListener("click", (event) => {
        const target = event.target.closest("[data-stage-view]");
        if (!target) return;
        const mode = target.dataset.stageView;
        if (mode && mode !== stageViewMode) {
          stageViewMode = mode;
          localStorage.setItem(stageViewKey, stageViewMode);
          renderStages();
        }
      });
      taskViewSwitch?.addEventListener("click", (event) => {
        const target = event.target.closest("[data-task-view]");
        if (!target) return;
        const mode = target.dataset.taskView;
        if (mode && mode !== taskViewMode) {
          taskViewMode = mode;
          localStorage.setItem(taskViewKey, taskViewMode);
          renderCompactTaskView();
        }
      });
      taskFilterChips?.addEventListener("click", handleFilterChipClick);
      taskStageFilter?.addEventListener("change", (event) => {
        taskFilterState.stageId = event.target.value || "";
        renderCompactTaskView();
      });
      taskResetFilters?.addEventListener("click", resetTaskFilters);
      taskSearchInput?.addEventListener("input", (event) => {
        taskFilterState.search = (event.target.value || "").trim().toLowerCase();
        renderCompactTaskView();
      });
      closeDiscussionButton?.addEventListener("click", closeDiscussionModal);
      discussionModal?.addEventListener("click", (event) => {
        if (event.target === discussionModal) {
          closeDiscussionModal();
        }
      });

      if (!projectId) {
        stagesContainer.innerHTML = "<p>–ù–µ —É–∫–∞–∑–∞–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö ?id=</p>";
      } else {
        loadData();
      }

      if (historyAccordion) {
        historyAccordion.open = false;
      }

      lightbox?.addEventListener("click", (event) => {
        if (event.target === lightbox) {
          closeLightbox();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (lightbox?.dataset.open === "true") {
          if (event.key === "Escape") closeLightbox();
          if (event.key === "ArrowRight") nextLightbox();
          if (event.key === "ArrowLeft") prevLightbox();
        }
      });

      function formatSelection(command, value = null) {
        document.execCommand(command, false, value);
      }

      function addLinkToSelection() {
        const url = prompt("–°—Å—ã–ª–∫–∞");
        if (url) {
          document.execCommand("createLink", false, url);
        }
      }

      function clearEditor(areaId) {
        const area = document.getElementById(areaId);
        if (area) area.innerHTML = "";
      }

      function editorHtml(area) {
        return (area?.innerHTML || "").trim();
      }

      function applyEditorCommand(area, command, value = null) {
        if (!area) return;
        area.focus();
        document.execCommand(command, false, value);
      }

      function createRichEditor(areaId, placeholder = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", compact = false) {
        const wrapper = document.createElement("div");
        wrapper.className = compact ? "rich-editor compact" : "rich-editor";
        const toolbar = document.createElement("div");
        toolbar.className = "rich-editor-toolbar";
        const area = document.createElement("div");
        area.id = areaId;
        area.className = "rich-editor-area";
        area.contentEditable = true;
        area.dataset.placeholder = placeholder;

        const actions = [
          { label: "B", command: "bold" },
          { label: "I", command: "italic" },
          { label: "U", command: "underline" },
          { label: "‚Ä¢", command: "insertUnorderedList" },
          { label: "1.", command: "insertOrderedList" },
          {
            label: "–°—Å—ã–ª–∫–∞",
            action: () => {
              const url = prompt("–°—Å—ã–ª–∫–∞");
              if (url) applyEditorCommand(area, "createLink", url);
            },
          },
        ];

        actions.forEach((action) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = action.label;
          btn.addEventListener("click", () => {
            if (action.command) {
              applyEditorCommand(area, action.command);
            } else if (action.action) {
              action.action();
            }
          });
          toolbar.appendChild(btn);
        });

        wrapper.appendChild(toolbar);
        wrapper.appendChild(area);
        return { wrapper, area };
      }

      function persistCollapsedTasks() {
        localStorage.setItem(collapsedTasksKey, JSON.stringify(Array.from(collapsedTasks)));
      }

      function isTaskCollapsed(taskId) {
        if (!taskId) return false;
        return collapsedTasks.has(String(taskId));
      }

      function setTaskCollapsed(taskId, collapsed) {
        if (!taskId) return;
        const normalizedId = String(taskId);
        if (collapsed) {
          collapsedTasks.add(normalizedId);
        } else {
          collapsedTasks.delete(normalizedId);
        }
        persistCollapsedTasks();
      }

      function focusTaskIfNeeded() {
        if (!focusTaskId || focusTaskHandled) return;
        const card = document.querySelector(`.task-card[data-task-id='${focusTaskId}']`);
        if (!card) return;
        focusTaskHandled = true;
        if (card.classList.contains("collapsed")) {
          card.classList.remove("collapsed");
          setTaskCollapsed(focusTaskId, false);
          const collapseBtn = document.querySelector(`[data-task-collapse='${focusTaskId}']`);
          if (collapseBtn) {
            collapseBtn.textContent = "‚ñ¥";
            collapseBtn.title = "–°–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞—á—É";
          }
        }
        card.classList.add("task-highlight");
        card.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => card.classList.remove("task-highlight"), 4000);
      }

      async function loadData() {
        await loadGroupList();
        await Promise.all([
          loadProject(),
          loadTemplates(),
          loadStages(),
        ]);
        await Promise.all([loadTasks(), loadImages(), loadFiles(), loadProjectComments(), loadHistory()]);
      }

      function taskProgress(task) {
        const total = task.subtasks?.length || 0;
        if (!total) {
          const base = task.status === "done" ? 100 : task.status === "in_progress" ? 60 : 10;
          return { percent: base, label: "–ë–µ–∑ –ø–æ–¥–∑–∞–¥–∞—á" };
        }
        const done = task.subtasks.filter((s) => s.done).length;
        const percent = Math.round((done / total) * 100);
        return { percent, label: `${done}/${total}` };
      }

      async function loadProject() {
        const res = await fetch(`/api/projects/${projectId}`, { cache: "no-store" });
        if (!res.ok) {
          stagesContainer.innerHTML = "<p>–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>";
          return;
        }
        project = await res.json();
        project.custom_fields = project.custom_fields || {};
        await loadGroupInfo();
        renderProject();
      }

      async function loadGroupInfo() {
        if (!project?.group_id) return;
        const res = await fetch(`/api/groups/${project.group_id}`, { cache: "no-store" });
        groupInfo = res.ok ? await res.json() : null;
      }

      async function loadGroupList() {
        const res = await fetch("/api/groups?include_archived=true", { cache: "no-store" });
        groups = res.ok ? await res.json() : [];
        basicGroup.innerHTML = groups
          .map((g) => `<option value="${g.id}">${g.name}</option>`)
          .join("");
      }

      async function loadTemplates() {
        const res = await fetch("/api/gtm-templates", { cache: "no-store" });
        gtmTemplates = res.ok ? await res.json() : [];
        renderTemplates();
      }

      async function loadStages() {
        const res = await fetch(`/api/projects/${projectId}/gtm-stages`, { cache: "no-store" });
        gtmStages = res.ok ? await res.json() : [];
        renderStages();
        renderTaskFilters();
        renderGtmProgress();
      }

      function renderProject() {
        document.getElementById("project-name").textContent = project.name;
        document.getElementById("project-desc").textContent = project.short_description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
        const idLabel = project.short_id ? `ID ${project.short_id}` : "ID ‚Äî";
        projectShortChip.textContent = idLabel;
        const metaParts = [];
        if (groupInfo?.name) metaParts.push(`–ì—Ä—É–ø–ø–∞: ${groupInfo.name}`);
        if (project.brand) metaParts.push(`–ë—Ä–µ–Ω–¥: ${project.brand}`);
        if (project.market) metaParts.push(`–†—ã–Ω–æ–∫: ${project.market}`);
        if (project.planned_launch) metaParts.push(`–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞: ${project.planned_launch}`);
        if (project.actual_launch) metaParts.push(`–§–∞–∫—Ç: ${project.actual_launch}`);
        document.getElementById("project-meta").textContent = metaParts.join(" ¬∑ ") || "–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞";
        projectGroupEl.textContent = groupInfo?.name || "‚Äî";
        projectBrandEl.textContent = project.brand || "‚Äî";
        projectMarketEl.textContent = project.market || "‚Äî";
        projectPlannedEl.textContent = project.planned_launch || "‚Äî";
        projectActualEl.textContent = project.actual_launch || "‚Äî";
        projectMoqEl.textContent = formatMoney(project.moq);
        projectPromoEl.textContent = formatMoney(project.promo_price);
        projectRrpEl.textContent = formatMoney(project.rrp_price);
        projectFobEl.textContent = formatMoney(project.fob_price);
        renderProjectCustomFields();

        const badges = [];
        if (project.status === "archived") {
          badges.push(`<span class="badge archived">–ê—Ä—Ö–∏–≤</span>`);
        } else if (project.status === "closed") {
          badges.push(`<span class="badge closed">–ó–∞–∫—Ä—ã—Ç</span>`);
        } else {
          badges.push(`<span class="badge">–ê–∫—Ç–∏–≤–µ–Ω</span>`);
        }
        if (project.priority) {
          const titles = { low: "–ù–∏–∑–∫–∏–π", medium: "–°—Ä–µ–¥–Ω–∏–π", high: "–í—ã—Å–æ–∫–∏–π" };
          badges.push(`<span class="badge">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${titles[project.priority] || project.priority}</span>`);
        }
        document.getElementById("project-badges").innerHTML = badges.join("");
        renderGtmProgress();
        renderCoverPanel();
        fillBasicsForm();
      }

      function renderProjectCustomFields() {
        if (!projectCustomFieldsEl) return;
        const entries = Object.entries(project?.custom_fields || {});
        if (!entries.length) {
          if (projectCustomFieldsSummary) {
            projectCustomFieldsSummary.textContent = "–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π";
          }
          projectCustomFieldsEl.innerHTML =
            '<div class="muted" style="padding: 6px 0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è –Ω–µ –∑–∞–¥–∞–Ω—ã</div>';
          return;
        }
        if (projectCustomFieldsSummary) {
          projectCustomFieldsSummary.textContent = formatCustomFieldCount(entries.length);
        }
        projectCustomFieldsEl.innerHTML = "";
        entries.forEach(([key, value]) => {
          const chip = document.createElement("div");
          chip.className = "custom-field-chip";
          const title = document.createElement("span");
          title.textContent = key;
          const content = document.createElement("strong");
          content.textContent = value === null || value === undefined || value === "" ? "‚Äî" : value;
          chip.append(title, content);
          projectCustomFieldsEl.appendChild(chip);
        });
      }

      function openBasicsModal() {
        if (!basicsModal) return;
        basicsModal.style.display = "flex";
      }

      function closeBasicsModal() {
        if (!basicsModal) return;
        basicsModal.style.display = "none";
      }

      function focusCustomFieldsEditor(addRow = false) {
        fillBasicsForm();
        if (addRow) {
          addBasicCustomFieldRow();
        }
        openBasicsModal();
        requestAnimationFrame(() => {
          if (!basicCustomFields) return;
          const rows = Array.from(basicCustomFields.querySelectorAll(".custom-field-row"));
          const targetRow = addRow && rows.length ? rows[rows.length - 1] : rows[0];
          const targetInput = targetRow?.querySelector("input");
          const scrollTarget = targetRow || basicCustomFields;
          scrollTarget?.scrollIntoView({ behavior: "smooth", block: "center" });
          targetInput?.focus();
        });
      }

      function copyProjectId() {
        if (!project?.short_id || !copyIdBtn) return;
        const original = copyIdBtn.textContent;
        navigator.clipboard?.writeText(String(project.short_id)).then(() => {
          copyIdBtn.textContent = "ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω";
          setTimeout(() => {
            copyIdBtn.textContent = original;
          }, 1200);
        });
      }

      async function saveBasics(event) {
        event.preventDefault();
        if (!project) return;
        const updated = {
          ...project,
          name: basicName.value.trim(),
          group_id: basicGroup.value,
          brand: basicBrand.value.trim(),
          market: basicMarket.value.trim(),
          status: basicStatus.value,
          priority: basicPriority.value || null,
          planned_launch: basicPlanned.value || null,
          actual_launch: basicActual.value || null,
          moq: basicMoq.value ? parseFloat(basicMoq.value) : null,
          promo_price: basicPromo.value ? parseFloat(basicPromo.value) : null,
          rrp_price: basicRrp.value ? parseFloat(basicRrp.value) : null,
          fob_price: basicFob.value ? parseFloat(basicFob.value) : null,
          short_description: basicShort.value || null,
          full_description: basicFull.value || null,
          custom_fields: collectBasicCustomFields(),
        };
        const res = await fetch(`/api/projects/${project.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updated),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞");
          return;
        }
        project = await res.json();
        project.custom_fields = project.custom_fields || {};
        await loadGroupInfo();
        renderProject();
        closeBasicsModal();
      }

      function fillBasicsForm() {
        if (!project) return;
        basicName.value = project.name || "";
        basicBrand.value = project.brand || "";
        basicMarket.value = project.market || "";
        basicStatus.value = project.status || "active";
        basicPriority.value = project.priority || "";
        basicPlanned.value = project.planned_launch || "";
        basicActual.value = project.actual_launch || "";
        basicMoq.value = project.moq ?? "";
        basicPromo.value = project.promo_price ?? "";
        basicRrp.value = project.rrp_price ?? "";
        basicFob.value = project.fob_price ?? "";
        basicShort.value = project.short_description || "";
        basicFull.value = project.full_description || "";
        populateBasicCustomFields(project.custom_fields || {});
        if (project.group_id) {
          basicGroup.value = project.group_id;
        }
      }

      function addBasicCustomFieldRow(key = "", value = "") {
        if (!basicCustomFields) return;
        const row = document.createElement("div");
        row.className = "custom-field-row";

        const keyLabel = document.createElement("label");
        keyLabel.textContent = "–ù–∞–∑–≤–∞–Ω–∏–µ";
        const keyInput = document.createElement("input");
        keyInput.value = key;
        keyInput.placeholder = "–ù–∞–ø—Ä–∏–º–µ—Ä: SKU";
        keyLabel.appendChild(keyInput);

        const valueLabel = document.createElement("label");
        valueLabel.textContent = "–ó–Ω–∞—á–µ–Ω–∏–µ";
        const valueInput = document.createElement("input");
        valueInput.value = value ?? "";
        valueInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ";
        valueLabel.appendChild(valueInput);

        const actions = document.createElement("div");
        actions.className = "custom-field-row-actions";

        const moveUpBtn = document.createElement("button");
        moveUpBtn.type = "button";
        moveUpBtn.className = "ghost icon-only btn-move-up";
        moveUpBtn.title = "–í–≤–µ—Ä—Ö";
        moveUpBtn.textContent = "‚Üë";
        moveUpBtn.addEventListener("click", () => {
          const prev = row.previousElementSibling;
          if (prev) {
            basicCustomFields.insertBefore(row, prev);
            updateCustomFieldReorderControls();
          }
        });

        const moveDownBtn = document.createElement("button");
        moveDownBtn.type = "button";
        moveDownBtn.className = "ghost icon-only btn-move-down";
        moveDownBtn.title = "–í–Ω–∏–∑";
        moveDownBtn.textContent = "‚Üì";
        moveDownBtn.addEventListener("click", () => {
          const next = row.nextElementSibling?.nextElementSibling;
          const sibling = row.nextElementSibling;
          if (sibling) {
            basicCustomFields.insertBefore(row, next || null);
            updateCustomFieldReorderControls();
          }
        });

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "ghost icon-only";
        removeBtn.title = "–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ";
        removeBtn.textContent = "‚úï";
        removeBtn.addEventListener("click", () => {
          row.remove();
          updateCustomFieldReorderControls();
        });

        actions.append(moveUpBtn, moveDownBtn, removeBtn);
        row.append(keyLabel, valueLabel, actions);
        basicCustomFields.appendChild(row);
        updateCustomFieldReorderControls();
      }

      function populateBasicCustomFields(fields = {}) {
        if (!basicCustomFields) return;
        basicCustomFields.innerHTML = "";
        const entries = Object.entries(fields);
        if (!entries.length) {
          addBasicCustomFieldRow();
          return;
        }
        entries.forEach(([key, value]) => addBasicCustomFieldRow(key, value ?? ""));
      }

      function updateCustomFieldReorderControls() {
        if (!basicCustomFields) return;
        const rows = Array.from(basicCustomFields.querySelectorAll(".custom-field-row"));
        rows.forEach((row, index) => {
          const up = row.querySelector(".btn-move-up");
          const down = row.querySelector(".btn-move-down");
          if (up) up.disabled = index === 0;
          if (down) down.disabled = index === rows.length - 1;
        });
      }

      function collectBasicCustomFields() {
        if (!basicCustomFields) return {};
        const result = {};
        basicCustomFields.querySelectorAll(".custom-field-row").forEach((row) => {
          const [keyInput, valueInput] = row.querySelectorAll("input");
          if (!keyInput) return;
          const key = keyInput.value.trim();
          if (!key) return;
          result[key] = valueInput ? valueInput.value || null : null;
        });
        return result;
      }

      function renderTemplates() {
        templateSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω";
        templateSelect.appendChild(defaultOption);
        gtmTemplates.forEach((tpl) => {
          const option = document.createElement("option");
          option.value = tpl.id;
          option.textContent = tpl.name;
          templateSelect.appendChild(option);
        });
      }

      function statusLabel(value) {
        return {
          not_started: "–ù–µ –Ω–∞—á–∞—Ç",
          in_progress: "–í —Ä–∞–±–æ—Ç–µ",
          done: "–ó–∞–≤–µ—Ä—à—ë–Ω",
          cancelled: "–û—Ç–º–µ–Ω—ë–Ω",
        }[value] || value;
      }

      function formatCustomFieldCount(count) {
        if (!count) return "–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π";
        const mod10 = count % 10;
        const mod100 = count % 100;
        if (mod10 === 1 && mod100 !== 11) return `${count} –ø–æ–ª–µ`;
        if ([2, 3, 4].includes(mod10) && ![12, 13, 14].includes(mod100)) return `${count} –ø–æ–ª—è`;
        return `${count} –ø–æ–ª–µ–π`;
      }

      function formatMoney(value) {
        if (value === null || value === undefined || value === "") return "‚Äî";
        const num = Number(value);
        if (Number.isNaN(num)) return "‚Äî";
        return num.toLocaleString("ru-RU", { maximumFractionDigits: 2 });
      }

      function pluralize(count, one, few, many) {
        const mod10 = Math.abs(count) % 10;
        const mod100 = Math.abs(count) % 100;
        if (mod10 === 1 && mod100 !== 11) return one;
        if ([2, 3, 4].includes(mod10) && ![12, 13, 14].includes(mod100)) return few;
        return many;
      }

      function updateStageViewSwitch() {
        stageViewSwitch?.querySelectorAll("[data-stage-view]").forEach((btn) => {
          const isActive = btn.dataset.stageView === stageViewMode;
          btn.classList.toggle("active", isActive);
          btn.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
      }

      function updateTaskViewSwitch() {
        taskViewSwitch?.querySelectorAll("[data-task-view]").forEach((btn) => {
          const isActive = btn.dataset.taskView === taskViewMode;
          btn.classList.toggle("active", isActive);
          btn.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
      }

      function isStageCollapsed(stageId) {
        return collapsedStages.has(String(stageId));
      }

      function setStageCollapsed(stageId, collapsed) {
        const normalizedId = String(stageId);
        if (collapsed) {
          collapsedStages.add(normalizedId);
        } else {
          collapsedStages.delete(normalizedId);
        }
        try {
          localStorage.setItem(collapsedStagesKey, JSON.stringify(Array.from(collapsedStages)));
        } catch (error) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç—Ç–∞–ø–æ–≤", error);
        }
      }


      function renderStages() {
        gtmStages.sort((a, b) => a.order - b.order);
        updateStageViewSwitch();
        const stageIds = new Set(gtmStages.map((stage) => stage.id));
        const stageTasks = tasks.filter((task) => stageIds.has(task.gtm_stage_id));
        const doneTasks = stageTasks.filter((task) => task.status === "done").length;
        if (gtmStageCount) {
          const count = gtmStages.length;
          gtmStageCount.textContent = count ? `${count} ${pluralize(count, "—ç—Ç–∞–ø", "—ç—Ç–∞–ø–∞", "—ç—Ç–∞–ø–æ–≤")}` : "–ù–µ—Ç —ç—Ç–∞–ø–æ–≤";
        }
        if (gtmTaskCount) {
          const count = stageTasks.length;
          gtmTaskCount.textContent = count ? `${count} ${pluralize(count, "–∑–∞–¥–∞—á–∞", "–∑–∞–¥–∞—á–∏", "–∑–∞–¥–∞—á")}` : "‚Äî";
        }
        if (gtmDoneCount) {
          gtmDoneCount.textContent = doneTasks ? `${doneTasks} –≥–æ—Ç–æ–≤–æ` : "–ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ";
        }
        if (!gtmStages.length) {
          stagesContainer.innerHTML = `<p class="muted">–≠—Ç–∞–ø—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>`;
          return;
        }

        if (stageViewMode === "table") {
          renderStageTable();
          return;
        }

        stagesContainer.innerHTML = "";
        gtmStages.forEach((stage, index) => {
          const collapsed = isStageCollapsed(stage.id);
          const card = document.createElement("div");
          const stageTasks = tasks.filter((task) => task.gtm_stage_id === stage.id);
          const doneTasks = stageTasks.filter((task) => task.status === "done").length;
          card.className = `stage-card${collapsed ? " collapsed" : ""}`;
          card.dataset.stageId = stage.id;
          const percent = Math.round(stageProgressScore(stage) * 100);
          const commentsCount = stage.comments?.length || 0;
          card.innerHTML = `
            <div class="stage-header">
              <div class="stage-title-line">
                <div class="stage-rank">${index + 1}</div>
                <div class="stage-heading">
                  <div class="stage-info-row">
                    <strong>${stage.title}</strong>
                    <span class="chip pill">${statusLabel(stage.status)}</span>
                    ${stage.risk_flag ? '<span class="chip warn">‚ö†Ô∏è –†–∏—Å–∫</span>' : ""}
                  </div>
                  <div class="stage-description" id="stage-desc-${stage.id}"></div>
                </div>
              </div>
              <div class="stage-actions" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <button class="icon-button comment-trigger" data-stage-comments="${stage.id}" aria-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —ç—Ç–∞–ø–∞">
                  üí¨ <span class="count">${commentsCount}</span>
                </button>
                <button class="ghost" onclick="openStageForm('${stage.id}')">‚úèÔ∏è</button>
                <button class="ghost" onclick="moveStage('${stage.id}', -1)" ${index === 0 ? "disabled" : ""}>‚Üë</button>
                <button class="ghost" onclick="moveStage('${stage.id}', 1)" ${index === gtmStages.length - 1 ? "disabled" : ""}>‚Üì</button>
                <button class="ghost" onclick="deleteStage('${stage.id}')">üóëÔ∏è</button>
                <button class="icon-button" data-stage-collapse="${stage.id}" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–∞–ø">
                  ${collapsed ? "‚ñæ" : "‚ñ¥"}
                </button>
              </div>
            </div>
            <div class="stage-info-row">
              <div class="stage-stat">
                <span class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å —ç—Ç–∞–ø–∞</span>
                <strong>${percent}%</strong>
              </div>
              <div class="stage-stat">
                <span class="muted">–ó–∞–¥–∞—á–∏</span>
                <strong>${stageTasks.length || "‚Äî"}</strong>
                <span class="muted">–ì–æ—Ç–æ–≤–æ: ${doneTasks}</span>
              </div>
              <div class="stage-stat">
                <span class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                <strong>${commentsCount}</strong>
              </div>
            </div>
            <div class="stage-progress">
              <div class="progress-line"><div class="fill" style="width:${percent}%"></div></div>
              <div class="muted">–ò–¥—ë–º –ø–æ –ø–ª–∞–Ω—É? –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á –∏ —Å—Ä–æ–∫–∏.</div>
            </div>
            <div class="stage-dates">
              <div class="chip">–ü–ª–∞–Ω: ${stage.planned_start || "‚Äî"} ‚Üí ${stage.planned_end || "‚Äî"}</div>
              <div class="chip">–§–∞–∫—Ç: ${stage.actual_end || "‚Äî"}</div>
            </div>
            <div class="stage-controls">
              <label style="display:flex; align-items:center; gap:6px; font-weight:500">
                –°—Ç–∞—Ç—É—Å
                <select onchange="changeStatus('${stage.id}', this.value)">
                  <option value="not_started" ${stage.status === "not_started" ? "selected" : ""}>–ù–µ –Ω–∞—á–∞—Ç</option>
                  <option value="in_progress" ${stage.status === "in_progress" ? "selected" : ""}>–í —Ä–∞–±–æ—Ç–µ</option>
                  <option value="done" ${stage.status === "done" ? "selected" : ""}>–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                  <option value="cancelled" ${stage.status === "cancelled" ? "selected" : ""}>–û—Ç–º–µ–Ω—ë–Ω</option>
                </select>
              </label>
              <label class="checkbox-lite" style="font-weight:500">
                <input type="checkbox" ${stage.risk_flag ? "checked" : ""} onchange="toggleRisk('${stage.id}', this.checked)" /> –†–∏—Å–∫
              </label>
              <button class="ghost" onclick="openTaskForm(null, '${stage.id}')">+ –ó–∞–¥–∞—á–∞</button>
            </div>
            <div id="stage-tasks-${stage.id}"></div>
          `;

          card.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            openStageContextMenu(event, stage, index);
          });

          const desc = card.querySelector(`#stage-desc-${stage.id}`);
          if (desc) {
            if (stage.description) {
              desc.innerHTML = stage.description;
              desc.classList.remove("empty");
            } else {
              desc.innerHTML = '<span class="muted">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</span>';
              desc.classList.add("empty");
            }
          }
          const taskSlot = card.querySelector(`#stage-tasks-${stage.id}`);
          if (taskSlot) {
            taskSlot.replaceWith(renderStageTasks(stage));
          }
          const stageCommentBtn = card.querySelector(`[data-stage-comments='${stage.id}']`);
          stageCommentBtn?.addEventListener("click", () => openStageDiscussion(stage.id));
          const collapseBtn = card.querySelector(`[data-stage-collapse='${stage.id}']`);
          if (collapseBtn) {
            collapseBtn.title = collapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–∞–ø" : "–°–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–∞–ø";
            collapseBtn.setAttribute("aria-label", collapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–∞–ø" : "–°–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–∞–ø");
            collapseBtn.addEventListener("click", () => {
              const nextCollapsed = !card.classList.contains("collapsed");
              card.classList.toggle("collapsed", nextCollapsed);
              collapseBtn.textContent = nextCollapsed ? "‚ñæ" : "‚ñ¥";
              const label = nextCollapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–∞–ø" : "–°–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–∞–ø";
              collapseBtn.title = label;
              collapseBtn.setAttribute("aria-label", label);
              setStageCollapsed(stage.id, nextCollapsed);
            });
          }

          stagesContainer.appendChild(card);
        });
      }

      function renderStageTable() {
        stagesContainer.innerHTML = "";
        const wrapper = document.createElement("div");
        wrapper.className = "table-scroll";
        const table = document.createElement("table");
        table.className = "compact-table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>#</th>
              <th>–≠—Ç–∞–ø</th>
              <th>–ü–ª–∞–Ω / –§–∞–∫—Ç</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ó–∞–¥–∞—á</th>
              <th>–†–∏—Å–∫</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
        `;
        const tbody = document.createElement("tbody");
        const taskCount = tasks.reduce((acc, task) => {
          const key = task.gtm_stage_id || "__none";
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});
        gtmStages.forEach((stage, index) => {
          const row = document.createElement("tr");
          const planned = `${stage.planned_start || "‚Äî"} ‚Üí ${stage.planned_end || "‚Äî"}`;
          const fact = stage.actual_end || "‚Äî";
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${stage.title}</td>
            <td><div>${planned}</div><div class="muted">–§–∞–∫—Ç: ${fact}</div></td>
            <td><span class="chip">${statusLabel(stage.status)}</span></td>
            <td>${taskCount[stage.id] || 0}</td>
            <td>${stage.risk_flag ? '<span class="chip warn">‚ö†Ô∏è –†–∏—Å–∫</span>' : "‚Äî"}</td>
            <td>${stage.comments?.length || 0}</td>
            <td>
              <div class="table-actions">
                <button class="ghost" onclick="openStageForm('${stage.id}')">‚úèÔ∏è</button>
                <button class="ghost" onclick="openStageDiscussion('${stage.id}')">üí¨</button>
                <button class="ghost" onclick="openTaskForm(null, '${stage.id}')">+ –ó–∞–¥–∞—á–∞</button>
              </div>
            </td>
          `;
          row.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            openStageContextMenu(event, stage, index);
          });
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        wrapper.appendChild(table);
        stagesContainer.appendChild(wrapper);
      }

      function renderStageTasks(stage) {
        const stageTasks = tasks
          .filter((task) => task.gtm_stage_id === stage.id)
          .sort((a, b) => {
            if (a.status === "done" && b.status !== "done") return 1;
            if (a.status !== "done" && b.status === "done") return -1;
            const aDate = a.due_date ? new Date(a.due_date).getTime() : Number.POSITIVE_INFINITY;
            const bDate = b.due_date ? new Date(b.due_date).getTime() : Number.POSITIVE_INFINITY;
            if (aDate !== bDate) return aDate - bDate;
            return a.title.localeCompare(b.title, "ru", { sensitivity: "base" });
          });

        const wrapper = document.createElement("div");
        wrapper.className = "stage-task-list";
        wrapper.dataset.stageId = stage.id;

        const header = document.createElement("div");
        header.className = "stage-task-header";
        const title = document.createElement("strong");
        title.textContent = `–ó–∞–¥–∞—á–∏ —ç—Ç–∞–ø–∞ (${stageTasks.length})`;
        const addBtn = document.createElement("button");
        addBtn.className = "ghost";
        addBtn.textContent = "+ –ó–∞–¥–∞—á–∞";
        addBtn.addEventListener("click", () => openTaskForm(null, stage.id));
        header.appendChild(title);
        header.appendChild(addBtn);
        wrapper.appendChild(header);

        if (!stageTasks.length) {
          const empty = document.createElement("p");
          empty.className = "muted";
          empty.textContent = "–î–ª—è —ç—Ç–∞–ø–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.";
          wrapper.appendChild(empty);
          return wrapper;
        }

        stageTasks.forEach((task, idx) => {
          const collapsed = isTaskCollapsed(task.id);
          const card = document.createElement("div");
          card.className = `task-card${collapsed ? " collapsed" : ""}`;
          card.dataset.taskId = task.id;

          const head = document.createElement("div");
          head.className = "task-head";

          const titleBlock = document.createElement("div");
          titleBlock.className = "task-title-block";
          const rank = document.createElement("span");
          rank.className = "task-rank";
          rank.textContent = `${idx + 1}`;
          const titleWrap = document.createElement("div");
          const titleEl = document.createElement("strong");
          titleEl.textContent = task.title;
          titleWrap.appendChild(titleEl);
          const statusLine = document.createElement("div");
          statusLine.className = "task-badges";
          const statusChip = document.createElement("span");
          statusChip.className = "chip";
          statusChip.textContent = taskStatusLabel(task.status);
          statusLine.appendChild(statusChip);
          if (task.important) {
            const importantChip = document.createElement("span");
            importantChip.className = "flag-badge flag-important";
            importantChip.textContent = "–í–∞–∂–Ω–æ";
            statusLine.appendChild(importantChip);
          }
          if (task.urgency === "high") {
            const urgentChip = document.createElement("span");
            urgentChip.className = "flag-badge flag-urgent";
            urgentChip.textContent = "–°—Ä–æ—á–Ω–æ";
            statusLine.appendChild(urgentChip);
          }
          titleWrap.appendChild(statusLine);
          titleBlock.appendChild(rank);
          titleBlock.appendChild(titleWrap);

          head.appendChild(titleBlock);

          const topActions = document.createElement("div");
          topActions.className = "task-top-actions";
          const commentBtn = document.createElement("button");
          commentBtn.type = "button";
          commentBtn.className = "icon-button comment-trigger";
          commentBtn.innerHTML = `üí¨ <span class="count">${task.comments?.length || 0}</span>`;
          commentBtn.title = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏";
          commentBtn.addEventListener("click", () => openTaskDiscussion(task.id));
          const collapseBtn = document.createElement("button");
          collapseBtn.type = "button";
          collapseBtn.className = "icon-button";
          collapseBtn.dataset.taskCollapse = task.id;
          collapseBtn.textContent = collapsed ? "‚ñæ" : "‚ñ¥";
          collapseBtn.title = collapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞—á—É" : "–°–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞—á—É";
          collapseBtn.addEventListener("click", () => {
            const nextCollapsed = !card.classList.contains("collapsed");
            card.classList.toggle("collapsed", nextCollapsed);
            collapseBtn.textContent = nextCollapsed ? "‚ñæ" : "‚ñ¥";
            collapseBtn.title = nextCollapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞—á—É" : "–°–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞—á—É";
            setTaskCollapsed(task.id, nextCollapsed);
          });
          topActions.appendChild(commentBtn);
          topActions.appendChild(collapseBtn);
          head.appendChild(topActions);
          card.appendChild(head);

          const metaGrid = document.createElement("div");
          metaGrid.className = "task-meta-grid";
          const due = dueInfo(task);
          const progress = taskProgress(task);

          const dueChip = document.createElement("div");
          dueChip.className = "task-meta-chip";
          dueChip.innerHTML = `<span class="${due.className}">${due.text}</span>`;
          const progressChip = document.createElement("div");
          progressChip.className = "task-meta-chip";
          progressChip.innerHTML = `‚úÖ ${progress.label}`;
          const subCountChip = document.createElement("div");
          const totalSubs = task.subtasks?.length || 0;
          const doneSubs = task.subtasks?.filter((s) => s.done).length || 0;
          subCountChip.className = "task-meta-chip";
          subCountChip.textContent = totalSubs
            ? `–ü–æ–¥–∑–∞–¥–∞—á–∏: ${doneSubs}/${totalSubs}`
            : "–ü–æ–¥–∑–∞–¥–∞—á –Ω–µ—Ç";
          const stageChip = document.createElement("div");
          stageChip.className = "task-meta-chip";
          stageChip.textContent = `–≠—Ç–∞–ø: ${stage.title}`;

          metaGrid.appendChild(dueChip);
          metaGrid.appendChild(progressChip);
          metaGrid.appendChild(subCountChip);
          metaGrid.appendChild(stageChip);
          card.appendChild(metaGrid);

          const progressBlock = document.createElement("div");
          progressBlock.className = "stage-progress";
          progressBlock.innerHTML = `
            <div class="progress-line"><div class="fill" style="width:${progress.percent}%"></div></div>
            <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞—á–∏: ${progress.label}</div>
          `;
          card.appendChild(progressBlock);

          const details = document.createElement("div");
          details.className = "task-details";
          if (task.description) {
            const desc = document.createElement("div");
            desc.className = "task-description";
            desc.textContent = task.description;
            details.appendChild(desc);
          }

          const actions = document.createElement("div");
          actions.className = "task-inline-actions";

          const actionButtons = [
            { label: "‚úèÔ∏è", title: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", onClick: () => openTaskForm(task.id) },
            {
              label: task.status === "done" ? "‚Ü∫" : "‚úî",
              title: task.status === "done" ? "–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É" : "–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π",
              onClick: () => changeTaskStatus(task.id, task.status === "done" ? "todo" : "done"),
            },
            {
              label: task.important ? "‚òÖ" : "‚òÜ",
              title: task.important ? "–°–Ω—è—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å" : "–°–¥–µ–ª–∞—Ç—å –≤–∞–∂–Ω–æ–π",
              onClick: () => toggleImportant(task.id),
            },
            { label: "üóëÔ∏è", title: "–£–¥–∞–ª–∏—Ç—å", onClick: () => deleteTask(task.id), danger: true },
          ];

          actionButtons.forEach((cfg) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = cfg.danger ? "icon-button danger" : "icon-button";
            btn.textContent = cfg.label;
            btn.title = cfg.title;
            btn.addEventListener("click", cfg.onClick);
            actions.appendChild(btn);
          });

          details.appendChild(actions);

          details.appendChild(renderSubtasksSection(task));
          card.appendChild(details);

          card.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            const menu = [
              { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => openTaskForm(task.id) },
              {
                label: task.status === "done" ? "–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É" : "–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π",
                action: () => changeTaskStatus(task.id, task.status === "done" ? "todo" : "done"),
              },
              {
                label: task.important ? "–°–Ω—è—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å" : "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤–∞–∂–Ω—É—é",
                action: () => toggleImportant(task.id),
              },
              { label: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏", action: () => openTaskDiscussion(task.id) },
              { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteTask(task.id) },
            ];
            openContextMenu(event, menu);
          });

          wrapper.appendChild(card);
        });

        return wrapper;
      }

      function renderCompactTaskView() {
        if (!taskCompactContent) return;
        updateTaskViewSwitch();
        taskCompactContent.innerHTML = "";
        taskCompactContent.classList.toggle("table-scroll", taskViewMode === "table");
        const filteredTasks = applyTaskFilters(tasks);
        updateTaskFilterSummary(filteredTasks.length, tasks.length);
        if (!filteredTasks.length) {
          const reason = tasks.length
            ? "–ü–æ –∞–∫—Ç–∏–≤–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–±—Ä–æ—Å—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã."
            : "–ó–∞–¥–∞—á–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.";
          taskCompactContent.innerHTML = `<p class="muted">${reason}</p>`;
          return;
        }
        if (taskViewMode === "table") {
          taskCompactContent.appendChild(buildTaskTable(filteredTasks));
        } else {
          taskCompactContent.appendChild(buildKanbanBoard(filteredTasks));
        }
      }

      function buildTaskTable(items) {
        const table = document.createElement("table");
        table.className = "compact-table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>–ó–∞–¥–∞—á–∞</th>
              <th>–≠—Ç–∞–ø</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–í–∞–∂–Ω–æ—Å—Ç—å</th>
              <th>–°—Ä–æ—á–Ω–æ—Å—Ç—å</th>
              <th>–°—Ä–æ–∫</th>
              <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
        `;
        const tbody = document.createElement("tbody");
        const orderMap = gtmStages.reduce((acc, stage, index) => {
          acc[stage.id] = index;
          return acc;
        }, {});
        const statusOrder = { todo: 0, in_progress: 1, done: 2 };
        const sortedTasks = [...items].sort((a, b) => {
          const stageDiff = (orderMap[a.gtm_stage_id] ?? 999) - (orderMap[b.gtm_stage_id] ?? 999);
          if (stageDiff !== 0) return stageDiff;
          const statusDiff = (statusOrder[a.status] ?? 99) - (statusOrder[b.status] ?? 99);
          if (statusDiff !== 0) return statusDiff;
          const aDate = a.due_date ? new Date(a.due_date).getTime() : Number.POSITIVE_INFINITY;
          const bDate = b.due_date ? new Date(b.due_date).getTime() : Number.POSITIVE_INFINITY;
          if (aDate !== bDate) return aDate - bDate;
          return a.title.localeCompare(b.title, "ru", { sensitivity: "base" });
        });
        sortedTasks.forEach((task) => tbody.appendChild(createCompactTaskRow(task, "table")));
        table.appendChild(tbody);
        return table;
      }

      function buildKanbanBoard(items) {
        const board = document.createElement("div");
        board.className = "kanban-board";
        const grouped = { todo: [], in_progress: [], done: [] };
        items.forEach((task) => {
          const bucket = grouped[task.status] || grouped.todo;
          bucket.push(task);
        });
        Object.keys(grouped).forEach((key) => {
          grouped[key].sort((a, b) => {
            const aDate = a.due_date ? new Date(a.due_date).getTime() : Number.POSITIVE_INFINITY;
            const bDate = b.due_date ? new Date(b.due_date).getTime() : Number.POSITIVE_INFINITY;
            if (aDate !== bDate) return aDate - bDate;
            return a.title.localeCompare(b.title, "ru", { sensitivity: "base" });
          });
        });
        kanbanStatuses.forEach(({ key, label }) => {
          const column = document.createElement("div");
          column.className = "kanban-column";
          const header = document.createElement("div");
          header.className = "kanban-column-header";
          header.innerHTML = `<span>${label}</span><span class="muted">${grouped[key]?.length || 0}</span>`;
          const body = document.createElement("div");
          body.className = "kanban-column-body";
          body.dataset.status = key;
          body.addEventListener("dragover", handleKanbanDragOver);
          body.addEventListener("dragleave", handleKanbanDragLeave);
          body.addEventListener("drop", handleKanbanDrop);
          if (!grouped[key]?.length) {
            const empty = document.createElement("p");
            empty.className = "kanban-empty";
            empty.textContent = "–ù–µ—Ç –∑–∞–¥–∞—á";
            body.appendChild(empty);
          } else {
            grouped[key].forEach((task) => body.appendChild(createCompactTaskRow(task, "kanban")));
          }
          column.appendChild(header);
          column.appendChild(body);
          board.appendChild(column);
        });
        return board;
      }

      function createKanbanCard(task) {
        return createCompactTaskRow(task, "kanban");
      }

      function handleFilterChipClick(event) {
        const btn = event.target.closest("[data-filter-group]");
        if (!btn) return;
        const group = btn.dataset.filterGroup;
        const value = btn.dataset.value;
        if (!group || !value) return;
        if (group === "status") {
          toggleFilterSet(taskFilterState.statuses, value, btn);
        } else if (group === "due") {
          toggleFilterSet(taskFilterState.due, value, btn);
        } else if (group === "flag") {
          taskFilterState.flags[value] = !taskFilterState.flags[value];
          btn.classList.toggle("active", taskFilterState.flags[value]);
        }
        renderCompactTaskView();
      }

      function toggleFilterSet(set, value, btn) {
        if (!set || !value) return;
        if (set.has(value)) {
          set.delete(value);
          btn?.classList.remove("active");
        } else {
          set.add(value);
          btn?.classList.add("active");
        }
      }

      function resetTaskFilters() {
        taskFilterState.statuses.clear();
        taskFilterState.due.clear();
        taskFilterState.flags = { important: false, urgent: false };
        taskFilterState.stageId = "";
        taskFilterState.search = "";
        taskFilterChips?.querySelectorAll(".filter-chip").forEach((chip) => chip.classList.remove("active"));
        if (taskStageFilter) taskStageFilter.value = "";
        if (taskSearchInput) taskSearchInput.value = "";
        renderCompactTaskView();
      }

      function applyTaskFilters(list) {
        if (!Array.isArray(list)) return [];
        const search = taskFilterState.search;
        const stageId = taskFilterState.stageId;
        const statuses = taskFilterState.statuses;
        const dueFilters = taskFilterState.due;
        const { important, urgent } = taskFilterState.flags;
        return list.filter((task) => {
          if (statuses.size && !statuses.has(task.status)) return false;
          if (important && !task.important) return false;
          if (urgent && task.urgency !== "high") return false;
          if (stageId && String(task.gtm_stage_id) !== stageId) return false;
          if (search) {
            const haystack = `${task.title} ${task.description || ""}`.toLowerCase();
            if (!haystack.includes(search)) return false;
          }
          if (dueFilters.size) {
            const due = dueInfo(task);
            const states = new Set([
              due.state,
              due.state === "none" && !task.due_date ? "none" : null,
              due.state === "done" ? "done" : null,
            ].filter(Boolean));
            const intersects = Array.from(dueFilters).some((val) => states.has(val));
            if (!intersects) return false;
          }
          return true;
        });
      }

      function updateTaskFilterSummary(filteredCount, totalCount) {
        if (!taskFilterSummary) return;
        const active = [];
        if (taskFilterState.statuses.size) {
          const labels = Array.from(taskFilterState.statuses)
            .map((s) => taskStatusLabel(s))
            .join(", ");
          active.push(`–°—Ç–∞—Ç—É—Å—ã: ${labels}`);
        }
        if (taskFilterState.due.size) {
          const dueLabels = Array.from(taskFilterState.due)
            .map((d) => (d === "soon" ? "7 –¥–Ω–µ–π" : d === "overdue" ? "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" : d))
            .join(", ");
          active.push(`–°—Ä–æ–∫–∏: ${dueLabels}`);
        }
        if (taskFilterState.flags.important) active.push("–í–∞–∂–Ω–æ");
        if (taskFilterState.flags.urgent) active.push("–°—Ä–æ—á–Ω–æ");
        if (taskFilterState.stageId) {
          active.push(`–≠—Ç–∞–ø: ${stageTitle(taskFilterState.stageId)}`);
        }
        if (taskFilterState.search) {
          active.push(`–ü–æ–∏—Å–∫: ‚Äú${taskFilterState.search}‚Äù`);
        }
        const base = `–ü–æ–∫–∞–∑–∞–Ω–æ ${filteredCount} –∏–∑ ${totalCount || 0}`;
        taskFilterSummary.textContent = active.length ? `${base} ¬∑ ${active.join(" ¬∑ ")}` : base;
      }

      function handleFilterChipClick(event) {
        const btn = event.target.closest("[data-filter-group]");
        if (!btn) return;
        const group = btn.dataset.filterGroup;
        const value = btn.dataset.value;
        if (!group || !value) return;
        if (group === "status") {
          toggleFilterSet(taskFilterState.statuses, value, btn);
        } else if (group === "due") {
          toggleFilterSet(taskFilterState.due, value, btn);
        } else if (group === "flag") {
          taskFilterState.flags[value] = !taskFilterState.flags[value];
          btn.classList.toggle("active", taskFilterState.flags[value]);
        }
        renderCompactTaskView();
      }

      function toggleFilterSet(set, value, btn) {
        if (!set || !value) return;
        if (set.has(value)) {
          set.delete(value);
          btn?.classList.remove("active");
        } else {
          set.add(value);
          btn?.classList.add("active");
        }
      }

      function resetTaskFilters() {
        taskFilterState.statuses.clear();
        taskFilterState.due.clear();
        taskFilterState.flags = { important: false, urgent: false };
        taskFilterState.stageId = "";
        taskFilterState.search = "";
        taskFilterChips?.querySelectorAll(".filter-chip").forEach((chip) => chip.classList.remove("active"));
        if (taskStageFilter) taskStageFilter.value = "";
        if (taskSearchInput) taskSearchInput.value = "";
        renderCompactTaskView();
      }

      function applyTaskFilters(list) {
        if (!Array.isArray(list)) return [];
        const search = taskFilterState.search;
        const stageId = taskFilterState.stageId;
        const statuses = taskFilterState.statuses;
        const dueFilters = taskFilterState.due;
        const { important, urgent } = taskFilterState.flags;
        return list.filter((task) => {
          if (statuses.size && !statuses.has(task.status)) return false;
          if (important && !task.important) return false;
          if (urgent && task.urgency !== "high") return false;
          if (stageId && String(task.gtm_stage_id) !== stageId) return false;
          if (search) {
            const haystack = `${task.title} ${task.description || ""}`.toLowerCase();
            if (!haystack.includes(search)) return false;
          }
          if (dueFilters.size) {
            const due = dueInfo(task);
            const states = new Set([
              due.state,
              due.state === "none" && !task.due_date ? "none" : null,
              due.state === "done" ? "done" : null,
            ].filter(Boolean));
            const intersects = Array.from(dueFilters).some((val) => states.has(val));
            if (!intersects) return false;
          }
          return true;
        });
      }

      function updateTaskFilterSummary(filteredCount, totalCount) {
        if (!taskFilterSummary) return;
        const active = [];
        if (taskFilterState.statuses.size) {
          const labels = Array.from(taskFilterState.statuses)
            .map((s) => taskStatusLabel(s))
            .join(", ");
          active.push(`–°—Ç–∞—Ç—É—Å—ã: ${labels}`);
        }
        if (taskFilterState.due.size) {
          const dueLabels = Array.from(taskFilterState.due)
            .map((d) => (d === "soon" ? "7 –¥–Ω–µ–π" : d === "overdue" ? "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" : d))
            .join(", ");
          active.push(`–°—Ä–æ–∫–∏: ${dueLabels}`);
        }
        if (taskFilterState.flags.important) active.push("–í–∞–∂–Ω–æ");
        if (taskFilterState.flags.urgent) active.push("–°—Ä–æ—á–Ω–æ");
        if (taskFilterState.stageId) {
          active.push(`–≠—Ç–∞–ø: ${stageTitle(taskFilterState.stageId)}`);
        }
        if (taskFilterState.search) {
          active.push(`–ü–æ–∏—Å–∫: ‚Äú${taskFilterState.search}‚Äù`);
        }
        const base = `–ü–æ–∫–∞–∑–∞–Ω–æ ${filteredCount} –∏–∑ ${totalCount || 0}`;
        taskFilterSummary.textContent = active.length ? `${base} ¬∑ ${active.join(" ¬∑ ")}` : base;
      }

      function handleKanbanDragStart(event) {
        const card = event.currentTarget;
        draggedTaskId = card.dataset.taskId;
        card.classList.add("dragging");
        if (event.dataTransfer) {
          event.dataTransfer.setData("text/plain", draggedTaskId);
          event.dataTransfer.effectAllowed = "move";
        }
      }

      function handleKanbanDragEnd(event) {
        event.currentTarget.classList.remove("dragging");
        draggedTaskId = null;
      }

      function handleKanbanDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("drop-ready");
        if (event.dataTransfer) {
          event.dataTransfer.dropEffect = "move";
        }
      }

      function handleKanbanDragLeave(event) {
        event.currentTarget.classList.remove("drop-ready");
      }

      async function handleKanbanDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drop-ready");
        const status = event.currentTarget.dataset.status;
        if (!draggedTaskId || !status) {
          draggedTaskId = null;
          return;
        }
        const task = tasks.find((t) => String(t.id) === String(draggedTaskId));
        draggedTaskId = null;
        if (task && task.status !== status) {
          await changeTaskStatus(task.id, status);
        } else {
          renderCompactTaskView();
        }
      }

      function taskProgressScore(task) {
        if (!task) return 0;
        const subtasks = task.subtasks || [];
        if (subtasks.length) {
          const done = subtasks.filter((s) => s.done).length;
          return subtasks.length ? done / subtasks.length : 0;
        }
        if (task.status === "done") return 1;
        if (task.status === "in_progress") return 0.5;
        return 0;
      }

      function stageProgressScore(stage) {
        const relatedTasks = tasks.filter((task) => task.gtm_stage_id === stage.id);
        if (!relatedTasks.length) {
          if (stage.status === "done") return 1;
          if (stage.status === "in_progress") return 0.5;
          return 0;
        }
        const total = relatedTasks.reduce((acc, task) => acc + taskProgressScore(task), 0);
        return total / relatedTasks.length;
      }

      function calcProjectProgress() {
        const totalStages = gtmStages.length;
        if (!totalStages) {
          return { label: "–≠—Ç–∞–ø—ã –Ω–µ –∑–∞–¥–∞–Ω—ã", percent: 0, completed: 0 };
        }
        const stageScores = gtmStages.map((stage) => stageProgressScore(stage));
        const percent = Math.round((stageScores.reduce((a, b) => a + b, 0) / totalStages) * 100);
        const completed = stageScores.filter((score) => score >= 0.999).length;
        return { label: `–ó–∞–≤–µ—Ä—à–µ–Ω–æ ${completed} –∏–∑ ${totalStages}`, percent, completed };
      }

      function calcProjectRisk() {
        const today = new Date();
        const overdueStage = gtmStages.some(
          (s) => s.planned_end && ["done", "cancelled"].indexOf(s.status) === -1 && new Date(s.planned_end) < today
        );
        const overdueTask = tasks.some((t) => t.due_date && t.status !== "done" && new Date(t.due_date) < today);
        return overdueStage || overdueTask;
      }

      function renderGtmProgress() {
        const progress = calcProjectProgress();
        gtmProgressLabel.textContent = progress.label;
        gtmProgressFill.style.width = `${progress.percent}%`;
        gtmProgressBadge.textContent = `${progress.percent}%`;
        const risky = calcProjectRisk();
        if (projectRiskEl) {
          projectRiskEl.textContent = risky ? "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏" : "–†–∏—Å–∫–∏: –Ω–µ—Ç";
          projectRiskEl.classList.toggle("warn", risky);
        }
      }

      function openStageContextMenu(event, stage, index) {
        const actions = [
          { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => openStageForm(stage.id) },
          { label: stage.risk_flag ? "–°–Ω—è—Ç—å —Ä–∏—Å–∫" : "–û—Ç–º–µ—Ç–∏—Ç—å —Ä–∏—Å–∫", action: () => toggleRisk(stage.id, !stage.risk_flag) },
          { label: "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", action: () => openTaskForm(null, stage.id) },
          { label: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏", action: () => openStageDiscussion(stage.id) },
          { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö", disabled: index === 0, action: () => moveStage(stage.id, -1) },
          { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑", disabled: index === gtmStages.length - 1, action: () => moveStage(stage.id, 1) },
          { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteStage(stage.id) },
        ];
        openContextMenu(event, actions);
      }

      function openContextMenu(event, actions) {
        contextMenuList.innerHTML = "";
        actions.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item.label;
          if (item.disabled) {
            li.classList.add("disabled");
          } else {
            li.addEventListener("click", () => {
              item.action();
              hideContextMenu();
            });
          }
          contextMenuList.appendChild(li);
        });

        contextMenu.style.display = "block";
        contextMenu.style.left = `${event.pageX}px`;
        contextMenu.style.top = `${event.pageY}px`;
      }

      function hideContextMenu() {
        contextMenu.style.display = "none";
      }

      document.addEventListener("click", () => hideContextMenu());

      function openStageForm(stageId = null) {
        document.getElementById("modal").style.display = "flex";
        const stage = gtmStages.find((s) => s.id === stageId);
        document.getElementById("modalTitle").textContent = stage ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞" : "–ù–æ–≤—ã–π —ç—Ç–∞–ø";
        document.getElementById("stageId").value = stage ? stage.id : "";
        document.getElementById("stageTitle").value = stage ? stage.title : "";
        document.getElementById("stageOrder").value = stage ? stage.order : gtmStages.length;
        if (stageDescriptionArea) {
          stageDescriptionArea.innerHTML = stage?.description || "";
        }
        document.getElementById("stagePlannedStart").value = stage?.planned_start || "";
        document.getElementById("stagePlannedEnd").value = stage?.planned_end || "";
        document.getElementById("stageActualEnd").value = stage?.actual_end || "";
        document.getElementById("stageStatus").value = stage?.status || "not_started";
        document.getElementById("stageRisk").checked = stage?.risk_flag || false;
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
        if (stageDescriptionArea) {
          stageDescriptionArea.innerHTML = "";
        }
      }

      document.getElementById("stageForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = {
          title: document.getElementById("stageTitle").value,
          order: Number(document.getElementById("stageOrder").value || 0),
          description: editorHtml(stageDescriptionArea) || null,
          planned_start: document.getElementById("stagePlannedStart").value || null,
          planned_end: document.getElementById("stagePlannedEnd").value || null,
          actual_end: document.getElementById("stageActualEnd").value || null,
          status: document.getElementById("stageStatus").value,
          risk_flag: document.getElementById("stageRisk").checked,
          comments: [],
        };

        const stageId = document.getElementById("stageId").value;
        let res;
        if (stageId) {
          const existing = gtmStages.find((s) => s.id === stageId);
          payload.comments = existing?.comments || [];
          res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } else {
          if (!stageDescriptionArea) {
            payload.description = null;
          }
          res = await fetch(`/api/projects/${projectId}/gtm-stages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        }

        if (res.ok) {
          await loadStages();
          closeModal();
        } else {
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞");
        }
      });

      async function changeStatus(stageId, value) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.status = value;
        await saveStage(stage);
      }

      async function toggleRisk(stageId, value) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.risk_flag = value;
        await saveStage(stage);
      }

      async function moveStage(stageId, delta) {
        const index = gtmStages.findIndex((s) => s.id === stageId);
        if (index === -1) return;
        const target = index + delta;
        if (target < 0 || target >= gtmStages.length) return;
        const otherId = gtmStages[target].id;

        [gtmStages[index].order, gtmStages[target].order] = [gtmStages[target].order, gtmStages[index].order];
        const firstSave = saveStage(gtmStages[index]);
        const secondSave = saveStage(gtmStages[target]);
        await Promise.all([firstSave, secondSave]);
        await loadStages();
      }

      async function deleteStage(stageId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø?")) return;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}`, { method: "DELETE" });
        if (res.ok) {
          await loadStages();
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø");
        }
      }

      async function saveStage(stage) {
        await fetch(`/api/projects/${projectId}/gtm-stages/${stage.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(stage),
        });
      }

      async function applyTemplate() {
        const templateId = templateSelect.value;
        if (!templateId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω");
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/apply-template?template_id=${templateId}`, {
          method: "POST",
        });
        if (res.ok) {
          gtmStages = await res.json();
          renderStages();
          await loadTasks();
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      async function saveTemplate() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞", project?.name ? `GTM ${project.name}` : "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω");
        if (!name) return;
        const description = prompt("–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") || null;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/save-template`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description }),
        });
        if (res.ok) {
          await loadTemplates();
          alert("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      function triggerImport() {
        importInput.click();
      }

      importInput.addEventListener("change", async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/import`, {
          method: "POST",
          body: formData,
        });
        if (res.ok) {
          gtmStages = await res.json();
          renderStages();
          await loadTasks();
          alert("–≠—Ç–∞–ø—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        } else {
          const detail = await res.json();
          alert(detail?.detail?.errors?.join("\n") || "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
        }
        event.target.value = "";
      });

      async function exportStages() {
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/export`);
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–ø—ã");
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `gtm_stages_${projectId}.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      async function loadTasks() {
        const res = await fetch(`/api/projects/${projectId}/tasks`, { cache: "no-store" });
        tasks = res.ok ? await res.json() : [];
        renderStages();
        renderGtmProgress();
        renderCompactTaskView();
        focusTaskIfNeeded();
      }

      function renderTaskFilters() {
        taskGtmStageSelect.innerHTML = "";
        const sorted = [...gtmStages].sort((a, b) => a.order - b.order);
        if (!sorted.length) {
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "–ù–µ—Ç —ç—Ç–∞–ø–æ–≤";
          taskGtmStageSelect.appendChild(placeholder);
          taskGtmStageSelect.disabled = true;
        } else {
          taskGtmStageSelect.disabled = false;
        }
        sorted.forEach((stage) => {
          const option = document.createElement("option");
          option.value = stage.id;
          option.textContent = `${stage.order}. ${stage.title}`;
          taskGtmStageSelect.appendChild(option);
        });
        if (taskStageFilter) {
          const current = taskStageFilter.value;
          taskStageFilter.innerHTML = '<option value="">–í—Å–µ —ç—Ç–∞–ø—ã</option>';
          sorted.forEach((stage) => {
            const option = document.createElement("option");
            option.value = stage.id;
            option.textContent = `${stage.order}. ${stage.title}`;
            taskStageFilter.appendChild(option);
          });
          if (current) {
            const match = Array.from(taskStageFilter.options).some((opt) => opt.value === current);
            taskStageFilter.value = match ? current : "";
          }
        }
      }

      function taskStatusLabel(value) {
        return {
          todo: "ToDo",
          in_progress: "–í —Ä–∞–±–æ—Ç–µ",
          done: "–ì–æ—Ç–æ–≤–æ",
        }[value] || value;
      }

      function stageTitle(stageId) {
        if (!stageId) return "–ë–µ–∑ —ç—Ç–∞–ø–∞";
        const stage = gtmStages.find((s) => s.id === stageId);
        return stage ? `${stage.order}. ${stage.title}` : "–ë–µ–∑ —ç—Ç–∞–ø–∞";
      }

      function dueInfo(task) {
        const base = { text: "–°—Ä–æ–∫ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω", className: "tag", tagKind: "", state: "none" };
        if (!task.due_date) return base;
        const today = new Date();
        const due = new Date(task.due_date);
        const diffDays = Math.floor((due - today) / (1000 * 60 * 60 * 24));
        if (task.status === "done") {
          return { text: `–°—Ä–æ–∫: ${task.due_date}`, className: "tag", tagKind: "positive", state: "done" };
        }
        if (due < today) {
          return {
            text: `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(diffDays)} –¥–Ω.`,
            className: "tag due-overdue",
            tagKind: "negative",
            state: "overdue",
          };
        }
        if (diffDays <= 7) {
          return {
            text: `–î–æ —Å—Ä–æ–∫–∞ ${diffDays} –¥–Ω.`,
            className: "tag due-soon",
            tagKind: "warn",
            state: "soon",
          };
        }
        return { text: `–°—Ä–æ–∫: ${task.due_date}`, className: "tag", tagKind: "", state: "scheduled" };
      }

      function buildInlineStatusControl(task) {
        const wrapper = document.createElement("div");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "inline-chip-btn";
        btn.textContent = taskStatusLabel(task.status);

        const openSelect = () => {
          if (wrapper.querySelector("select")) return;
          const select = document.createElement("select");
          select.className = "inline-edit-input";
          [
            { value: "todo", label: "ToDo" },
            { value: "in_progress", label: "–í —Ä–∞–±–æ—Ç–µ" },
            { value: "done", label: "–ì–æ—Ç–æ–≤–æ" },
          ].forEach(({ value, label }) => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = label;
            if (value === task.status) option.selected = true;
            select.appendChild(option);
          });
          const close = () => {
            wrapper.replaceChildren(btn);
          };
          select.addEventListener("change", async () => {
            await updateTaskInline(task.id, { status: select.value });
          });
          select.addEventListener("blur", close);
          wrapper.replaceChildren(select);
          select.focus();
        };

        btn.addEventListener("click", openSelect);
        wrapper.appendChild(btn);
        return wrapper;
      }

      function buildInlineDueControl(task) {
        const wrapper = document.createElement("div");
        const due = dueInfo(task);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `inline-chip-btn tag-mini ${due.tagKind}`.trim();
        btn.textContent = due.text;

        const openDate = () => {
          if (wrapper.querySelector("input")) return;
          const input = document.createElement("input");
          input.type = "date";
          input.className = "inline-edit-input";
          input.value = task.due_date || "";
          const close = () => wrapper.replaceChildren(btn);
          input.addEventListener("change", async () => {
            const nextValue = input.value || null;
            await updateTaskInline(task.id, { due_date: nextValue });
          });
          input.addEventListener("blur", close);
          wrapper.replaceChildren(input);
          input.focus();
          if (input.showPicker) input.showPicker();
        };

        btn.addEventListener("click", openDate);
        wrapper.appendChild(btn);
        return wrapper;
      }

      function createCompactTaskRow(task, variant = "table") {
        const rowPriorityClass = task.priority ? `priority-${task.priority}` : "";
        const due = dueInfo(task);
        const progress = taskProgress(task);

        const titleWrap = document.createElement("div");
        titleWrap.className = "compact-row-title";
        const titleEl = document.createElement("strong");
        titleEl.textContent = task.title;
        const metaLine = document.createElement("div");
        metaLine.className = "muted";
        metaLine.textContent = task.description?.trim() || "–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ";
        titleWrap.append(titleEl, metaLine);

        const statusControl = buildInlineStatusControl(task);
        const dueControl = buildInlineDueControl(task);

        if (variant === "kanban") {
          const card = document.createElement("div");
          card.className = "kanban-card compact priority-bar";
          if (rowPriorityClass) card.classList.add(rowPriorityClass);
          card.draggable = true;
          card.dataset.taskId = task.id;
          card.addEventListener("dragstart", handleKanbanDragStart);
          card.addEventListener("dragend", handleKanbanDragEnd);
          card.addEventListener("dblclick", () => openTaskForm(task.id));

          const titleBlock = document.createElement("div");
          titleBlock.appendChild(titleWrap);
          card.appendChild(titleBlock);

          const meta = document.createElement("div");
          meta.className = "kanban-meta";
          meta.innerHTML = `<span>${stageTitle(task.gtm_stage_id)}</span>`;
          meta.appendChild(dueControl);
          card.appendChild(meta);

          const progressBar = document.createElement("div");
          progressBar.className = "micro-progress";
          if (due.state === "overdue") progressBar.classList.add("danger");
          if (due.state === "soon") progressBar.classList.add("warn");
          const fill = document.createElement("span");
          fill.style.width = `${progress.percent}%`;
          progressBar.appendChild(fill);
          card.appendChild(progressBar);

          const badges = document.createElement("div");
          badges.className = "compact-actions-inline";
          if (task.important) {
            badges.insertAdjacentHTML("beforeend", '<span class="flag-badge flag-important">–í–∞–∂–Ω–æ</span>');
          }
          if (task.urgency === "high") {
            badges.insertAdjacentHTML("beforeend", '<span class="flag-badge flag-urgent">–°—Ä–æ—á–Ω–æ</span>');
          }
          badges.appendChild(statusControl);
          const commentBtn = document.createElement("button");
          commentBtn.type = "button";
          commentBtn.className = "icon-button";
          commentBtn.textContent = "üí¨";
          commentBtn.title = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏";
          commentBtn.addEventListener("click", () => openTaskDiscussion(task.id));
          badges.appendChild(commentBtn);
          card.appendChild(badges);
          return card;
        }

        const row = document.createElement("tr");

        const titleCell = document.createElement("td");
        titleCell.className = "priority-bar";
        if (rowPriorityClass) titleCell.classList.add(rowPriorityClass);
        titleCell.appendChild(titleWrap);
        row.appendChild(titleCell);

        const stageCell = document.createElement("td");
        stageCell.innerHTML = `<span class="tag-mini">${stageTitle(task.gtm_stage_id)}</span>`;
        row.appendChild(stageCell);

        const statusCell = document.createElement("td");
        statusCell.appendChild(statusControl);
        row.appendChild(statusCell);

        const importanceCell = document.createElement("td");
        importanceCell.innerHTML = task.important ? '<span class="flag-badge flag-important">–í–∞–∂–Ω–æ</span>' : "‚Äî";
        row.appendChild(importanceCell);

        const urgencyCell = document.createElement("td");
        urgencyCell.innerHTML = task.urgency === "high" ? '<span class="flag-badge flag-urgent">–°—Ä–æ—á–Ω–æ</span>' : "‚Äî";
        row.appendChild(urgencyCell);

        const dueCell = document.createElement("td");
        dueCell.appendChild(dueControl);
        row.appendChild(dueCell);

        const progressCell = document.createElement("td");
        const micro = document.createElement("div");
        micro.className = "micro-progress";
        if (due.state === "overdue") micro.classList.add("danger");
        if (due.state === "soon") micro.classList.add("warn");
        const fill = document.createElement("span");
        fill.style.width = `${progress.percent}%`;
        micro.appendChild(fill);
        const progressLabel = document.createElement("div");
        progressLabel.className = "muted";
        progressLabel.textContent = `${progress.percent}% (${progress.label})`;
        progressCell.append(micro, progressLabel);
        row.appendChild(progressCell);

        const actionsCell = document.createElement("td");
        const actionWrap = document.createElement("div");
        actionWrap.className = "table-actions";

        const toggleStatus = task.status === "done" ? "todo" : "done";
        const toggleTitle = task.status === "done" ? "–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É" : "–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π";
        const toggleIcon = toggleStatus === "todo" ? "‚Ü∫" : "‚úî";

        const actionButtons = [
          { label: "‚úèÔ∏è", title: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", onClick: () => openTaskForm(task.id) },
          { label: "üí¨", title: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏", onClick: () => openTaskDiscussion(task.id) },
          { label: toggleIcon, title: toggleTitle, onClick: () => changeTaskStatus(task.id, toggleStatus) },
          { label: "üóëÔ∏è", title: "–£–¥–∞–ª–∏—Ç—å", onClick: () => deleteTask(task.id), danger: true },
        ];

        actionButtons.forEach((cfg) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = cfg.danger ? "icon-button danger" : "icon-button";
          btn.textContent = cfg.label;
          btn.title = cfg.title;
          btn.addEventListener("click", cfg.onClick);
          actionWrap.appendChild(btn);
        });

        actionsCell.appendChild(actionWrap);
        row.appendChild(actionsCell);
        return row;
      }

      function createSubtaskComposer(taskId) {
        const composer = document.createElement("div");
        composer.className = "subtask-inline";
        composer.innerHTML = `
          <input class="inline-input" placeholder="–ù–æ–≤–∞—è –ø–æ–¥–∑–∞–¥–∞—á–∞" />
          <button class="ghost">–î–æ–±–∞–≤–∏—Ç—å</button>
        `;
        const [subInput, subBtn] = composer.querySelectorAll("input, button");
        const submit = () => {
          const title = subInput.value.trim();
          if (!title) return;
          addSubtask(taskId, title);
          subInput.value = "";
        };
        subBtn.addEventListener("click", submit);
        subInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            submit();
          }
        });
        return composer;
      }

      function renderSubtasksSection(task) {
        const wrapper = document.createElement("div");
        const subtasks = [...(task.subtasks || [])].sort((a, b) => a.order - b.order);
        const active = subtasks.filter((s) => !s.done);
        const completed = subtasks.filter((s) => s.done);

        const buildList = (items, titleText, emptyText) => {
          const block = document.createElement("div");
          const heading = document.createElement("div");
          heading.className = "muted";
          heading.textContent = titleText;
          block.appendChild(heading);
          const list = document.createElement("ul");
          list.className = "subtasks";
          if (!items.length) {
            const li = document.createElement("li");
            li.className = "muted";
            li.style.background = "transparent";
            li.style.border = "none";
            li.textContent = emptyText;
            list.appendChild(li);
          } else {
            items.forEach((sub) => {
              const li = document.createElement("li");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = sub.done;
              checkbox.addEventListener("change", (event) => {
                toggleSubtask(task.id, sub.id, event.target.checked);
              });

              const title = document.createElement("div");
              title.className = "subtask-title";
              title.contentEditable = true;
              title.textContent = sub.title;
              if (sub.done) {
                title.style.textDecoration = "line-through";
                title.style.color = "#94a3b8";
              }
              title.addEventListener("blur", () => updateSubtaskTitle(task.id, sub.id, title.innerText));
              title.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                  e.preventDefault();
                  title.blur();
                }
              });

              const actions = document.createElement("div");
              actions.className = "subtask-actions";
              const editBtn = document.createElement("button");
              editBtn.className = "ghost";
              editBtn.textContent = "‚úèÔ∏è";
              editBtn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
              editBtn.addEventListener("click", () => title.focus());
              const delBtn = document.createElement("button");
              delBtn.className = "ghost";
              delBtn.textContent = "üóëÔ∏è";
              delBtn.addEventListener("click", () => deleteSubtask(task.id, sub.id));
              actions.appendChild(editBtn);
              actions.appendChild(delBtn);

              li.appendChild(checkbox);
              li.appendChild(title);
              li.appendChild(actions);
              li.addEventListener("contextmenu", (event) => {
                event.preventDefault();
                const itemsMenu = [
                  { label: sub.done ? "–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π" : "–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π", action: () => toggleSubtask(task.id, sub.id, !sub.done) },
                  { label: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", action: () => title.focus() },
                  { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteSubtask(task.id, sub.id) },
                ];
                openContextMenu(event, itemsMenu);
              });
              list.appendChild(li);
            });
          }
          block.appendChild(list);
          return block;
        };

        wrapper.appendChild(buildList(active, "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏", "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∑–∞–¥–∞—á"));
        wrapper.appendChild(buildList(completed, "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ", "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"));
        wrapper.appendChild(createSubtaskComposer(task.id));
        return wrapper;
      }

      function openTaskDiscussion(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task || !discussionModal) return;
        discussionContext = { type: "task", id: taskId };
        discussionModal.style.display = "flex";
        discussionModal.dataset.open = "true";
        discussionTitle.textContent = `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–¥–∞—á–µ: ${task.title}`;
        renderDiscussionModalContent();
      }

      function openStageDiscussion(stageId) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage || !discussionModal) return;
        discussionContext = { type: "stage", id: stageId };
        discussionModal.style.display = "flex";
        discussionModal.dataset.open = "true";
        discussionTitle.textContent = `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —ç—Ç–∞–ø—É: ${stage.title}`;
        renderDiscussionModalContent();
      }

      function closeDiscussionModal() {
        if (!discussionModal) return;
        discussionModal.style.display = "none";
        discussionModal.dataset.open = "false";
        discussionList.innerHTML = "";
        discussionComposer.innerHTML = "";
        discussionContext = null;
      }

      function getDiscussionOwner() {
        if (!discussionContext) return null;
        if (discussionContext.type === "task") {
          return tasks.find((t) => t.id === discussionContext.id) || null;
        }
        if (discussionContext.type === "stage") {
          return gtmStages.find((s) => s.id === discussionContext.id) || null;
        }
        return null;
      }

      function renderDiscussionModalContent() {
        if (!discussionModal || !discussionContext) return;
        const owner = getDiscussionOwner();
        if (!owner) {
          discussionList.innerHTML = "<li class='muted'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</li>";
          discussionComposer.innerHTML = "";
          return;
        }
        const comments = owner.comments?.slice().sort((a, b) => new Date(b.created_at) - new Date(a.created_at)) || [];
        discussionList.innerHTML = "";
        if (!comments.length) {
          const empty = document.createElement("li");
          empty.className = "muted";
          empty.textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç";
          discussionList.appendChild(empty);
        } else {
          comments.forEach((comment) => {
            const item = document.createElement("li");
            item.className = "comment-item";
            item.id = `discussion-comment-${comment.id}`;
            const meta = document.createElement("div");
            meta.className = "muted";
            meta.style.fontSize = "0.85rem";
            const edited = comment.edited_at
              ? ` ¬∑ –∏–∑–º–µ–Ω–µ–Ω–æ ${new Date(comment.edited_at).toLocaleString("ru-RU")}`
              : "";
            meta.textContent = `${new Date(comment.created_at).toLocaleString("ru-RU")}${edited}`;
            const body = document.createElement("div");
            body.innerHTML = comment.text || "";
            const actions = document.createElement("div");
            actions.className = "comment-actions";
            const editBtn = document.createElement("button");
            editBtn.className = "ghost";
            editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
            editBtn.addEventListener("click", () => startDiscussionEdit(comment.id));
            const delBtn = document.createElement("button");
            delBtn.className = "ghost";
            delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
            delBtn.addEventListener("click", () => {
              if (!discussionContext) return;
              if (discussionContext.type === "task") {
                deleteTaskComment(discussionContext.id, comment.id);
              } else {
                deleteStageComment(discussionContext.id, comment.id);
              }
            });
            actions.appendChild(editBtn);
            actions.appendChild(delBtn);
            item.appendChild(meta);
            item.appendChild(body);
            item.appendChild(actions);
            discussionList.appendChild(item);
          });
        }

        discussionComposer.innerHTML = "";
        const editorContainer = document.createElement("div");
        editorContainer.className = "comment-editor";
        const editorId = `discussion-editor-${discussionContext.type}-${owner.id}`;
        const { wrapper, area } = createRichEditor(editorId, "–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", true);
        editorContainer.appendChild(wrapper);
        const composerActions = document.createElement("div");
        composerActions.className = "comment-actions";
        const saveBtn = document.createElement("button");
        saveBtn.className = "primary";
        saveBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å";
        saveBtn.addEventListener("click", () => {
          if (!discussionContext) return;
          const html = editorHtml(area);
          if (discussionContext.type === "task") {
            addTaskComment(owner.id, html, area);
          } else {
            addStageComment(owner.id, html, area);
          }
        });
        const clearBtn = document.createElement("button");
        clearBtn.className = "ghost";
        clearBtn.textContent = "–û—á–∏—Å—Ç–∏—Ç—å";
        clearBtn.addEventListener("click", () => {
          area.innerHTML = "";
        });
        composerActions.appendChild(saveBtn);
        composerActions.appendChild(clearBtn);
        editorContainer.appendChild(composerActions);
        discussionComposer.appendChild(editorContainer);
      }

      function refreshDiscussionModal() {
        if (discussionModal?.dataset.open === "true" && discussionContext) {
          renderDiscussionModalContent();
        }
      }

      function startDiscussionEdit(commentId) {
        const owner = getDiscussionOwner();
        if (!owner) return;
        const comment = owner.comments?.find((c) => c.id === commentId);
        if (!comment) return;
        const item = document.getElementById(`discussion-comment-${commentId}`);
        if (!item) return;
        item.innerHTML = "";
        const editorId = `discussion-edit-${commentId}`;
        const { wrapper, area } = createRichEditor(editorId, "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", true);
        area.innerHTML = comment.text || "";
        item.appendChild(wrapper);
        const actions = document.createElement("div");
        actions.className = "comment-actions";
        const saveBtn = document.createElement("button");
        saveBtn.className = "primary";
        saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        saveBtn.addEventListener("click", () => persistDiscussionUpdate(commentId, editorHtml(area)));
        const cancelBtn = document.createElement("button");
        cancelBtn.className = "ghost";
        cancelBtn.textContent = "–û—Ç–º–µ–Ω–∞";
        cancelBtn.addEventListener("click", renderDiscussionModalContent);
        actions.appendChild(saveBtn);
        actions.appendChild(cancelBtn);
        item.appendChild(actions);
      }

      async function persistDiscussionUpdate(commentId, html) {
        const text = (html || "").trim();
        if (!text || !discussionContext) return;
        if (discussionContext.type === "task") {
          await updateTaskComment(discussionContext.id, commentId, text);
        } else {
          await updateStageComment(discussionContext.id, commentId, text);
        }
      }

      async function addTaskComment(taskId, html, areaRef = null) {
        const text = (html || "").trim();
        if (!text) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        if (areaRef) areaRef.innerHTML = "";
        await loadTasks();
        refreshDiscussionModal();
      }

      async function updateTaskComment(taskId, commentId, html) {
        const text = (html || "").trim();
        if (!text) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/comments/${commentId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadTasks();
        refreshDiscussionModal();
      }

      async function deleteTaskComment(taskId, commentId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/comments/${commentId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadTasks();
        refreshDiscussionModal();
      }

      async function addStageComment(stageId, html, areaRef = null) {
        const text = (html || "").trim();
        if (!text) return;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        if (areaRef) areaRef.innerHTML = "";
        await loadStages();
        refreshDiscussionModal();
      }

      async function updateStageComment(stageId, commentId, text) {
        const prepared = (text || "").trim();
        if (!prepared) return;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}/comments/${commentId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: prepared }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadStages();
        refreshDiscussionModal();
      }

      async function deleteStageComment(stageId, commentId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —ç—Ç–∞–ø–∞?")) return;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}/comments/${commentId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
        return;
        }
        await loadStages();
        refreshDiscussionModal();
      }

      function openTaskForm(taskId = null, defaultStageId = null) {
        taskModal.style.display = "flex";
        const task = tasks.find((t) => t.id === taskId);
        document.getElementById("taskModalTitle").textContent = task ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" : "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞";
        document.getElementById("taskId").value = task?.id || "";
        document.getElementById("taskTitle").value = task?.title || "";
        document.getElementById("taskDescription").value = task?.description || "";
        document.getElementById("taskStatus").value = task?.status || "todo";
        document.getElementById("taskDueDate").value = task?.due_date || "";
        document.getElementById("taskImportant").checked = task?.important || false;
        if (taskUrgencyField) {
          taskUrgencyField.value = task?.urgency || "normal";
        }
        if (task?.gtm_stage_id) {
          taskGtmStageSelect.value = task.gtm_stage_id;
        } else if (defaultStageId) {
          taskGtmStageSelect.value = defaultStageId;
        } else if (gtmStages.length) {
          const sorted = [...gtmStages].sort((a, b) => a.order - b.order);
          taskGtmStageSelect.value = sorted[0].id;
        } else {
          taskGtmStageSelect.value = "";
        }
      }

      function closeTaskModal() {
        taskModal.style.display = "none";
      }

      document.getElementById("taskForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = {
          title: document.getElementById("taskTitle").value,
          description: document.getElementById("taskDescription").value || null,
          status: document.getElementById("taskStatus").value,
          due_date: document.getElementById("taskDueDate").value || null,
          important: document.getElementById("taskImportant").checked,
          urgency: taskUrgencyField?.value || "normal",
          gtm_stage_id: document.getElementById("taskGtmStage").value || null,
          subtasks: [],
          comments: [],
        };

        if (!payload.gtm_stage_id) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ GTM-—ç—Ç–∞–ø –¥–ª—è –∑–∞–¥–∞—á–∏");
          return;
        }
        const taskId = document.getElementById("taskId").value;
        let res;
        if (taskId) {
          const existing = tasks.find((t) => t.id === taskId);
          payload.subtasks = existing?.subtasks || [];
          payload.comments = existing?.comments || [];
          payload.id = taskId;
          res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } else {
          res = await fetch(`/api/projects/${projectId}/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        }
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É");
          return;
        }
        closeTaskModal();
        await loadTasks();
      });

      async function updateTaskInline(taskId, patch) {
        const existing = tasks.find((t) => t.id === taskId);
        if (!existing) return;
        const payload = { ...existing, ...patch };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function changeTaskStatus(taskId, status) {
        await updateTaskInline(taskId, { status });
      }

      async function toggleImportant(taskId) {
        const existing = tasks.find((t) => t.id === taskId);
        if (!existing) return;
        const payload = { ...existing, important: !existing.important };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å");
          return;
        }
        await loadTasks();
      }

      async function deleteTask(taskId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏ –µ—ë –ø–æ–¥–∑–∞–¥–∞—á–∏?")) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function addSubtask(taskId, title) {
        const prepared = title?.trim();
        if (!prepared) return;
        const task = tasks.find((t) => t.id === taskId);
        const order = task?.subtasks?.length || 0;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: prepared, done: false, order }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function toggleSubtask(taskId, subtaskId, done) {
        const task = tasks.find((t) => t.id === taskId);
        const sub = task?.subtasks.find((s) => s.id === subtaskId);
        if (!task || !sub) return;
        const payload = { ...sub, done };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks/${subtaskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function updateSubtaskTitle(taskId, subtaskId, title) {
        const task = tasks.find((t) => t.id === taskId);
        const sub = task?.subtasks.find((s) => s.id === subtaskId);
        const prepared = title?.trim();
        if (!task || !sub || !prepared) return;
        const payload = { ...sub, title: prepared };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks/${subtaskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function deleteSubtask(taskId, subtaskId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É?")) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks/${subtaskId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function loadImages() {
        const res = await fetch(`/api/projects/${projectId}/images`, { cache: "no-store" });
        if (res.ok) {
          images = await res.json();
          renderGallery();
          renderCoverPanel();
        }
      }

      function imageDownloadUrl(image) {
        if (!image) return "";
        const cacheKey = encodeURIComponent(image.updated_at || image.uploaded_at || image.id || "0");
        return `/api/projects/${projectId}/images/${image.id}/download?ts=${cacheKey}`;
      }

      function resetGalleryObserver() {
        if (galleryObserver) {
          galleryObserver.disconnect();
        }

        galleryObserver = new IntersectionObserver(
          (entries, obs) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.dataset.src;
                if (src && img.src !== src) {
                  img.src = src;
                }
                obs.unobserve(img);
              }
            });
          },
          { rootMargin: "200px 0px" }
        );

        galleryContainer.querySelectorAll("img[data-src]").forEach((img) => {
          galleryObserver.observe(img);
        });
      }

      function renderGallery() {
        galleryContainer.innerHTML = "";
        const sorted = [...images].sort((a, b) => a.order - b.order);
        lightboxOrder = sorted;

        if (!sorted.length) {
          galleryContainer.innerHTML = "<p class='muted'>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>";
          return;
        }

        let cancelled = false;
        const fragment = document.createDocumentFragment();
        const total = sorted.length;
        const batchByTime = typeof requestIdleCallback === "function";

        const renderChunk = () => {
          if (cancelled) return;

          const start = performance.now();
          let processed = 0;

          while (processed < 12 && galleryContainer.isConnected) {
            const currentIndex = fragment.childElementCount;
            if (currentIndex >= total) break;

            const img = sorted[currentIndex];
            const card = document.createElement("div");
            card.className = "image-card";
            card.innerHTML = `
              ${img.is_cover ? '<span class="cover-chip">–û–±–ª–æ–∂–∫–∞</span>' : ""}
              <img class="image-thumb" src="${transparentPixel}" data-src="${imageDownloadUrl(img)}" alt="${img.filename}" loading="lazy" decoding="async" fetchpriority="low" onclick="openImage('${img.id}')" />
              <div class="image-meta">
                <div style="display:flex; flex-direction:column; gap:2px">
                  <strong>${img.filename}</strong>
                  <span class="muted" style="font-size:0.9rem">${img.caption || "–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∏"}</span>
                </div>
                <div class="toolbar">
                  <button class="ghost" onclick="openImage('${img.id}')">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                  <button class="ghost" onclick="editImageCaption('${img.id}')">–ü–æ–¥–ø–∏—Å—å</button>
                  <button class="ghost" onclick="setCover('${img.id}')" ${img.is_cover ? "disabled" : ""}>–°–¥–µ–ª–∞—Ç—å –æ–±–ª–æ–∂–∫–æ–π</button>
                  <button class="ghost" onclick="moveImage('${img.id}', -1)" ${currentIndex === 0 ? "disabled" : ""}>‚Üë</button>
                  <button class="ghost" onclick="moveImage('${img.id}', 1)" ${currentIndex === total - 1 ? "disabled" : ""}>‚Üì</button>
                  <button onclick="deleteImage('${img.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </div>
            `;

            card.addEventListener("contextmenu", (event) => {
              event.preventDefault();
              const actions = [
                { label: "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å", action: () => openImage(img.id) },
                { label: "–°–¥–µ–ª–∞—Ç—å –æ–±–ª–æ–∂–∫–æ–π", action: () => setCover(img.id) },
                { label: "–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å—å", action: () => editImageCaption(img.id) },
                { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteImage(img.id) },
              ];
              openContextMenu(event, actions);
            });

            fragment.appendChild(card);
            processed += 1;

            if (batchByTime && performance.now() - start > 12) {
              break;
            }
          }

          if (fragment.childElementCount >= total) {
            galleryContainer.replaceChildren(fragment);
            resetGalleryObserver();
            cancelled = true;
            return;
          }

          scheduleIdle(renderChunk);
        };

        const handle = scheduleIdle(renderChunk);
        galleryContainer.addEventListener(
          "DOMNodeRemovedFromDocument",
          () => {
            cancelled = true;
            cancelIdle(handle);
          },
          { once: true }
        );
      }

      function renderCoverPanel() {
        const cover = getCoverImage();
        if (cover) {
          coverImage.src = imageDownloadUrl(cover);
          coverImage.style.display = "block";
          coverPlaceholder.style.display = "none";
          clearCoverButton.disabled = false;
        } else {
          coverImage.removeAttribute("src");
          coverImage.style.display = "none";
          coverPlaceholder.style.display = "flex";
          clearCoverButton.disabled = true;
        }
      }

      function getCoverImage() {
        return images.find((img) => img.is_cover) || null;
      }

      function triggerImageUpload() {
        imageUploadInput.click();
      }

      imageUploadInput.addEventListener("change", async (event) => {
        const selected = Array.from(event.target.files || []);
        for (const file of selected) {
          const optimized = await maybeDownscaleImage(file);
          const formData = new FormData();
          formData.append("file", optimized);
          const res = await fetch(`/api/projects/${projectId}/images/upload`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
            break;
          }
        }
        imageUploadInput.value = "";
        await loadImages();
      });

      function triggerCoverUpload() {
        coverUploadInput.click();
      }

      coverUploadInput.addEventListener("change", async (event) => {
        const selected = event.target.files?.[0];
        if (!selected) return;
        const optimized = await maybeDownscaleImage(selected);
        const formData = new FormData();
        formData.append("file", optimized);
        formData.append("is_cover", "true");
        const res = await fetch(`/api/projects/${projectId}/images/upload`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É");
        }
        coverUploadInput.value = "";
        await loadImages();
      });

      async function clearCover() {
        const res = await fetch(`/api/projects/${projectId}/images/clear-cover`, { method: "POST" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –æ–±–ª–æ–∂–∫—É");
          return;
        }
        await loadImages();
      }

      async function downloadAllImages() {
        const res = await fetch(`/api/projects/${projectId}/images/archive`);
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π");
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `project-${projectId}-images.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function scrollToGallery() {
        gallerySection?.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function openImage(imageId) {
        if (!lightboxOrder.length) {
          lightboxOrder = [...images].sort((a, b) => a.order - b.order);
        }
        const idx = lightboxOrder.findIndex((img) => img.id === imageId);
        if (idx === -1) return;
        lightboxIndex = idx;
        showLightbox();
      }

      function showLightbox() {
        const current = lightboxOrder[lightboxIndex];
        if (!current) return;
        lightboxImage.src = imageDownloadUrl(current);
        lightboxTitle.textContent = current.filename;
        lightboxCaption.textContent = current.caption || "";
        lightbox.dataset.open = "true";
      }

      function closeLightbox() {
        lightbox.dataset.open = "false";
      }

      function nextLightbox() {
        if (!lightboxOrder.length) return;
        lightboxIndex = (lightboxIndex + 1) % lightboxOrder.length;
        showLightbox();
      }

      function prevLightbox() {
        if (!lightboxOrder.length) return;
        lightboxIndex = (lightboxIndex - 1 + lightboxOrder.length) % lightboxOrder.length;
        showLightbox();
      }

      async function setCover(imageId) {
        const image = images.find((img) => img.id === imageId);
        if (!image) return;
        const payload = { ...image, is_cover: true };
        const res = await fetch(`/api/projects/${projectId}/images/${imageId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–±–ª–æ–∂–∫—É");
          return;
        }
        await loadImages();
      }

      async function editImageCaption(imageId) {
        const image = images.find((img) => img.id === imageId);
        if (!image) return;
        const caption = prompt("–ü–æ–¥–ø–∏—Å—å/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", image.caption || "");
        if (caption === null) return;
        const payload = { ...image, caption: caption || null };
        const res = await fetch(`/api/projects/${projectId}/images/${imageId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å");
          return;
        }
        await loadImages();
      }

      async function moveImage(imageId, delta) {
        const sorted = [...images].sort((a, b) => a.order - b.order);
        const index = sorted.findIndex((img) => img.id === imageId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= sorted.length) return;
        [sorted[index], sorted[target]] = [sorted[target], sorted[index]];
        sorted.forEach((img, idx) => (img.order = idx));
        await Promise.all(
          sorted.map((img) =>
            fetch(`/api/projects/${projectId}/images/${img.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(img),
            })
          )
        );
        await loadImages();
      }

      async function deleteImage(imageId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?")) return;
        const res = await fetch(`/api/projects/${projectId}/images/${imageId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
          return;
        }
        await loadImages();
      }

      async function loadFiles() {
        const res = await fetch(`/api/projects/${projectId}/files`);
        if (res.ok) {
          files = await res.json();
          renderFiles();
        }
      }

      function renderFiles() {
        fileTable.innerHTML = "";
        if (!files.length) {
          const row = document.createElement("tr");
          row.innerHTML = '<td colspan="5" class="muted">–§–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</td>';
          fileTable.appendChild(row);
          return;
        }

        files
          .slice()
          .sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at))
          .forEach((file) => {
            const row = document.createElement("tr");
            const date = new Date(file.uploaded_at).toLocaleString("ru-RU");
            row.innerHTML = `
              <td>${file.name}</td>
              <td>${file.description || ""}</td>
              <td>${file.category || ""}</td>
              <td>${date}</td>
              <td>
                <button class="ghost" onclick="downloadFile('${file.id}')">–°–∫–∞—á–∞—Ç—å</button>
                <button class="ghost" onclick="openFileModal('${file.id}')">–ü—Ä–∞–≤–∏—Ç—å</button>
                <button onclick="deleteFile('${file.id}')">–£–¥–∞–ª–∏—Ç—å</button>
              </td>
            `;
            row.addEventListener("contextmenu", (event) => {
              event.preventDefault();
              const actions = [
                { label: "–°–∫–∞—á–∞—Ç—å", action: () => downloadFile(file.id) },
                { label: "–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ/–∫–∞—Ç–µ–≥–æ—Ä–∏—é", action: () => openFileModal(file.id) },
                { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteFile(file.id) },
              ];
              openContextMenu(event, actions);
            });
            fileTable.appendChild(row);
          });
      }

      function downloadFile(fileId) {
        window.open(`/api/projects/${projectId}/files/${fileId}/download`, "_blank");
      }

      function openFileModal(fileId = null) {
        if (!fileModal) return;
        const editing = Boolean(fileId);
        fileModal.style.display = "flex";
        fileModalTitle.textContent = editing ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞" : "–ù–æ–≤—ã–π —Ñ–∞–π–ª";
        fileIdField.value = editing ? fileId : "";
        if (fileInput) {
          fileInput.value = "";
          fileInput.required = !editing;
        }
        if (fileUploadRow) {
          fileUploadRow.style.display = editing ? "none" : "flex";
        }
        if (editing) {
          const existing = files.find((f) => f.id === fileId);
          if (!existing) {
            alert("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
            fileModal.style.display = "none";
            return;
          }
          fileNameInput.value = existing?.name || "";
          fileDescriptionInput.value = existing?.description || "";
          fileCategoryInput.value = existing?.category || "";
        } else {
          fileNameInput.value = "";
          fileDescriptionInput.value = "";
          fileCategoryInput.value = "";
        }
      }

      function closeFileModal() {
        if (!fileModal) return;
        fileModal.style.display = "none";
        resetFileForm();
      }

      function resetFileForm() {
        fileIdField.value = "";
        fileNameInput.value = "";
        fileDescriptionInput.value = "";
        fileCategoryInput.value = "";
        if (fileInput) {
          fileInput.value = "";
          fileInput.required = true;
        }
        if (fileUploadRow) {
          fileUploadRow.style.display = "flex";
        }
      }

      async function handleFileSubmit(event) {
        event.preventDefault();
        const editing = Boolean(fileIdField.value);
        if (editing) {
          const existing = files.find((f) => f.id === fileIdField.value);
          if (!existing) {
            alert("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
          }
          const payload = {
            ...existing,
            name: fileNameInput.value.trim() || existing.name,
            description: fileDescriptionInput.value.trim() || null,
            category: fileCategoryInput.value.trim() || null,
          };
          const res = await fetch(`/api/projects/${projectId}/files/${existing.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª");
            return;
          }
        } else {
          const upload = fileInput?.files?.[0];
          if (!upload) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
            return;
          }
          const formData = new FormData();
          formData.append("file", upload);
          if (fileNameInput.value.trim()) formData.append("name", fileNameInput.value.trim());
          if (fileDescriptionInput.value.trim()) formData.append("description", fileDescriptionInput.value.trim());
          if (fileCategoryInput.value.trim()) formData.append("category", fileCategoryInput.value.trim());
          const res = await fetch(`/api/projects/${projectId}/files/upload`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª");
            return;
          }
        }
        closeFileModal();
        await loadFiles();
      }

      async function deleteFile(fileId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?")) return;
        const res = await fetch(`/api/projects/${projectId}/files/${fileId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª");
          return;
        }
        await loadFiles();
      }

      async function loadProjectComments() {
        const res = await fetch(`/api/projects/${projectId}/comments`);
        if (res.ok) {
          projectComments = await res.json();
          renderProjectComments();
        }
      }

      function renderProjectComments() {
        projectCommentsList.innerHTML = "";
        if (!projectComments.length) {
          const li = document.createElement("li");
          li.className = "muted";
          li.textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç";
          projectCommentsList.appendChild(li);
          return;
        }
        projectComments
          .slice()
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .forEach((comment) => {
            const li = document.createElement("li");
            li.className = "comment-item";
            const meta = document.createElement("div");
            meta.className = "muted";
            meta.style.fontSize = "0.85rem";
            const edited = comment.edited_at
              ? ` (–∏–∑–º–µ–Ω—ë–Ω ${new Date(comment.edited_at).toLocaleString("ru-RU")})`
              : "";
            meta.textContent = `${new Date(comment.created_at).toLocaleString("ru-RU")}${edited}`;
            const body = document.createElement("div");
            body.innerHTML = comment.text || "";
            const actions = document.createElement("div");
            actions.className = "toolbar";
            actions.style.margin = "6px 0 0";
            const editBtn = document.createElement("button");
            editBtn.className = "ghost";
            editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
            editBtn.addEventListener("click", () => startProjectCommentEdit(comment));
            const remove = document.createElement("button");
            remove.className = "ghost";
            remove.textContent = "–£–¥–∞–ª–∏—Ç—å";
            remove.addEventListener("click", () => deleteProjectComment(comment.id));
            actions.appendChild(editBtn);
            actions.appendChild(remove);
            li.appendChild(meta);
            li.appendChild(body);
            li.appendChild(actions);
            projectCommentsList.appendChild(li);
          });
      }

      async function addProjectComment() {
        const html = editorHtml(projectCommentArea);
        if (!html) return;
        const res = await fetch(`/api/projects/${projectId}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: html }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        clearEditor("projectCommentArea");
        await loadProjectComments();
      }

      function startProjectCommentEdit(comment) {
        const existing = Array.from(projectCommentsList.children).find((li) =>
          li.querySelector(".toolbar button")?.onclick?.toString().includes(comment.id)
        );
        const li = existing || document.createElement("li");
        li.innerHTML = "";
        li.className = "comment-item";
        const editor = document.createElement("div");
        editor.className = "rich-editor";
        editor.innerHTML = `
          <div class="rich-editor-toolbar">
            <button type="button" onclick="formatSelection('bold')">B</button>
            <button type="button" onclick="formatSelection('italic')"><em>I</em></button>
            <button type="button" onclick="formatSelection('insertUnorderedList')">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
            <button type="button" onclick="addLinkToSelection()">–°—Å—ã–ª–∫–∞</button>
          </div>
          <div class="rich-editor-area" contenteditable="true">${comment.text || ""}</div>
        `;
        const actions = document.createElement("div");
        actions.className = "toolbar";
        actions.style.marginTop = "6px";
        const save = document.createElement("button");
        save.className = "primary";
        save.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        save.addEventListener("click", async () => {
          const html = editorHtml(editor.querySelector(".rich-editor-area"));
          if (!html) return;
          await updateProjectComment(comment.id, html);
        });
        const cancel = document.createElement("button");
        cancel.className = "ghost";
        cancel.textContent = "–û—Ç–º–µ–Ω–∞";
        cancel.addEventListener("click", renderProjectComments);
        actions.appendChild(save);
        actions.appendChild(cancel);
        li.appendChild(editor);
        li.appendChild(actions);
        if (!existing) projectCommentsList.prepend(li);
      }

      async function updateProjectComment(commentId, text) {
        const res = await fetch(`/api/projects/${projectId}/comments/${commentId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadProjectComments();
      }

      async function deleteProjectComment(commentId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) return;
        const res = await fetch(`/api/projects/${projectId}/comments/${commentId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadProjectComments();
      }

      async function loadHistory() {
        const res = await fetch(`/api/projects/${projectId}/history`);
        if (res.ok) {
          historyEvents = await res.json();
          renderHistory();
        }
      }

      function renderHistory() {
        historyContainer.innerHTML = "";
        if (historyAccordion) historyAccordion.open = false;
        if (!historyEvents.length) {
          historyContainer.innerHTML = "<p class='muted'>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è.</p>";
          return;
        }

        const list = document.createElement("ul");
        list.className = "history-list";
        historyEvents
          .slice()
          .sort((a, b) => new Date(b.occurred_at) - new Date(a.occurred_at))
          .forEach((event) => {
            const item = document.createElement("li");
            item.className = "history-row";
            const left = document.createElement("div");
            left.innerHTML = `
              <div class="muted" style="font-size:0.85rem">${new Date(event.occurred_at).toLocaleString("ru-RU")}</div>
              <div><strong>${event.summary}</strong></div>
              ${event.details ? `<div class="muted">${event.details}</div>` : ""}
            `;
            const actions = document.createElement("div");
            actions.className = "toolbar";
            const remove = document.createElement("button");
            remove.className = "ghost";
            remove.textContent = "–£–¥–∞–ª–∏—Ç—å";
            remove.addEventListener("click", () => deleteHistoryEvent(event.id));
            actions.appendChild(remove);
            item.appendChild(left);
            item.appendChild(actions);
            list.appendChild(item);
          });
        historyContainer.appendChild(list);
      }

      async function addHistoryEvent() {
        const summary = prompt("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è");
        if (!summary || !summary.trim()) return;
        const details = prompt("–î–µ—Ç–∞–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") || null;
        const res = await fetch(`/api/projects/${projectId}/history`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ summary, details }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ");
          return;
        }
        await loadHistory();
      }

      async function deleteHistoryEvent(eventId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏?")) return;
        const res = await fetch(`/api/projects/${projectId}/history/${eventId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏");
          return;
        }
        await loadHistory();
      }


    </script>
    <footer class="site-footer">
      <small>Made by Smuk Marian / 2025</small>
    </footer>
  </body>
</html>
