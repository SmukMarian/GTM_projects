<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/theme.js" defer></script>
    <script>
      (() => {
        const key = "hpt-theme";
        const normalize = (value) =>
          value === "dark" || value === "light" || value === "system" ? value : null;
        const stored = normalize(localStorage.getItem(key));
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const mode = stored || "system";
        const theme = mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        document.documentElement.dataset.theme = theme;
        document.documentElement.dataset.themeMode = mode;
        document.documentElement.style.colorScheme = theme === "dark" ? "dark" : "light";
      })();
    </script>
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî Haier Project Tracker</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        --bg: #f3f5f9;
        --bg-alt: #eef1f6;
        --surface: #ffffff;
        --surface-muted: #f7f8fc;
        --text: #0f172a;
        --muted: #475569;
        --border: #d9e0ea;
        --divider: rgba(148, 163, 184, 0.35);
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.12);
        --danger: #ef4444;
        --warning: #f59e0b;
      }

      [data-theme="dark"] {
        color-scheme: dark;
        --bg: #0e1218;
        --bg-alt: #0b1017;
        --surface: #111827;
        --surface-muted: #161f30;
        --text: #e6edf3;
        --muted: #9aa6b6;
        --border: #1f2937;
        --divider: rgba(148, 163, 184, 0.25);
        --shadow: 0 22px 50px rgba(0, 0, 0, 0.5);
        --accent: #10a37f;
        --accent-strong: #19b88f;
        --accent-soft: rgba(16, 163, 127, 0.2);
        --danger: #f87171;
        --warning: #fbbf24;
      }

      body {
        margin: 0 auto;
        max-width: 1200px;
        padding: 34px 20px 72px;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-alt) 100%);
        color: var(--text);
      }

      a {
        color: var(--accent);
      }

      h1 {
        margin: 4px 0 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--surface-muted);
        color: var(--accent);
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid var(--border);
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 18px 18px 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 16px;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        background: var(--accent-soft);
        color: var(--text);
      }

      .badge.archived {
        background: rgba(248, 113, 113, 0.15);
        color: #dc2626;
      }

      .badge.closed {
        background: var(--surface-muted);
        color: var(--text);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 12px;
      }

      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 9px 14px;
        border-radius: 12px;
        color: var(--text);
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent-strong), var(--accent));
        border-color: var(--accent);
        color: #fff;
        font-weight: 700;
        box-shadow: 0 12px 30px rgba(16, 163, 127, 0.2);
      }

      button.ghost {
        background: transparent;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      label {
        display: grid;
        gap: 6px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font: inherit;
        background: var(--surface-muted);
        color: var(--text);
      }

      textarea {
        resize: vertical;
      }

      .grid-two {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }

      .stage-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        background: var(--surface);
      }

      .stage-header {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: var(--surface-muted);
        border-radius: 8px;
        font-size: 0.85rem;
      }

      .chip.warn {
        background: rgba(248, 113, 113, 0.16);
        color: #fca5a5;
      }

      .checklist li {
        list-style: none;
        margin: 6px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .muted {
        color: var(--muted);
        font-size: 0.95rem;
      }

      .context-menu {
        position: absolute;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        padding: 6px 0;
        display: none;
        z-index: 20;
      }

      .context-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
        min-width: 200px;
      }

      .context-menu li {
        padding: 10px 14px;
        cursor: pointer;
      }

      .context-menu li:hover {
        background: var(--accent-soft);
      }

      .context-menu li.disabled {
        color: var(--muted);
        cursor: not-allowed;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 30;
      }

      .modal {
        background: var(--surface);
        padding: 20px;
        border-radius: 14px;
        width: min(640px, 92vw);
        max-height: 90vh;
        overflow: auto;
        box-shadow: var(--shadow);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }

      th,
      td {
        border: 1px solid var(--border);
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: var(--surface-muted);
        font-weight: 700;
      }

      .inline-input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px 8px;
        background: var(--surface-muted);
        color: var(--text-primary);
        min-height: 36px;
        resize: vertical;
      }

      .inline-input:focus {
        outline: 2px solid var(--accent);
        background: var(--surface);
      }

      .inline-checkbox {
        width: 20px;
        height: 20px;
      }

      .inline-status {
        font-size: 0.85rem;
        color: var(--muted);
      }

      tr.saving td {
        background: color-mix(in srgb, var(--accent-soft) 40%, transparent);
      }

      tr.save-error td {
        background: color-mix(in srgb, #ef4444 18%, transparent);
      }

      .characteristics-grid {
        display: grid;
        gap: 12px;
      }

      .section-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: var(--surface);
      }

      .task-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: var(--surface);
        margin-bottom: 12px;
      }

      .task-meta {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: var(--surface-muted);
        border-radius: 10px;
        font-size: 0.85rem;
      }

      .status-chip.todo {
        background: #eef2ff;
        color: #312e81;
      }

      .status-chip.in_progress {
        background: #e0f2fe;
        color: #075985;
      }

      .status-chip.done {
        background: #ecfdf3;
        color: #166534;
      }

      .task-board {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }

      .task-column {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        background: var(--surface);
      }

      .tag {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 4px 8px;
        border-radius: 8px;
        background: var(--surface-muted);
        font-size: 0.85rem;
      }

      .tag.due-overdue {
        background: #fef2f2;
        color: #991b1b;
      }

      .tag.due-soon {
        background: #fffbeb;
        color: #92400e;
      }

      .subtasks {
        margin-top: 10px;
        padding-left: 0;
      }

      .subtasks li {
        list-style: none;
        margin: 6px 0;
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 6px 8px;
        border-radius: 8px;
        background: var(--surface-muted);
      }

      .subtask-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 6px;
      }

      .inline-input,
      .inline-textarea,
      .inline-select {
        width: 100%;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
      }

      .inline-textarea {
        min-height: 34px;
        resize: vertical;
      }

      .progress-line {
        width: 100%;
        height: 6px;
        background: var(--surface-muted);
        border-radius: 999px;
        overflow: hidden;
      }

      .progress-line .fill {
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
      }

      .rich-editor {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--surface);
      }

      .rich-editor-toolbar {
        display: flex;
        gap: 6px;
        padding: 6px;
        border-bottom: 1px solid var(--border);
        background: var(--surface-muted);
      }

      .rich-editor-toolbar button {
        border: 1px solid var(--border);
        padding: 4px 8px;
        border-radius: 8px;
        background: var(--surface);
      }

      .rich-editor-area {
        padding: 8px;
        min-height: 60px;
      }

      .comment-list {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 6px;
      }

      .comment-item {
        background: var(--surface-muted);
        border-radius: 8px;
        padding: 6px 8px;
      }

      .history-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 6px;
      }

      .history-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--surface);
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }

      .image-card {
        position: relative;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: var(--surface);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-soft);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .image-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .image-thumb {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        background: var(--surface-muted);
        cursor: pointer;
      }

      .image-meta {
        padding: 8px 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .image-card .toolbar {
        gap: 6px;
        flex-wrap: wrap;
      }

      .cover-chip {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--accent);
        color: #fff;
        padding: 4px 8px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.75rem;
        box-shadow: var(--shadow);
      }

      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1500;
        padding: 24px;
      }

      .lightbox[data-open="true"] {
        display: flex;
      }

      .lightbox-content {
        position: relative;
        max-width: min(1080px, 90vw);
        max-height: 90vh;
        background: var(--surface);
        border-radius: 16px;
        padding: 12px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .lightbox img {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 12px;
        object-fit: contain;
        background: var(--surface-muted);
      }

      .lightbox .lightbox-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .lightbox .nav-buttons {
        display: flex;
        gap: 8px;
      }

      .file-table {
        width: 100%;
        border-collapse: collapse;
      }

      .file-table th,
      .file-table td {
        border-bottom: 1px solid var(--border);
        padding: 10px 8px;
        text-align: left;
      }

      .theme-toggle-group {
        position: fixed;
        top: 16px;
        right: 16px;
        display: inline-flex;
        gap: 6px;
        padding: 6px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 999px;
        box-shadow: var(--shadow);
        z-index: 1200;
      }

      .theme-toggle-group button {
        border: none;
        background: transparent;
        color: var(--text);
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s ease, background-color 0.2s ease, color 0.2s ease;
      }

      .theme-toggle-group button[data-active="true"] {
        background: var(--accent-soft);
        color: var(--accent);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      }

      .theme-toggle-group button:hover {
        transform: translateY(-2px);
        background-color: var(--surface-muted);
      }

      .project-hero {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 16px;
        align-items: stretch;
      }

      .project-hero-left {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .project-hero-right {
        background: var(--surface-muted);
        border: 1px dashed var(--border);
        border-radius: 16px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 100%;
      }

      .cover-frame {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(0, 0, 0, 0.08));
        border: 1px solid var(--border);
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-soft);
      }

      .cover-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .cover-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: var(--muted-text);
        text-align: center;
        padding: 12px;
      }

      .cover-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
      }

      .meta-tile {
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .meta-tile span {
        color: var(--muted-text);
        font-size: 12px;
      }

      .progress-shell {
        background: var(--surface-muted);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background: var(--border);
        border-radius: 999px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-strong, #2dd4bf));
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="theme-toggle-group" role="group" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã">
      <button type="button" data-theme-select="light" aria-pressed="false" aria-label="–í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É">‚òÄÔ∏è</button>
      <button type="button" data-theme-select="system" aria-pressed="false" aria-label="–°–ª–µ–¥–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º">üñ•Ô∏è</button>
      <button type="button" data-theme-select="dark" aria-pressed="false" aria-label="–í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É">üåô</button>
    </div>
    <div class="toolbar">
      <a href="/projects.html">‚Üê –ö —Å–ø–∏—Å–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤</a>
      <a href="/groups.html">–ì—Ä—É–ø–ø—ã</a>
      <a href="/index.html">–î–∞—à–±–æ—Ä–¥</a>
    </div>

    <div id="project-card" class="card">
      <div class="project-hero">
        <div class="project-hero-left">
          <div style="display: flex; justify-content: space-between; gap: 12px; align-items: center; flex-wrap: wrap">
            <div>
              <p class="pill">–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</p>
              <h1 id="project-name">–ü—Ä–æ–µ–∫—Ç</h1>
            </div>
            <div id="project-badges" style="display: flex; gap: 8px; flex-wrap: wrap"></div>
          </div>
          <div id="project-meta" class="muted"></div>
          <div class="meta-grid">
            <div class="meta-tile">
              <span>–ì—Ä—É–ø–ø–∞</span>
              <strong id="project-group">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–ë—Ä–µ–Ω–¥</span>
              <strong id="project-brand">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–†—ã–Ω–æ–∫</span>
              <strong id="project-market">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞</span>
              <strong id="project-planned">‚Äî</strong>
            </div>
            <div class="meta-tile">
              <span>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞</span>
              <strong id="project-actual">‚Äî</strong>
            </div>
          </div>
          <div class="progress-shell">
            <div style="display:flex; justify-content: space-between; align-items:center; gap: 8px; flex-wrap: wrap">
              <div style="display:flex; flex-direction: column; gap: 4px">
                <span class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ GTM-—ç—Ç–∞–ø–∞–º</span>
                <strong id="gtm-progress-label">–ù–µ—Ç —ç—Ç–∞–ø–æ–≤</strong>
              </div>
              <div id="gtm-progress-badge" class="badge">0%</div>
            </div>
            <div class="progress-bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ GTM">
              <div id="gtm-progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <p id="project-desc" class="muted"></p>
        </div>
        <div class="project-hero-right">
          <div class="cover-frame" id="cover-frame">
            <div id="cover-placeholder" class="cover-placeholder">
              <div style="font-size: 28px">üñºÔ∏è</div>
              <div>–î–æ–±–∞–≤—å—Ç–µ –æ–±–ª–æ–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞</div>
            </div>
            <img id="cover-image" alt="–û–±–ª–æ–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞" style="display: none" />
          </div>
          <div class="cover-actions">
            <button class="primary" onclick="triggerCoverUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å / –∑–∞–º–µ–Ω–∏—Ç—å</button>
            <button class="ghost" onclick="clearCover()" id="clear-cover" disabled>–°–Ω—è—Ç—å –æ–±–ª–æ–∂–∫—É</button>
            <button class="ghost" onclick="scrollToGallery()">–ì–∞–ª–µ—Ä–µ—è</button>
          </div>
          <input type="file" id="coverUpload" accept="image/*" style="display: none" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>GTM-—ç—Ç–∞–ø—ã</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="openStageForm()">–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø</button>
          <select id="templateSelect"></select>
          <button onclick="applyTemplate()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
          <button onclick="saveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</button>
          <button onclick="triggerImport()">–ò–º–ø–æ—Ä—Ç Excel</button>
          <button onclick="exportStages()">–≠–∫—Å–ø–æ—Ä—Ç Excel</button>
          <input type="file" id="importInput" accept=".xlsx" style="display: none" />
        </div>
      </div>
      <div id="stages"></div>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (RU / EN)</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="promptSection()">–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é</button>
          <select id="characteristicTemplateSelect"></select>
          <button onclick="applyCharacteristicTemplate()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
          <button onclick="saveCharacteristicTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</button>
          <button onclick="copyCharacteristicStructure()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
          <button onclick="triggerCharacteristicImport()">–ò–º–ø–æ—Ä—Ç Excel</button>
          <button onclick="exportCharacteristics()">–≠–∫—Å–ø–æ—Ä—Ç Excel</button>
          <input type="file" id="characteristicImport" accept=".xlsx" style="display: none" />
        </div>
      </div>
      <div id="characteristics"></div>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ó–∞–¥–∞—á–∏ –∏ –ø–æ–¥–∑–∞–¥–∞—á–∏</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="openTaskForm()">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
          <button id="taskViewToggle" onclick="toggleTaskView()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥: —Å–ø–∏—Å–æ–∫</button>
        </div>
      </div>
      <div class="toolbar" style="gap: 16px">
        <label style="width: 200px">
          –°—Ç–∞—Ç—É—Å
          <select id="taskStatusFilter">
            <option value="all">–í—Å–µ</option>
            <option value="todo">ToDo</option>
            <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done">–ì–æ—Ç–æ–≤–æ</option>
          </select>
        </label>
        <label style="width: 200px">
          –°—Ä–æ–∫–∏
          <select id="taskDueFilter">
            <option value="all">–í—Å–µ —Å—Ä–æ–∫–∏</option>
            <option value="upcoming">–ë–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π</option>
            <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
          </select>
        </label>
        <label style="width: 220px">
          GTM-—ç—Ç–∞–ø
          <select id="taskGtmFilter">
            <option value="">–í—Å–µ —ç—Ç–∞–ø—ã</option>
          </select>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; font-weight: 600">
          <input type="checkbox" id="taskHideDone" /> –°–∫—Ä—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
        </label>
      </div>
      <div id="tasks"></div>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ì–∞–ª–µ—Ä–µ—è –∏ –æ–±–ª–æ–∂–∫–∞</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="triggerImageUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
        </div>
      </div>
      <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –æ–±–ª–æ–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ –º–µ–Ω—é –∏–ª–∏ –∫–Ω–æ–ø–∫—É. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤.</p>
      <div id="gallery" class="gallery-grid"></div>
      <input type="file" id="imageUploadInput" accept="image/*" style="display: none" multiple />
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–§–∞–π–ª—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="triggerFileUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        </div>
      </div>
      <p class="muted">–§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –ø—Ä–∞–≤–æ–∫.</p>
      <table class="file-table">
        <thead>
          <tr>
            <th>–ò–º—è</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="fileTable"></tbody>
      </table>
      <input type="file" id="fileUploadInput" style="display: none" />
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É</h2>
        <div style="display:flex; flex-direction: column; gap: 8px; width: 100%;">
          <div id="projectCommentEditor" class="rich-editor" style="max-width: 640px">
            <div class="rich-editor-toolbar">
              <button type="button" onclick="formatSelection('bold')">B</button>
              <button type="button" onclick="formatSelection('italic')"><em>I</em></button>
              <button type="button" onclick="formatSelection('insertUnorderedList')">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
              <button type="button" onclick="addLinkToSelection()">–°—Å—ã–ª–∫–∞</button>
            </div>
            <div id="projectCommentArea" class="rich-editor-area" contenteditable="true" aria-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –ø—Ä–æ–µ–∫—Ç—É"></div>
          </div>
          <div class="toolbar" style="margin:0; gap: 8px; flex-wrap: wrap; align-items: center;">
            <button class="primary" onclick="addProjectComment()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="ghost" onclick="clearEditor('projectCommentArea')">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </div>
      </div>
      <ul id="projectComments" class="comment-list"></ul>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
        <div class="toolbar" style="margin: 0">
          <button class="ghost" onclick="addHistoryEvent()">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        </div>
      </div>
      <details id="historyAccordion" class="card" style="background: var(--surface-muted); margin: 0">
        <summary style="cursor: pointer; display:flex; align-items:center; gap:6px; font-weight:700">–ò—Å—Ç–æ—Ä–∏—è (—Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</summary>
        <div id="history" style="margin-top: 8px"></div>
      </details>
    </div>

    <div id="lightbox" class="lightbox" data-open="false" aria-label="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
      <div class="lightbox-content">
        <img id="lightboxImage" alt="" />
        <div class="lightbox-actions">
          <div>
            <div id="lightboxTitle" style="font-weight:700"></div>
            <div id="lightboxCaption" class="muted"></div>
          </div>
          <div class="nav-buttons">
            <button class="ghost" onclick="prevLightbox()">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–µ–µ</button>
            <button class="ghost" onclick="nextLightbox()">–°–ª–µ–¥—É—é—â–µ–µ ‚Üí</button>
            <button onclick="closeLightbox()">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <div id="contextMenu" class="context-menu">
      <ul id="contextMenuList"></ul>
    </div>

    <div id="modal" class="modal-backdrop">
      <div class="modal">
        <h3 id="modalTitle">–≠—Ç–∞–ø</h3>
        <form id="stageForm">
          <input type="hidden" id="stageId" />
          <div class="grid-two">
            <label>
              –ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞
              <input required id="stageTitle" />
            </label>
            <label>
              –ü–æ—Ä—è–¥–æ–∫
              <input type="number" id="stageOrder" min="0" />
            </label>
          </div>
          <label>
            –û–ø–∏—Å–∞–Ω–∏–µ
            <textarea id="stageDescription" rows="3"></textarea>
          </label>
          <div class="grid-two">
            <label>
              –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
              <input type="date" id="stagePlannedStart" />
            </label>
            <label>
              –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
              <input type="date" id="stagePlannedEnd" />
            </label>
          </div>
          <div class="grid-two">
            <label>
              –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
              <input type="date" id="stageActualEnd" />
            </label>
            <label>
              –°—Ç–∞—Ç—É—Å
              <select id="stageStatus">
                <option value="not_started">–ù–µ –Ω–∞—á–∞—Ç</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
              </select>
            </label>
          </div>
          <label style="display: flex; align-items: center; gap: 8px">
            <input type="checkbox" id="stageRisk" /> –û—Ç–º–µ—Ç–∏—Ç—å —Ä–∏—Å–∫
          </label>
          <div style="margin-top: 12px; display: flex; gap: 10px; justify-content: flex-end">
            <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>

    <div id="taskModal" class="modal-backdrop">
      <div class="modal">
        <h3 id="taskModalTitle">–ó–∞–¥–∞—á–∞</h3>
        <form id="taskForm">
          <input type="hidden" id="taskId" />
          <label>
            –ó–∞–≥–æ–ª–æ–≤–æ–∫
            <input required id="taskTitle" />
          </label>
          <label>
            –û–ø–∏—Å–∞–Ω–∏–µ
            <textarea id="taskDescription" rows="3"></textarea>
          </label>
          <div class="grid-two">
            <label>
              –°—Ç–∞—Ç—É—Å
              <select id="taskStatus">
                <option value="todo">ToDo</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ì–æ—Ç–æ–≤–æ</option>
              </select>
            </label>
            <label>
              –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
              <input type="date" id="taskDueDate" />
            </label>
          </div>
          <div class="grid-two">
            <label>
              GTM-—ç—Ç–∞–ø
              <select id="taskGtmStage">
                <option value="">–ù–µ –∑–∞–¥–∞–Ω</option>
              </select>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600">
              <input type="checkbox" id="taskImportant" /> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤–∞–∂–Ω—É—é
            </label>
          </div>
          <div style="margin-top: 12px; display: flex; gap: 10px; justify-content: flex-end">
            <button type="button" onclick="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const projectId = params.get("id");
      const stagesContainer = document.getElementById("stages");
      const templateSelect = document.getElementById("templateSelect");
      const importInput = document.getElementById("importInput");
      const characteristicContainer = document.getElementById("characteristics");
      const characteristicTemplateSelect = document.getElementById("characteristicTemplateSelect");
      const characteristicImport = document.getElementById("characteristicImport");
      const tasksContainer = document.getElementById("tasks");
      const taskStatusFilter = document.getElementById("taskStatusFilter");
      const taskDueFilter = document.getElementById("taskDueFilter");
      const taskGtmFilter = document.getElementById("taskGtmFilter");
      const taskHideDone = document.getElementById("taskHideDone");
      const taskViewToggle = document.getElementById("taskViewToggle");
      const taskModal = document.getElementById("taskModal");
      const taskGtmStageSelect = document.getElementById("taskGtmStage");

      const galleryContainer = document.getElementById("gallery");
      const imageUploadInput = document.getElementById("imageUploadInput");
      const fileUploadInput = document.getElementById("fileUploadInput");
      const fileTable = document.getElementById("fileTable");
      const projectCommentArea = document.getElementById("projectCommentArea");
      const projectCommentsList = document.getElementById("projectComments");
      const historyContainer = document.getElementById("history");
      const historyAccordion = document.getElementById("historyAccordion");
      const lightbox = document.getElementById("lightbox");
      const lightboxImage = document.getElementById("lightboxImage");
      const lightboxTitle = document.getElementById("lightboxTitle");
      const lightboxCaption = document.getElementById("lightboxCaption");

      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");
      const coverImage = document.getElementById("cover-image");
      const coverPlaceholder = document.getElementById("cover-placeholder");
      const coverUploadInput = document.getElementById("coverUpload");
      const clearCoverButton = document.getElementById("clear-cover");
      const gallerySection = document.getElementById("gallery");
      const projectGroupEl = document.getElementById("project-group");
      const projectBrandEl = document.getElementById("project-brand");
      const projectMarketEl = document.getElementById("project-market");
      const projectPlannedEl = document.getElementById("project-planned");
      const projectActualEl = document.getElementById("project-actual");
      const gtmProgressLabel = document.getElementById("gtm-progress-label");
      const gtmProgressFill = document.getElementById("gtm-progress-fill");
      const gtmProgressBadge = document.getElementById("gtm-progress-badge");

      let project = null;
      let groupInfo = null;
      let gtmTemplates = [];
      let gtmStages = [];
      let characteristicTemplates = [];
      let characteristicSections = [];
      let tasks = [];
      let images = [];
      let lightboxOrder = [];
      let lightboxIndex = 0;
      let files = [];
      let projectComments = [];
      let historyEvents = [];
      let taskView = "list";
      const taskFilters = { status: "all", due: "all", gtm: "", hideDone: false };

      if (!projectId) {
        stagesContainer.innerHTML = "<p>–ù–µ —É–∫–∞–∑–∞–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö ?id=</p>";
      } else {
        loadData();
      }

      if (historyAccordion) {
        historyAccordion.open = false;
      }

      lightbox?.addEventListener("click", (event) => {
        if (event.target === lightbox) {
          closeLightbox();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (lightbox?.dataset.open === "true") {
          if (event.key === "Escape") closeLightbox();
          if (event.key === "ArrowRight") nextLightbox();
          if (event.key === "ArrowLeft") prevLightbox();
        }
      });

      function formatSelection(command, value = null) {
        document.execCommand(command, false, value);
      }

      function addLinkToSelection() {
        const url = prompt("–°—Å—ã–ª–∫–∞");
        if (url) {
          document.execCommand("createLink", false, url);
        }
      }

      function clearEditor(areaId) {
        const area = document.getElementById(areaId);
        if (area) area.innerHTML = "";
      }

      function editorHtml(area) {
        return (area?.innerHTML || "").trim();
      }

      taskStatusFilter.addEventListener("change", (event) => {
        taskFilters.status = event.target.value;
        loadTasks();
      });

      taskDueFilter.addEventListener("change", (event) => {
        taskFilters.due = event.target.value;
        renderTasks();
      });

      taskGtmFilter.addEventListener("change", (event) => {
        taskFilters.gtm = event.target.value;
        loadTasks();
      });

      taskHideDone.addEventListener("change", (event) => {
        taskFilters.hideDone = event.target.checked;
        loadTasks();
      });

      async function loadData() {
        await Promise.all([
          loadProject(),
          loadTemplates(),
          loadStages(),
          loadCharacteristicTemplates(),
          loadCharacteristics(),
        ]);
        await Promise.all([loadTasks(), loadImages(), loadFiles(), loadProjectComments(), loadHistory()]);
      }

      function taskProgress(task) {
        const total = task.subtasks?.length || 0;
        if (!total) {
          const base = task.status === "done" ? 100 : task.status === "in_progress" ? 60 : 10;
          return { percent: base, label: "–ë–µ–∑ –ø–æ–¥–∑–∞–¥–∞—á" };
        }
        const done = task.subtasks.filter((s) => s.done).length;
        const percent = Math.round((done / total) * 100);
        return { percent, label: `${done}/${total}` };
      }

      async function loadProject() {
        const res = await fetch(`/api/projects/${projectId}`);
        if (!res.ok) {
          stagesContainer.innerHTML = "<p>–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>";
          return;
        }
        project = await res.json();
        await loadGroupInfo();
        renderProject();
      }

      async function loadGroupInfo() {
        if (!project?.group_id) return;
        const res = await fetch(`/api/groups/${project.group_id}`);
        groupInfo = res.ok ? await res.json() : null;
      }

      async function loadTemplates() {
        const res = await fetch("/api/gtm-templates");
        gtmTemplates = res.ok ? await res.json() : [];
        renderTemplates();
      }

      async function loadStages() {
        const res = await fetch(`/api/projects/${projectId}/gtm-stages`);
        gtmStages = res.ok ? await res.json() : [];
        renderStages();
        renderTaskFilters();
        renderGtmProgress();
      }

      async function loadCharacteristicTemplates() {
        const res = await fetch("/api/characteristic-templates");
        characteristicTemplates = res.ok ? await res.json() : [];
        renderCharacteristicTemplates();
      }

      async function loadCharacteristics() {
        const res = await fetch(`/api/projects/${projectId}/characteristics/sections`);
        characteristicSections = res.ok ? await res.json() : [];
        renderCharacteristics();
      }

      function renderProject() {
        document.getElementById("project-name").textContent = project.name;
        document.getElementById("project-desc").textContent = project.short_description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
        const metaParts = [];
        if (groupInfo?.name) metaParts.push(`–ì—Ä—É–ø–ø–∞: ${groupInfo.name}`);
        if (project.brand) metaParts.push(`–ë—Ä–µ–Ω–¥: ${project.brand}`);
        if (project.market) metaParts.push(`–†—ã–Ω–æ–∫: ${project.market}`);
        if (project.planned_launch) metaParts.push(`–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞: ${project.planned_launch}`);
        if (project.actual_launch) metaParts.push(`–§–∞–∫—Ç: ${project.actual_launch}`);
        document.getElementById("project-meta").textContent = metaParts.join(" ¬∑ ") || "–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞";
        projectGroupEl.textContent = groupInfo?.name || "‚Äî";
        projectBrandEl.textContent = project.brand || "‚Äî";
        projectMarketEl.textContent = project.market || "‚Äî";
        projectPlannedEl.textContent = project.planned_launch || "‚Äî";
        projectActualEl.textContent = project.actual_launch || "‚Äî";

        const badges = [];
        if (project.status === "archived") {
          badges.push(`<span class="badge archived">–ê—Ä—Ö–∏–≤</span>`);
        } else if (project.status === "closed") {
          badges.push(`<span class="badge closed">–ó–∞–∫—Ä—ã—Ç</span>`);
        } else {
          badges.push(`<span class="badge">–ê–∫—Ç–∏–≤–µ–Ω</span>`);
        }
        if (project.priority) {
          const titles = { low: "–ù–∏–∑–∫–∏–π", medium: "–°—Ä–µ–¥–Ω–∏–π", high: "–í—ã—Å–æ–∫–∏–π" };
          badges.push(`<span class="badge">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${titles[project.priority] || project.priority}</span>`);
        }
        document.getElementById("project-badges").innerHTML = badges.join("");
        renderGtmProgress();
        renderCoverPanel();
      }

      function renderTemplates() {
        templateSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω";
        templateSelect.appendChild(defaultOption);
        gtmTemplates.forEach((tpl) => {
          const option = document.createElement("option");
          option.value = tpl.id;
          option.textContent = tpl.name;
          templateSelect.appendChild(option);
        });
      }

      function renderCharacteristicTemplates() {
        characteristicTemplateSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "–®–∞–±–ª–æ–Ω—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫";
        characteristicTemplateSelect.appendChild(defaultOption);
        characteristicTemplates.forEach((tpl) => {
          const option = document.createElement("option");
          option.value = tpl.id;
          option.textContent = tpl.name;
          characteristicTemplateSelect.appendChild(option);
        });
      }

      function statusLabel(value) {
        return {
          not_started: "–ù–µ –Ω–∞—á–∞—Ç",
          in_progress: "–í —Ä–∞–±–æ—Ç–µ",
          done: "–ó–∞–≤–µ—Ä—à—ë–Ω",
          cancelled: "–û—Ç–º–µ–Ω—ë–Ω",
        }[value] || value;
      }

      function renderStages() {
        gtmStages.sort((a, b) => a.order - b.order);
        if (!gtmStages.length) {
          stagesContainer.innerHTML = "<p class=\"muted\">–≠—Ç–∞–ø—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>";
          return;
        }

        stagesContainer.innerHTML = "";
        gtmStages.forEach((stage, index) => {
          const card = document.createElement("div");
          card.className = "stage-card";
          card.dataset.stageId = stage.id;
          card.innerHTML = `
            <div class="stage-header">
              <div>
                <strong>${stage.order}. ${stage.title}</strong>
                <div class="muted">${stage.description || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <span class="chip">${statusLabel(stage.status)}</span>
                ${stage.risk_flag ? '<span class="chip warn">‚ö†Ô∏è –†–∏—Å–∫</span>' : ""}
                <button class="ghost" onclick="openStageForm('${stage.id}')">‚úèÔ∏è</button>
                <button class="ghost" onclick="moveStage('${stage.id}', -1)" ${index === 0 ? "disabled" : ""}>‚Üë</button>
                <button class="ghost" onclick="moveStage('${stage.id}', 1)" ${index === gtmStages.length - 1 ? "disabled" : ""}>‚Üì</button>
                <button class="ghost" onclick="deleteStage('${stage.id}')">üóëÔ∏è</button>
              </div>
            </div>
            <div class="grid-two" style="margin-top:8px">
              <div class="chip">–ü–ª–∞–Ω: ${stage.planned_start || "‚Äî"} ‚Üí ${stage.planned_end || "‚Äî"}</div>
              <div class="chip">–§–∞–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: ${stage.actual_end || "‚Äî"}</div>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <label style="display:flex; align-items:center; gap:6px; font-weight:500">
                –°—Ç–∞—Ç—É—Å
                <select onchange="changeStatus('${stage.id}', this.value)">
                  <option value="not_started" ${stage.status === "not_started" ? "selected" : ""}>–ù–µ –Ω–∞—á–∞—Ç</option>
                  <option value="in_progress" ${stage.status === "in_progress" ? "selected" : ""}>–í —Ä–∞–±–æ—Ç–µ</option>
                  <option value="done" ${stage.status === "done" ? "selected" : ""}>–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                  <option value="cancelled" ${stage.status === "cancelled" ? "selected" : ""}>–û—Ç–º–µ–Ω—ë–Ω</option>
                </select>
              </label>
              <label style="display:flex; align-items:center; gap:6px; font-weight:500">
                <input type="checkbox" ${stage.risk_flag ? "checked" : ""} onchange="toggleRisk('${stage.id}', this.checked)" /> –†–∏—Å–∫
              </label>
              <button class="ghost" onclick="promptChecklist('${stage.id}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</button>
            </div>
            <ul class="checklist">
              ${stage.checklist
                .sort((a, b) => a.order - b.order)
                .map(
                  (item) => `
                  <li>
                    <input type="checkbox" ${item.done ? "checked" : ""} onchange="toggleChecklistItem('${stage.id}', '${item.id}', this.checked)" />
                    <span ${item.done ? 'style="text-decoration: line-through; color:#94a3b8"' : ''}>${item.title}</span>
                    <button class="ghost" onclick="editChecklistItem('${stage.id}', '${item.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="ghost" onclick="deleteChecklistItem('${stage.id}', '${item.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                  </li>
                `)
                .join("")}
            </ul>
          `;

          card.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            openStageContextMenu(event, stage, index);
          });

          stagesContainer.appendChild(card);
        });
      }

      function renderGtmProgress() {
        const total = gtmStages.length;
        const done = gtmStages.filter((stage) => stage.status === "done").length;
        const percent = total ? Math.round((done / total) * 100) : 0;
        if (!total) {
          gtmProgressLabel.textContent = "–≠—Ç–∞–ø—ã –Ω–µ –∑–∞–¥–∞–Ω—ã";
          gtmProgressFill.style.width = "0%";
          gtmProgressBadge.textContent = "0%";
          return;
        }
        gtmProgressLabel.textContent = `–ó–∞–≤–µ—Ä—à–µ–Ω–æ ${done} –∏–∑ ${total}`;
        gtmProgressFill.style.width = `${percent}%`;
        gtmProgressBadge.textContent = `${percent}%`;
      }

      function openStageContextMenu(event, stage, index) {
        const actions = [
          { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => openStageForm(stage.id) },
          { label: stage.risk_flag ? "–°–Ω—è—Ç—å —Ä–∏—Å–∫" : "–û—Ç–º–µ—Ç–∏—Ç—å —Ä–∏—Å–∫", action: () => toggleRisk(stage.id, !stage.risk_flag) },
          { label: "–î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç —á–µ–∫-–ª–∏—Å—Ç–∞", action: () => promptChecklist(stage.id) },
          { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö", disabled: index === 0, action: () => moveStage(stage.id, -1) },
          { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑", disabled: index === gtmStages.length - 1, action: () => moveStage(stage.id, 1) },
          { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteStage(stage.id) },
        ];
        openContextMenu(event, actions);
      }

      function openContextMenu(event, actions) {
        contextMenuList.innerHTML = "";
        actions.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item.label;
          if (item.disabled) {
            li.classList.add("disabled");
          } else {
            li.addEventListener("click", () => {
              item.action();
              hideContextMenu();
            });
          }
          contextMenuList.appendChild(li);
        });

        contextMenu.style.display = "block";
        contextMenu.style.left = `${event.pageX}px`;
        contextMenu.style.top = `${event.pageY}px`;
      }

      function hideContextMenu() {
        contextMenu.style.display = "none";
      }

      document.addEventListener("click", () => hideContextMenu());

      function openStageForm(stageId = null) {
        document.getElementById("modal").style.display = "flex";
        const stage = gtmStages.find((s) => s.id === stageId);
        document.getElementById("modalTitle").textContent = stage ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞" : "–ù–æ–≤—ã–π —ç—Ç–∞–ø";
        document.getElementById("stageId").value = stage ? stage.id : "";
        document.getElementById("stageTitle").value = stage ? stage.title : "";
        document.getElementById("stageOrder").value = stage ? stage.order : gtmStages.length;
        document.getElementById("stageDescription").value = stage?.description || "";
        document.getElementById("stagePlannedStart").value = stage?.planned_start || "";
        document.getElementById("stagePlannedEnd").value = stage?.planned_end || "";
        document.getElementById("stageActualEnd").value = stage?.actual_end || "";
        document.getElementById("stageStatus").value = stage?.status || "not_started";
        document.getElementById("stageRisk").checked = stage?.risk_flag || false;
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }

      document.getElementById("stageForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = {
          title: document.getElementById("stageTitle").value,
          order: Number(document.getElementById("stageOrder").value || 0),
          description: document.getElementById("stageDescription").value || null,
          planned_start: document.getElementById("stagePlannedStart").value || null,
          planned_end: document.getElementById("stagePlannedEnd").value || null,
          actual_end: document.getElementById("stageActualEnd").value || null,
          status: document.getElementById("stageStatus").value,
          risk_flag: document.getElementById("stageRisk").checked,
          checklist: [],
        };

        const stageId = document.getElementById("stageId").value;
        let res;
        if (stageId) {
          const existing = gtmStages.find((s) => s.id === stageId);
          payload.checklist = existing?.checklist || [];
          res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } else {
          res = await fetch(`/api/projects/${projectId}/gtm-stages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        }

        if (res.ok) {
          await loadStages();
          closeModal();
        } else {
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞");
        }
      });

      async function changeStatus(stageId, value) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.status = value;
        await saveStage(stage);
      }

      async function toggleRisk(stageId, value) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.risk_flag = value;
        await saveStage(stage);
      }

      async function moveStage(stageId, delta) {
        const index = gtmStages.findIndex((s) => s.id === stageId);
        if (index === -1) return;
        const target = index + delta;
        if (target < 0 || target >= gtmStages.length) return;
        const otherId = gtmStages[target].id;

        [gtmStages[index].order, gtmStages[target].order] = [gtmStages[target].order, gtmStages[index].order];
        const firstSave = saveStage(gtmStages[index]);
        const secondSave = saveStage(gtmStages[target]);
        await Promise.all([firstSave, secondSave]);
        await loadStages();
      }

      async function deleteStage(stageId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø?")) return;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}`, { method: "DELETE" });
        if (res.ok) {
          await loadStages();
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø");
        }
      }

      async function saveStage(stage) {
        await fetch(`/api/projects/${projectId}/gtm-stages/${stage.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(stage),
        });
      }

      function promptChecklist(stageId) {
        const text = prompt("–¢–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ —á–µ–∫-–ª–∏—Å—Ç–∞");
        if (!text) return;
        addChecklistItem(stageId, text);
      }

      async function addChecklistItem(stageId, title) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        const nextOrder = stage.checklist.length;
        stage.checklist.push({ id: crypto.randomUUID(), title, done: false, order: nextOrder });
        await saveStage(stage);
        await loadStages();
      }

      async function toggleChecklistItem(stageId, itemId, done) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        const item = stage.checklist.find((c) => c.id === itemId);
        if (!item) return;
        item.done = done;
        await saveStage(stage);
        await loadStages();
      }

      async function editChecklistItem(stageId, itemId) {
        const stage = gtmStages.find((s) => s.id === stageId);
        const item = stage?.checklist.find((c) => c.id === itemId);
        if (!item) return;
        const text = prompt("–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞", item.title);
        if (!text) return;
        item.title = text;
        await saveStage(stage);
        await loadStages();
      }

      async function deleteChecklistItem(stageId, itemId) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.checklist = stage.checklist.filter((c) => c.id !== itemId);
        stage.checklist.forEach((c, idx) => (c.order = idx));
        await saveStage(stage);
        await loadStages();
      }

      async function applyTemplate() {
        const templateId = templateSelect.value;
        if (!templateId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω");
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/apply-template?template_id=${templateId}`, {
          method: "POST",
        });
        if (res.ok) {
          gtmStages = await res.json();
          renderStages();
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      async function saveTemplate() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞", project?.name ? `GTM ${project.name}` : "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω");
        if (!name) return;
        const description = prompt("–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") || null;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/save-template`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description }),
        });
        if (res.ok) {
          await loadTemplates();
          alert("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      function triggerImport() {
        importInput.click();
      }

      importInput.addEventListener("change", async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/import`, {
          method: "POST",
          body: formData,
        });
        if (res.ok) {
          gtmStages = await res.json();
          renderStages();
          alert("–≠—Ç–∞–ø—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        } else {
          const detail = await res.json();
          alert(detail?.detail?.errors?.join("\n") || "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
        }
        event.target.value = "";
      });

      async function exportStages() {
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/export`);
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–ø—ã");
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `gtm_stages_${projectId}.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      async function loadTasks() {
        const params = new URLSearchParams();
        if (taskFilters.status !== "all") params.append("status", taskFilters.status);
        if (taskFilters.hideDone) params.append("only_active", "true");
        if (taskFilters.gtm) params.append("gtm_stage_id", taskFilters.gtm);
        const res = await fetch(`/api/projects/${projectId}/tasks?${params.toString()}`);
        tasks = res.ok ? await res.json() : [];
        renderTasks();
      }

      function renderTaskFilters() {
        taskGtmFilter.innerHTML = "";
        const all = document.createElement("option");
        all.value = "";
        all.textContent = "–í—Å–µ —ç—Ç–∞–ø—ã";
        taskGtmFilter.appendChild(all);

        taskGtmStageSelect.innerHTML = "";
        const none = document.createElement("option");
        none.value = "";
        none.textContent = "–ù–µ –∑–∞–¥–∞–Ω";
        taskGtmStageSelect.appendChild(none);

        const sorted = [...gtmStages].sort((a, b) => a.order - b.order);
        sorted.forEach((stage) => {
          const option = document.createElement("option");
          option.value = stage.id;
          option.textContent = `${stage.order}. ${stage.title}`;
          taskGtmFilter.appendChild(option.cloneNode(true));
          taskGtmStageSelect.appendChild(option);
        });

        taskGtmFilter.value = taskFilters.gtm;
      }

      function taskStatusLabel(value) {
        return {
          todo: "ToDo",
          in_progress: "–í —Ä–∞–±–æ—Ç–µ",
          done: "–ì–æ—Ç–æ–≤–æ",
        }[value] || value;
      }

      function stageTitle(stageId) {
        if (!stageId) return "–ë–µ–∑ —ç—Ç–∞–ø–∞";
        const stage = gtmStages.find((s) => s.id === stageId);
        return stage ? `${stage.order}. ${stage.title}` : "–ë–µ–∑ —ç—Ç–∞–ø–∞";
      }

      function dueInfo(task) {
        if (!task.due_date) return { text: "–°—Ä–æ–∫ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω", className: "tag" };
        const today = new Date();
        const due = new Date(task.due_date);
        const diffDays = Math.floor((due - today) / (1000 * 60 * 60 * 24));
        if (task.status === "done") {
          return { text: `–°—Ä–æ–∫: ${task.due_date}`, className: "tag" };
        }
        if (due < today) {
          return { text: `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(diffDays)} –¥–Ω.`, className: "tag due-overdue" };
        }
        if (diffDays <= 7) {
          return { text: `–î–æ —Å—Ä–æ–∫–∞ ${diffDays} –¥–Ω.`, className: "tag due-soon" };
        }
        return { text: `–°—Ä–æ–∫: ${task.due_date}`, className: "tag" };
      }

      function applyTaskFilters(list = tasks) {
        return list.filter((task) => {
          if (taskFilters.status !== "all" && task.status !== taskFilters.status) return false;
          if (taskFilters.gtm && task.gtm_stage_id !== taskFilters.gtm) return false;
          if (taskFilters.due === "overdue") {
            if (!task.due_date) return false;
            const due = new Date(task.due_date);
            if (due >= new Date() || task.status === "done") return false;
          }
          if (taskFilters.due === "upcoming") {
            if (!task.due_date) return false;
            const due = new Date(task.due_date);
            const diffDays = Math.floor((due - new Date()) / (1000 * 60 * 60 * 24));
            if (diffDays < 0 || diffDays > 7) return false;
          }
          return true;
        });
      }

      function toggleTaskView() {
        taskView = taskView === "list" ? "board" : "list";
        renderTasks();
      }

      function renderTasks() {
        const filtered = applyTaskFilters();
        taskViewToggle.textContent = taskView === "list" ? "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥: –¥–æ—Å–∫–∞" : "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥: —Å–ø–∏—Å–æ–∫";
        if (!filtered.length) {
          tasksContainer.innerHTML = "<p class='muted'>–ó–∞–¥–∞—á–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã –∏–ª–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –ø–æ–¥ —Ñ–∏–ª—å—Ç—Ä.</p>";
          return;
        }

        if (taskView === "board") {
          renderTaskBoard(filtered);
        } else {
          renderTaskList(filtered);
        }
      }

      function renderTaskBoard(list) {
        const statuses = [
          { key: "todo", title: "ToDo" },
          { key: "in_progress", title: "–í —Ä–∞–±–æ—Ç–µ" },
          { key: "done", title: "–ì–æ—Ç–æ–≤–æ" },
        ];
        const board = document.createElement("div");
        board.className = "task-board";
        statuses.forEach((column) => {
          const col = document.createElement("div");
          col.className = "task-column";
          const columnTasks = list.filter((t) => t.status === column.key);
          col.innerHTML = `<div class="stage-header"><h3 style="margin:0">${column.title}</h3><span class="chip">${columnTasks.length}</span></div>`;

          if (!columnTasks.length) {
            const empty = document.createElement("p");
            empty.className = "muted";
            empty.textContent = "–ù–µ—Ç –∑–∞–¥–∞—á";
            col.appendChild(empty);
          } else {
            columnTasks
              .slice()
              .sort((a, b) => (a.due_date || "")?.localeCompare(b.due_date || ""))
              .forEach((task) => {
                const card = document.createElement("div");
                card.className = "task-card";
                const due = dueInfo(task);
                card.innerHTML = `
                  <div class="stage-header">
                    <div>
                      <strong>${task.title}</strong>
                      <div class="muted">${stageTitle(task.gtm_stage_id)}</div>
                    </div>
                    <div style="display:flex; gap:6px">
                      <button class="ghost" onclick="openTaskForm('${task.id}')">‚úèÔ∏è</button>
                      <button class="ghost" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
                    </div>
                  </div>
                  <div class="task-meta" style="margin-top:6px">
                    <span class="status-chip ${task.status}">${taskStatusLabel(task.status)}</span>
                    <span class="${due.className}">${due.text}</span>
                    ${task.important ? '<span class="tag">‚≠ê –í–∞–∂–Ω–æ</span>' : ""}
                  </div>
                  <div class="muted" style="margin-top:6px">${task.description || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</div>
                  <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
                    <button class="ghost" onclick="changeTaskStatus('${task.id}', 'todo')">ToDo</button>
                    <button class="ghost" onclick="changeTaskStatus('${task.id}', 'in_progress')">–í —Ä–∞–±–æ—Ç—É</button>
                    <button class="ghost" onclick="changeTaskStatus('${task.id}', 'done')">–ì–æ—Ç–æ–≤–æ</button>
                    <button class="ghost" onclick="addSubtaskPrompt('${task.id}')">+ –ü–æ–¥–∑–∞–¥–∞—á–∞</button>
                  </div>
                `;
                card.addEventListener("contextmenu", (event) => {
                  event.preventDefault();
                  const actions = [
                    { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => openTaskForm(task.id) },
                    { label: "ToDo", action: () => changeTaskStatus(task.id, "todo") },
                    { label: "–í —Ä–∞–±–æ—Ç—É", action: () => changeTaskStatus(task.id, "in_progress") },
                    { label: "–ì–æ—Ç–æ–≤–æ", action: () => changeTaskStatus(task.id, "done") },
                    { label: task.important ? "–°–Ω—è—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å" : "–°–¥–µ–ª–∞—Ç—å –≤–∞–∂–Ω–æ–π", action: () => toggleImportant(task.id) },
                    { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteTask(task.id) },
                  ];
                  openContextMenu(event, actions);
                });
                col.appendChild(card);
              });
          }
          board.appendChild(col);
        });
        tasksContainer.innerHTML = "";
        tasksContainer.appendChild(board);
      }

      function renderTaskList(list) {
        tasksContainer.innerHTML = "";
        list
          .slice()
          .sort((a, b) => (a.due_date || "").localeCompare(b.due_date || ""))
          .forEach((task) => {
            const card = document.createElement("div");
            card.className = "task-card";
            const due = dueInfo(task);
            const progress = taskProgress(task);
            card.innerHTML = `
              <div class="stage-header">
                <div>
                  <strong>${task.title}</strong>
                  <div class="muted">${stageTitle(task.gtm_stage_id)}</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center">
                  <button class="ghost" onclick="openTaskForm('${task.id}')">‚úèÔ∏è</button>
                  <button class="ghost" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
                </div>
              </div>
              <div class="task-meta" style="margin-top:6px">
                <span class="status-chip ${task.status}">${taskStatusLabel(task.status)}</span>
                <span class="${due.className}">${due.text}</span>
                ${task.important ? '<span class="tag">‚≠ê –í–∞–∂–Ω–æ</span>' : ""}
              </div>
              <div style="margin-top:8px; display:flex; flex-direction:column; gap:4px;">
                <div class="progress-line"><div class="fill" style="width:${progress.percent}%"></div></div>
                <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress.label}</div>
              </div>
              <div class="muted" style="margin-top:6px">${task.description || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</div>
            `;

            const actionBar = document.createElement("div");
            actionBar.style.display = "flex";
            actionBar.style.gap = "8px";
            actionBar.style.flexWrap = "wrap";
            actionBar.style.marginTop = "8px";
            [
              { label: "ToDo", next: "todo" },
              { label: "–í —Ä–∞–±–æ—Ç—É", next: "in_progress" },
              { label: "–ì–æ—Ç–æ–≤–æ", next: "done" },
            ].forEach((action) => {
              const btn = document.createElement("button");
              btn.className = "ghost";
              btn.textContent = action.label;
              btn.addEventListener("click", () => changeTaskStatus(task.id, action.next));
              actionBar.appendChild(btn);
            });
            const importantBtn = document.createElement("button");
            importantBtn.className = "ghost";
            importantBtn.textContent = task.important ? "–°–Ω—è—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å" : "–°–¥–µ–ª–∞—Ç—å –≤–∞–∂–Ω–æ–π";
            importantBtn.addEventListener("click", () => toggleImportant(task.id));
            actionBar.appendChild(importantBtn);
            card.appendChild(actionBar);

            const subtasksList = document.createElement("ul");
            subtasksList.className = "subtasks";
            const subtasks = [...(task.subtasks || [])].sort((a, b) => a.order - b.order);
            if (!subtasks.length) {
              const li = document.createElement("li");
              li.className = "muted";
              li.textContent = "–ü–æ–¥–∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç";
              subtasksList.appendChild(li);
            } else {
              subtasks.forEach((sub) => {
                const li = document.createElement("li");
                li.innerHTML = `
                  <input type="checkbox" ${sub.done ? "checked" : ""} />
                  <span ${sub.done ? 'style="text-decoration: line-through; color:#94a3b8"' : ''}>${sub.title}</span>
                `;
                li.querySelector("input").addEventListener("change", (event) => {
                  toggleSubtask(task.id, sub.id, event.target.checked);
                });
                const textSpan = li.querySelector("span");
                textSpan.contentEditable = true;
                textSpan.addEventListener("blur", () => updateSubtaskTitle(task.id, sub.id, textSpan.innerText));
                textSpan.addEventListener("keydown", (e) => {
                  if (e.key === "Enter") {
                    e.preventDefault();
                    textSpan.blur();
                  }
                });
                const editBtn = document.createElement("button");
                editBtn.className = "ghost";
                editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
                editBtn.addEventListener("click", () => textSpan.focus());
                const delBtn = document.createElement("button");
                delBtn.className = "ghost";
                delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                delBtn.addEventListener("click", () => deleteSubtask(task.id, sub.id));
                li.appendChild(editBtn);
                li.appendChild(delBtn);
                li.addEventListener("contextmenu", (event) => {
                  event.preventDefault();
                  const actions = [
                    { label: sub.done ? "–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π" : "–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π", action: () => toggleSubtask(task.id, sub.id, !sub.done) },
                    { label: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", action: () => textSpan.focus() },
                    { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteSubtask(task.id, sub.id) },
                  ];
                  openContextMenu(event, actions);
                });
                subtasksList.appendChild(li);
              });
            }
            card.appendChild(subtasksList);

            const composer = document.createElement("div");
            composer.className = "subtask-inline";
            composer.innerHTML = `
              <input class="inline-input" placeholder="–ù–æ–≤–∞—è –ø–æ–¥–∑–∞–¥–∞—á–∞" />
              <button class="ghost">–î–æ–±–∞–≤–∏—Ç—å</button>
            `;
            const [subInput, subBtn] = composer.querySelectorAll("input, button");
            subBtn.addEventListener("click", () => {
              const title = subInput.value.trim();
              if (!title) return;
              addSubtask(task.id, title);
              subInput.value = "";
            });
            card.appendChild(composer);

            const commentsBlock = document.createElement("div");
            commentsBlock.style.marginTop = "10px";
            commentsBlock.innerHTML = `<strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</strong>`;
            const commentList = document.createElement("ul");
            commentList.className = "comment-list";
            if (!task.comments?.length) {
              const empty = document.createElement("li");
              empty.className = "muted";
              empty.textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç";
              commentList.appendChild(empty);
            } else {
              task.comments
                .slice()
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .forEach((comment) => {
                  const item = document.createElement("li");
                  item.className = "comment-item";
                  const created = new Date(comment.created_at).toLocaleString("ru-RU");
                  item.innerHTML = `<div class="muted" style="font-size:0.85rem">${created}</div><div>${comment.text}</div>`;
                  const del = document.createElement("button");
                  del.className = "ghost";
                  del.textContent = "–£–¥–∞–ª–∏—Ç—å";
                  del.addEventListener("click", () => deleteTaskComment(task.id, comment.id));
                  item.appendChild(del);
                  commentList.appendChild(item);
                });
            }
            commentsBlock.appendChild(commentList);
            const addCommentBtn = document.createElement("button");
            addCommentBtn.className = "ghost";
            addCommentBtn.textContent = "+ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
            addCommentBtn.addEventListener("click", () => addTaskComment(task.id));
            commentsBlock.appendChild(addCommentBtn);
            card.appendChild(commentsBlock);

            card.addEventListener("contextmenu", (event) => {
              event.preventDefault();
              const actions = [
                { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => openTaskForm(task.id) },
                { label: "ToDo", action: () => changeTaskStatus(task.id, "todo") },
                { label: "–í —Ä–∞–±–æ—Ç—É", action: () => changeTaskStatus(task.id, "in_progress") },
                { label: "–ì–æ—Ç–æ–≤–æ", action: () => changeTaskStatus(task.id, "done") },
                { label: task.important ? "–°–Ω—è—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å" : "–°–¥–µ–ª–∞—Ç—å –≤–∞–∂–Ω–æ–π", action: () => toggleImportant(task.id) },
                { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteTask(task.id) },
              ];
              openContextMenu(event, actions);
            });

            tasksContainer.appendChild(card);
          });
      }

      function openTaskForm(taskId = null) {
        taskModal.style.display = "flex";
        const task = tasks.find((t) => t.id === taskId);
        document.getElementById("taskModalTitle").textContent = task ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" : "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞";
        document.getElementById("taskId").value = task?.id || "";
        document.getElementById("taskTitle").value = task?.title || "";
        document.getElementById("taskDescription").value = task?.description || "";
        document.getElementById("taskStatus").value = task?.status || "todo";
        document.getElementById("taskDueDate").value = task?.due_date || "";
        document.getElementById("taskImportant").checked = task?.important || false;
        taskGtmStageSelect.value = task?.gtm_stage_id || "";
      }

      function closeTaskModal() {
        taskModal.style.display = "none";
      }

      document.getElementById("taskForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = {
          title: document.getElementById("taskTitle").value,
          description: document.getElementById("taskDescription").value || null,
          status: document.getElementById("taskStatus").value,
          due_date: document.getElementById("taskDueDate").value || null,
          important: document.getElementById("taskImportant").checked,
          gtm_stage_id: document.getElementById("taskGtmStage").value || null,
          subtasks: [],
          comments: [],
        };
        const taskId = document.getElementById("taskId").value;
        let res;
        if (taskId) {
          const existing = tasks.find((t) => t.id === taskId);
          payload.subtasks = existing?.subtasks || [];
          payload.comments = existing?.comments || [];
          payload.id = taskId;
          res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } else {
          res = await fetch(`/api/projects/${projectId}/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        }
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É");
          return;
        }
        closeTaskModal();
        await loadTasks();
      });

      async function changeTaskStatus(taskId, status) {
        const existing = tasks.find((t) => t.id === taskId);
        if (!existing) return;
        const payload = { ...existing, status };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å");
          return;
        }
        await loadTasks();
      }

      async function toggleImportant(taskId) {
        const existing = tasks.find((t) => t.id === taskId);
        if (!existing) return;
        const payload = { ...existing, important: !existing.important };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å");
          return;
        }
        await loadTasks();
      }

      async function deleteTask(taskId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏ –µ—ë –ø–æ–¥–∑–∞–¥–∞—á–∏?")) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function addSubtask(taskId, title) {
        const prepared = title?.trim();
        if (!prepared) return;
        const task = tasks.find((t) => t.id === taskId);
        const order = task?.subtasks?.length || 0;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: prepared, done: false, order }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      function addSubtaskPrompt(taskId) {
        const title = prompt("–¢–µ–∫—Å—Ç –ø–æ–¥–∑–∞–¥–∞—á–∏");
        if (!title) return;
        addSubtask(taskId, title);
      }

      async function toggleSubtask(taskId, subtaskId, done) {
        const task = tasks.find((t) => t.id === taskId);
        const sub = task?.subtasks.find((s) => s.id === subtaskId);
        if (!task || !sub) return;
        const payload = { ...sub, done };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks/${subtaskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function updateSubtaskTitle(taskId, subtaskId, title) {
        const task = tasks.find((t) => t.id === taskId);
        const sub = task?.subtasks.find((s) => s.id === subtaskId);
        const prepared = title?.trim();
        if (!task || !sub || !prepared) return;
        const payload = { ...sub, title: prepared };
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks/${subtaskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function deleteSubtask(taskId, subtaskId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É?")) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/subtasks/${subtaskId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É");
          return;
        }
        await loadTasks();
      }

      async function addTaskComment(taskId) {
        const text = prompt("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ");
        if (!text || !text.trim()) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: text.trim() }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadTasks();
      }

      async function deleteTaskComment(taskId, commentId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) return;
        const res = await fetch(`/api/projects/${projectId}/tasks/${taskId}/comments/${commentId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadTasks();
      }

      async function loadImages() {
        const res = await fetch(`/api/projects/${projectId}/images`);
        if (res.ok) {
          images = await res.json();
          renderGallery();
          renderCoverPanel();
        }
      }

      function renderGallery() {
        galleryContainer.innerHTML = "";
        const sorted = [...images].sort((a, b) => a.order - b.order);
        lightboxOrder = sorted;
        if (!sorted.length) {
          galleryContainer.innerHTML = "<p class='muted'>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>";
          return;
        }

        sorted.forEach((img, index) => {
          const card = document.createElement("div");
          card.className = "image-card";
          card.innerHTML = `
            ${img.is_cover ? '<span class="cover-chip">–û–±–ª–æ–∂–∫–∞</span>' : ""}
            <img class="image-thumb" src="/api/projects/${projectId}/images/${img.id}/download" alt="${img.filename}" onclick="openImage('${img.id}')" />
            <div class="image-meta">
              <div style="display:flex; flex-direction:column; gap:2px">
                <strong>${img.filename}</strong>
                <span class="muted" style="font-size:0.9rem">${img.caption || "–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∏"}</span>
              </div>
              <div class="toolbar">
                <button class="ghost" onclick="openImage('${img.id}')">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                <button class="ghost" onclick="editImageCaption('${img.id}')">–ü–æ–¥–ø–∏—Å—å</button>
                <button class="ghost" onclick="setCover('${img.id}')" ${img.is_cover ? "disabled" : ""}>–°–¥–µ–ª–∞—Ç—å –æ–±–ª–æ–∂–∫–æ–π</button>
                <button class="ghost" onclick="moveImage('${img.id}', -1)" ${index === 0 ? "disabled" : ""}>‚Üë</button>
                <button class="ghost" onclick="moveImage('${img.id}', 1)" ${index === sorted.length - 1 ? "disabled" : ""}>‚Üì</button>
                <button onclick="deleteImage('${img.id}')">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
          `;

          card.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            const actions = [
              { label: "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å", action: () => openImage(img.id) },
              { label: "–°–¥–µ–ª–∞—Ç—å –æ–±–ª–æ–∂–∫–æ–π", action: () => setCover(img.id) },
              { label: "–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å—å", action: () => editImageCaption(img.id) },
              { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteImage(img.id) },
            ];
            openContextMenu(event, actions);
          });

          galleryContainer.appendChild(card);
        });
      }

      function renderCoverPanel() {
        const cover = getCoverImage();
        if (cover) {
          coverImage.src = `/api/projects/${projectId}/images/${cover.id}/download`;
          coverImage.style.display = "block";
          coverPlaceholder.style.display = "none";
          clearCoverButton.disabled = !cover.is_cover;
        } else {
          coverImage.removeAttribute("src");
          coverImage.style.display = "none";
          coverPlaceholder.style.display = "flex";
          clearCoverButton.disabled = true;
        }
      }

      function getCoverImage() {
        const explicit = images.find((img) => img.is_cover);
        if (explicit) return explicit;
        return images.length ? images[0] : null;
      }

      function triggerImageUpload() {
        imageUploadInput.click();
      }

      imageUploadInput.addEventListener("change", async (event) => {
        const selected = Array.from(event.target.files || []);
        for (const file of selected) {
          const formData = new FormData();
          formData.append("file", file);
          const res = await fetch(`/api/projects/${projectId}/images/upload`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
            break;
          }
        }
        imageUploadInput.value = "";
        await loadImages();
      });

      function triggerCoverUpload() {
        coverUploadInput.click();
      }

      coverUploadInput.addEventListener("change", async (event) => {
        const selected = event.target.files?.[0];
        if (!selected) return;
        const formData = new FormData();
        formData.append("file", selected);
        formData.append("is_cover", "true");
        const res = await fetch(`/api/projects/${projectId}/images/upload`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É");
        }
        coverUploadInput.value = "";
        await loadImages();
      });

      async function clearCover() {
        const cover = getCoverImage();
        if (!cover || !cover.is_cover) {
          renderCoverPanel();
          return;
        }
        const payload = { ...cover, is_cover: false };
        const res = await fetch(`/api/projects/${projectId}/images/${cover.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –æ–±–ª–æ–∂–∫—É");
          return;
        }
        await loadImages();
      }

      function scrollToGallery() {
        gallerySection?.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function openImage(imageId) {
        if (!lightboxOrder.length) {
          lightboxOrder = [...images].sort((a, b) => a.order - b.order);
        }
        const idx = lightboxOrder.findIndex((img) => img.id === imageId);
        if (idx === -1) return;
        lightboxIndex = idx;
        showLightbox();
      }

      function showLightbox() {
        const current = lightboxOrder[lightboxIndex];
        if (!current) return;
        lightboxImage.src = `/api/projects/${projectId}/images/${current.id}/download`;
        lightboxTitle.textContent = current.filename;
        lightboxCaption.textContent = current.caption || "";
        lightbox.dataset.open = "true";
      }

      function closeLightbox() {
        lightbox.dataset.open = "false";
      }

      function nextLightbox() {
        if (!lightboxOrder.length) return;
        lightboxIndex = (lightboxIndex + 1) % lightboxOrder.length;
        showLightbox();
      }

      function prevLightbox() {
        if (!lightboxOrder.length) return;
        lightboxIndex = (lightboxIndex - 1 + lightboxOrder.length) % lightboxOrder.length;
        showLightbox();
      }

      async function setCover(imageId) {
        const image = images.find((img) => img.id === imageId);
        if (!image) return;
        const payload = { ...image, is_cover: true };
        const res = await fetch(`/api/projects/${projectId}/images/${imageId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–±–ª–æ–∂–∫—É");
          return;
        }
        await loadImages();
      }

      async function editImageCaption(imageId) {
        const image = images.find((img) => img.id === imageId);
        if (!image) return;
        const caption = prompt("–ü–æ–¥–ø–∏—Å—å/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", image.caption || "");
        if (caption === null) return;
        const payload = { ...image, caption: caption || null };
        const res = await fetch(`/api/projects/${projectId}/images/${imageId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å");
          return;
        }
        await loadImages();
      }

      async function moveImage(imageId, delta) {
        const sorted = [...images].sort((a, b) => a.order - b.order);
        const index = sorted.findIndex((img) => img.id === imageId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= sorted.length) return;
        [sorted[index], sorted[target]] = [sorted[target], sorted[index]];
        sorted.forEach((img, idx) => (img.order = idx));
        await Promise.all(
          sorted.map((img) =>
            fetch(`/api/projects/${projectId}/images/${img.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(img),
            })
          )
        );
        await loadImages();
      }

      async function deleteImage(imageId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?")) return;
        const res = await fetch(`/api/projects/${projectId}/images/${imageId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
          return;
        }
        await loadImages();
      }

      async function loadFiles() {
        const res = await fetch(`/api/projects/${projectId}/files`);
        if (res.ok) {
          files = await res.json();
          renderFiles();
        }
      }

      function renderFiles() {
        fileTable.innerHTML = "";
        if (!files.length) {
          const row = document.createElement("tr");
          row.innerHTML = '<td colspan="5" class="muted">–§–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</td>';
          fileTable.appendChild(row);
          return;
        }

        files
          .slice()
          .sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at))
          .forEach((file) => {
            const row = document.createElement("tr");
            const date = new Date(file.uploaded_at).toLocaleString("ru-RU");
            row.innerHTML = `
              <td>${file.name}</td>
              <td>${file.description || ""}</td>
              <td>${file.category || ""}</td>
              <td>${date}</td>
              <td>
                <button class="ghost" onclick="downloadFile('${file.id}')">–°–∫–∞—á–∞—Ç—å</button>
                <button class="ghost" onclick="editFile('${file.id}')">–ü—Ä–∞–≤–∏—Ç—å</button>
                <button onclick="deleteFile('${file.id}')">–£–¥–∞–ª–∏—Ç—å</button>
              </td>
            `;
            row.addEventListener("contextmenu", (event) => {
              event.preventDefault();
              const actions = [
                { label: "–°–∫–∞—á–∞—Ç—å", action: () => downloadFile(file.id) },
                { label: "–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ/–∫–∞—Ç–µ–≥–æ—Ä–∏—é", action: () => editFile(file.id) },
                { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteFile(file.id) },
              ];
              openContextMenu(event, actions);
            });
            fileTable.appendChild(row);
          });
      }

      function triggerFileUpload() {
        fileUploadInput.click();
      }

      fileUploadInput.addEventListener("change", async (event) => {
        const selected = Array.from(event.target.files || []);
        for (const file of selected) {
          const description = prompt(`–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${file.name} (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)`) || "";
          const category = prompt(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è ${file.name} (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)`) || "";
          const formData = new FormData();
          formData.append("file", file);
          if (description) formData.append("description", description);
          if (category) formData.append("category", category);
          const res = await fetch(`/api/projects/${projectId}/files/upload`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª");
            break;
          }
        }
        fileUploadInput.value = "";
        await loadFiles();
      });

      function downloadFile(fileId) {
        window.open(`/api/projects/${projectId}/files/${fileId}/download`, "_blank");
      }

      async function editFile(fileId) {
        const file = files.find((f) => f.id === fileId);
        if (!file) return;
        const name = prompt("–ò–º—è —Ñ–∞–π–ª–∞", file.name) || file.name;
        const description = prompt("–û–ø–∏—Å–∞–Ω–∏–µ", file.description || "") || "";
        const category = prompt("–ö–∞—Ç–µ–≥–æ—Ä–∏—è", file.category || "") || "";
        const payload = { ...file, name, description: description || null, category: category || null };
        const res = await fetch(`/api/projects/${projectId}/files/${fileId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª");
          return;
        }
        await loadFiles();
      }

      async function deleteFile(fileId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?")) return;
        const res = await fetch(`/api/projects/${projectId}/files/${fileId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª");
          return;
        }
        await loadFiles();
      }

      async function loadProjectComments() {
        const res = await fetch(`/api/projects/${projectId}/comments`);
        if (res.ok) {
          projectComments = await res.json();
          renderProjectComments();
        }
      }

      function renderProjectComments() {
        projectCommentsList.innerHTML = "";
        if (!projectComments.length) {
          const li = document.createElement("li");
          li.className = "muted";
          li.textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç";
          projectCommentsList.appendChild(li);
          return;
        }
        projectComments
          .slice()
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .forEach((comment) => {
            const li = document.createElement("li");
            li.className = "comment-item";
            const meta = document.createElement("div");
            meta.className = "muted";
            meta.style.fontSize = "0.85rem";
            const edited = comment.edited_at
              ? ` (–∏–∑–º–µ–Ω—ë–Ω ${new Date(comment.edited_at).toLocaleString("ru-RU")})`
              : "";
            meta.textContent = `${new Date(comment.created_at).toLocaleString("ru-RU")}${edited}`;
            const body = document.createElement("div");
            body.innerHTML = comment.text || "";
            const actions = document.createElement("div");
            actions.className = "toolbar";
            actions.style.margin = "6px 0 0";
            const editBtn = document.createElement("button");
            editBtn.className = "ghost";
            editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
            editBtn.addEventListener("click", () => startProjectCommentEdit(comment));
            const remove = document.createElement("button");
            remove.className = "ghost";
            remove.textContent = "–£–¥–∞–ª–∏—Ç—å";
            remove.addEventListener("click", () => deleteProjectComment(comment.id));
            actions.appendChild(editBtn);
            actions.appendChild(remove);
            li.appendChild(meta);
            li.appendChild(body);
            li.appendChild(actions);
            projectCommentsList.appendChild(li);
          });
      }

      async function addProjectComment() {
        const html = editorHtml(projectCommentArea);
        if (!html) return;
        const res = await fetch(`/api/projects/${projectId}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: html }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        clearEditor("projectCommentArea");
        await loadProjectComments();
      }

      function startProjectCommentEdit(comment) {
        const existing = Array.from(projectCommentsList.children).find((li) =>
          li.querySelector(".toolbar button")?.onclick?.toString().includes(comment.id)
        );
        const li = existing || document.createElement("li");
        li.innerHTML = "";
        li.className = "comment-item";
        const editor = document.createElement("div");
        editor.className = "rich-editor";
        editor.innerHTML = `
          <div class="rich-editor-toolbar">
            <button type="button" onclick="formatSelection('bold')">B</button>
            <button type="button" onclick="formatSelection('italic')"><em>I</em></button>
            <button type="button" onclick="formatSelection('insertUnorderedList')">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
            <button type="button" onclick="addLinkToSelection()">–°—Å—ã–ª–∫–∞</button>
          </div>
          <div class="rich-editor-area" contenteditable="true">${comment.text || ""}</div>
        `;
        const actions = document.createElement("div");
        actions.className = "toolbar";
        actions.style.marginTop = "6px";
        const save = document.createElement("button");
        save.className = "primary";
        save.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        save.addEventListener("click", async () => {
          const html = editorHtml(editor.querySelector(".rich-editor-area"));
          if (!html) return;
          await updateProjectComment(comment.id, html);
        });
        const cancel = document.createElement("button");
        cancel.className = "ghost";
        cancel.textContent = "–û—Ç–º–µ–Ω–∞";
        cancel.addEventListener("click", renderProjectComments);
        actions.appendChild(save);
        actions.appendChild(cancel);
        li.appendChild(editor);
        li.appendChild(actions);
        if (!existing) projectCommentsList.prepend(li);
      }

      async function updateProjectComment(commentId, text) {
        const res = await fetch(`/api/projects/${projectId}/comments/${commentId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadProjectComments();
      }

      async function deleteProjectComment(commentId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) return;
        const res = await fetch(`/api/projects/${projectId}/comments/${commentId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
          return;
        }
        await loadProjectComments();
      }

      async function loadHistory() {
        const res = await fetch(`/api/projects/${projectId}/history`);
        if (res.ok) {
          historyEvents = await res.json();
          renderHistory();
        }
      }

      function renderHistory() {
        historyContainer.innerHTML = "";
        if (historyAccordion) historyAccordion.open = false;
        if (!historyEvents.length) {
          historyContainer.innerHTML = "<p class='muted'>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è.</p>";
          return;
        }

        const list = document.createElement("ul");
        list.className = "history-list";
        historyEvents
          .slice()
          .sort((a, b) => new Date(b.occurred_at) - new Date(a.occurred_at))
          .forEach((event) => {
            const item = document.createElement("li");
            item.className = "history-row";
            const left = document.createElement("div");
            left.innerHTML = `
              <div class="muted" style="font-size:0.85rem">${new Date(event.occurred_at).toLocaleString("ru-RU")}</div>
              <div><strong>${event.summary}</strong></div>
              ${event.details ? `<div class="muted">${event.details}</div>` : ""}
            `;
            const actions = document.createElement("div");
            actions.className = "toolbar";
            const remove = document.createElement("button");
            remove.className = "ghost";
            remove.textContent = "–£–¥–∞–ª–∏—Ç—å";
            remove.addEventListener("click", () => deleteHistoryEvent(event.id));
            actions.appendChild(remove);
            item.appendChild(left);
            item.appendChild(actions);
            list.appendChild(item);
          });
        historyContainer.appendChild(list);
      }

      async function addHistoryEvent() {
        const summary = prompt("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è");
        if (!summary || !summary.trim()) return;
        const details = prompt("–î–µ—Ç–∞–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") || null;
        const res = await fetch(`/api/projects/${projectId}/history`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ summary, details }),
        });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ");
          return;
        }
        await loadHistory();
      }

      async function deleteHistoryEvent(eventId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏?")) return;
        const res = await fetch(`/api/projects/${projectId}/history/${eventId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏");
          return;
        }
        await loadHistory();
      }

      function renderCharacteristics() {
        characteristicContainer.innerHTML = "";
        const sortedSections = [...characteristicSections].sort((a, b) => a.order - b.order);
        if (!sortedSections.length) {
          characteristicContainer.innerHTML = "<p class='muted'>–°–µ–∫—Ü–∏–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>";
          return;
        }

        sortedSections.forEach((section, sIndex) => {
          const wrapper = document.createElement("div");
          wrapper.className = "section-card";
          wrapper.innerHTML = `
            <div class=\"stage-header\" style=\"margin-bottom:8px\">
              <div>
                <h3 style=\"margin:0\">${section.title}</h3>
                <div class=\"muted\">–ü–æ—Ä—è–¥–æ–∫: ${section.order}</div>
              </div>
              <div class=\"toolbar\" style=\"margin:0\">
                <button class=\"ghost\" onclick=\"promptSection('${section.id}')\">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class=\"ghost\" onclick=\"promptField('${section.id}')\">+ –ü–æ–ª–µ</button>
                <button class=\"ghost\" onclick=\"moveSection('${section.id}', -1)\" ${sIndex === 0 ? "disabled" : ""}>–í–≤–µ—Ä—Ö</button>
                <button class=\"ghost\" onclick=\"moveSection('${section.id}', 1)\" ${sIndex === sortedSections.length - 1 ? "disabled" : ""}>–í–Ω–∏–∑</button>
                <button onclick=\"deleteSection('${section.id}')\">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
          `;

          const table = document.createElement("table");
          table.innerHTML = `
            <thead>
              <tr>
                <th>Label RU</th>
                <th>Label EN</th>
                <th>Value RU</th>
                <th>Value EN</th>
                <th>–¢–∏–ø</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;

          const tbody = table.querySelector("tbody");
          const fields = [...section.fields].sort((a, b) => a.order - b.order);
          if (!fields.length) {
            const emptyRow = document.createElement("tr");
            emptyRow.innerHTML = `<td colspan="6" class="muted">–ü–æ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</td>`;
            tbody.appendChild(emptyRow);
          } else {
            fields.forEach((field, fIndex) => {
              const row = document.createElement("tr");
              row.dataset.sectionId = section.id;
              row.dataset.fieldId = field.id;

              const labelRu = document.createElement("td");
              labelRu.textContent = field.label_ru;
              const labelEn = document.createElement("td");
              labelEn.textContent = field.label_en;

              const valueRu = document.createElement("td");
              valueRu.appendChild(buildCharacteristicValueControl(section.id, field, "value_ru"));
              const valueEn = document.createElement("td");
              valueEn.appendChild(buildCharacteristicValueControl(section.id, field, "value_en"));

              const typeCell = document.createElement("td");
              typeCell.textContent = field.field_type;

              const actions = document.createElement("td");
              const actionsBar = document.createElement("div");
              actionsBar.className = "toolbar";
              actionsBar.style.margin = "0";
              const editBtn = document.createElement("button");
              editBtn.className = "ghost";
              editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
              editBtn.onclick = () => promptField(section.id, field.id);
              const upBtn = document.createElement("button");
              upBtn.className = "ghost";
              upBtn.textContent = "‚Üë";
              upBtn.disabled = fIndex === 0;
              upBtn.onclick = () => moveField(section.id, field.id, -1);
              const downBtn = document.createElement("button");
              downBtn.className = "ghost";
              downBtn.textContent = "‚Üì";
              downBtn.disabled = fIndex === fields.length - 1;
              downBtn.onclick = () => moveField(section.id, field.id, 1);
              const delBtn = document.createElement("button");
              delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
              delBtn.onclick = () => deleteField(section.id, field.id);
              actionsBar.appendChild(editBtn);
              actionsBar.appendChild(upBtn);
              actionsBar.appendChild(downBtn);
              actionsBar.appendChild(delBtn);
              const status = document.createElement("div");
              status.className = "inline-status";
              actions.appendChild(actionsBar);
              actions.appendChild(status);

              row.appendChild(labelRu);
              row.appendChild(labelEn);
              row.appendChild(valueRu);
              row.appendChild(valueEn);
              row.appendChild(typeCell);
              row.appendChild(actions);

              row.addEventListener("contextmenu", (event) => {
                event.preventDefault();
                const actions = [
                  { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => promptField(section.id, field.id) },
                  { label: "–í–≤–µ—Ä—Ö", disabled: fIndex === 0, action: () => moveField(section.id, field.id, -1) },
                  { label: "–í–Ω–∏–∑", disabled: fields.length - 1 === fIndex, action: () => moveField(section.id, field.id, 1) },
                  { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteField(section.id, field.id) },
                ];
                openContextMenu(event, actions);
              });
              tbody.appendChild(row);
            });
          }

          wrapper.addEventListener("contextmenu", (event) => {
            if (event.target.tagName === "BUTTON" || event.target.closest("tr")) return;
            event.preventDefault();
            const actions = [
              { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ü–∏—é", action: () => promptSection(section.id) },
              { label: "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ", action: () => promptField(section.id) },
              { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö", disabled: sIndex === 0, action: () => moveSection(section.id, -1) },
              { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑", disabled: sIndex === sortedSections.length - 1, action: () => moveSection(section.id, 1) },
              { label: "–£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é", action: () => deleteSection(section.id) },
            ];
            openContextMenu(event, actions);
          });

          wrapper.appendChild(table);
          characteristicContainer.appendChild(wrapper);
        });
      }

      const characteristicSaveTimers = new Map();

      function buildCharacteristicValueControl(sectionId, field, key) {
        if (field.field_type === "checkbox") {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "inline-checkbox";
          checkbox.checked = Boolean(field[key]);
          checkbox.addEventListener("change", () => handleCharacteristicValueChange(sectionId, field.id, key, checkbox));
          return checkbox;
        }

        const area = document.createElement("textarea");
        area.className = "inline-input";
        area.value = field[key] ?? "";
        area.rows = Math.min(4, Math.max(1, area.value.split("\n").length));
        const trigger = () => handleCharacteristicValueChange(sectionId, field.id, key, area);
        area.addEventListener("change", trigger);
        area.addEventListener("blur", trigger);
        return area;
      }

      function handleCharacteristicValueChange(sectionId, fieldId, key, inputEl) {
        const section = characteristicSections.find((s) => s.id === sectionId);
        if (!section) return;
        const field = section.fields.find((f) => f.id === fieldId);
        if (!field) return;
        const isCheckbox = inputEl.type === "checkbox";
        const raw = isCheckbox ? inputEl.checked : inputEl.value;
        field[key] = isCheckbox ? raw : raw;
        queueCharacteristicSave(sectionId, fieldId);
      }

      function setCharacteristicRowState(sectionId, fieldId, text, state = null) {
        const row = characteristicContainer.querySelector(
          `tr[data-section-id="${sectionId}"][data-field-id="${fieldId}"]`
        );
        if (!row) return;
        row.classList.remove("saving", "save-error");
        if (state === "saving") row.classList.add("saving");
        if (state === "error") row.classList.add("save-error");
        const status = row.querySelector(".inline-status");
        if (status) status.textContent = text || "";
      }

      async function persistCharacteristicField(sectionId, fieldId) {
        const key = `${sectionId}:${fieldId}`;
        characteristicSaveTimers.delete(key);
        const section = characteristicSections.find((s) => s.id === sectionId);
        if (!section) return;
        const field = section.fields.find((f) => f.id === fieldId);
        if (!field) return;
        setCharacteristicRowState(sectionId, fieldId, "–°–æ—Ö—Ä–∞–Ω—è–µ–º...", "saving");
        const payload = { ...field };
        if (payload.value_ru === "") payload.value_ru = null;
        if (payload.value_en === "") payload.value_en = null;
        const res = await fetch(
          `/api/projects/${projectId}/characteristics/sections/${sectionId}/fields/${fieldId}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );
        if (!res.ok) {
          setCharacteristicRowState(sectionId, fieldId, "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
          return;
        }
        setCharacteristicRowState(sectionId, fieldId, "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
        setTimeout(() => setCharacteristicRowState(sectionId, fieldId, ""), 1800);
      }

      function queueCharacteristicSave(sectionId, fieldId) {
        const key = `${sectionId}:${fieldId}`;
        if (characteristicSaveTimers.has(key)) clearTimeout(characteristicSaveTimers.get(key));
        setCharacteristicRowState(sectionId, fieldId, "–°–æ—Ö—Ä–∞–Ω—è–µ–º...", "saving");
        const timer = setTimeout(() => persistCharacteristicField(sectionId, fieldId), 500);
        characteristicSaveTimers.set(key, timer);
      }

      async function promptSection(sectionId = null) {
        const current = characteristicSections.find((s) => s.id === sectionId);
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–∏", current?.title || "");
        if (title === null || title.trim() === "") return;
        const order = Number(prompt("–ü–æ—Ä—è–¥–æ–∫", current?.order ?? characteristicSections.length) || 0);

        const payload = { title: title.trim(), order, fields: current?.fields || [] };
        if (sectionId) {
          payload.id = sectionId;
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é");
            return;
          }
        } else {
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ–∫—Ü–∏—é");
            return;
          }
        }
        await loadCharacteristics();
      }

      async function deleteSection(sectionId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é –∏ –≤—Å–µ –µ—ë –ø–æ–ª—è?")) return;
        const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é");
          return;
        }
        await loadCharacteristics();
      }

      async function moveSection(sectionId, delta) {
        const sorted = [...characteristicSections].sort((a, b) => a.order - b.order);
        const index = sorted.findIndex((s) => s.id === sectionId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= sorted.length) return;
        [sorted[index], sorted[target]] = [sorted[target], sorted[index]];
        sorted.forEach((section, idx) => (section.order = idx));
        await Promise.all(
          sorted.map((section) =>
            fetch(`/api/projects/${projectId}/characteristics/sections/${section.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(section),
            })
          )
        );
        characteristicSections = sorted;
        renderCharacteristics();
      }

      async function promptField(sectionId, fieldId = null) {
        const section = characteristicSections.find((s) => s.id === sectionId);
        if (!section) return;
        const current = section.fields.find((f) => f.id === fieldId);
        const label_ru = prompt("Label RU", current?.label_ru || "");
        if (label_ru === null || label_ru.trim() === "") return;
        const label_en = prompt("Label EN", current?.label_en || "");
        if (label_en === null || label_en.trim() === "") return;
        const value_ru = prompt("Value RU", current?.value_ru ?? "");
        if (value_ru === null) return;
        const value_en = prompt("Value EN", current?.value_en ?? "");
        if (value_en === null) return;
        const field_type = prompt("–¢–∏–ø (text/number/select/checkbox/other)", current?.field_type || "text") || "text";

        const payload = {
          label_ru: label_ru.trim(),
          label_en: label_en.trim(),
          value_ru: value_ru || null,
          value_en: value_en || null,
          field_type: field_type.toLowerCase(),
          order: current?.order ?? section.fields.length,
        };

        if (fieldId) {
          payload.id = fieldId;
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}/fields/${fieldId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ");
            return;
          }
        } else {
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}/fields`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ");
            return;
          }
        }
        await loadCharacteristics();
      }

      async function deleteField(sectionId, fieldId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ?")) return;
        const res = await fetch(
          `/api/projects/${projectId}/characteristics/sections/${sectionId}/fields/${fieldId}`,
          { method: "DELETE" }
        );
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ");
          return;
        }
        await loadCharacteristics();
      }

      async function moveField(sectionId, fieldId, delta) {
        const section = characteristicSections.find((s) => s.id === sectionId);
        if (!section) return;
        const fields = [...section.fields].sort((a, b) => a.order - b.order);
        const index = fields.findIndex((f) => f.id === fieldId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= fields.length) return;
        [fields[index], fields[target]] = [fields[target], fields[index]];
        fields.forEach((field, idx) => (field.order = idx));
        await Promise.all(
          fields.map((field) =>
            fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}/fields/${field.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(field),
            })
          )
        );
        await loadCharacteristics();
      }

      async function applyCharacteristicTemplate() {
        const templateId = characteristicTemplateSelect.value;
        if (!templateId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω");
        const res = await fetch(
          `/api/projects/${projectId}/characteristics/apply-template?template_id=${templateId}`,
          { method: "POST" }
        );
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
          return;
        }
        characteristicSections = await res.json();
        renderCharacteristics();
      }

      async function saveCharacteristicTemplate() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞", project?.name ? `–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ${project.name}` : "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω");
        if (!name) return;
        const description = prompt("–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") || null;
        const payload = { name, description, sections: characteristicSections };
        const res = await fetch(`/api/characteristic-templates`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.ok) {
          await loadCharacteristicTemplates();
          alert("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      async function copyCharacteristicStructure() {
        const sourceId = prompt("ID –ø—Ä–æ–µ–∫—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã");
        if (!sourceId) return;
        const res = await fetch(
          `/api/projects/${projectId}/characteristics/copy-structure?source_project_id=${sourceId}`,
          { method: "POST" }
        );
        if (res.ok) {
          characteristicSections = await res.json();
          renderCharacteristics();
          alert("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞, –∑–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã");
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É");
        }
      }

      function triggerCharacteristicImport() {
        characteristicImport.click();
      }

      characteristicImport.addEventListener("change", async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(`/api/projects/${projectId}/characteristics/import`, {
          method: "POST",
          body: formData,
        });
        if (res.ok) {
          characteristicSections = await res.json();
          renderCharacteristics();
          alert("–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã");
        } else {
          const detail = await res.json();
          alert(detail?.detail?.errors?.join("\n") || "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
        }
        event.target.value = "";
      });

      async function exportCharacteristics() {
        const res = await fetch(`/api/projects/${projectId}/characteristics/export`);
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏");
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `characteristics_${projectId}.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
