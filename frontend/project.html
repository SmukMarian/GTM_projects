<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî Haier Project Tracker</title>
    <style>
      :root {
        color-scheme: light light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.5;
      }

      body {
        margin: 0 auto;
        max-width: 1180px;
        padding: 28px 18px 60px;
        background: radial-gradient(circle at 20% 20%, rgba(0, 146, 255, 0.08), transparent 30%),
          radial-gradient(circle at 80% 0%, rgba(0, 146, 255, 0.08), transparent 25%);
        color: #0f172a;
      }

      a {
        color: #0a66c2;
      }

      h1 {
        margin: 4px 0 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: rgba(0, 146, 255, 0.12);
        color: #0060a8;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .card {
        background: rgba(255, 255, 255, 0.94);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        border: 1px solid #e2e8f0;
        margin-bottom: 16px;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        background: #e2f0ff;
        color: #0f172a;
      }

      .badge.archived {
        background: #fef2f2;
        color: #991b1b;
      }

      .badge.closed {
        background: #f1f5f9;
        color: #0f172a;
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 12px;
      }

      button {
        cursor: pointer;
        border: 1px solid #cbd5e1;
        background: #fff;
        padding: 8px 12px;
        border-radius: 10px;
      }

      button.primary {
        background: linear-gradient(135deg, #0077ff, #00a0f0);
        border-color: transparent;
        color: #fff;
        font-weight: 600;
      }

      button.ghost {
        background: transparent;
      }

      label {
        display: grid;
        gap: 6px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font: inherit;
      }

      textarea {
        resize: vertical;
      }

      .grid-two {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }

      .stage-card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        background: #fff;
      }

      .stage-header {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: #f8fafc;
        border-radius: 8px;
        font-size: 0.85rem;
      }

      .chip.warn {
        background: #fff1f2;
        color: #b91c1c;
      }

      .checklist li {
        list-style: none;
        margin: 6px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .muted {
        color: #64748b;
        font-size: 0.95rem;
      }

      .context-menu {
        position: absolute;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2);
        padding: 6px 0;
        display: none;
        z-index: 20;
      }

      .context-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
        min-width: 200px;
      }

      .context-menu li {
        padding: 10px 14px;
        cursor: pointer;
      }

      .context-menu li:hover {
        background: #f1f5f9;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 30;
      }

      .modal {
        background: #fff;
        padding: 20px;
        border-radius: 14px;
        width: min(640px, 92vw);
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }

      th,
      td {
        border: 1px solid #e2e8f0;
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #f8fafc;
        font-weight: 700;
      }

      .characteristics-grid {
        display: grid;
        gap: 12px;
      }

      .section-card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <a href="/projects.html">‚Üê –ö —Å–ø–∏—Å–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤</a>
      <a href="/groups.html">–ì—Ä—É–ø–ø—ã</a>
      <a href="/index.html">–î–∞—à–±–æ—Ä–¥</a>
    </div>

    <div id="project-card" class="card">
      <div style="display: flex; justify-content: space-between; gap: 12px; align-items: center; flex-wrap: wrap">
        <div>
          <p class="pill">–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</p>
          <h1 id="project-name">–ü—Ä–æ–µ–∫—Ç</h1>
          <div id="project-meta" class="muted"></div>
        </div>
        <div id="project-badges" style="display: flex; gap: 8px; flex-wrap: wrap"></div>
      </div>
      <p id="project-desc" class="muted"></p>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>GTM-—ç—Ç–∞–ø—ã</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="openStageForm()">–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø</button>
          <select id="templateSelect"></select>
          <button onclick="applyTemplate()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
          <button onclick="saveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</button>
          <button onclick="triggerImport()">–ò–º–ø–æ—Ä—Ç Excel</button>
          <button onclick="exportStages()">–≠–∫—Å–ø–æ—Ä—Ç Excel</button>
          <input type="file" id="importInput" accept=".xlsx" style="display: none" />
        </div>
      </div>
      <div id="stages"></div>
    </div>

    <div class="card">
      <div class="stage-header" style="margin-bottom: 8px">
        <h2>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (RU / EN)</h2>
        <div class="toolbar" style="margin: 0">
          <button class="primary" onclick="promptSection()">–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é</button>
          <select id="characteristicTemplateSelect"></select>
          <button onclick="applyCharacteristicTemplate()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
          <button onclick="saveCharacteristicTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</button>
          <button onclick="copyCharacteristicStructure()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
          <button onclick="triggerCharacteristicImport()">–ò–º–ø–æ—Ä—Ç Excel</button>
          <button onclick="exportCharacteristics()">–≠–∫—Å–ø–æ—Ä—Ç Excel</button>
          <input type="file" id="characteristicImport" accept=".xlsx" style="display: none" />
        </div>
      </div>
      <div id="characteristics"></div>
    </div>

    <div id="contextMenu" class="context-menu">
      <ul id="contextMenuList"></ul>
    </div>

    <div id="modal" class="modal-backdrop">
      <div class="modal">
        <h3 id="modalTitle">–≠—Ç–∞–ø</h3>
        <form id="stageForm">
          <input type="hidden" id="stageId" />
          <div class="grid-two">
            <label>
              –ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞
              <input required id="stageTitle" />
            </label>
            <label>
              –ü–æ—Ä—è–¥–æ–∫
              <input type="number" id="stageOrder" min="0" />
            </label>
          </div>
          <label>
            –û–ø–∏—Å–∞–Ω–∏–µ
            <textarea id="stageDescription" rows="3"></textarea>
          </label>
          <div class="grid-two">
            <label>
              –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
              <input type="date" id="stagePlannedStart" />
            </label>
            <label>
              –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
              <input type="date" id="stagePlannedEnd" />
            </label>
          </div>
          <div class="grid-two">
            <label>
              –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
              <input type="date" id="stageActualEnd" />
            </label>
            <label>
              –°—Ç–∞—Ç—É—Å
              <select id="stageStatus">
                <option value="not_started">–ù–µ –Ω–∞—á–∞—Ç</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
              </select>
            </label>
          </div>
          <label style="display: flex; align-items: center; gap: 8px">
            <input type="checkbox" id="stageRisk" /> –û—Ç–º–µ—Ç–∏—Ç—å —Ä–∏—Å–∫
          </label>
          <div style="margin-top: 12px; display: flex; gap: 10px; justify-content: flex-end">
            <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const projectId = params.get("id");
      const stagesContainer = document.getElementById("stages");
      const templateSelect = document.getElementById("templateSelect");
      const importInput = document.getElementById("importInput");
      const characteristicContainer = document.getElementById("characteristics");
      const characteristicTemplateSelect = document.getElementById("characteristicTemplateSelect");
      const characteristicImport = document.getElementById("characteristicImport");
      const contextMenu = document.getElementById("contextMenu");
      const contextMenuList = document.getElementById("contextMenuList");

      let project = null;
      let gtmTemplates = [];
      let gtmStages = [];
      let characteristicTemplates = [];
      let characteristicSections = [];

      if (!projectId) {
        stagesContainer.innerHTML = "<p>–ù–µ —É–∫–∞–∑–∞–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö ?id=</p>";
      } else {
        loadData();
      }

      async function loadData() {
        await Promise.all([
          loadProject(),
          loadTemplates(),
          loadStages(),
          loadCharacteristicTemplates(),
          loadCharacteristics(),
        ]);
      }

      async function loadProject() {
        const res = await fetch(`/api/projects/${projectId}`);
        if (!res.ok) {
          stagesContainer.innerHTML = "<p>–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>";
          return;
        }
        project = await res.json();
        renderProject();
      }

      async function loadTemplates() {
        const res = await fetch("/api/gtm-templates");
        gtmTemplates = res.ok ? await res.json() : [];
        renderTemplates();
      }

      async function loadStages() {
        const res = await fetch(`/api/projects/${projectId}/gtm-stages`);
        gtmStages = res.ok ? await res.json() : [];
        renderStages();
      }

      async function loadCharacteristicTemplates() {
        const res = await fetch("/api/characteristic-templates");
        characteristicTemplates = res.ok ? await res.json() : [];
        renderCharacteristicTemplates();
      }

      async function loadCharacteristics() {
        const res = await fetch(`/api/projects/${projectId}/characteristics/sections`);
        characteristicSections = res.ok ? await res.json() : [];
        renderCharacteristics();
      }

      function renderProject() {
        document.getElementById("project-name").textContent = project.name;
        document.getElementById("project-desc").textContent = project.short_description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
        const metaParts = [];
        if (project.brand) metaParts.push(`–ë—Ä–µ–Ω–¥: ${project.brand}`);
        if (project.market) metaParts.push(`–†—ã–Ω–æ–∫: ${project.market}`);
        if (project.planned_launch) metaParts.push(`–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞: ${project.planned_launch}`);
        document.getElementById("project-meta").textContent = metaParts.join(" ¬∑ ");

        const badges = [];
        if (project.status === "archived") {
          badges.push(`<span class="badge archived">–ê—Ä—Ö–∏–≤</span>`);
        } else if (project.status === "closed") {
          badges.push(`<span class="badge closed">–ó–∞–∫—Ä—ã—Ç</span>`);
        } else {
          badges.push(`<span class="badge">–ê–∫—Ç–∏–≤–µ–Ω</span>`);
        }
        if (project.priority) {
          const titles = { low: "–ù–∏–∑–∫–∏–π", medium: "–°—Ä–µ–¥–Ω–∏–π", high: "–í—ã—Å–æ–∫–∏–π" };
          badges.push(`<span class="badge">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${titles[project.priority] || project.priority}</span>`);
        }
        document.getElementById("project-badges").innerHTML = badges.join("");
      }

      function renderTemplates() {
        templateSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω";
        templateSelect.appendChild(defaultOption);
        gtmTemplates.forEach((tpl) => {
          const option = document.createElement("option");
          option.value = tpl.id;
          option.textContent = tpl.name;
          templateSelect.appendChild(option);
        });
      }

      function renderCharacteristicTemplates() {
        characteristicTemplateSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "–®–∞–±–ª–æ–Ω—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫";
        characteristicTemplateSelect.appendChild(defaultOption);
        characteristicTemplates.forEach((tpl) => {
          const option = document.createElement("option");
          option.value = tpl.id;
          option.textContent = tpl.name;
          characteristicTemplateSelect.appendChild(option);
        });
      }

      function statusLabel(value) {
        return {
          not_started: "–ù–µ –Ω–∞—á–∞—Ç",
          in_progress: "–í —Ä–∞–±–æ—Ç–µ",
          done: "–ó–∞–≤–µ—Ä—à—ë–Ω",
          cancelled: "–û—Ç–º–µ–Ω—ë–Ω",
        }[value] || value;
      }

      function renderStages() {
        gtmStages.sort((a, b) => a.order - b.order);
        if (!gtmStages.length) {
          stagesContainer.innerHTML = "<p class=\"muted\">–≠—Ç–∞–ø—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>";
          return;
        }

        stagesContainer.innerHTML = "";
        gtmStages.forEach((stage, index) => {
          const card = document.createElement("div");
          card.className = "stage-card";
          card.dataset.stageId = stage.id;
          card.innerHTML = `
            <div class="stage-header">
              <div>
                <strong>${stage.order}. ${stage.title}</strong>
                <div class="muted">${stage.description || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <span class="chip">${statusLabel(stage.status)}</span>
                ${stage.risk_flag ? '<span class="chip warn">‚ö†Ô∏è –†–∏—Å–∫</span>' : ""}
                <button class="ghost" onclick="openStageForm('${stage.id}')">‚úèÔ∏è</button>
                <button class="ghost" onclick="moveStage('${stage.id}', -1)" ${index === 0 ? "disabled" : ""}>‚Üë</button>
                <button class="ghost" onclick="moveStage('${stage.id}', 1)" ${index === gtmStages.length - 1 ? "disabled" : ""}>‚Üì</button>
                <button class="ghost" onclick="deleteStage('${stage.id}')">üóëÔ∏è</button>
              </div>
            </div>
            <div class="grid-two" style="margin-top:8px">
              <div class="chip">–ü–ª–∞–Ω: ${stage.planned_start || "‚Äî"} ‚Üí ${stage.planned_end || "‚Äî"}</div>
              <div class="chip">–§–∞–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: ${stage.actual_end || "‚Äî"}</div>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <label style="display:flex; align-items:center; gap:6px; font-weight:500">
                –°—Ç–∞—Ç—É—Å
                <select onchange="changeStatus('${stage.id}', this.value)">
                  <option value="not_started" ${stage.status === "not_started" ? "selected" : ""}>–ù–µ –Ω–∞—á–∞—Ç</option>
                  <option value="in_progress" ${stage.status === "in_progress" ? "selected" : ""}>–í —Ä–∞–±–æ—Ç–µ</option>
                  <option value="done" ${stage.status === "done" ? "selected" : ""}>–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                  <option value="cancelled" ${stage.status === "cancelled" ? "selected" : ""}>–û—Ç–º–µ–Ω—ë–Ω</option>
                </select>
              </label>
              <label style="display:flex; align-items:center; gap:6px; font-weight:500">
                <input type="checkbox" ${stage.risk_flag ? "checked" : ""} onchange="toggleRisk('${stage.id}', this.checked)" /> –†–∏—Å–∫
              </label>
              <button class="ghost" onclick="promptChecklist('${stage.id}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</button>
            </div>
            <ul class="checklist">
              ${stage.checklist
                .sort((a, b) => a.order - b.order)
                .map(
                  (item) => `
                  <li>
                    <input type="checkbox" ${item.done ? "checked" : ""} onchange="toggleChecklistItem('${stage.id}', '${item.id}', this.checked)" />
                    <span ${item.done ? 'style="text-decoration: line-through; color:#94a3b8"' : ''}>${item.title}</span>
                    <button class="ghost" onclick="editChecklistItem('${stage.id}', '${item.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="ghost" onclick="deleteChecklistItem('${stage.id}', '${item.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                  </li>
                `)
                .join("")}
            </ul>
          `;

          card.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            openStageContextMenu(event, stage, index);
          });

          stagesContainer.appendChild(card);
        });
      }

      function openStageContextMenu(event, stage, index) {
        const actions = [
          { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => openStageForm(stage.id) },
          { label: stage.risk_flag ? "–°–Ω—è—Ç—å —Ä–∏—Å–∫" : "–û—Ç–º–µ—Ç–∏—Ç—å —Ä–∏—Å–∫", action: () => toggleRisk(stage.id, !stage.risk_flag) },
          { label: "–î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç —á–µ–∫-–ª–∏—Å—Ç–∞", action: () => promptChecklist(stage.id) },
          { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö", disabled: index === 0, action: () => moveStage(stage.id, -1) },
          { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑", disabled: index === gtmStages.length - 1, action: () => moveStage(stage.id, 1) },
          { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteStage(stage.id) },
        ];
        openContextMenu(event, actions);
      }

      function openContextMenu(event, actions) {
        contextMenuList.innerHTML = "";
        actions.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item.label;
          if (item.disabled) {
            li.style.color = "#cbd5e1";
            li.style.cursor = "not-allowed";
          } else {
            li.addEventListener("click", () => {
              item.action();
              hideContextMenu();
            });
          }
          contextMenuList.appendChild(li);
        });

        contextMenu.style.display = "block";
        contextMenu.style.left = `${event.pageX}px`;
        contextMenu.style.top = `${event.pageY}px`;
      }

      function hideContextMenu() {
        contextMenu.style.display = "none";
      }

      document.addEventListener("click", () => hideContextMenu());

      function openStageForm(stageId = null) {
        document.getElementById("modal").style.display = "flex";
        const stage = gtmStages.find((s) => s.id === stageId);
        document.getElementById("modalTitle").textContent = stage ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞" : "–ù–æ–≤—ã–π —ç—Ç–∞–ø";
        document.getElementById("stageId").value = stage ? stage.id : "";
        document.getElementById("stageTitle").value = stage ? stage.title : "";
        document.getElementById("stageOrder").value = stage ? stage.order : gtmStages.length;
        document.getElementById("stageDescription").value = stage?.description || "";
        document.getElementById("stagePlannedStart").value = stage?.planned_start || "";
        document.getElementById("stagePlannedEnd").value = stage?.planned_end || "";
        document.getElementById("stageActualEnd").value = stage?.actual_end || "";
        document.getElementById("stageStatus").value = stage?.status || "not_started";
        document.getElementById("stageRisk").checked = stage?.risk_flag || false;
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }

      document.getElementById("stageForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = {
          title: document.getElementById("stageTitle").value,
          order: Number(document.getElementById("stageOrder").value || 0),
          description: document.getElementById("stageDescription").value || null,
          planned_start: document.getElementById("stagePlannedStart").value || null,
          planned_end: document.getElementById("stagePlannedEnd").value || null,
          actual_end: document.getElementById("stageActualEnd").value || null,
          status: document.getElementById("stageStatus").value,
          risk_flag: document.getElementById("stageRisk").checked,
          checklist: [],
        };

        const stageId = document.getElementById("stageId").value;
        let res;
        if (stageId) {
          const existing = gtmStages.find((s) => s.id === stageId);
          payload.checklist = existing?.checklist || [];
          res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } else {
          res = await fetch(`/api/projects/${projectId}/gtm-stages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        }

        if (res.ok) {
          await loadStages();
          closeModal();
        } else {
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞");
        }
      });

      async function changeStatus(stageId, value) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.status = value;
        await saveStage(stage);
      }

      async function toggleRisk(stageId, value) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.risk_flag = value;
        await saveStage(stage);
      }

      async function moveStage(stageId, delta) {
        const index = gtmStages.findIndex((s) => s.id === stageId);
        if (index === -1) return;
        const target = index + delta;
        if (target < 0 || target >= gtmStages.length) return;
        const otherId = gtmStages[target].id;

        [gtmStages[index].order, gtmStages[target].order] = [gtmStages[target].order, gtmStages[index].order];
        const firstSave = saveStage(gtmStages[index]);
        const secondSave = saveStage(gtmStages[target]);
        await Promise.all([firstSave, secondSave]);
        await loadStages();
      }

      async function deleteStage(stageId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø?")) return;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/${stageId}`, { method: "DELETE" });
        if (res.ok) {
          await loadStages();
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø");
        }
      }

      async function saveStage(stage) {
        await fetch(`/api/projects/${projectId}/gtm-stages/${stage.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(stage),
        });
      }

      function promptChecklist(stageId) {
        const text = prompt("–¢–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ —á–µ–∫-–ª–∏—Å—Ç–∞");
        if (!text) return;
        addChecklistItem(stageId, text);
      }

      async function addChecklistItem(stageId, title) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        const nextOrder = stage.checklist.length;
        stage.checklist.push({ id: crypto.randomUUID(), title, done: false, order: nextOrder });
        await saveStage(stage);
        await loadStages();
      }

      async function toggleChecklistItem(stageId, itemId, done) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        const item = stage.checklist.find((c) => c.id === itemId);
        if (!item) return;
        item.done = done;
        await saveStage(stage);
        await loadStages();
      }

      async function editChecklistItem(stageId, itemId) {
        const stage = gtmStages.find((s) => s.id === stageId);
        const item = stage?.checklist.find((c) => c.id === itemId);
        if (!item) return;
        const text = prompt("–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞", item.title);
        if (!text) return;
        item.title = text;
        await saveStage(stage);
        await loadStages();
      }

      async function deleteChecklistItem(stageId, itemId) {
        const stage = gtmStages.find((s) => s.id === stageId);
        if (!stage) return;
        stage.checklist = stage.checklist.filter((c) => c.id !== itemId);
        stage.checklist.forEach((c, idx) => (c.order = idx));
        await saveStage(stage);
        await loadStages();
      }

      async function applyTemplate() {
        const templateId = templateSelect.value;
        if (!templateId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω");
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/apply-template?template_id=${templateId}`, {
          method: "POST",
        });
        if (res.ok) {
          gtmStages = await res.json();
          renderStages();
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      async function saveTemplate() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞", project?.name ? `GTM ${project.name}` : "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω");
        if (!name) return;
        const description = prompt("–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") || null;
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/save-template`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description }),
        });
        if (res.ok) {
          await loadTemplates();
          alert("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      function triggerImport() {
        importInput.click();
      }

      importInput.addEventListener("change", async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/import`, {
          method: "POST",
          body: formData,
        });
        if (res.ok) {
          gtmStages = await res.json();
          renderStages();
          alert("–≠—Ç–∞–ø—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        } else {
          const detail = await res.json();
          alert(detail?.detail?.errors?.join("\n") || "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
        }
        event.target.value = "";
      });

      async function exportStages() {
        const res = await fetch(`/api/projects/${projectId}/gtm-stages/export`);
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–ø—ã");
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `gtm_stages_${projectId}.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      function renderCharacteristics() {
        characteristicContainer.innerHTML = "";
        const sortedSections = [...characteristicSections].sort((a, b) => a.order - b.order);
        if (!sortedSections.length) {
          characteristicContainer.innerHTML = "<p class='muted'>–°–µ–∫—Ü–∏–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>";
          return;
        }

        sortedSections.forEach((section, sIndex) => {
          const wrapper = document.createElement("div");
          wrapper.className = "section-card";
          wrapper.innerHTML = `
            <div class="stage-header" style="margin-bottom:8px">
              <div>
                <h3 style="margin:0">${section.title}</h3>
                <div class="muted">–ü–æ—Ä—è–¥–æ–∫: ${section.order}</div>
              </div>
              <div class="toolbar" style="margin:0">
                <button class="ghost" onclick="promptSection('${section.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="ghost" onclick="promptField('${section.id}')">+ –ü–æ–ª–µ</button>
                <button class="ghost" onclick="moveSection('${section.id}', -1)" ${sIndex === 0 ? "disabled" : ""}>–í–≤–µ—Ä—Ö</button>
                <button class="ghost" onclick="moveSection('${section.id}', 1)" ${sIndex === sortedSections.length - 1 ? "disabled" : ""}>–í–Ω–∏–∑</button>
                <button onclick="deleteSection('${section.id}')">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
          `;

          const table = document.createElement("table");
          table.innerHTML = `
            <thead>
              <tr>
                <th>Label RU</th>
                <th>Label EN</th>
                <th>Value RU</th>
                <th>Value EN</th>
                <th>–¢–∏–ø</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;

          const tbody = table.querySelector("tbody");
          const fields = [...section.fields].sort((a, b) => a.order - b.order);
          if (!fields.length) {
            const emptyRow = document.createElement("tr");
            emptyRow.innerHTML = `<td colspan="6" class="muted">–ü–æ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</td>`;
            tbody.appendChild(emptyRow);
          } else {
            fields.forEach((field, fIndex) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${field.label_ru}</td>
                <td>${field.label_en}</td>
                <td>${field.value_ru ?? ""}</td>
                <td>${field.value_en ?? ""}</td>
                <td>${field.field_type}</td>
                <td>
                  <button class="ghost" onclick="promptField('${section.id}', '${field.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="ghost" onclick="moveField('${section.id}', '${field.id}', -1)" ${fIndex === 0 ? "disabled" : ""}>‚Üë</button>
                  <button class="ghost" onclick="moveField('${section.id}', '${field.id}', 1)" ${fIndex === fields.length - 1 ? "disabled" : ""}>‚Üì</button>
                  <button onclick="deleteField('${section.id}', '${field.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </td>
              `;
              row.addEventListener("contextmenu", (event) => {
                event.preventDefault();
                const actions = [
                  { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", action: () => promptField(section.id, field.id) },
                  { label: "–í–≤–µ—Ä—Ö", disabled: fIndex === 0, action: () => moveField(section.id, field.id, -1) },
                  { label: "–í–Ω–∏–∑", disabled: fIndex === fields.length - 1, action: () => moveField(section.id, field.id, 1) },
                  { label: "–£–¥–∞–ª–∏—Ç—å", action: () => deleteField(section.id, field.id) },
                ];
                openContextMenu(event, actions);
              });
              tbody.appendChild(row);
            });
          }

          wrapper.addEventListener("contextmenu", (event) => {
            if (event.target.tagName === "BUTTON" || event.target.closest("tr")) return;
            event.preventDefault();
            const actions = [
              { label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ü–∏—é", action: () => promptSection(section.id) },
              { label: "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ", action: () => promptField(section.id) },
              { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö", disabled: sIndex === 0, action: () => moveSection(section.id, -1) },
              { label: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑", disabled: sIndex === sortedSections.length - 1, action: () => moveSection(section.id, 1) },
              { label: "–£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é", action: () => deleteSection(section.id) },
            ];
            openContextMenu(event, actions);
          });

          wrapper.appendChild(table);
          characteristicContainer.appendChild(wrapper);
        });
      }

      async function promptSection(sectionId = null) {
        const current = characteristicSections.find((s) => s.id === sectionId);
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–∏", current?.title || "");
        if (title === null || title.trim() === "") return;
        const order = Number(prompt("–ü–æ—Ä—è–¥–æ–∫", current?.order ?? characteristicSections.length) || 0);

        const payload = { title: title.trim(), order, fields: current?.fields || [] };
        if (sectionId) {
          payload.id = sectionId;
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é");
            return;
          }
        } else {
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ–∫—Ü–∏—é");
            return;
          }
        }
        await loadCharacteristics();
      }

      async function deleteSection(sectionId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é –∏ –≤—Å–µ –µ—ë –ø–æ–ª—è?")) return;
        const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}`, { method: "DELETE" });
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é");
          return;
        }
        await loadCharacteristics();
      }

      async function moveSection(sectionId, delta) {
        const sorted = [...characteristicSections].sort((a, b) => a.order - b.order);
        const index = sorted.findIndex((s) => s.id === sectionId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= sorted.length) return;
        [sorted[index], sorted[target]] = [sorted[target], sorted[index]];
        sorted.forEach((section, idx) => (section.order = idx));
        await Promise.all(
          sorted.map((section) =>
            fetch(`/api/projects/${projectId}/characteristics/sections/${section.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(section),
            })
          )
        );
        characteristicSections = sorted;
        renderCharacteristics();
      }

      async function promptField(sectionId, fieldId = null) {
        const section = characteristicSections.find((s) => s.id === sectionId);
        if (!section) return;
        const current = section.fields.find((f) => f.id === fieldId);
        const label_ru = prompt("Label RU", current?.label_ru || "");
        if (label_ru === null || label_ru.trim() === "") return;
        const label_en = prompt("Label EN", current?.label_en || "");
        if (label_en === null || label_en.trim() === "") return;
        const value_ru = prompt("Value RU", current?.value_ru ?? "");
        if (value_ru === null) return;
        const value_en = prompt("Value EN", current?.value_en ?? "");
        if (value_en === null) return;
        const field_type = prompt("–¢–∏–ø (text/number/select/checkbox/other)", current?.field_type || "text") || "text";

        const payload = {
          label_ru: label_ru.trim(),
          label_en: label_en.trim(),
          value_ru: value_ru || null,
          value_en: value_en || null,
          field_type: field_type.toLowerCase(),
          order: current?.order ?? section.fields.length,
        };

        if (fieldId) {
          payload.id = fieldId;
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}/fields/${fieldId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ");
            return;
          }
        } else {
          const res = await fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}/fields`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ");
            return;
          }
        }
        await loadCharacteristics();
      }

      async function deleteField(sectionId, fieldId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ?")) return;
        const res = await fetch(
          `/api/projects/${projectId}/characteristics/sections/${sectionId}/fields/${fieldId}`,
          { method: "DELETE" }
        );
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ");
          return;
        }
        await loadCharacteristics();
      }

      async function moveField(sectionId, fieldId, delta) {
        const section = characteristicSections.find((s) => s.id === sectionId);
        if (!section) return;
        const fields = [...section.fields].sort((a, b) => a.order - b.order);
        const index = fields.findIndex((f) => f.id === fieldId);
        const target = index + delta;
        if (index < 0 || target < 0 || target >= fields.length) return;
        [fields[index], fields[target]] = [fields[target], fields[index]];
        fields.forEach((field, idx) => (field.order = idx));
        await Promise.all(
          fields.map((field) =>
            fetch(`/api/projects/${projectId}/characteristics/sections/${sectionId}/fields/${field.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(field),
            })
          )
        );
        await loadCharacteristics();
      }

      async function applyCharacteristicTemplate() {
        const templateId = characteristicTemplateSelect.value;
        if (!templateId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω");
        const res = await fetch(
          `/api/projects/${projectId}/characteristics/apply-template?template_id=${templateId}`,
          { method: "POST" }
        );
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
          return;
        }
        characteristicSections = await res.json();
        renderCharacteristics();
      }

      async function saveCharacteristicTemplate() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞", project?.name ? `–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ${project.name}` : "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω");
        if (!name) return;
        const description = prompt("–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") || null;
        const payload = { name, description, sections: characteristicSections };
        const res = await fetch(`/api/characteristic-templates`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.ok) {
          await loadCharacteristicTemplates();
          alert("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω");
        }
      }

      async function copyCharacteristicStructure() {
        const sourceId = prompt("ID –ø—Ä–æ–µ–∫—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã");
        if (!sourceId) return;
        const res = await fetch(
          `/api/projects/${projectId}/characteristics/copy-structure?source_project_id=${sourceId}`,
          { method: "POST" }
        );
        if (res.ok) {
          characteristicSections = await res.json();
          renderCharacteristics();
          alert("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞, –∑–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã");
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É");
        }
      }

      function triggerCharacteristicImport() {
        characteristicImport.click();
      }

      characteristicImport.addEventListener("change", async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(`/api/projects/${projectId}/characteristics/import`, {
          method: "POST",
          body: formData,
        });
        if (res.ok) {
          characteristicSections = await res.json();
          renderCharacteristics();
          alert("–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã");
        } else {
          const detail = await res.json();
          alert(detail?.detail?.errors?.join("\n") || "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
        }
        event.target.value = "";
      });

      async function exportCharacteristics() {
        const res = await fetch(`/api/projects/${projectId}/characteristics/export`);
        if (!res.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏");
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `characteristics_${projectId}.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
